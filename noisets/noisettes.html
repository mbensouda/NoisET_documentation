<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.1.0"/>
    <title> NoisET documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>
            <img src="NT.png" class="logo" alt="project logo"/>


        <h2>Contents</h2>
        <ul>
  <li><a href="#noisetsupsup-noise-sampling-learning-expansion-detection-of-t-cell-receptors-using-bayesian-inference">NoisET<sup>*</sup>  NOIse sampling learning &amp; Expansion detection of T-cell receptors using Bayesian inference.</a></li>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#documentation">Documentation</a>
  <ul>
    <li><a href="#command-lines-with-terminal">Command lines with terminal</a></li>
    <li><a href="#1-infer-noise-model">1/ Infer noise model</a></li>
    <li><a href="#2-generate-synthetic-data-from-null-model-learning">2/ Generate synthetic data from null model learning:</a></li>
    <li><a href="#3-detect-responding-clones">3/ Detect responding clones:</a></li>
    <li><a href="#python-package">Python package</a></li>
  </ul></li>
</ul>



        <h3> NoisET Python package documentation</h3>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#longitudinal_analysis">longitudinal_analysis</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#longitudinal_analysis.__init__">longitudinal_analysis</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.import_clones">import_clones</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.merge_replicates">merge_replicates</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.persistence_clones">persistence_clones</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.plot_hist_persistence">plot_hist_persistence</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.get_top_clones_set">get_top_clones_set</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.build_traj_frame">build_traj_frame</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.plot_trajectories">plot_trajectories</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.PCA_traj">PCA_traj</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.plot_clusters2D">plot_clusters2D</a>
                        </li>
                        <li>
                                <a class="function" href="#longitudinal_analysis.plot_traj_clusters">plot_traj_clusters</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Data_Process">Data_Process</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Data_Process.__init__">Data_Process</a>
                        </li>
                        <li>
                                <a class="function" href="#Data_Process.import_data">import_data</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Noise_Model">Noise_Model</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Noise_Model.__init__">Noise_Model</a>
                        </li>
                        <li>
                                <a class="function" href="#Noise_Model.get_sparserep">get_sparserep</a>
                        </li>
                        <li>
                                <a class="function" href="#Noise_Model.learn_null_model">learn_null_model</a>
                        </li>
                        <li>
                                <a class="function" href="#Noise_Model.diversity_estimate">diversity_estimate</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Expansion_Model">Expansion_Model</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Expansion_Model.__init__">Expansion_Model</a>
                        </li>
                        <li>
                                <a class="function" href="#Expansion_Model.get_sparserep">get_sparserep</a>
                        </li>
                        <li>
                                <a class="function" href="#Expansion_Model.expansion_table">expansion_table</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Generator">Generator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Generator.__init__">Generator</a>
                        </li>
                        <li>
                                <a class="function" href="#Generator.gen_synthetic_data_Null">gen_synthetic_data_Null</a>
                        </li>
                        <li>
                                <a class="function" href="#Generator.generate_trajectories">generate_trajectories</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
noisets<wbr>.noisettes    </h1>

                        <div class="docstring"><h1 id="noisetsupsup-noise-sampling-learning-expansion-detection-of-t-cell-receptors-using-bayesian-inference">NoisET<sup>*</sup>  NOIse sampling learning &amp; Expansion detection of T-cell receptors using Bayesian inference.</h1>

<p>High-throughput sequencing of T- and B-cell receptors makes it possible to track immune
repertoires across time, in different tissues, in acute and chronic diseases or in healthy individuals. However
quantitative comparison between repertoires is confounded by variability in the read count of each receptor
clonotype due to sampling, library preparation, and expression noise. We present an easy-to-use python
package NoisET that implements and generalizes a previously developed Bayesian method in <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2">Puelma Touzel et al, 2020</a>. It can be used
to learn experimental noise models for repertoire sequencing from replicates, and to detect responding
clones following a stimulus. The package was tested on different repertoire sequencing technologies and
datasets. NoisET package is desribed <a href="https://arxiv.org/abs/2102.03568">here</a>. </p>

<p><sup>* NoisET should be pronounced as "noisettes" (ie hazelnuts in French).</sup></p>

<p>Functions library for NoisET - construction of noisettes package
Copyright (C) 2021 Meriem Bensouda Koraichi. 
   This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>.</p>

<h1 id="installation">Installation</h1>

<p>Python 3 </p>

<p>NoisET is a python /3.6 software. It is available on PyPI and can be downloaded and installed through pip:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>pip install noisets
</code></pre></div>

<p>Watch out, Data pre-processing, diversity estimates and generation of neutral TCR clonal dynamics is not possible yet with installation with pip. Use only the sudo command below.</p>

<p>To install NoisET and try the tutorial dusplayed in this github: gitclone the file in your working environment. 
Using the terminal, go to NoisET directory and write the following command : </p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>sudo python setup.py install
</code></pre></div>

<p>If you do not have the following python libraries (that are useful to use NoisET) : numpy, pandas, matplotlib, seaborn, scipy, scikit-learn, please do the following commands, to try first to install the dependencies separately: :</p>

<pre><code>python -m pip install -U pip
python -m pip install -U matplotlib
pip install numpy
pip install pandas
pip install matplotlib
pip install seaborn
pip install -U scikit-learn

</code></pre>

<h1 id="documentation">Documentation</h1>

<h2 id="command-lines-with-terminal"> A/ Command lines with terminal</h2>

<p>A tutorial is available at <a href="https://github.com/mbensouda/NoisET_tutorial">https://github.com/mbensouda/NoisET_tutorial</a> . 
Three commands are available to use :</p>

<ul>
<li><code>noiset-noise</code> To infer Null noise model: NoisET first function (1)</li>
<li><code>noiset-nullgenerator</code> To qualitatively check consistency of NoisET first function</li>
<li><code>noiset-detection</code> To detect responding clones to a stimulus: NoisET second function (2)</li>
</ul>

<p>All options are described typing one of the previous commands + <code>--help</code>or <code>-h</code>. Options are also described in the following READme.</p>

<h3 id="1-infer-noise-model">1/ Infer noise model</h3>

<p>To infer null noise model: NoisET first function (1), use the command <code>noiset-noise</code></p>

<p>At the command prompt, type:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>noiset-noise --path <span class="s1">&#39;DATA_REPO/&#39;</span> --f1 <span class="s1">&#39;FILENAME1_X_REP1&#39;</span> --f2 <span class="s1">&#39;FILENAME2_X_REP2&#39;</span> --<span class="o">(</span>noisemodel<span class="o">)</span>
</code></pre></div>

<p>Several options are needed to learn noise model from two replicate samples associated to one individual at a specific time point:</p>

<h4 id="1-data-information">1/ Data information:</h4>

<ul>
<li><code>--path 'PATHTODATA'</code>: set path to data file </li>
<li><code>--f1 'FILENAME1_X_REP1'</code>: filename for individual X replicate 1 </li>
<li><code>--f2 'FILENAME2_X_REP2'</code>: filename for individual X replicate 2 </li>
</ul>

<p>If your TCR CDR3 clonal populations features (ie clonal fractions, clonal counts, clonal nucleotide CDR3 sequences and clonal amino acid sequences) have different column names than: ('Clone fraction', 'Clone count', 'N. Seq. CDR3', 'AA. Seq. CDR3), you can specify the name directly by using: </p>

<ul>
<li><code>--specify</code> </li>
<li><code>--freq 'frequency'</code> : Column label associated to clonal fraction </li>
<li><code>--counts 'counts'</code>:  Column label associated to clonal count  </li>
<li><code>--ntCDR3 'ntCDR3'</code>:  Column label associated to clonal CDR3 nucleotides sequence  </li>
<li><code>--AACDR3 'AACDR3'</code>:  Column label associated to clonal CDR3 amino acid sequence</li>
</ul>

<h4 id="2-choice-of-noise-model-parameters-meaning-described-in-methods-section">2/ Choice of noise model: (parameters meaning described in Methods section)</h4>

<ul>
<li><code>--NBPoisson</code>: Negative Binomial + Poisson Noise Model - 5 parameters </li>
<li><code>--NB</code>: Negative Binomial - 4 parameters  </li>
<li><code>--Poisson</code>: Poisson - 2 parameters </li>
</ul>

<h4 id="3-example">3/ Example:</h4>

<p>At the command prompt, type:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>noiset-noise --path <span class="s1">&#39;data_examples/&#39;</span> --f1 <span class="s1">&#39;Q1_0_F1_.txt.gz&#39;</span> --f2 <span class="s1">&#39;Q1_0_F2_.txt.gz&#39;</span> --NB
</code></pre></div>

<p>This command line will learn four parameters associated to negative binomial null noise Model <code>--NB</code> for individual Q1 at day 0.
A '.txt' file is created in the working directory: it is a 5/4/2 parameters data-set regarding on NBP/NB/Poisson noise model. In this example, it is a four parameters table (already created in data_examples repository). 
You can run previous examples using data (Q1 day 0/ day15) provided in the data_examples folder - data from <a href="https://www.pnas.org/content/115/50/12704">Precise tracking of vaccine-responding T cell clones reveals convergent and personalized response in identical twins, Pogorelyy et al, PNAS</a> </p>

<h4 id="4-example-with-specify">4/ Example with <code>--specify</code>:</h4>

<p>At the command prompt, type:</p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>noiset-noise --path <span class="s1">&#39;data_examples/&#39;</span> --f1 <span class="s1">&#39;replicate_1_1.tsv.gz&#39;</span> --f2 <span class="s1">&#39;replicate_1_2.tsv.gz&#39;</span> --specify --freq <span class="s1">&#39;frequencyCount&#39;</span> --counts <span class="s1">&#39;count&#39;</span> --ntCDR3 <span class="s1">&#39;nucleotide&#39;</span> --AACDR3 <span class="s1">&#39;aminoAcid&#39;</span> --NB
</code></pre></div>

<p>As previously this command enables us to learn four parameters associated to negative binomial null noise model <code>--NB</code> for one individual in cohort produced in <a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0213684">Model to improve specificity for identification of clinically-relevant expanded T cells in peripheral blood, Rytlewski et al, PLOS ONE</a>. </p>

<h3 id="2-generate-synthetic-data-from-null-model-learning">2/ Generate synthetic data from null model learning:</h3>

<p>To qualitatively check consistency of NoisET first function (1) with experiments or for other reasons, it can be useful to generates synthetic replicates from the null model (described in Methods section).
One can also generalte healthy RepSeq samples dynamics using the noise model which has been learned in a first step anf giving the time-scale dynamics of turnover of the repertoire as defined in <a href="https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1">https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1</a>. Check <a href="https://github.com/statbiophys/NoisET/blob/master/NoisET%20example%20-%20Null%20model%20learning%20.ipynb">here</a>.  </p>

<p>To generate synthetic TCR RepSeq data replicates having chosen sampling noise characteristics, use the command <code>noiset-nullgenerator</code>
 <div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>noiset-nullgenerator --<span class="o">(</span>noise-model<span class="o">)</span> --nullpara <span class="s1">&#39;NULLPARAS&#39;</span> --NreadsI float --NreadsII float --Nclones float --output <span class="s1">&#39;SYNTHETICDATA&#39;</span> <br />
 </code></pre></div></p>

<h4 id="1-choice-of-noise-model">1/ Choice of noise model:</h4>

<p>The user must chose one of the three possible models for the probability that a TCR has <strong> an empirical count n </strong> knowing that its  <strong> true frequency is f </strong>, P(n|f): a Poisson distribution <code>--Poisson</code>, a negative binomial distribution <code>--NB</code>, or a two-step model combining Negative-Binomial and a Poisson distribution <code>--NBP</code>. n is the empirical clone size and  depends on the experimental protocol.
For each P(n|f), a set of parameters is learned.</p>

<ul>
<li><code>--NBPoisson</code>: Negative Binomial + Poisson Noise Model - 5 parameters 5 parameters described in <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2">Puelma Touzel et al, 2020</a>: power-law exponent of clonotypes frequencies distributions <code>'alph_rho'</code>, minimum of clonotype frequencies distribution <code>'fmin'</code>, <code>'beta'</code> and <code>'alpha'</code>, parameters of negative binomial distribution constraining mean and variance of P(m|f) distribution (m being the number of cells associated to a clonotype in the experiemental sample), and <code>'m_total'</code> the total number of cells in the sample of interest..</li>
<li><code>--NB</code>: Negative Binomial - 4 parameters: power-law of the clonotypes frequencies distributions (same ansatz than in <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2">Puelma Touzel et al, 2020</a> <code>'alph_rho'</code>, minimum of clonotype frequencies distribution <code>'fmin'</code>, <code>'beta'</code> and <code>'alpha'</code>, parameters of negative binomial distribution constraining mean and variance of P(n|f) distribution. <em> NB(fNreads, fNreads + betafNreads<sup>alpha</sup>) </em>. (Nreads is the total number of reads in the sample of interest.) </li>
<li><code>--Poisson</code>: Poisson - 2 parameters power-law of the clonotypes frequencies distributions (same ansatz than in <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2">Puelma Touzel et al, 2020</a><code>'alph_rho'</code> and minimum of clonotype frequencies distribution <code>'fmin'</code>. P(n|f) is a Poisson distribution of parameter <em> fNreads </em>. (Nreads is the total number of reads in the sample of interest.)</li>
</ul>

<h4 id="2-specify-learned-noise-parameters">2/ Specify learned noise parameters:</h4>

<ul>
<li><code>--nullpara 'PATHTOFOLDER/NULLPARAS.txt'</code>: parameters learned thanks to NoisET function (1) !!! Make sure to match correctly the noise model and the null parameter file content : 5 parameters for <code>--NBP</code>, 4 parameters for <code>--NB</code>and 2 parameters
for <code>--Poisson</code>. </li>
</ul>

<h4 id="3-sequencing-properties-of-data">3/ Sequencing properties of data:</h4>

<ul>
<li><code>--NreadsI NNNN</code>: total number  of reads in first replicate - it should match the actual data. In the example below, it is the sum of 'Clone count' in 'Q1_0_F1_.txt.gz'. </li>
<li><code>--Nreads2 NNNN</code>: total number  of reads in second replicate - it should match the actual data. In the example below, it is the sum of 'Clone count' in 'Q1_0_F2_.txt.gz'. </li>
<li><code>--Nclones NNNN</code>: total number of clones in union of two replicates - it should match the actual data. In the example below, it is the number of clones present in both replicates : 'Q1_0_F1_.txt.gz' and 'Q1_0_F2_.txt.gz'.</li>
</ul>

<h4 id="4-output-file">4/ Output file</h4>

<p><code>--output 'SYNTHETICDATA'</code>: name of the output file where you can find the synthetic data set. </p>

<p>At the command prompt, type 
 <div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>noiset-nullgenerator --NB --nullpara <span class="s1">&#39;data_examples/nullpara1.txt&#39;</span> --NreadsI <span class="m">829578</span> --NreadsII <span class="m">954389</span> --Nclones <span class="m">776247</span> --output <span class="s1">&#39;test&#39;</span> <br />
 </code></pre></div></p>

<p>Running this line, you create a 'synthetic_test.csv' file with four columns : 'Clone_count_1', 'Clone_count_2', 'Clone_fraction_1', 'Clone_fraction_2', resctively synthetic read counts and frequencies that you would have found in an experimental sample of same learned parameters 'nullpara1.txt', 'NreadsI', 'NreadsII' and 'Nclones'.</p>

<h3 id="3-detect-responding-clones">3/ Detect responding clones:</h3>

<p>Detects responding clones to a stimulus: NoisET second function (2)</p>

<p>To detect responding clones from two RepSeq data at time_1 and time_2, use the command <code>noiset-detection</code></p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>noiset-detection --<span class="o">(</span>noisemodel<span class="o">)</span>  --nullpara1 <span class="s1">&#39;FILEFORPARAS1&#39;</span> --nullpara2 <span class="s1">&#39;FILEFORPARAS1&#39;</span> --path <span class="s1">&#39;REPO/&#39;</span> --f1 <span class="s1">&#39;FILENAME_TIME_1&#39;</span> --f2 <span class="s1">&#39;FILENAME_TIME_2&#39;</span> --pval float --smedthresh float --output <span class="s1">&#39;DETECTIONDATA&#39;</span> 
</code></pre></div>

<p>Several options are needed to learn noise model from two replicate samples associated to one individual at a specific time point:</p>

<h4 id="1-choice-of-noise-model-2">1/ Choice of noise model:</h4>

<ul>
<li><code>--NBPoisson</code>: Negative Binomial + Poisson Noise Model - 5 parameters </li>
<li><code>--NB</code>: Negative Binomial - 4 parameters  </li>
<li><code>--Poisson</code>: Poisson - 2 parameters </li>
</ul>

<h4 id="2-specify-learned-parameters-for-both-time-points">2/ Specify learned parameters for both time points:</h4>

<p>(they can be the same for both time points if replicates are not available but to use carefully as mentioned in [ARTICLE]) </p>

<ul>
<li><code>--nullpara1 'PATH/FOLDER/NULLPARAS1.txt'</code>: parameters learned thanks to NoisET function (1) for time 1 </li>
<li><code>--nullpara2 'PATH/FOLDER/NULLPARAS2.txt'</code>: parameters learned thanks to NoisET function (1) for time 2  </li>
</ul>

<p>!!! Make sure to match correctly the noise model and the null parameters file content : 5 parameters for <code>--NBP</code>, 4 parameters for <code>--NB</code>and 2 parameters
for <code>--Poisson</code>. </p>

<h4 id="3-data-information">3/ Data information:</h4>

<ul>
<li><code>--path 'PATHTODATA'</code>: set path to data file </li>
<li><code>--f1 'FILENAME1_X_time1'</code>: filename for individual X time 1 </li>
<li><code>--f2 'FILENAME2_X_time2'</code>: filename for individual X time 2 </li>
</ul>

<p>If your TCR CDR3 clonal populations features (ie clonal fractions, clonal counts, clonal nucleotides CDR3 sequences and clonal amino acids sequences) have different column names than: ('Clone fraction', 'Clone count', 'N. Seq. CDR3', 'AA. Seq. CDR3), you can specify the name by using: </p>

<ul>
<li><code>--specify</code> </li>
<li><code>--freq 'frequency'</code> : Column label associated to clonal fraction </li>
<li><code>--counts 'counts'</code>:  Column label associated to clonal count  </li>
<li><code>--ntCDR3 'ntCDR3'</code>:  Column label associated to clonal CDR3 nucleotides sequence  </li>
<li><code>--AACDR3 'AACDR3'</code>:  Column label associated to clonal CDR3 amino acid sequence</li>
</ul>

<h4 id="4-detection-thresholds-more-details-in-methods-section">4/ Detection thresholds: (More details in Methods section).</h4>

<ul>
<li><code>--pval XXX</code> : p-value threshold for the expansion/contraction - use 0.05 as a default value. </li>
<li><code>--smedthresh XXX</code> : log fold change median threshold for the expansion/contraction - use 0 as a default value. </li>
</ul>

<h4 id="5-output-file">5/ Output file</h4>

<p><code>--output 'DETECTIONDATA'</code>: name of the output file (.csv) where you can find a list of the putative responding clones with statistics features. (More details in Methods section).</p>

<p>At the command prompt, type </p>

<div class="pdoc-code codehilite"><pre><span></span><code><span class="gp">$ </span>noiset-detection --NB  --nullpara1 <span class="s1">&#39;data_examples/nullpara1.txt&#39;</span> --nullpara2 <span class="s1">&#39;data_examples/nullpara1.txt&#39;</span> --path <span class="s1">&#39;data_examples/&#39;</span> --f1 <span class="s1">&#39;Q1_0_F1_.txt.gz&#39;</span> --f2 <span class="s1">&#39;Q1_15_F1_.txt.gz&#39;</span> --pval <span class="m">0</span>.05 --smedthresh <span class="m">0</span> --output <span class="s1">&#39;detection&#39;</span> 
</code></pre></div>

<p>Ouput: table containing all putative detected clones with statistics features about logfold-change variable <em> s </em>: more theoretical description <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2">Puelma Touzel et al, 2020</a>.</p>

<h2 id="python-package">B/ Python package</h2>
</div>

                        <input id="noisettes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="noisettes-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd"># NoisET&lt;sup&gt;*&lt;/sup&gt;  NOIse sampling learning &amp; Expansion detection of T-cell receptors using Bayesian inference.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">High-throughput sequencing of T- and B-cell receptors makes it possible to track immune</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">repertoires across time, in different tissues, in acute and chronic diseases or in healthy individuals. However</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">quantitative comparison between repertoires is confounded by variability in the read count of each receptor</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">clonotype due to sampling, library preparation, and expression noise. We present an easy-to-use python</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="sd">package NoisET that implements and generalizes a previously developed Bayesian method in [Puelma Touzel et al, 2020](&lt;https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2&gt;). It can be used</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="sd">to learn experimental noise models for repertoire sequencing from replicates, and to detect responding</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">clones following a stimulus. The package was tested on different repertoire sequencing technologies and</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="sd">datasets. NoisET package is desribed [here](&lt;https://arxiv.org/abs/2102.03568&gt;). </span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">&lt;sup&gt;* NoisET should be pronounced as &quot;noisettes&quot; (ie hazelnuts in French).&lt;/sup&gt;</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">Functions library for NoisET - construction of noisettes package</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">Copyright (C) 2021 Meriem Bensouda Koraichi. </span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">   This program is free software: you can redistribute it and/or modify</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">    it under the terms of the GNU General Public License as published by</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">    (at your option) any later version.</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">    This program is distributed in the hope that it will be useful,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">    GNU General Public License for more details.</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">    You should have received a copy of the GNU General Public License</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd"># Installation</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">Python 3 </span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">NoisET is a python /3.6 software. It is available on PyPI and can be downloaded and installed through pip:</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">```console</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">$ pip install noisets</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">```</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">Watch out, Data pre-processing, diversity estimates and generation of neutral TCR clonal dynamics is not possible yet with installation with pip. Use only the sudo command below.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">To install NoisET and try the tutorial dusplayed in this github: gitclone the file in your working environment. </span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">Using the terminal, go to NoisET directory and write the following command : </span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">```console</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">$ sudo python setup.py install</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">```</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">If you do not have the following python libraries (that are useful to use NoisET) : numpy, pandas, matplotlib, seaborn, scipy, scikit-learn, please do the following commands, to try first to install the dependencies separately: :</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd"> ```</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">python -m pip install -U pip</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">python -m pip install -U matplotlib</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">pip install numpy</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">pip install pandas</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">pip install matplotlib</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">pip install seaborn</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">pip install -U scikit-learn</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd"> ```</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd"># Documentation</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">## Command lines with terminal</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">A tutorial is available at https://github.com/mbensouda/NoisET_tutorial . </span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">Three commands are available to use :</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">- `noiset-noise` To infer Null noise model: NoisET first function (1)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">- `noiset-nullgenerator` To qualitatively check consistency of NoisET first function</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">- `noiset-detection` To detect responding clones to a stimulus: NoisET second function (2)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">All options are described typing one of the previous commands + `--help`or `-h`. Options are also described in the following READme.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">## 1/ Infer noise model </span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">To infer null noise model: NoisET first function (1), use the command `noiset-noise`</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">At the command prompt, type:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">```console</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">$ noiset-noise --path &#39;DATA_REPO/&#39; --f1 &#39;FILENAME1_X_REP1&#39; --f2 &#39;FILENAME2_X_REP2&#39; --(noisemodel)</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">```</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">Several options are needed to learn noise model from two replicate samples associated to one individual at a specific time point:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">#### 1/ Data information:</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">- `--path &#39;PATHTODATA&#39;`: set path to data file </span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">- `--f1 &#39;FILENAME1_X_REP1&#39;`: filename for individual X replicate 1 </span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">- `--f2 &#39;FILENAME2_X_REP2&#39;`: filename for individual X replicate 2 </span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">If your TCR CDR3 clonal populations features (ie clonal fractions, clonal counts, clonal nucleotide CDR3 sequences and clonal amino acid sequences) have different column names than: (&#39;Clone fraction&#39;, &#39;Clone count&#39;, &#39;N. Seq. CDR3&#39;, &#39;AA. Seq. CDR3), you can specify the name directly by using: </span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">- `--specify` </span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">- `--freq &#39;frequency&#39;` : Column label associated to clonal fraction </span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">- `--counts &#39;counts&#39;`:  Column label associated to clonal count  </span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">- `--ntCDR3 &#39;ntCDR3&#39;`:  Column label associated to clonal CDR3 nucleotides sequence  </span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">- `--AACDR3 &#39;AACDR3&#39;`:  Column label associated to clonal CDR3 amino acid sequence</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">#### 2/ Choice of noise model: (parameters meaning described in Methods section)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">- `--NBPoisson`: Negative Binomial + Poisson Noise Model - 5 parameters </span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">- `--NB`: Negative Binomial - 4 parameters  </span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">- `--Poisson`: Poisson - 2 parameters </span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">#### 3/ Example:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">At the command prompt, type:</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">```console</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">$ noiset-noise --path &#39;data_examples/&#39; --f1 &#39;Q1_0_F1_.txt.gz&#39; --f2 &#39;Q1_0_F2_.txt.gz&#39; --NB</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">```</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">This command line will learn four parameters associated to negative binomial null noise Model `--NB` for individual Q1 at day 0.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">A &#39;.txt&#39; file is created in the working directory: it is a 5/4/2 parameters data-set regarding on NBP/NB/Poisson noise model. In this example, it is a four parameters table (already created in data_examples repository). </span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">You can run previous examples using data (Q1 day 0/ day15) provided in the data_examples folder - data from [Precise tracking of vaccine-responding T cell clones reveals convergent and personalized response in identical twins, Pogorelyy et al, PNAS](https://www.pnas.org/content/115/50/12704) </span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">#### 4/ Example with `--specify`:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">At the command prompt, type:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">```console</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">$ noiset-noise --path &#39;data_examples/&#39; --f1 &#39;replicate_1_1.tsv.gz&#39; --f2 &#39;replicate_1_2.tsv.gz&#39; --specify --freq &#39;frequencyCount&#39; --counts &#39;count&#39; --ntCDR3 &#39;nucleotide&#39; --AACDR3 &#39;aminoAcid&#39; --NB</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">```</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">As previously this command enables us to learn four parameters associated to negative binomial null noise model `--NB` for one individual in cohort produced in [Model to improve specificity for identification of clinically-relevant expanded T cells in peripheral blood, Rytlewski et al, PLOS ONE](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0213684). </span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">## 2/ Generate synthetic data from null model learning:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">To qualitatively check consistency of NoisET first function (1) with experiments or for other reasons, it can be useful to generates synthetic replicates from the null model (described in Methods section).</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">One can also generalte healthy RepSeq samples dynamics using the noise model which has been learned in a first step anf giving the time-scale dynamics of turnover of the repertoire as defined in https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. Check [here](&lt;https://github.com/statbiophys/NoisET/blob/master/NoisET%20example%20-%20Null%20model%20learning%20.ipynb&gt;).  </span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">To generate synthetic TCR RepSeq data replicates having chosen sampling noise characteristics, use the command `noiset-nullgenerator`</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd"> ```console</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd"> $ noiset-nullgenerator --(noise-model) --nullpara &#39;NULLPARAS&#39; --NreadsI float --NreadsII float --Nclones float --output &#39;SYNTHETICDATA&#39;  </span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd"> ```</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">#### 1/ Choice of noise model:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">The user must chose one of the three possible models for the probability that a TCR has &lt;strong&gt; an empirical count n &lt;/strong&gt; knowing that its  &lt;strong&gt; true frequency is f &lt;/strong&gt;, P(n|f): a Poisson distribution `--Poisson`, a negative binomial distribution `--NB`, or a two-step model combining Negative-Binomial and a Poisson distribution `--NBP`. n is the empirical clone size and  depends on the experimental protocol.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">For each P(n|f), a set of parameters is learned.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">- `--NBPoisson`: Negative Binomial + Poisson Noise Model - 5 parameters 5 parameters described in [Puelma Touzel et al, 2020](&lt;https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2&gt;): power-law exponent of clonotypes frequencies distributions `&#39;alph_rho&#39;`, minimum of clonotype frequencies distribution `&#39;fmin&#39;`, `&#39;beta&#39;` and `&#39;alpha&#39;`, parameters of negative binomial distribution constraining mean and variance of P(m|f) distribution (m being the number of cells associated to a clonotype in the experiemental sample), and `&#39;m_total&#39;` the total number of cells in the sample of interest..</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">- `--NB`: Negative Binomial - 4 parameters: power-law of the clonotypes frequencies distributions (same ansatz than in [Puelma Touzel et al, 2020](&lt;https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2&gt;) `&#39;alph_rho&#39;`, minimum of clonotype frequencies distribution `&#39;fmin&#39;`, `&#39;beta&#39;` and `&#39;alpha&#39;`, parameters of negative binomial distribution constraining mean and variance of P(n|f) distribution. &lt;em&gt; NB(fNreads, fNreads + betafNreads&lt;sup&gt;alpha&lt;/sup&gt;) &lt;/em&gt;. (Nreads is the total number of reads in the sample of interest.) </span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">- `--Poisson`: Poisson - 2 parameters power-law of the clonotypes frequencies distributions (same ansatz than in [Puelma Touzel et al, 2020](&lt;https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2&gt;)`&#39;alph_rho&#39;` and minimum of clonotype frequencies distribution `&#39;fmin&#39;`. P(n|f) is a Poisson distribution of parameter &lt;em&gt; fNreads &lt;/em&gt;. (Nreads is the total number of reads in the sample of interest.)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">#### 2/ Specify learned noise parameters:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">- `--nullpara &#39;PATHTOFOLDER/NULLPARAS.txt&#39;`: parameters learned thanks to NoisET function (1) \</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">!!! Make sure to match correctly the noise model and the null parameter file content : 5 parameters for `--NBP`, 4 parameters for `--NB`and 2 parameters</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">for `--Poisson`. </span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">#### 3/ Sequencing properties of data:</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">- `--NreadsI NNNN`: total number  of reads in first replicate - it should match the actual data. In the example below, it is the sum of &#39;Clone count&#39; in &#39;Q1_0_F1_.txt.gz&#39;. </span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">- `--Nreads2 NNNN`: total number  of reads in second replicate - it should match the actual data. In the example below, it is the sum of &#39;Clone count&#39; in &#39;Q1_0_F2_.txt.gz&#39;. </span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">- `--Nclones NNNN`: total number of clones in union of two replicates - it should match the actual data. In the example below, it is the number of clones present in both replicates : &#39;Q1_0_F1_.txt.gz&#39; and &#39;Q1_0_F2_.txt.gz&#39;.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">#### 4/ Output file</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">`--output &#39;SYNTHETICDATA&#39;`: name of the output file where you can find the synthetic data set. </span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">At the command prompt, type </span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd"> ```console</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd"> $ noiset-nullgenerator --NB --nullpara &#39;data_examples/nullpara1.txt&#39; --NreadsI 829578 --NreadsII 954389 --Nclones 776247 --output &#39;test&#39;  </span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd"> ```</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd"> Running this line, you create a &#39;synthetic_test.csv&#39; file with four columns : &#39;Clone_count_1&#39;, &#39;Clone_count_2&#39;, &#39;Clone_fraction_1&#39;, &#39;Clone_fraction_2&#39;, resctively synthetic read counts and frequencies that you would have found in an experimental sample of same learned parameters &#39;nullpara1.txt&#39;, &#39;NreadsI&#39;, &#39;NreadsII&#39; and &#39;Nclones&#39;.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">## 3/ Detect responding clones:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd"> </span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">Detects responding clones to a stimulus: NoisET second function (2)</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">To detect responding clones from two RepSeq data at time_1 and time_2, use the command `noiset-detection`</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">```console</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">$ noiset-detection --(noisemodel)  --nullpara1 &#39;FILEFORPARAS1&#39; --nullpara2 &#39;FILEFORPARAS1&#39; --path &#39;REPO/&#39; --f1 &#39;FILENAME_TIME_1&#39; --f2 &#39;FILENAME_TIME_2&#39; --pval float --smedthresh float --output &#39;DETECTIONDATA&#39; </span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">```</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">Several options are needed to learn noise model from two replicate samples associated to one individual at a specific time point:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">#### 1/ Choice of noise model:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">- `--NBPoisson`: Negative Binomial + Poisson Noise Model - 5 parameters </span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">- `--NB`: Negative Binomial - 4 parameters  </span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">- `--Poisson`: Poisson - 2 parameters </span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">#### 2/ Specify learned parameters for both time points:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">(they can be the same for both time points if replicates are not available but to use carefully as mentioned in [ARTICLE]) </span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">- `--nullpara1 &#39;PATH/FOLDER/NULLPARAS1.txt&#39;`: parameters learned thanks to NoisET function (1) for time 1 </span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">- `--nullpara2 &#39;PATH/FOLDER/NULLPARAS2.txt&#39;`: parameters learned thanks to NoisET function (1) for time 2  </span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">!!! Make sure to match correctly the noise model and the null parameters file content : 5 parameters for `--NBP`, 4 parameters for `--NB`and 2 parameters</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">for `--Poisson`. </span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">#### 3/ Data information:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">- `--path &#39;PATHTODATA&#39;`: set path to data file </span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">- `--f1 &#39;FILENAME1_X_time1&#39;`: filename for individual X time 1 </span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">- `--f2 &#39;FILENAME2_X_time2&#39;`: filename for individual X time 2 </span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">If your TCR CDR3 clonal populations features (ie clonal fractions, clonal counts, clonal nucleotides CDR3 sequences and clonal amino acids sequences) have different column names than: (&#39;Clone fraction&#39;, &#39;Clone count&#39;, &#39;N. Seq. CDR3&#39;, &#39;AA. Seq. CDR3), you can specify the name by using: </span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">- `--specify` </span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">- `--freq &#39;frequency&#39;` : Column label associated to clonal fraction </span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">- `--counts &#39;counts&#39;`:  Column label associated to clonal count  </span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">- `--ntCDR3 &#39;ntCDR3&#39;`:  Column label associated to clonal CDR3 nucleotides sequence  </span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">- `--AACDR3 &#39;AACDR3&#39;`:  Column label associated to clonal CDR3 amino acid sequence</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">#### 4/ Detection thresholds: (More details in Methods section).</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">- `--pval XXX` : p-value threshold for the expansion/contraction - use 0.05 as a default value. </span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">- `--smedthresh XXX` : log fold change median threshold for the expansion/contraction - use 0 as a default value. </span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">#### 5/ Output file</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">`--output &#39;DETECTIONDATA&#39;`: name of the output file (.csv) where you can find a list of the putative responding clones with statistics features. (More details in Methods section).</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">At the command prompt, type </span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">```console</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">$ noiset-detection --NB  --nullpara1 &#39;data_examples/nullpara1.txt&#39; --nullpara2 &#39;data_examples/nullpara1.txt&#39; --path &#39;data_examples/&#39; --f1 &#39;Q1_0_F1_.txt.gz&#39; --f2 &#39;Q1_15_F1_.txt.gz&#39; --pval 0.05 --smedthresh 0 --output &#39;detection&#39; </span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">```</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">Ouput: table containing all putative detected clones with statistics features about logfold-change variable &lt;em&gt; s &lt;/em&gt;: more theoretical description [Puelma Touzel et al, 2020](&lt;https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1007873&amp;rev=2&gt;).</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">## Python package</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="c1"># Import python libraries</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">colorbar</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nbinom</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">poisson</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">rv_discrete</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="c1">#tools for PCA</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a><span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">AgglomerativeClustering</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="c1">#tools to generate RepSeq traj</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="kn">import</span> <span class="nn">shutil</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="c1">###===================================TOOLS-TO-GENERATE-NEUTRAL-TCR-REP-SEQ-TRAJECTORIES=====================================================</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="c1">#  Library functions to generate TCR repertoires</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="c1">##------------------------Initial-Distributions------------------------</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="k">def</span> <span class="nf">_rho_counts_theo_minus_x</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">N_0</span><span class="p">):</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>    
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>    <span class="c1"># this function is not made for a NoisET user </span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>    <span class="c1"># I am disretizing the logspace with nfbins = 100000</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>    
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>    <span class="n">Cmin</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>    <span class="n">freq_dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>    <span class="n">N_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>    <span class="n">S_c</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">A</span><span class="o">+</span><span class="n">B</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">N_cells</span><span class="o">/</span><span class="p">(</span><span class="n">N_0</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>    
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">/</span><span class="n">B</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>    
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>    <span class="n">nbins_1</span> <span class="o">=</span> <span class="mi">100000</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>    
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>    <span class="n">logcountvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Cmin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">N_0</span><span class="p">),</span> <span class="n">nbins_1</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>    <span class="n">log_countvec_minus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">logcountvec</span><span class="p">))</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> 
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>    <span class="n">log_rho_minus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">S_c</span><span class="o">/</span><span class="n">A</span><span class="p">))</span><span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="o">*</span><span class="n">log_countvec_minus</span><span class="p">))</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>    
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>    <span class="n">N_clones_1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">S_c</span><span class="o">/</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N_0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">N_0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)))</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>    
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>    
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>    <span class="k">return</span> <span class="n">log_rho_minus</span><span class="p">,</span> <span class="n">log_countvec_minus</span><span class="p">,</span> <span class="n">N_clones_1</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="k">def</span> <span class="nf">_rho_counts_theo_plus_x</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">N_0</span><span class="p">):</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>    <span class="c1"># this function is not made for a NoisET user </span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>    <span class="c1"># I am disretizing the logspace with nfbins = 100000, I can put a better discretization than for the minus</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>    <span class="c1"># distribution</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>    
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>    <span class="n">Cmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>    <span class="c1">#Cmax = np.inf</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>    <span class="n">freq_dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>    <span class="n">N_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>    <span class="n">S_c</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">A</span><span class="o">+</span><span class="n">B</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">N_cells</span><span class="o">/</span><span class="p">(</span><span class="n">N_0</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>    
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">/</span><span class="n">B</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>    
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>    <span class="n">nbins_2</span> <span class="o">=</span> <span class="mi">100000</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>    
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>    <span class="n">logcountvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">N_0</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Cmax</span><span class="p">),</span> <span class="n">nbins_2</span> <span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>    <span class="n">log_countvec_plus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">logcountvec</span><span class="p">))</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> 
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>    <span class="n">log_rho_plus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N_0</span><span class="o">**</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">S_c</span><span class="o">/</span><span class="n">A</span><span class="p">))</span> <span class="o">-</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">log_countvec_plus</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>    
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>    <span class="n">N_clones_2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">S_c</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">alpha</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">N_0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">))</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>    
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>    <span class="k">return</span> <span class="n">log_rho_plus</span><span class="p">,</span> <span class="n">log_countvec_plus</span><span class="p">,</span> <span class="n">N_clones_2</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="k">def</span> <span class="nf">_get_distsample</span><span class="p">(</span><span class="n">pmf</span><span class="p">,</span><span class="n">Nsamp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint32&#39;</span><span class="p">):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>    <span class="c1"># this function is not made for a NoisET user </span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>    <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="sd">    generates Nsamp index samples of dtype (e.g. uint16 handles up to 65535 indices) from discrete probability mass function pmf.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">    Handles multi-dimensional domain. N.B. Output is sorted.</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">    &#39;&#39;&#39;</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>    <span class="c1">#assert np.sum(pmf)==1, &quot;cmf not normalized!&quot;</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>    
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>    <span class="n">sortindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pmf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="c1">#uses flattened array</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>    <span class="n">pmf</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>    <span class="n">pmf</span> <span class="o">=</span> <span class="n">pmf</span><span class="p">[</span><span class="n">sortindex</span><span class="p">]</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>    <span class="n">cmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>   <span class="c1">#print(&#39;cumulative distribution is equal to: &#39; + str(cmf[-1]))</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>    <span class="n">choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">high</span> <span class="o">=</span> <span class="n">cmf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">)))</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cmf</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>    <span class="n">index</span> <span class="o">=</span> <span class="n">sortindex</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>    <span class="n">sampled_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">index</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>    <span class="k">return</span> <span class="n">sampled_inds</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="c1">##------------------------Propagator------------------------</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="k">def</span> <span class="nf">_gaussian_matrix</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">x_i_vec_unique</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>    <span class="n">x_vec_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>    <span class="n">ones_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_i_vec_unique</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ones_vec</span><span class="p">,</span> <span class="n">x_vec_reshaped</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>    <span class="n">x_i_unique_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_i_vec_unique</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_i_vec_unique</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>    
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">t</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">x_i_unique_reshaped</span> <span class="o">-</span> <span class="n">A</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="k">def</span> <span class="nf">_gaussian_adsorption_matrix</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">x_i_vec_unique</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>    <span class="n">gauss</span> <span class="o">=</span> <span class="n">_gaussian_matrix</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">x_i_vec_unique</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>    <span class="n">gauss_a</span> <span class="o">=</span> <span class="n">_gaussian_matrix</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">-</span><span class="n">x_i_vec_unique</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>    <span class="n">x_i_unique_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_i_vec_unique</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_i_vec_unique</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>    <span class="k">return</span> <span class="n">gauss</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">A</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">x_i_unique_reshaped</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">B</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">gauss_a</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="k">def</span> <span class="nf">_extinction_vector</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> 
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>    <span class="n">nbins</span> <span class="o">=</span> <span class="mi">2000</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-20</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>    <span class="c1">#eps = 0</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>    <span class="n">x_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">nbins</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>    
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>    <span class="n">x_i_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>    
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>    <span class="n">xiind_vals</span><span class="p">,</span> <span class="n">xi_start_ind</span><span class="p">,</span> <span class="n">xi_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x_i_sorted</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>    <span class="n">Prop_Matrix</span> <span class="o">=</span> <span class="n">_gaussian_adsorption_matrix</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">xiind_vals</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>    
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>    <span class="n">dx</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>    <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="p">(</span><span class="n">Prop_Matrix</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">Prop_Matrix</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>    <span class="n">p_ext</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">integ</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>    
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>    <span class="n">p_ext_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_i</span><span class="p">)))</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>    <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">xiind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xiind_vals</span><span class="p">):</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>        <span class="n">p_ext_new</span><span class="p">[</span><span class="n">xi_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">xi_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">xi_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p_ext</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>    <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_ext_new</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="n">p_ext_new</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>    <span class="n">results_extinction</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>    
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>    <span class="k">return</span> <span class="n">results_extinction</span><span class="p">,</span> <span class="n">Prop_Matrix</span><span class="p">,</span> <span class="n">x_vec</span><span class="p">,</span> <span class="n">xiind_vals</span><span class="p">,</span> <span class="n">xi_start_ind</span><span class="p">,</span> <span class="n">xi_counts</span><span class="p">,</span> <span class="n">p_ext</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="c1">#------------------------Source-term-no-frequency-dependency------------------------</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="k">def</span> <span class="nf">_gaussian_matrix_time</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">x_i_scal</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">tvec_unique</span><span class="p">):</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>    
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="n">x_vec_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_vec</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>    <span class="n">ones_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tvec_unique</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ones_vec</span><span class="p">,</span> <span class="n">x_vec_reshaped</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>    <span class="n">tvec_unique_reshaped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tvec_unique</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tvec_unique</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>    <span class="c1">#x_i_unique_reshaped = np.reshape(x_i_vec_unique, (len(x_i_vec_unique), 1))</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>    
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">tvec_unique_reshaped</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">tvec_unique_reshaped</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="n">x_i_scal</span> <span class="o">-</span> <span class="n">A</span><span class="o">*</span><span class="n">tvec_unique_reshaped</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="k">def</span> <span class="nf">_gaussian_adsorption_matrix_time</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">x_i_scal</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">tvec_unique</span><span class="p">):</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>    
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>    <span class="n">gauss</span> <span class="o">=</span> <span class="n">_gaussian_matrix_time</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">x_i_scal</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">tvec_unique</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>    <span class="n">gauss_a</span> <span class="o">=</span> <span class="n">_gaussian_matrix_time</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">-</span><span class="n">x_i_scal</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">tvec_unique</span><span class="p">)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>    
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>    <span class="k">return</span> <span class="n">gauss</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">A</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">x_i_scal</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">B</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">gauss_a</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="k">def</span> <span class="nf">_Prop_Matrix_source</span><span class="p">(</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">tvec</span><span class="p">):</span> 
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>    
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>    <span class="n">nbins</span> <span class="o">=</span> <span class="mi">2000</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>    <span class="n">N_0</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>    <span class="n">x_i_scal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N_0</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>    <span class="n">x_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_i_scal</span> <span class="o">-</span> <span class="n">A</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">nbins</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>    
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>    <span class="n">tvec_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>    
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>    <span class="n">tiind_vals</span><span class="p">,</span> <span class="n">ti_start_ind</span><span class="p">,</span> <span class="n">ti_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tvec_sorted</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>    <span class="n">Prop_Matrix</span> <span class="o">=</span> <span class="n">_gaussian_adsorption_matrix_time</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">x_i_scal</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">tiind_vals</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>    
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>    <span class="n">dx</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>    <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="p">(</span><span class="n">Prop_Matrix</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">Prop_Matrix</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>    
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>    <span class="k">return</span> <span class="n">Prop_Matrix</span><span class="p">,</span> <span class="n">x_vec</span><span class="p">,</span> <span class="n">tiind_vals</span><span class="p">,</span> <span class="n">ti_start_ind</span><span class="p">,</span> <span class="n">ti_counts</span><span class="p">,</span> <span class="n">integ</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="k">def</span> <span class="nf">_extinction_vector_source</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">tvec</span><span class="p">):</span> 
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>    
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>    <span class="n">nbins</span> <span class="o">=</span> <span class="mi">2000</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>    <span class="n">N_0</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>    <span class="n">x_i_scal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N_0</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>    <span class="n">x_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_i_scal</span> <span class="o">-</span> <span class="n">A</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="n">nbins</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>    
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>    <span class="n">tvec_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>    
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>    <span class="n">tiind_vals</span><span class="p">,</span> <span class="n">ti_start_ind</span><span class="p">,</span> <span class="n">ti_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tvec_sorted</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>    <span class="n">Prop_Matrix</span> <span class="o">=</span> <span class="n">_gaussian_adsorption_matrix_time</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">x_i_scal</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">tiind_vals</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>    
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>    <span class="n">dx</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>    <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="p">(</span><span class="n">Prop_Matrix</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">Prop_Matrix</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>    <span class="n">p_ext</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">integ</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>    
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>    <span class="n">p_ext_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">tvec</span><span class="p">)))</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>    <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">tiind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tiind_vals</span><span class="p">):</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="n">p_ext_new</span><span class="p">[</span><span class="n">ti_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">ti_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">ti_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p_ext</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>    <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_ext_new</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="n">p_ext_new</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>    <span class="n">results_extinction</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>    
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>    <span class="k">return</span> <span class="n">results_extinction</span><span class="p">,</span> <span class="n">Prop_Matrix</span><span class="p">,</span> <span class="n">x_vec</span><span class="p">,</span> <span class="n">tiind_vals</span><span class="p">,</span> <span class="n">ti_start_ind</span><span class="p">,</span> <span class="n">ti_counts</span><span class="p">,</span> <span class="n">p_ext</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="c1">##------------------------Function-to-generate-in-silico-Rep-Seq-samples------------------------</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="k">def</span> <span class="nf">_generator_diffusion_LB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">N_0</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>    
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>    
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-20</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>    
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>    <span class="c1">## Choose initial size of the immune system to be 1e10 (for a mouse)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>    <span class="n">N_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>    
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>    <span class="c1">#Parameters for the repertoire generation</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>    <span class="n">alpha_rho</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">/</span><span class="n">B</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>    <span class="n">N_ext</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>    <span class="n">freq_dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span> 
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>    
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>    <span class="c1">#==========================generate the steady state distribution===============================</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>    
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>    <span class="c1">#for counts &lt; N0: </span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>    <span class="n">logrhofvec</span><span class="p">,</span><span class="n">logfvec</span><span class="p">,</span> <span class="n">N_clones_1</span> <span class="o">=</span> <span class="n">_rho_counts_theo_minus_x</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">N_0</span><span class="p">)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>    <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>    <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>    <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">dlogfby2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">N_clones_1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>    <span class="c1">#print(&quot;generation population smaller than N_0: check&quot;)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>    
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>    <span class="n">logcvec_generated</span> <span class="o">=</span> <span class="n">logfvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>    <span class="n">counts_generated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logcvec_generated</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>    <span class="n">C_f_minus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts_generated</span><span class="p">)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">C_f_minus</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; cells smaller than N_0&#39;</span><span class="p">)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>    <span class="n">log_cminus_generated</span> <span class="o">=</span> <span class="n">logcvec_generated</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>    <span class="n">logrhofvec_1</span><span class="p">,</span><span class="n">logfvec_1</span> <span class="o">=</span> <span class="n">logrhofvec</span><span class="p">,</span><span class="n">logfvec</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">N_clones_1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; N_clones_1&#39;</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>    
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>    <span class="c1">#for counts &gt; N0:</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>    
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>    <span class="n">logrhofvec</span><span class="p">,</span><span class="n">logfvec</span><span class="p">,</span> <span class="n">N_clones_2</span> <span class="o">=</span> <span class="n">_rho_counts_theo_plus_x</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">N_0</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>    <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>    <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>    <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">dlogfby2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span><span class="n">N_clones_2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>    <span class="c1">#print(&quot;generation population larger than N_0: check&quot;)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>    <span class="n">logcvec_generated</span> <span class="o">=</span> <span class="n">logfvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>    <span class="n">counts_generated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logcvec_generated</span><span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>    <span class="n">C_f_plus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts_generated</span><span class="p">)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">C_f_plus</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; N_cells larger than N_0&#39;</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>    <span class="n">log_cplus_generated</span> <span class="o">=</span> <span class="n">logcvec_generated</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>    <span class="n">logrhofvec_2</span><span class="p">,</span><span class="n">logfvec_2</span> <span class="o">=</span> <span class="n">logrhofvec</span><span class="p">,</span><span class="n">logfvec</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">N_clones_2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; N_clones_2&#39;</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>    
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>    <span class="c1">#===================================================</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>    
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>    <span class="n">N_clones</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_clones_1</span> <span class="o">+</span> <span class="n">N_clones_2</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;N_clones= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_clones</span><span class="p">))</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>    <span class="n">S_c</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="n">B</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">N_cells</span><span class="o">/</span><span class="p">(</span><span class="n">N_0</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;N_clones_theory= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">S_c</span><span class="o">/</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N_0</span><span class="p">)))</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>    
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>    
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>    <span class="n">x_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">log_cminus_generated</span><span class="p">,</span> <span class="n">log_cplus_generated</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>    
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>    <span class="n">N_total_cells_generated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_i</span><span class="p">))</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;N_total_cells_generated/N_total_cells:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_total_cells_generated</span><span class="o">/</span><span class="n">N_cells</span><span class="p">))</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>    
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>    
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>    
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>    <span class="n">results_extinction</span><span class="p">,</span> <span class="n">Prop_Matrix</span><span class="p">,</span> <span class="n">x_vec</span><span class="p">,</span> <span class="n">xiind_vals</span><span class="p">,</span> <span class="n">xi_start_ind</span><span class="p">,</span> <span class="n">xi_counts</span><span class="p">,</span> <span class="n">p_ext</span> <span class="o">=</span> <span class="n">_extinction_vector</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>    <span class="c1">#x_vec = np.linspace(0, 30*B*t, 2000)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>    <span class="n">dx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_vec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>    
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>    <span class="n">x_i_noext</span><span class="o">=</span> <span class="n">x_i</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">results_extinction</span> <span class="o">==</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>    <span class="n">x_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_i</span><span class="p">)))</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>    
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xiind_vals</span><span class="p">)):</span> 
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">Prop_Matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">Prop_Matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">1e-7</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>            <span class="k">pass</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="n">Prop_adsorp</span> <span class="o">=</span> <span class="n">Prop_Matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">Prop_Matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">Prop_Matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="n">integ</span> <span class="o">=</span> <span class="n">Prop_adsorp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="n">f_samples_inds</span> <span class="o">=</span> <span class="n">_get_distsample</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">dx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">xi_counts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="n">x_f</span><span class="p">[</span><span class="n">xi_start_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">xi_start_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">xi_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x_vec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>    
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>    <span class="n">x_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">x_f</span><span class="p">,</span><span class="n">results_extinction</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>    
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>    <span class="n">x_f</span><span class="p">[</span><span class="n">x_f</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>    
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>    <span class="n">N_extinction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span> <span class="n">results_extinction</span><span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>    <span class="n">N_extinction</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_f</span><span class="p">[</span><span class="n">x_f</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>    
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of extinction= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_extinction</span><span class="p">))</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>    <span class="n">sim_ext</span> <span class="o">=</span> <span class="p">(</span><span class="n">N_extinction</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">results_extinction</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>    <span class="n">theo_ext</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N_0</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;simulations </span><span class="si">% o</span><span class="s1">f extinction= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">N_extinction</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">results_extinction</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;theoretical </span><span class="si">% o</span><span class="s1">f extinction= &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="o">-</span><span class="n">A</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N_0</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>    <span class="c1">#Source term</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>    <span class="n">N_source</span> <span class="o">=</span> <span class="n">S_c</span><span class="o">*</span><span class="n">t</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of insertions= &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N_source</span><span class="p">))</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>    <span class="n">N_source</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_source</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-8</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>    <span class="n">time_vec_span</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>    <span class="n">time_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">time_vec_span</span><span class="p">,</span> <span class="n">N_source</span><span class="p">)</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>    <span class="n">time_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">time_vec</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>    
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>    <span class="n">results_extinction_source</span><span class="p">,</span> <span class="n">Prop_Matrix_source</span><span class="p">,</span> <span class="n">x_vec_source</span><span class="p">,</span> <span class="n">tiind_vals</span><span class="p">,</span> <span class="n">ti_start_ind</span><span class="p">,</span> <span class="n">ti_counts</span><span class="p">,</span> <span class="n">p_ext_source</span> <span class="o">=</span> <span class="n">_extinction_vector_source</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">time_vec</span><span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>    <span class="n">dx_source</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_vec_source</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>    <span class="n">x_source_LB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_source</span><span class="p">))</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiind_vals</span><span class="p">)):</span> 
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dx_source</span><span class="p">,</span> <span class="n">Prop_Matrix_source</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">Prop_Matrix_source</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">1e-7</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>            <span class="k">pass</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>            <span class="n">Prop_adsorp_s</span> <span class="o">=</span> <span class="n">Prop_Matrix_source</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>            <span class="n">Prop_adsorp_s</span> <span class="o">=</span> <span class="n">Prop_Matrix_source</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dx_source</span><span class="p">,</span> <span class="n">Prop_Matrix_source</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">Prop_Matrix_source</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="n">integ</span> <span class="o">=</span> <span class="n">Prop_adsorp_s</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>            <span class="n">f_samples_inds_s</span> <span class="o">=</span> <span class="n">_get_distsample</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">dx_source</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">),</span> <span class="n">ti_counts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>            <span class="n">x_source_LB</span><span class="p">[</span><span class="n">ti_start_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">ti_start_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">ti_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x_vec_source</span><span class="p">[</span><span class="n">f_samples_inds_s</span><span class="p">]</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>            
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>        
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>    <span class="n">x_source_LB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">x_source_LB</span><span class="p">,</span> <span class="n">results_extinction_source</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>    
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>    <span class="n">x_source_LB</span><span class="p">[</span><span class="n">x_source_LB</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>    
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>    <span class="k">return</span> <span class="n">x_i</span><span class="p">,</span> <span class="n">x_f</span><span class="p">,</span> <span class="n">Prop_Matrix</span><span class="p">,</span> <span class="n">p_ext</span><span class="p">,</span> <span class="n">results_extinction</span><span class="p">,</span> <span class="n">time_vec</span><span class="p">,</span> <span class="n">results_extinction_source</span><span class="p">,</span> <span class="n">x_source_LB</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="k">def</span> <span class="nf">_experimental_sampling_diffusion_Poisson</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">x_2</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">N_cell_0</span><span class="p">,</span> <span class="n">N_cell_2</span><span class="p">):</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>    <span class="c1"># This function has been made to generate TCR clonal frequencies distribution from the theoretical model described in the paper </span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>    <span class="c1"># https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1. </span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>    <span class="c1"># this function is not made for a NoisET user</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>    
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>    
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>    <span class="c1">#----------------------------Counts generation --------------------------------------------</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>    
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>    <span class="c1">##Initial condition</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>    <span class="n">N_total_0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_0</span><span class="p">[</span><span class="n">x_0</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>    <span class="n">x_0_bis</span> <span class="o">=</span> <span class="n">x_0</span><span class="p">[</span><span class="n">x_0</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>    
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of clones at initial time &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_total_0</span><span class="p">))</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>    
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>    <span class="n">N_total_2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_2</span><span class="p">[</span><span class="n">x_2</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>    <span class="n">x_2_bis</span> <span class="o">=</span> <span class="n">x_2</span><span class="p">[</span><span class="n">x_2</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>    
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>    
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of clones after &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; year(s) &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">N_total_2</span><span class="p">))</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>    
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>    <span class="c1">#N_total = min(N_total_0, N_total_2)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_2</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>    <span class="n">N_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>    
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>    <span class="n">x_2_final</span> <span class="o">=</span> <span class="n">x_2</span><span class="p">[:</span><span class="n">N_total</span><span class="p">]</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>    
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>    <span class="n">f_vec_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span><span class="o">/</span><span class="n">N_cell_0</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>    <span class="n">m</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">)</span><span class="o">*</span><span class="n">f_vec_initial</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>    <span class="n">n_counts_day_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_total</span><span class="p">)))</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>    <span class="n">n_counts_day_0</span> <span class="o">=</span> <span class="n">n_counts_day_0</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>    
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>    <span class="c1">#print(&#39;done&#39;)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>    
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>    <span class="c1">#Final condition</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>    <span class="n">f_vec_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_2_final</span><span class="p">)</span><span class="o">/</span><span class="n">N_cell_2</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>    <span class="n">m</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">NreadsII</span><span class="p">)</span><span class="o">*</span><span class="n">f_vec_end</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>    <span class="c1">#print(m)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MEAN N : &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>    <span class="n">n_counts_day_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_total</span><span class="p">)))</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">n_counts_day_1</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>    <span class="n">n_counts_day_1</span> <span class="o">=</span> <span class="n">n_counts_day_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>    
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>    <span class="c1">#-------------------------------Creation of the data set-------------------------------------</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>    
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>    <span class="n">obs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">n_counts_day_0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_counts_day_1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>    <span class="n">n1_samples</span><span class="o">=</span><span class="n">n_counts_day_0</span><span class="p">[</span><span class="n">obs</span><span class="p">]</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>    <span class="n">n2_samples</span><span class="o">=</span><span class="n">n_counts_day_1</span><span class="p">[</span><span class="n">obs</span><span class="p">]</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>    <span class="n">pair_samples_df</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">:</span><span class="n">n1_samples</span><span class="p">,</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">:</span><span class="n">n2_samples</span><span class="p">})</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>    
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>    <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_frequency_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>    <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_frequency_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>    
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>    
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>    <span class="k">return</span> <span class="n">pair_samples_df</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="k">def</span> <span class="nf">_experimental_sampling_diffusion_NegBin</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">x_2</span><span class="p">,</span> <span class="n">N_cell_0</span><span class="p">,</span> <span class="n">N_cell_2</span><span class="p">):</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>    
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>    
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>    <span class="c1">#----------------------------Counts generation --------------------------------------------</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>    
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>    <span class="c1">##Initial condition</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>    <span class="n">N_total_0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_0</span><span class="p">[</span><span class="n">x_0</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>    <span class="n">x_0_bis</span> <span class="o">=</span> <span class="n">x_0</span><span class="p">[</span><span class="n">x_0</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>    
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of clones at initial time &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_total_0</span><span class="p">))</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>    
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>    <span class="n">N_total_2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_2</span><span class="p">[</span><span class="n">x_2</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>    <span class="n">x_2_bis</span> <span class="o">=</span> <span class="n">x_2</span><span class="p">[</span><span class="n">x_2</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>    
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of clones after 2 years &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_total_2</span><span class="p">))</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>    
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>    <span class="c1">#N_total = min(N_total_0, N_total_2)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_2</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>    <span class="n">N_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>    
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>    <span class="n">f_vec_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span><span class="o">/</span><span class="n">N_cell_0</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>    <span class="n">m</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">)</span><span class="o">*</span><span class="n">f_vec_initial</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a> 
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>    <span class="n">beta_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>    <span class="n">alpha_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>   
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>    <span class="n">v</span><span class="o">=</span><span class="n">m</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>    <span class="n">pvec</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>    <span class="n">nvec</span><span class="o">=</span><span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">pvec</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>    <span class="n">pvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">pvec</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>    <span class="n">nvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">1e-30</span><span class="p">)</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">pvec</span><span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>    <span class="nb">print</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">pvec</span><span class="p">)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvec</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">nvec</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>    <span class="n">n_counts_day_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">negative_binomial</span><span class="p">(</span><span class="n">nvec</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">pvec</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_total</span><span class="p">)))</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>    <span class="n">n_counts_day_0</span> <span class="o">=</span> <span class="n">n_counts_day_0</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">n_counts_day_0</span><span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>    
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>    
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>    <span class="c1">#Final condition</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>    <span class="n">f_vec_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_2</span><span class="p">)</span><span class="o">/</span><span class="n">N_cell_2</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>    <span class="n">m_end</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">NreadsII</span><span class="p">)</span><span class="o">*</span><span class="n">f_vec_end</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">m_end</span><span class="p">)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>    <span class="n">v_end</span><span class="o">=</span><span class="n">m_end</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m_end</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>    <span class="n">pvec_end</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m_end</span><span class="o">/</span><span class="n">v_end</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>    <span class="n">nvec_end</span><span class="o">=</span><span class="n">m_end</span><span class="o">*</span><span class="n">m_end</span><span class="o">/</span><span class="n">v_end</span><span class="o">/</span><span class="n">pvec_end</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>    <span class="n">pvec_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">pvec_end</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>    <span class="n">nvec_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">nvec_end</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">1e-30</span><span class="p">)</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>    <span class="n">n_counts_day_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">negative_binomial</span><span class="p">(</span><span class="n">nvec_end</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">pvec_end</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_total</span><span class="p">)))</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>    <span class="n">n_counts_day_1</span> <span class="o">=</span> <span class="n">n_counts_day_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">n_counts_day_1</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>    <span class="c1">#-------------------------------Creation of the data set-------------------------------------</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>    
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>    <span class="n">obs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">n_counts_day_0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_counts_day_1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>    <span class="n">n1_samples</span><span class="o">=</span><span class="n">n_counts_day_0</span><span class="p">[</span><span class="n">obs</span><span class="p">]</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>    <span class="n">n2_samples</span><span class="o">=</span><span class="n">n_counts_day_1</span><span class="p">[</span><span class="n">obs</span><span class="p">]</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>    <span class="n">pair_samples_df</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">:</span><span class="n">n1_samples</span><span class="p">,</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">:</span><span class="n">n2_samples</span><span class="p">})</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>    
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>    <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_frequency_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>    <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_frequency_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>    
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>    
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>    <span class="k">return</span> <span class="n">pair_samples_df</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="c1">#==========================================================================================================================</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="c1">#===============================Longitudinal-Data-Pre-Processing===================================</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="k">class</span> <span class="nc">longitudinal_analysis</span><span class="p">():</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">    A class used to represent longitudinal RepSeq data and pre-analysis of the longitudinal data associated with</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">    one individual.</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">    ...</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">    Attributes</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">    ----------</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">    patient : str</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">        the patient label associated with the data</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">    data_foler : str</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">        the name of the animal</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">    replicate_1D : str</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">        the default first replicate label is &#39;_F1&#39; but can be modified by the user to match the used data</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">    replicate_2D : str</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        the default first replicate label is &#39;_F2&#39; but can be modified by the user to match the used data</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">    Methods</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">    -------</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">    import_clones()</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">        to import all the clonotypes of a given patient and store them in a dictionary.</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">        It returns also the list of #ordered time points of the longitudinal dataset.</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a><span class="sd">    merge_replicates(ntCDR3 = &#39;N. Seq. CDR3&#39;)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a><span class="sd">        tool to merge biological replicate 1 and biological replicate 2 data</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a><span class="sd">    persistence_clones(ntCDR3 = &#39;N. Seq. CDR3&#39;)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a><span class="sd">    plot_hist_persistence(filename,  ntCDR3 = &#39;N. Seq. CDR3&#39;, fontsize = 12)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a><span class="sd">    get_top_clones_set(n_top_clones, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a><span class="sd">    build_traj_frame(top_clones_set, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a><span class="sd">    plot_trajectories(n_top_clones, filename, colormap = &#39;viridis&#39;, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a><span class="sd">    PCA_traj(n_top_clones, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;, nclus = 3)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">    plot_clusters2D(n_top_clones, filename, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;, nclus = 3, colormap = &#39;viridis&#39;)</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">    plot_traj_clusters(n_top_clones, filename, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;, nclus = 3, colormap = &#39;viridis&#39;)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">,</span> <span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="s1">&#39;_F1&#39;</span><span class="p">,</span> <span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="s1">&#39;_F2&#39;</span><span class="p">):</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="o">=</span> <span class="n">patient</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span> <span class="o">=</span> <span class="n">data_folder</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="n">replicate_1_ID</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="n">replicate_2_ID</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>    <span class="k">def</span> <span class="nf">import_clones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="sd">&quot;&quot;&quot; </span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">        to import all the clonotypes of a given patient and store them in a dictionary.</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">        It returns also the list of #ordered time points of the longitudinal dataset.</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">        Parameters</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">        ----------</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">        patient : str</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">            The ID of the patient</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">        data_folder : str</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">            The name of the folder to find data</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        Returns</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">        -------</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">        clones</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient.</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">           </span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">        times</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">            a numpy vector containing all the RepSeq sampling times ordered.</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="n">patient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="n">data_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="n">clones</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        <span class="c1"># Iteration over all the file in the folder</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">):</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="c1"># If the name before the underscore corresponds to the chosen patient..</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>            <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">patient</span><span class="p">:</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                <span class="c1"># Import the table</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_folder</span><span class="o">+</span><span class="n">file_name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;zip&#39;</span><span class="p">))</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                <span class="c1"># Store it in a dictionary where the key contains the patient, the time</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                <span class="c1"># and the replicate.</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                <span class="n">clones</span><span class="p">[</span><span class="n">file_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">]]</span> <span class="o">=</span> <span class="n">frame</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                <span class="c1"># Reading the time from the name and storing it</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                <span class="c1">#print(&#39;Clonotypes&#39;,file_name[:-10],&#39;imported&#39;)</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="c1"># Sorting the unique times</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">times</span><span class="p">)))</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="k">return</span> <span class="n">clones</span><span class="p">,</span> <span class="n">times</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>    <span class="k">def</span> <span class="nf">merge_replicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">):</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="sd">&#39;&#39;&#39; Creating the dataframes for the merged replicates. After this operation the </span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">        clones_merged dictionary contains the the merged table of the first and second</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">        replicate. The indexes are the same as before without the F1/2 label.</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">        Parameters</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">        ----------</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;. </span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="sd">        Returns</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="sd">        -------</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="sd">        clones_merged</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient that were merged for both replicates.</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="n">patient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicate_1_ID</span> 
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicate_2_ID</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="c1"># Iteration over the times</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>            <span class="c1"># Building the ids correponding at 1st and 2nd replicate at given time point</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>            <span class="n">id_F1</span> <span class="o">=</span> <span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">replicate_1_ID</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>            <span class="n">id_F2</span> <span class="o">=</span> <span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">replicate_2_ID</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>            <span class="c1"># Below all the rows of one table are appended to the rows of the other</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>            <span class="n">merged_replicates</span> <span class="o">=</span> <span class="n">clones</span><span class="p">[</span><span class="n">id_F1</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">clones</span><span class="p">[</span><span class="n">id_F2</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>            <span class="c1"># But there are common clonotypes that now appear in two different rows </span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>            <span class="c1"># (one for the first and one for the second replicate)! </span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>            <span class="c1"># Below we collapse those common sequences and the counts of the two are summed </span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="n">merged_replicates</span> <span class="o">=</span> <span class="n">merged_replicates</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ntCDR3</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Clone count&#39;</span><span class="p">:</span><span class="nb">sum</span><span class="p">})</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="c1"># The merged table is then added to the dictionary</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="n">clones_merged</span><span class="p">[</span><span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">merged_replicates</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>        <span class="k">return</span> <span class="n">clones_merged</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>    <span class="k">def</span> <span class="nf">persistence_clones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">):</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="sd">&quot;&quot;&quot;A list of all the clonotypes appearing in all the time points is created.</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">        Note that if one clonotype is present in 2 or more points, it will be repeated</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">        twice in the list.</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">        Parameters</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        ----------</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;. </span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a><span class="sd">        Returns</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">        -------</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">        unique_clones</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient that were merged for both replicates.</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="sd">        </span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        time_occurence</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="n">all_clones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="n">all_clones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_clones</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="c1"># The following function returns the list of unique clonotypes and the number of</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="c1"># repetitions for each of them. </span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="c1"># Note that the number of repetitions is exactly the time occurrence</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_clones</span><span class="p">,</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="k">return</span> <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>    <span class="k">def</span> <span class="nf">plot_hist_persistence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>  <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="sd">&quot;&quot;&quot; TOFILL</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        Parameters</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">        ----------</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">        filename : str</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">            TOFILL</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">        fontsize : float</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">            TOFILL</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">        Returns</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">        -------</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">        plot</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_clones</span><span class="p">()</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time occurrence&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="n">h</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">time_occurrence</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>    <span class="k">def</span> <span class="nf">get_top_clones_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="sd">&quot;&quot;&quot; TOFILL</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">        Parameters</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">        ----------</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">        filename : str</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">            TOFILL</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">        fontsize : float</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">            TOFILL</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">        Returns</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">        -------</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">        plot</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">        </span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>            <span class="n">top_clones_at_time</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">clone_count</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="n">n_top_clones</span><span class="p">]</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="n">top_clones</span> <span class="o">=</span> <span class="n">top_clones</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">top_clones_at_time</span><span class="p">[</span><span class="n">ntCDR3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="k">return</span> <span class="n">top_clones</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>    <span class="k">def</span> <span class="nf">build_traj_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_clones_set</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="sd">&quot;&quot;&quot; </span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">        This builds a dataframe containing the count at all the time points for each </span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">        of the clonotypes specified in top_clones_set.</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">        The dataframe has also a field that contains the cumulative count.</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="sd">        The trajectory dataframe is initialised with indexes as the clonotypes in</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">        top_clones_set</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">        Parameters</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">        ----------</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">        top_clones_set : TOFILL</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">        clone_count : str </span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">        Returns</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">        -------</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a><span class="sd">        traj_frame</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">top_clones_set</span><span class="p">)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>            <span class="c1"># Getting the time from the index of clones_merged</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">id_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>            <span class="c1"># Selecting the clonotypes that are both in the frame at the given time </span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>            <span class="c1"># point and in the list of top_clones_set</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>            <span class="n">top_clones_at_time</span> <span class="o">=</span> <span class="n">top_clones_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="n">ntCDR3</span><span class="p">]))</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="c1"># Creating a sub-dataframe containing only the clone in top_clones_at_time</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>            <span class="n">clones_at_time</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">ntCDR3</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_clones_at_time</span><span class="p">]</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>            <span class="c1"># Creating a new column in the trajectory frames for the counts at that time</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">clones_at_time</span><span class="p">[</span><span class="n">clone_count</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>            <span class="c1"># The clonotypes not present at that time are NaN. Below we convert NaN in 0s</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>            <span class="n">traj_frame</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>            <span class="c1"># The cumulative count for each clonotype is updated</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>            <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="k">return</span> <span class="n">traj_frame</span> 
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>    <span class="c1"># Plot clonal trajectories</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>    <span class="k">def</span> <span class="nf">plot_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">        Function to plot the trajectories of the first top n clones using your favorite colormap</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">        </span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">        Parameters</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">        ----------</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">        filename  : str</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">        colormap : TOFILL</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a><span class="sd">        clone_count : str</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a><span class="sd">        Returns</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a><span class="sd">        -------</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a><span class="sd">        plot </span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="n">log_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="n">max_log_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="n">min_log_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>            <span class="n">traj</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>            <span class="n">log_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">])</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>            <span class="n">norm_log_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_count</span><span class="o">-</span><span class="n">min_log_count</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">max_log_count</span><span class="o">-</span><span class="n">min_log_count</span><span class="p">)</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">traj</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm_log_count</span><span class="p">))</span> <span class="c1"># I am adding 1 to define a kind of pseudo-count here and avoid 0 values</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>        <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">log_counts</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)))</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Log10 cumulative count&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>    <span class="k">def</span> <span class="nf">PCA_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">        Perform PCA computation over the normalized trajectories of n_top_clones TCR clones</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">        nclus: number of clusters of clonal dynamics, by default this number is set to 3</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">        </span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">        Parameters</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">        ----------</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">        clone_count : str</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">        nclus : float</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a><span class="sd">        </span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">        Returns</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">        -------</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">        pca </span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">        clustering</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">norm_traj_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="n">clustering</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">nclus</span><span class="p">)</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="n">clustering</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="k">return</span> <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>    <span class="k">def</span> <span class="nf">plot_clusters2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">        TOFILL</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">        </span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">        Parameters</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">        ----------</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a><span class="sd">        filename  : str</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">        clone_count : str</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">        nclus : float</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a><span class="sd">        colormap : str</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">        Returns</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">        -------</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">        plot </span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PCA_traj</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PCA components (</span><span class="si">%i</span><span class="s1"> trajs)&#39;</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">norm_traj_matrix</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;First component (expl var: </span><span class="si">%3.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Second component (expl var: </span><span class="si">%3.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="k">for</span> <span class="n">c_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">):</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">c_ind</span><span class="p">]</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">c_ind</span><span class="p">]</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c_ind</span><span class="o">/</span><span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">))</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>    <span class="k">def</span> <span class="nf">plot_traj_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a><span class="sd">        TOFILL</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a><span class="sd">        </span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a><span class="sd">        Parameters</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a><span class="sd">        ----------</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a><span class="sd">        filename  : str</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a><span class="sd">        clone_count : str</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a><span class="sd">        nclus : float</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">        colormap : str</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">            TOFILL</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">        Returns</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="sd">        -------</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">        plot </span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>        <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PCA_traj</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="n">n_cl</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_cl</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">n_cl</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cl</span><span class="p">):</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>            <span class="n">trajs</span> <span class="o">=</span> <span class="n">norm_traj_matrix</span><span class="p">[</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">cl</span><span class="p">]</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>            <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">cl</span><span class="o">/</span><span class="n">n_cl</span><span class="p">))</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>                                <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">cl</span><span class="o">/</span><span class="n">n_cl</span><span class="p">))</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>            <span class="c1">#axs[1][cl].fill_between(times, np.quantile(trajs, 0.75, axis=0), np.quantile(trajs, 0.25, axis=0), color=colors[cl])</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>               
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span> 
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a><span class="c1">#===============================Data-Pre-Processing===================================</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="k">class</span> <span class="nc">Data_Process</span><span class="p">():</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a><span class="sd">    ## TODO in the future, merge this class with other classes.</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="sd">    A class used to represent longitudinal RepSeq data and pre-analysis of the longitudinal data associated with</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">    one individual.</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a><span class="sd">    ...</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a><span class="sd">    Attributes</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="sd">    ----------</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a><span class="sd">    path : str</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a><span class="sd">        the name of the path to get access to the data files to use for our analysis</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a><span class="sd">    filename1 : str</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a><span class="sd">        the name of the file of the RepSeq sample which can be the first replicate when deciphering the experimental noise </span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a><span class="sd">        or the first time point RepSeq sample when analysing responding clones to a stimulus between two time points.</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a><span class="sd">    filename2 : str</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a><span class="sd">        the name of the file of the RepSeq sample which can be the second replicate when deciphering the experimental noise </span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a><span class="sd">        or the second time point RepSeq sample when analysing responding clones to a stimulus between two time points.</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="sd">    colnames1 : str</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="sd">        list of columns names of data-set - first sample</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a><span class="sd">    colnames2 : str</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a><span class="sd">        list of columns names of data-set - second sample </span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a><span class="sd">    Methods</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="sd">    -------</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a><span class="sd">    import_data() : </span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="sd">        to import and merged two RepSeq samples and build a unique data-frame with frequencies and abundances of all TCR clones present in the </span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a><span class="sd">        union of both samples.</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a><span class="sd">    </span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename1</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="n">colnames1</span><span class="p">,</span>  <span class="n">colnames2</span><span class="p">):</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span> <span class="o">=</span> <span class="n">filename1</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span> <span class="o">=</span> <span class="n">filename2</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span> <span class="o">=</span> <span class="n">colnames1</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span> <span class="o">=</span> <span class="n">colnames2</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>    
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>    <span class="k">def</span> <span class="nf">import_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a><span class="sd">        TOFILL</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">        </span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">        Parameters</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">        ----------</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">        NONE</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">        Returns</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">        -------</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">        number_clones</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">            numpy array, number of clones in the data frame which is the union of the two RepSeq used as entries of the function</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a><span class="sd">        df</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a><span class="sd">            pandas data-frame which is the data-frame containing the informations labeled in colnames vector string</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="sd">            for both RepSeq samples taken as input.</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>        <span class="n">mincount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>        <span class="n">maxcount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>        
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>        <span class="n">headerline</span><span class="o">=</span><span class="mi">0</span> <span class="c1">#line number of headerline</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="n">newnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Clone_fraction&#39;</span><span class="p">,</span><span class="s1">&#39;Clone_count&#39;</span><span class="p">,</span><span class="s1">&#39;ntCDR3&#39;</span><span class="p">,</span><span class="s1">&#39;AACDR3&#39;</span><span class="p">]</span>   
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span><span class="p">:</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>            <span class="n">F1Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">]</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>            <span class="n">F1Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">]</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span><span class="p">:</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>            <span class="n">F2Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">]</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>            <span class="n">F2Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">]</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>        <span class="n">F1Frame_chunk</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">newnames</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="n">F2Frame_chunk</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">newnames</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span><span class="s1">&#39;_2&#39;</span><span class="p">)</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>        <span class="n">mergedFrame</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">F1Frame_chunk</span><span class="p">,</span><span class="n">F2Frame_chunk</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="n">newnames</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="n">suffixes</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>        <span class="k">for</span> <span class="n">nameit</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>            <span class="k">for</span> <span class="n">labelit</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>                <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="n">nameit</span><span class="p">]</span><span class="o">+</span><span class="n">labelit</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>                <span class="k">if</span> <span class="n">nameit</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>                    <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="n">nameit</span><span class="p">]</span><span class="o">+</span><span class="n">labelit</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>        <span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>            <span class="n">val</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>                <span class="n">val</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>            <span class="k">return</span> <span class="n">val</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#assigns AA sequence to clones, creates duplicates</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#removes duplicates</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>        <span class="n">mergedFrame</span><span class="o">=</span><span class="n">mergedFrame</span><span class="p">[[</span><span class="n">newname</span><span class="o">+</span><span class="n">suffix</span> <span class="k">for</span> <span class="n">newname</span> <span class="ow">in</span> <span class="n">newnames</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">newnames</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>        <span class="n">filterout</span><span class="o">=</span><span class="p">((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">&lt;</span><span class="n">mincount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">&lt;</span><span class="n">mincount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="c1">#has effect only if mincount&gt;0</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>        <span class="n">number_clones</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mergedFrame</span><span class="p">)</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="k">return</span> <span class="n">number_clones</span><span class="p">,</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">&lt;=</span><span class="n">maxcount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">&lt;=</span><span class="n">maxcount</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filterout</span><span class="p">]</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>        
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>            
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="c1">#===============================Noise-Model===================================================================</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a><span class="c1">### Noise Model</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a><span class="k">class</span> <span class="nc">Noise_Model</span><span class="p">():</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="sd">    A class used to build an object associated to methods in order to learn the experimental noise from same day </span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">    biological RepSeq samples.</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">    ...</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">    Methods</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a><span class="sd">    -------</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">    get_sparserep(df) :</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">        get sparse representation of the abundances / frequencies of the TCR clones present in both RepSeq samples of interest.</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a><span class="sd">        this changes the data input to fasten the algorithm</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a><span class="sd">    learn_null_model(df, noise_model, init_paras,  output_dir = None, filename = None, display_loss_function = False) :</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a><span class="sd">        function to optimize the likelihood associated to the experimental noise model and get the associated parameters.</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a><span class="sd">    diversity_estimate(df, paras, noise_model) :</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a><span class="sd">        function to get the estimation of diversity from the noise model information.</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>    <span class="k">def</span> <span class="nf">get_sparserep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span> 
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">        Tranforms {(n1,n2)} data stored in pandas dataframe to a sparse 1D representation.</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a><span class="sd">        unicountvals_1(2) are the unique values of n1(2).</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a><span class="sd">        sparse_rep_counts gives the counts of unique pairs.</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a><span class="sd">        ndn1(2) is the index of unicountvals_1(2) giving the value of n1(2) in that unique pair.</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a><span class="sd">        len(indn1)=len(indn2)=len(sparse_rep_counts)</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a><span class="sd">        Parameters</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a><span class="sd">        ----------</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two replicates RepSeq samples</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a><span class="sd">            associated to their clone frequencies and clone abundances in the first and second replicate.</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a><span class="sd">        Returns</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a><span class="sd">        -------</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="sd">        indn1</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_1</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a><span class="sd">        indn2</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_2</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a><span class="sd">        sparse_rep_counts</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a><span class="sd">            numpy array, # of clones having the read counts pair {(n1,n2)} </span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a><span class="sd">        unicountvals_1</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="sd">            numpy array list of unique counts values present in the first sample in df[clone_count_1]</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">        unicountvals_2</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a><span class="sd">            numpy array list of unique counts values present in the second sample in df[clone_count_2]</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">        Nreads1</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">            float, total number of counts/reads in the first sample referred in df by &quot;_1&quot;</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a><span class="sd">        Nreads2</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">            float, total number of counts/reads in the second sample referred in df by &quot;_2&quot;</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>        
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]]</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>        <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;paircount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># gives a weight of 1 to each observed clone</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>        <span class="n">clone_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>        <span class="n">sparse_rep_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clone_counts</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>        <span class="n">clonecountpair_vals</span> <span class="o">=</span> <span class="n">clone_counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>        <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>        <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn2</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="k">return</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>    <span class="k">def</span> <span class="nf">_NegBinPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">mvec</span><span class="p">):</span> 
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a><span class="sd">        Same as NegBinParMtr, but for m and v being scalars.</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a><span class="sd">        Assumes m&gt;0.</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a><span class="sd">        Output is (len(mvec),) array</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>        <span class="n">mmax</span><span class="o">=</span><span class="n">mvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>   
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        <span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="c1">#vectorization won&#39;t help unfortuneately here since log needs to be over array</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>        <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="p">)</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">NBvec</span><span class="p">)[</span><span class="n">mvec</span><span class="p">])</span> <span class="c1">#save a bit here</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>        <span class="k">return</span> <span class="n">NBvec</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>    <span class="k">def</span> <span class="nf">_NegBinParMtr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">nvec</span><span class="p">):</span> <span class="c1">#speed up only insofar as the log and exp are called once on array instead of multiple times on rows</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        <span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a><span class="sd">        computes NegBin probabilities over the ordered (but possibly discontiguous) vector (nvec) </span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a><span class="sd">        for mean/variance combinations given by the mean (m) and variance (v) vectors. </span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a><span class="sd">        Note that m&lt;v for negative binomial.</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a><span class="sd">        Output is (len(m),len(nvec)) array</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="n">nmax</span><span class="o">=</span><span class="n">nvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">NBvec</span><span class="o">+</span><span class="n">r</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">/</span><span class="n">NBvec</span><span class="p">))</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>        <span class="n">NBvec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="p">)</span> <span class="c1">#handle NBvec[0]=0, treated specially when m[0]=0, see below</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">NBvec</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#save a bit here</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>            <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">0.</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>            <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">NBvec</span><span class="p">[:,</span><span class="n">nvec</span><span class="p">]</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>        <span class="k">return</span> <span class="n">NBvec</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>    <span class="k">def</span> <span class="nf">_PoisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Mvec</span><span class="p">,</span><span class="n">unicountvals</span><span class="p">):</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>        <span class="c1">#assert Mvec[0]==0, &quot;first element needs to be zero&quot;</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>        <span class="n">nmax</span><span class="o">=</span><span class="n">unicountvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>        <span class="n">nlen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unicountvals</span><span class="p">)</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>        <span class="n">mlen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">Mvec</span><span class="p">)</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>        <span class="n">Nvec</span><span class="o">=</span><span class="n">unicountvals</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>        <span class="n">logNvec</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">))),</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.</span><span class="p">)[</span><span class="n">unicountvals</span><span class="p">]</span> <span class="c1">#avoid n=0 nans  </span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>        <span class="n">Nmtr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Nvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Mvec</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">+</span><span class="n">logNvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">-</span><span class="n">Mvec</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="c1"># np.log(Mvec) throws warning: since log(0)=-inf</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>        <span class="k">if</span> <span class="n">Mvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>            <span class="n">Nmtr</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlen</span><span class="p">,))</span> <span class="c1">#when m=0, n=0, and so get rid of nans from log(0)</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="n">Nmtr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span> <span class="c1">#handled belowacq_model_type</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>        <span class="k">if</span> <span class="n">unicountvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#if n=0 included get rid of nans from log(0)</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>            <span class="n">Nmtr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Mvec</span><span class="p">)</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>        <span class="k">return</span> <span class="n">Nmtr</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>    <span class="k">def</span> <span class="nf">_get_rhof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alpha_rho</span><span class="p">,</span> <span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">):</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a><span class="sd">        generates power law (power is alpha_rho) clone frequency distribution over </span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a><span class="sd">        freq_nbins discrete logarithmically spaced frequences between fmin and 1 of dtype freq_dtype</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a><span class="sd">        Outputs log probabilities obtained at log frequencies&#39;&#39;&#39;</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>        <span class="n">fmax</span><span class="o">=</span><span class="mf">1e0</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span> <span class="n">nfbins</span><span class="p">)</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">logfvec</span><span class="p">))</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>        <span class="n">logrhovec</span><span class="o">=</span><span class="n">logfvec</span><span class="o">*</span><span class="n">alpha_rho</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhovec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>        <span class="n">normconst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>        <span class="n">logrhovec</span><span class="o">-=</span><span class="n">normconst</span> 
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>        <span class="k">return</span> <span class="n">logrhovec</span><span class="p">,</span><span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>    <span class="k">def</span> <span class="nf">_get_logPn_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unicounts</span><span class="p">,</span><span class="n">Nreads</span><span class="p">,</span><span class="n">logfvec</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">):</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="sd">        tools to compute the likelihood of the noise model. It is not useful for the user.</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>        <span class="c1"># Choice of the model:</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>        
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>            <span class="n">m_total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> 
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="n">r_c</span><span class="o">=</span><span class="n">Nreads</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>            <span class="n">beta_mv</span><span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>            <span class="n">alpha_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>            
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#for models that include cell counts</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>            <span class="c1">#compute parametrized range (mean-sigma,mean+5*sigma) of m values (number of cells) conditioned on n values (reads) appearing in the data only </span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>            <span class="n">nsigma</span><span class="o">=</span><span class="mf">5.</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>            <span class="n">nmin</span><span class="o">=</span><span class="mf">300.</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>            <span class="c1">#for each n, get actual range of m to compute around n-dependent mean m</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>            <span class="n">m_low</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>            <span class="n">m_high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>            <span class="k">for</span> <span class="n">nit</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unicounts</span><span class="p">):</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>                <span class="n">mean_m</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">r_c</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                <span class="n">dev</span><span class="o">=</span><span class="n">nsigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_m</span><span class="p">)</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                <span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span> <span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mean_m</span><span class="o">-</span>  <span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">mean_m</span><span class="o">&gt;</span><span class="n">dev</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>                         
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>                <span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mean_m</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span>      <span class="n">n</span><span class="o">&gt;</span><span class="n">nmin</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">nmin</span><span class="o">/</span><span class="n">r_c</span><span class="p">)</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>            <span class="n">m_cellmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">m_high</span><span class="p">)</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>            <span class="c1">#across n, collect all in-range m</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>            <span class="n">mvec_bool</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m_cellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1">#cheap bool</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>            <span class="n">nvec</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">))</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>            <span class="k">for</span> <span class="n">nit</span> <span class="ow">in</span> <span class="n">nvec</span><span class="p">:</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>                <span class="n">mvec_bool</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>  <span class="c1">#mask vector</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>            <span class="n">mvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_cellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">mvec_bool</span><span class="p">]</span>                
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>            <span class="c1">#transform to in-range index</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>            <span class="k">for</span> <span class="n">nit</span> <span class="ow">in</span> <span class="n">nvec</span><span class="p">:</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>                <span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">==</span><span class="n">mvec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>                <span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">==</span><span class="n">mvec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">)))</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>            <span class="n">mean_m</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>            <span class="n">var_m</span><span class="o">=</span><span class="n">mean_m</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_m</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>            <span class="n">Poisvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PoisPar</span><span class="p">(</span><span class="n">mvec</span><span class="o">*</span><span class="n">r_c</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="k">for</span> <span class="n">f_it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)):</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>                <span class="n">NBvec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_NegBinPar</span><span class="p">(</span><span class="n">mean_m</span><span class="p">[</span><span class="n">f_it</span><span class="p">],</span><span class="n">var_m</span><span class="p">[</span><span class="n">f_it</span><span class="p">],</span><span class="n">mvec</span><span class="p">)</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>                <span class="k">for</span> <span class="n">n_it</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unicounts</span><span class="p">):</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">f_it</span><span class="p">,</span><span class="n">n_it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">NBvec</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">n_it</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">n_it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Poisvec</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">n_it</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">n_it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n_it</span><span class="p">])</span> 
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>        
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>        <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>            <span class="n">mean_n</span><span class="o">=</span><span class="n">Nreads</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="n">var_n</span><span class="o">=</span><span class="n">mean_n</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="n">Pn_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NegBinParMtr</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">var_n</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>        <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>            <span class="n">mean_n</span><span class="o">=</span><span class="n">Nreads</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="n">Pn_f</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PoisPar</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1, or 2 only&#39;</span><span class="p">)</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn_f</span><span class="p">)</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>    <span class="c1">#-----------------------------Null-Model-optimization--------------------------</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>        
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>    <span class="k">def</span> <span class="nf">_get_Pn1n2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">):</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="sd">        Tool to compute likelihood of the noise model. It is not useful for the user.</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>            
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>        <span class="c1"># Parameters</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>        <span class="c1"># </span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>        <span class="c1"># </span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>        <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>        <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>        <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>        <span class="c1"># for the trapezoid integral methods</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>        <span class="c1"># Compute P(0,0) for the normalization constraint</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>        <span class="n">Pn0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>        <span class="c1">#print(&quot;computing P(n1,n2)&quot;)</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>        <span class="n">Pn1n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))</span>  <span class="c1"># 1D representation</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">)):</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>            <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span> <span class="n">ind1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="n">ind2</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>            <span class="n">Pn1n2</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>        <span class="n">Pn1n2</span> <span class="o">/=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">Pn0n0</span>  <span class="c1"># renormalize</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pn1n2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn1n2</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>    
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">nparas</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">):</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>        <span class="sd">&#39;&#39;&#39;prints iteration info. called by scipy.minimize. Not useful for the user.&#39;&#39;&#39;</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>        <span class="k">global</span> <span class="n">curr_iter</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>        <span class="c1">#curr_iter = 0</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>        <span class="k">global</span> <span class="n">Loss_function</span> 
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0:d}</span><span class="s1"> &#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;{&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:3.6f} &#39;</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">paras</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">curr_iter</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">paras</span><span class="p">))))</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>        <span class="c1">#print (&#39;{&#39; + str(len(paras)+1) + &#39;:3.6f}&#39;.format( [self.get_Pn1n2(paras, sparse_rep, acq_model_type)]))</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>        <span class="n">Loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pn1n2</span><span class="p">(</span><span class="n">paras</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">)</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">Loss_function</span><span class="p">)</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>        <span class="n">curr_iter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>        
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>    <span class="c1"># Constraints for the Null-Model, no filtered </span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>    <span class="k">def</span> <span class="nf">_nullmodel_constr_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">constr_type</span><span class="p">):</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>            
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a><span class="sd">        returns either or both of the two level-set functions: log&lt;f&gt;-log(1/N), with N=Nclones/(1-P(0,0)) and log(Z_f), with Z_f=N&lt;f&gt;_{n+n&#39;=0} + sum_i^Nclones &lt;f&gt;_{f|n,n&#39;}</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a><span class="sd">        not useful for the user</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>        <span class="c1"># Choice of the model: </span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>        <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>        <span class="c1">#Variables that would be chosen in the future by the user </span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># power law exponent</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># true minimal frequency </span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>        <span class="n">dlogfby2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>  <span class="c1"># 1/2 comes from trapezoid integration below</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>        <span class="n">avgf_ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>        <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>        <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>        <span class="n">Pn0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>        <span class="n">logPnng0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Pn0n0</span><span class="p">)</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>        <span class="n">avgf_null_pair</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPnng0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)))</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>        <span class="n">C1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgf_ps</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgf_null_pair</span><span class="p">)</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logrhofvec</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>        <span class="n">log_avgf_n0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span> <span class="n">indn1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="n">indn2</span><span class="p">]</span> <span class="o">+</span> <span class="n">logrhofvec</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>        <span class="n">log_Pn1n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">integ</span><span class="p">)</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">log_Pn1n2</span><span class="p">)</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>        <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>  <span class="c1"># since subtracted in next line</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>        <span class="n">avgf_n1n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">)</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>        <span class="n">log_sumavgf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">avgf_n1n2</span><span class="p">))</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>        <span class="n">logNclones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))</span> <span class="o">-</span> <span class="n">logPnng0</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logNclones</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn0n0</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_avgf_n0n0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_sumavgf</span><span class="p">)</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>        <span class="n">C2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>        
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>        <span class="c1"># print(&#39;C1:&#39;+str(C1)+&#39; C2:&#39;+str(C2))</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>        <span class="k">if</span> <span class="n">constr_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>            <span class="k">return</span> <span class="n">C1</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>        <span class="k">elif</span> <span class="n">constr_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>            <span class="k">return</span> <span class="n">C2</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>            <span class="k">return</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>        
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>    <span class="c1"># Null-Model optimization learning </span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>    <span class="k">def</span> <span class="nf">learn_null_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">init_paras</span><span class="p">,</span>  <span class="n">output_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">display_loss_function</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>  <span class="c1"># constraint type 1 gives only low error modes, see paper for details.</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a><span class="sd">        Parameters</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a><span class="sd">        ----------</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two replicates RepSeq samples</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a><span class="sd">            associated to their clone frequencies and clone abundances in the first and second replicate.</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a><span class="sd">        noise_model: numpy array</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a><span class="sd">            choice of noise model </span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a><span class="sd">        init_paras: numpy array</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a><span class="sd">            initial vector of parameters to start the optimization of the model from data (df)</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a><span class="sd">        output_dir : str</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a><span class="sd">            default value is None, it is the output directory name i which we want to save the values of the parameters</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a><span class="sd">        display_loss_function : bool</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a><span class="sd">            boolean variable to chose if we want to print the loss function during the experimental noise learning, default value is </span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a><span class="sd">            None.</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a><span class="sd">        </span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a><span class="sd">        Returns</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a><span class="sd">        -------</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a><span class="sd">        outstruct</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a><span class="sd">            numpy array parameters of the noise model</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a><span class="sd">        constr_value</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a><span class="sd">            float, value of the constraint </span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a><span class="sd">    </span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>            
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>        <span class="c1"># Data introduction</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>        <span class="n">constr_type</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>        <span class="c1"># Choice of the model:</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>        <span class="c1"># Parameters initialization depending on the model </span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>        <span class="k">if</span> <span class="n">noise_model</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;m_total&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>        <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">),</span> <span class="s2">&quot;number of model and initial paras differ!&quot;</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>        <span class="n">condict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nullmodel_constr_fn</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">constr_type</span><span class="p">)}</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>        <span class="n">partialobjfunc</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_Pn1n2</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="o">=</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="o">=</span><span class="n">noise_model</span><span class="p">)</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>        <span class="n">nullfunctol</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>        <span class="n">nullmaxiter</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Iter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameter_labels</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:9s} &#39;</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">))</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>            
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>        <span class="k">global</span> <span class="n">curr_iter</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>        <span class="n">curr_iter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>        <span class="n">callbackp</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">,</span> <span class="n">nparas</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">),</span> <span class="n">sparse_rep</span> <span class="o">=</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="o">=</span> <span class="n">noise_model</span><span class="p">)</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>        <span class="n">outstruct</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">partialobjfunc</span><span class="p">,</span> <span class="n">init_paras</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callbackp</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">condict</span><span class="p">,</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="n">nullfunctol</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">nullmaxiter</span><span class="p">})</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>            
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>        <span class="n">constr_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nullmodel_constr_fn</span><span class="p">(</span><span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">constr_type</span><span class="p">)</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>        <span class="k">if</span> <span class="n">noise_model</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;m_total&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>        <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">output_dir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;nullpara&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">noise_model</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>        <span class="k">elif</span> <span class="p">(</span><span class="n">output_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;/nullpara&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">noise_model</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>        <span class="k">else</span> <span class="p">:</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>        <span class="k">return</span> <span class="n">outstruct</span><span class="p">,</span> <span class="n">constr_value</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>    <span class="k">def</span> <span class="nf">diversity_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">):</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a><span class="sd">        Estimate diversity of the individual repertoire from the experimental noise learning step. </span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a><span class="sd">        Parameters</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a><span class="sd">        ----------</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a><span class="sd">        df : data-frame </span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a><span class="sd">            The data-frame which has been used to learn the noise model</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a><span class="sd">        paras : numpy array</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a><span class="sd">            vector containing the noise parameters</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a><span class="sd">        noise_model : int</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a><span class="sd">            choice of noise model </span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a><span class="sd">        Returns</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a><span class="sd">        -------</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a><span class="sd">        diversity_estimate</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a><span class="sd">            float, diversity estimate from the noise model inference.</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a><span class="sd">    </span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>            
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>        <span class="c1"># Parameters</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>        <span class="c1"># </span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>        <span class="c1"># </span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>        <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>        <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>        <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>        <span class="c1"># for the trapezoid integral methods</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>        <span class="c1"># Compute P(0,0) for the normalization constraint</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>        <span class="n">Pn0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>        <span class="c1">#print(np.sum(sparse_rep_counts))</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>        <span class="n">N_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_obs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn0n0</span><span class="p">))</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a><span class="c1">#============================================Differential expression =============================================================</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a><span class="k">class</span> <span class="nc">Expansion_Model</span><span class="p">():</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>    
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a><span class="sd">    A class used to build an object associated to methods in order to select significant expanding or </span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a><span class="sd">    contracting clones from RepSeq samples taken at two different time points.</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a><span class="sd">    ...</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a><span class="sd">    Methods</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a><span class="sd">    -------</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a><span class="sd">    get_sparserep(df) :</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a><span class="sd">        get sparse representation of the abundances / frequencies of the TCR clones present in RepSeq samples of both time points.</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a><span class="sd">        This changes the data input to fasten the algorithm</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a><span class="sd">    expansion_table(outpath, paras_1, paras_2, df, noise_model, pval_threshold, smed_threshold):</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a><span class="sd">        generate the table of clones that have been significantly detected to be responsive to an acute stimuli.</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>    <span class="k">def</span> <span class="nf">get_sparserep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span> 
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a><span class="sd">        Tranforms {(n1,n2)} data stored in pandas dataframe to a sparse 1D representation.</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a><span class="sd">        unicountvals_1(2) are the unique values of n1(2).</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a><span class="sd">        sparse_rep_counts gives the counts of unique pairs.</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a><span class="sd">        ndn1(2) is the index of unicountvals_1(2) giving the value of n1(2) in that unique pair.</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a><span class="sd">        len(indn1)=len(indn2)=len(sparse_rep_counts)</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a><span class="sd">        Parameters</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a><span class="sd">        ----------</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two RepSeq samples, talen at two </span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a><span class="sd">            different time points, associated to their clone frequencies and clone abundances in the first and second replicate?</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a><span class="sd">        Returns</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a><span class="sd">        -------</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a><span class="sd">        indn1</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_1</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a><span class="sd">        indn2</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_2</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a><span class="sd">        sparse_rep_counts</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a><span class="sd">            numpy array, # of clones having the read counts pair {(n1,n2)} </span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a><span class="sd">        unicountvals_1</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a><span class="sd">            numpy array list of unique counts values present in the first sample in df[clone_count_1]</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a><span class="sd">        unicountvals_2</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a><span class="sd">            numpy array list of unique counts values present in the second sample in df[clone_count_2]</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a><span class="sd">        Nreads1</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a><span class="sd">            float, total number of counts/reads in the first sample referred in df by &quot;_1&quot; for first time point</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a><span class="sd">        Nreads2</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a><span class="sd">            float, total number of counts/reads in the second sample referred in df by &quot;_2&quot; for second time point</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a>        
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]]</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>        <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;paircount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># gives a weight of 1 to each observed clone</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>        <span class="n">clone_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>        <span class="n">sparse_rep_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clone_counts</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>        <span class="n">clonecountpair_vals</span> <span class="o">=</span> <span class="n">clone_counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>        <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>        <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>        <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>        <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn2</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>        <span class="k">return</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>    
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>    <span class="k">def</span> <span class="nf">_NegBinPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">mvec</span><span class="p">):</span> 
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a><span class="sd">        Same as NegBinParMtr, but for m and v being scalars.</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a><span class="sd">        Assumes m&gt;0.</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a><span class="sd">        Output is (len(mvec),) array</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>        <span class="n">mmax</span><span class="o">=</span><span class="n">mvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>   
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>        <span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="c1">#vectorization won&#39;t help unfortuneately here since log needs to be over array</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>        <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="p">)</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">NBvec</span><span class="p">)[</span><span class="n">mvec</span><span class="p">])</span> <span class="c1">#save a bit here</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>        <span class="k">return</span> <span class="n">NBvec</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>    <span class="k">def</span> <span class="nf">_NegBinParMtr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">nvec</span><span class="p">):</span> <span class="c1">#speed up only insofar as the log and exp are called once on array instead of multiple times on rows</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>        <span class="sd">&#39;&#39;&#39; </span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a><span class="sd">        computes NegBin probabilities over the ordered (but possibly discontiguous) vector (nvec) </span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a><span class="sd">        for mean/variance combinations given by the mean (m) and variance (v) vectors. </span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a><span class="sd">        Note that m&lt;v for negative binomial.</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a><span class="sd">        Output is (len(m),len(nvec)) array</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>        <span class="n">nmax</span><span class="o">=</span><span class="n">nvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">NBvec</span><span class="o">+</span><span class="n">r</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">/</span><span class="n">NBvec</span><span class="p">))</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>        <span class="n">NBvec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="p">)</span> <span class="c1">#handle NBvec[0]=0, treated specially when m[0]=0, see below</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">NBvec</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#save a bit here</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>            <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">0.</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>            <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">NBvec</span><span class="p">[:,</span><span class="n">nvec</span><span class="p">]</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>        <span class="k">return</span> <span class="n">NBvec</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>    <span class="k">def</span> <span class="nf">_PoisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Mvec</span><span class="p">,</span><span class="n">unicountvals</span><span class="p">):</span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>        <span class="c1">#assert Mvec[0]==0, &quot;first element needs to be zero&quot;</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>        <span class="n">nmax</span><span class="o">=</span><span class="n">unicountvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a>        <span class="n">nlen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unicountvals</span><span class="p">)</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a>        <span class="n">mlen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">Mvec</span><span class="p">)</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>        <span class="n">Nvec</span><span class="o">=</span><span class="n">unicountvals</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>        <span class="n">logNvec</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">))),</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.</span><span class="p">)[</span><span class="n">unicountvals</span><span class="p">]</span> <span class="c1">#avoid n=0 nans  </span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>        <span class="n">Nmtr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Nvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Mvec</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">+</span><span class="n">logNvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">-</span><span class="n">Mvec</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="c1"># np.log(Mvec) throws warning: since log(0)=-inf</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>        <span class="k">if</span> <span class="n">Mvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>            <span class="n">Nmtr</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlen</span><span class="p">,))</span> <span class="c1">#when m=0, n=0, and so get rid of nans from log(0)</span>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>            <span class="n">Nmtr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span> <span class="c1">#handled belowacq_model_type</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>        <span class="k">if</span> <span class="n">unicountvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#if n=0 included get rid of nans from log(0)</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>            <span class="n">Nmtr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Mvec</span><span class="p">)</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>        <span class="k">return</span> <span class="n">Nmtr</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>    <span class="k">def</span> <span class="nf">_get_rhof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alpha_rho</span><span class="p">,</span> <span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">):</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a><span class="sd">        generates power law (power is alpha_rho) clone frequency distribution over </span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a><span class="sd">        freq_nbins discrete logarithmically spaced frequences between fmin and 1 of dtype freq_dtype</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a><span class="sd">        Outputs log probabilities obtained at log frequencies&#39;&#39;&#39;</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>        <span class="n">fmax</span><span class="o">=</span><span class="mf">1e0</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span> <span class="n">nfbins</span><span class="p">)</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">logfvec</span><span class="p">))</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>        <span class="n">logrhovec</span><span class="o">=</span><span class="n">logfvec</span><span class="o">*</span><span class="n">alpha_rho</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhovec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>        <span class="n">normconst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>        <span class="n">logrhovec</span><span class="o">-=</span><span class="n">normconst</span> 
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>        <span class="k">return</span> <span class="n">logrhovec</span><span class="p">,</span><span class="n">logfvec</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>    
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>    <span class="k">def</span> <span class="nf">_get_logPn_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unicounts</span><span class="p">,</span><span class="n">Nreads</span><span class="p">,</span><span class="n">logfvec</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">):</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a><span class="sd">        tools to compute the likelihood of the noise model. It is not useful for the user.</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>        
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>        <span class="c1"># Choice of the model:</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>        
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>            <span class="n">m_total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> 
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>            <span class="n">r_c</span><span class="o">=</span><span class="n">Nreads</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>            <span class="n">beta_mv</span><span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>            <span class="n">alpha_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>            
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#for models that include cell counts</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>            <span class="c1">#compute parametrized range (mean-sigma,mean+5*sigma) of m values (number of cells) conditioned on n values (reads) appearing in the data only </span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>            <span class="n">nsigma</span><span class="o">=</span><span class="mf">5.</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>            <span class="n">nmin</span><span class="o">=</span><span class="mf">300.</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>            <span class="c1">#for each n, get actual range of m to compute around n-dependent mean m</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>            <span class="n">m_low</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>            <span class="n">m_high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>            <span class="k">for</span> <span class="n">nit</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unicounts</span><span class="p">):</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>                <span class="n">mean_m</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">r_c</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>                <span class="n">dev</span><span class="o">=</span><span class="n">nsigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_m</span><span class="p">)</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>                <span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span> <span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mean_m</span><span class="o">-</span>  <span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">mean_m</span><span class="o">&gt;</span><span class="n">dev</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>                         
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>                <span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mean_m</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span>      <span class="n">n</span><span class="o">&gt;</span><span class="n">nmin</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">nmin</span><span class="o">/</span><span class="n">r_c</span><span class="p">)</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>            <span class="n">m_cellmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">m_high</span><span class="p">)</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>            <span class="c1">#across n, collect all in-range m</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>            <span class="n">mvec_bool</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m_cellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1">#cheap bool</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>            <span class="n">nvec</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">))</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>            <span class="k">for</span> <span class="n">nit</span> <span class="ow">in</span> <span class="n">nvec</span><span class="p">:</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>                <span class="n">mvec_bool</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>  <span class="c1">#mask vector</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>            <span class="n">mvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_cellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">mvec_bool</span><span class="p">]</span>                
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>            <span class="c1">#transform to in-range index</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>            <span class="k">for</span> <span class="n">nit</span> <span class="ow">in</span> <span class="n">nvec</span><span class="p">:</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>                <span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">==</span><span class="n">mvec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>                <span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">==</span><span class="n">mvec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>        <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">)))</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>            <span class="n">mean_m</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>            <span class="n">var_m</span><span class="o">=</span><span class="n">mean_m</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_m</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>            <span class="n">Poisvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PoisPar</span><span class="p">(</span><span class="n">mvec</span><span class="o">*</span><span class="n">r_c</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>            <span class="k">for</span> <span class="n">f_it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)):</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>                <span class="n">NBvec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_NegBinPar</span><span class="p">(</span><span class="n">mean_m</span><span class="p">[</span><span class="n">f_it</span><span class="p">],</span><span class="n">var_m</span><span class="p">[</span><span class="n">f_it</span><span class="p">],</span><span class="n">mvec</span><span class="p">)</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>                <span class="k">for</span> <span class="n">n_it</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unicounts</span><span class="p">):</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">f_it</span><span class="p">,</span><span class="n">n_it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">NBvec</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">n_it</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">n_it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Poisvec</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">n_it</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">n_it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n_it</span><span class="p">])</span> 
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>        
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>        <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>            <span class="n">mean_n</span><span class="o">=</span><span class="n">Nreads</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>            <span class="n">var_n</span><span class="o">=</span><span class="n">mean_n</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>            <span class="n">Pn_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NegBinParMtr</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">var_n</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>        <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a>            <span class="n">mean_n</span><span class="o">=</span><span class="n">Nreads</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a>            <span class="n">Pn_f</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PoisPar</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1,or 2 only&#39;</span><span class="p">)</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn_f</span><span class="p">)</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>    <span class="k">def</span> <span class="nf">_get_Ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alp</span><span class="p">,</span><span class="n">sbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">stp</span><span class="p">):</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a><span class="sd">        generates symmetric exponential distribution over log fold change</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a><span class="sd">        with effect size sbar and nonresponding fraction 1-alp at s=0.</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a><span class="sd">        computed over discrete range of s from -smax to smax in steps of size stp</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>        <span class="n">lamb</span><span class="o">=-</span><span class="n">stp</span><span class="o">/</span><span class="n">sbar</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>        <span class="n">smaxt</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">stp</span><span class="p">)</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a>        <span class="n">s_zeroind</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">smaxt</span><span class="p">)</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>        <span class="n">Z</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">smaxt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">lamb</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>        <span class="n">Ps</span><span class="o">=</span><span class="n">alp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lamb</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">smaxt</span><span class="p">,</span><span class="n">smaxt</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="n">Z</span>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>        <span class="n">Ps</span><span class="p">[</span><span class="n">s_zeroind</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alp</span><span class="p">)</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>        <span class="k">return</span> <span class="n">Ps</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>    <span class="k">def</span> <span class="nf">_callbackFdiffexpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Xi</span><span class="p">):</span> <span class="c1">#case dependent</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>        <span class="sd">&#39;&#39;&#39;prints iteration info. called scipy.minimize&#39;&#39;&#39;</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>               
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: 3.6f}</span><span class="s1">   </span><span class="si">{1: 3.6f}</span><span class="s1">   &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Xi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Xi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>   
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>    
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a>    <span class="k">def</span> <span class="nf">_learning_dynamics_expansion_polished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span>  <span class="n">noise_model</span><span class="p">):</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a><span class="sd">        function to infer the expansion mode parameters - not usable by the user.</span>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a>        <span class="n">alpha_rho</span> <span class="o">=</span> <span class="n">paras_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span> <span class="c1">#Accuracy of the integration</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span> <span class="o">=</span> <span class="n">get_rhof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha_rho</span><span class="p">,</span> <span class="n">nfbins</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>        <span class="c1">#Definition of svec</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>        <span class="n">smax</span> <span class="o">=</span> <span class="mf">25.0</span>     <span class="c1">#maximum absolute logfold change value</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>        <span class="n">s_step</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>        <span class="n">s_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>        
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>        <span class="n">s_step_old</span><span class="o">=</span> <span class="n">s_step</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>        <span class="n">logf_step</span><span class="o">=</span> <span class="n">logfvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">logfvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#use natural log here since f2 increments in increments in exp().  </span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>        <span class="n">f2s_step</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_step</span><span class="o">/</span><span class="n">logf_step</span><span class="p">))</span> <span class="c1">#rounded number of f-steps in one s-step</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>        <span class="n">s_step</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f2s_step</span><span class="p">)</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>        <span class="n">smax</span><span class="o">=</span> <span class="n">s_step</span><span class="o">*</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">s_step_old</span><span class="p">)</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>        <span class="n">svec</span><span class="o">=</span> <span class="n">s_step</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">s_step</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>   
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>        <span class="n">svec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">svec</span><span class="p">[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">svec</span><span class="p">)</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>        <span class="n">smaxind</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">svec</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>        <span class="n">f2s_step</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_step</span><span class="o">/</span><span class="n">logf_step</span><span class="p">))</span> <span class="c1">#rounded number of f-steps in one s-step</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>        <span class="n">logfmin</span><span class="o">=</span><span class="n">logfvec</span><span class="p">[</span><span class="mi">0</span> <span class="p">]</span><span class="o">-</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>        <span class="n">logfmax</span><span class="o">=</span><span class="n">logfvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>        
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>        <span class="n">logfvecwide</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">logfmin</span><span class="p">,</span><span class="n">logfmax</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">f2s_step</span><span class="p">)</span> <span class="c1">#a wider domain for the second frequency f2=f1*exp(s)</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>            
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>        <span class="c1"># Compute P(n1|f) and P(n2|f), each in an iteration of the following loop</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>                <span class="n">unicounts</span><span class="o">=</span><span class="n">unicountvals_1</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a>                <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>                <span class="n">Nreads</span> <span class="o">=</span> <span class="n">NreadsI</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a>                <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_1</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>                <span class="n">unicounts</span><span class="o">=</span><span class="n">unicountvals_2</span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>                <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvecwide</span><span class="p">)</span> <span class="c1">#contains s-shift for sampled data method</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>                <span class="n">Nreads</span> <span class="o">=</span> <span class="n">NreadsII</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>                <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_2</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>                <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span> <span class="n">unicounts</span><span class="p">,</span> <span class="n">Nreads</span><span class="p">,</span> <span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>                <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicounts</span><span class="p">,</span> <span class="n">Nreads</span><span class="p">,</span> <span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>        <span class="c1">#for the trapezoid method</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> 
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a>        <span class="c1"># Computing P(n1,n2|f,s)</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>        <span class="n">Pn1n2_s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">svec</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">)))</span> 
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>        <span class="k">for</span> <span class="n">s_it</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svec</span><span class="p">):</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>            <span class="k">for</span> <span class="n">it</span><span class="p">,(</span><span class="n">n1_it</span><span class="p">,</span> <span class="n">n2_it</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">)):</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a>                <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span><span class="o">+</span><span class="n">logPn2_f</span><span class="p">[</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="p">:(</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)),</span><span class="n">n2_it</span><span class="p">]</span><span class="o">+</span><span class="n">logPn1_f</span><span class="p">[:,</span><span class="n">n1_it</span><span class="p">]</span><span class="o">+</span> <span class="n">logfvec</span> <span class="p">)</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a>                <span class="n">Pn1n2_s</span><span class="p">[</span><span class="n">s_it</span><span class="p">,</span> <span class="n">n1_it</span><span class="p">,</span> <span class="n">n2_it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>            
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a>    
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>        <span class="n">Pn0n0_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">svec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>        <span class="k">for</span> <span class="n">s_it</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svec</span><span class="p">):</span>    
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>            <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logPn2_f</span><span class="p">[</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="p">:(</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)),</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logrhofvec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a>            <span class="n">Pn0n0_s</span><span class="p">[</span><span class="n">s_it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a>            
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a>    
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>        <span class="n">N_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;N_obs: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_obs</span><span class="p">))</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>    
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>            
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>        <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">PARAS</span><span class="p">):</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>            <span class="n">alp</span> <span class="o">=</span> <span class="n">PARAS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>            <span class="n">sbar</span> <span class="o">=</span> <span class="n">PARAS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>            <span class="n">Ps</span> <span class="o">=</span> <span class="n">_get_Ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alp</span><span class="p">,</span><span class="n">sbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">s_step</span><span class="p">)</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>            <span class="n">Pn0n0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Pn0n0_s</span><span class="p">,</span><span class="n">Ps</span><span class="p">)</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a>            <span class="n">Pn1n2_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pn1n2_s</span><span class="o">*</span><span class="n">Ps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a>            <span class="n">Pn1n2_ps</span><span class="o">/=</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn0n0</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Pn0n0</span><span class="p">)</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>       
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>            <span class="n">Energy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">N_obs</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">]),</span><span class="mi">0</span><span class="p">))</span> 
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>                
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>            <span class="k">return</span> <span class="n">Energy</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>    <span class="c1">#--------------------------Compute-the-grid-----------------------------------------</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>        
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculation Surface : </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>        <span class="n">npoints</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#to be chosen by the user </span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>        <span class="n">alpvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.99</span><span class="p">),</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>        <span class="n">sbarvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>        <span class="n">LSurface</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sbarvec</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">alpvec</span><span class="p">)))</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sbarvec</span><span class="p">)):</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpvec</span><span class="p">)):</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>                <span class="n">LSurface</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">=</span>  <span class="o">-</span> <span class="n">cost</span><span class="p">([</span><span class="n">alpvec</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sbarvec</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>        
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>        <span class="n">alpmesh</span><span class="p">,</span> <span class="n">sbarmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">alpvec</span><span class="p">,</span> <span class="n">sbarvec</span><span class="p">)</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LSurface</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LSurface</span><span class="p">))</span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>    
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a>    
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a>    <span class="c1">#------------------------------Optimization----------------------------------------------</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>        
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>        <span class="n">optA</span> <span class="o">=</span> <span class="n">alpmesh</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>        <span class="n">optB</span> <span class="o">=</span> <span class="n">sbarmesh</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>                  
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;polish parameter estimate from &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">optA</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">optB</span><span class="p">))</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>        <span class="n">initparas</span><span class="o">=</span><span class="p">(</span><span class="n">optA</span><span class="p">,</span><span class="n">optB</span><span class="p">)</span>  
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>    
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>        <span class="n">outstruct</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">initparas</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">_callbackFdiffexpr</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ftol&#39;</span><span class="p">:</span><span class="mf">1e-8</span> <span class="p">,</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mi">300</span><span class="p">})</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>        <span class="k">return</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">Pn1n2_s</span><span class="p">,</span> <span class="n">Pn0n0_s</span><span class="p">,</span> <span class="n">svec</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>    <span class="k">def</span> <span class="nf">_learning_dynamics_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">display_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a><span class="sd">        function to infer the expansion mode parameters - not usable by the user.</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>        <span class="n">alpha_rho</span> <span class="o">=</span> <span class="n">paras_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span> <span class="c1">#Accuracy of the integration</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rhof</span><span class="p">(</span><span class="n">alpha_rho</span><span class="p">,</span> <span class="n">nfbins</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>        <span class="c1">#Definition of svec</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>        <span class="n">smax</span> <span class="o">=</span> <span class="mf">25.0</span>     <span class="c1">#maximum absolute logfold change value</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>        <span class="n">s_step</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>        <span class="n">s_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>        
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>        <span class="n">s_step_old</span><span class="o">=</span> <span class="n">s_step</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>        <span class="n">logf_step</span><span class="o">=</span> <span class="n">logfvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">logfvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#use natural log here since f2 increments in increments in exp().  </span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>        <span class="n">f2s_step</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_step</span><span class="o">/</span><span class="n">logf_step</span><span class="p">))</span> <span class="c1">#rounded number of f-steps in one s-step</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>        <span class="n">s_step</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f2s_step</span><span class="p">)</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>        <span class="n">smax</span><span class="o">=</span> <span class="n">s_step</span><span class="o">*</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">s_step_old</span><span class="p">)</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>        <span class="n">svec</span><span class="o">=</span> <span class="n">s_step</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">s_step</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>   
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>        <span class="n">svec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">svec</span><span class="p">[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">svec</span><span class="p">)</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>        <span class="n">smaxind</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">svec</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>        <span class="n">f2s_step</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_step</span><span class="o">/</span><span class="n">logf_step</span><span class="p">))</span> <span class="c1">#rounded number of f-steps in one s-step</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>        <span class="n">logfmin</span><span class="o">=</span><span class="n">logfvec</span><span class="p">[</span><span class="mi">0</span> <span class="p">]</span><span class="o">-</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>        <span class="n">logfmax</span><span class="o">=</span><span class="n">logfvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>        
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a>        <span class="n">logfvecwide</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">logfmin</span><span class="p">,</span><span class="n">logfmax</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">f2s_step</span><span class="p">))</span> <span class="c1">#a wider domain for the second frequency f2=f1*exp(s)</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>            
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>        <span class="c1"># Compute P(n1|f) and P(n2|f), each in an iteration of the following loop</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>                <span class="n">unicounts</span><span class="o">=</span><span class="n">unicountvals_1</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>                <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>                <span class="n">Nreads</span> <span class="o">=</span> <span class="n">NreadsI</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>                <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_1</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>                <span class="n">unicounts</span><span class="o">=</span><span class="n">unicountvals_2</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>                <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvecwide</span><span class="p">)</span> <span class="c1">#contains s-shift for sampled data method</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>                <span class="n">Nreads</span> <span class="o">=</span> <span class="n">NreadsII</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>                <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_2</span>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>                <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicounts</span><span class="p">,</span> <span class="n">Nreads</span><span class="p">,</span> <span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>                <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicounts</span><span class="p">,</span> <span class="n">Nreads</span><span class="p">,</span> <span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a>        <span class="c1">#for the trapezoid method</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> 
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>        <span class="c1"># Computing P(n1,n2|f,s)</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>        <span class="n">Pn1n2_s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">svec</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">)))</span> 
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>        <span class="k">for</span> <span class="n">s_it</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svec</span><span class="p">):</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>            <span class="k">for</span> <span class="n">it</span><span class="p">,(</span><span class="n">n1_it</span><span class="p">,</span> <span class="n">n2_it</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">)):</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>                <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span><span class="o">+</span><span class="n">logPn2_f</span><span class="p">[</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="p">:(</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)),</span><span class="n">n2_it</span><span class="p">]</span><span class="o">+</span><span class="n">logPn1_f</span><span class="p">[:,</span><span class="n">n1_it</span><span class="p">]</span><span class="o">+</span> <span class="n">logfvec</span> <span class="p">)</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>                <span class="n">Pn1n2_s</span><span class="p">[</span><span class="n">s_it</span><span class="p">,</span> <span class="n">n1_it</span><span class="p">,</span> <span class="n">n2_it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>            
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>    
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>        <span class="n">Pn0n0_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">svec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>        <span class="k">for</span> <span class="n">s_it</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svec</span><span class="p">):</span>    
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>            <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logPn2_f</span><span class="p">[</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="p">:(</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)),</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logrhofvec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>            <span class="n">Pn0n0_s</span><span class="p">[</span><span class="n">s_it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>            
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>   
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>        <span class="n">N_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;N_obs: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_obs</span><span class="p">))</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>    
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>            
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>        <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">PARAS</span><span class="p">):</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>            <span class="n">alp</span> <span class="o">=</span> <span class="n">PARAS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>            <span class="n">sbar</span> <span class="o">=</span> <span class="n">PARAS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>            <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Ps</span><span class="p">(</span><span class="n">alp</span><span class="p">,</span><span class="n">sbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">s_step</span><span class="p">)</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>            <span class="n">Pn0n0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Pn0n0_s</span><span class="p">,</span><span class="n">Ps</span><span class="p">)</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>            <span class="n">Pn1n2_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pn1n2_s</span><span class="o">*</span><span class="n">Ps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>            <span class="n">Pn1n2_ps</span><span class="o">/=</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn0n0</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>            <span class="c1">#print(Pn0n0)</span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>       
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>            <span class="n">Energy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">N_obs</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">]),</span><span class="mi">0</span><span class="p">))</span> 
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>                
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>            <span class="k">return</span> <span class="n">Energy</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>    <span class="c1">#--------------------------Compute-the-grid-----------------------------------------</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>        
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculation Surface : </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a>        <span class="n">npoints</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1">#to be chosen by the user </span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a>        <span class="n">alpvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.99</span><span class="p">),</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>        <span class="n">sbarvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>        <span class="n">LSurface</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sbarvec</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">alpvec</span><span class="p">)))</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sbarvec</span><span class="p">)):</span>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpvec</span><span class="p">)):</span>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>                <span class="n">LSurface</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">=</span>  <span class="o">-</span> <span class="n">cost</span><span class="p">([</span><span class="n">alpvec</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sbarvec</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>        
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>        <span class="n">alpmesh</span><span class="p">,</span> <span class="n">sbarmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">alpvec</span><span class="p">,</span> <span class="n">sbarvec</span><span class="p">)</span>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LSurface</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LSurface</span><span class="p">))</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>    
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>    <span class="c1">#---------------------------Plot-the-grid-------------------------------------------</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>        <span class="k">if</span> <span class="n">display_plot</span><span class="p">:</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>         
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LSurface</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LSurface</span><span class="p">))</span>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">alpmesh</span><span class="p">,</span> <span class="n">sbarmesh</span><span class="p">,</span> <span class="n">LSurface</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">)</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">alpmesh</span><span class="p">,</span> <span class="n">sbarmesh</span><span class="p">,</span> <span class="n">LSurface</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>            <span class="n">xmax</span> <span class="o">=</span> <span class="n">alpmesh</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>            <span class="n">ymax</span> <span class="o">=</span> <span class="n">sbarmesh</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>            <span class="n">text</span><span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$ alpha=</span><span class="si">{:.3f}</span><span class="s2">, s=</span><span class="si">{:.3f}</span><span class="s2"> $&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a>            <span class="n">bbox_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;square,pad=0.3&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.72</span><span class="p">)</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span><span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle,angleA=0,angleB=80&quot;</span><span class="p">)</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>                <span class="n">arrowprops</span><span class="o">=</span><span class="n">arrowprops</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox_props</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.94</span><span class="p">,</span><span class="mf">0.96</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ \alpha, \ size \ of \ the \ repertoire \ that \ answers \ to \ the \ vaccine $&#39;</span><span class="p">)</span> 
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ s_</span><span class="si">{bar}</span><span class="s1">, \ characteristic \ expansion \ decrease $&#39;</span><span class="p">)</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$Grid \ Search \ graph \ for \ \alpha \ and \ s_</span><span class="si">{bar}</span><span class="s1"> \ parameters. $&#39;</span><span class="p">)</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>        <span class="k">return</span> <span class="n">LSurface</span><span class="p">,</span> <span class="n">Pn1n2_s</span><span class="p">,</span> <span class="n">Pn0n0_s</span><span class="p">,</span> <span class="n">svec</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a> 
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>    <span class="k">def</span> <span class="nf">_save_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">svec</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span><span class="n">Pn1n2_s</span><span class="p">,</span> <span class="n">Pn0n0_s</span><span class="p">,</span>  <span class="n">subset</span><span class="p">,</span> <span class="n">unicountvals_1_d</span><span class="p">,</span> <span class="n">unicountvals_2_d</span><span class="p">,</span> <span class="n">indn1_d</span><span class="p">,</span> <span class="n">indn2_d</span><span class="p">,</span> <span class="n">print_expanded</span><span class="p">,</span> <span class="n">pthresh</span><span class="p">,</span> <span class="n">smedthresh</span><span class="p">):</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a><span class="sd">        takes learned diffexpr model, Pn1n2_s*Ps, computes posteriors over (n1,n2) pairs, and writes to file a table of data with clones as rows and columns as measures of thier posteriors </span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a><span class="sd">        print_expanded=True orders table as ascending by , else descending</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a><span class="sd">        pthresh is the threshold in &#39;p-value&#39;-like (null hypo) probability, 1-P(s&gt;0|n1_i,n2_i), where i is the row (i.e. the clone) n.b. lower null prob implies larger probability of expansion</span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a><span class="sd">        smedthresh is the threshold on the posterior median, below which clones are discarded</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a><span class="sd">        not usable by the user. </span>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>        <span class="n">Psn1n2_ps</span><span class="o">=</span><span class="n">Pn1n2_s</span><span class="o">*</span><span class="n">Ps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> 
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>    
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a>        <span class="c1">#compute marginal likelihood (neglect renormalization , since it cancels in conditional below) </span>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>        <span class="n">Pn1n2_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Psn1n2_ps</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a>        <span class="n">Ps_n1n2ps</span><span class="o">=</span><span class="n">Pn1n2_s</span><span class="o">*</span><span class="n">Ps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">/</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a>        <span class="c1">#compute cdf to get p-value to threshold on to reduce output size</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>        <span class="n">cdfPs_n1n2ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Ps_n1n2ps</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>    
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a>        <span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">cdfPs_n1n2ps</span><span class="p">,</span><span class="n">unicountvals_1_d</span><span class="p">,</span><span class="n">unicountvals_2_d</span><span class="p">):</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>            <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a><span class="sd">            when applied to dataframe, generates &#39;p-value&#39;-like (null hypo) probability, 1-P(s&gt;0|n1_i,n2_i), where i is the row (i.e. the clone)</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a><span class="sd">            &#39;&#39;&#39;</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a>            <span class="k">return</span> <span class="n">cdfPs_n1n2ps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">svec</span><span class="p">)),</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">unicountvals_1_d</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">unicountvals_2_d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a>        <span class="n">dummy_part</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="n">cdfPs_n1n2ps</span><span class="o">=</span><span class="n">cdfPs_n1n2ps</span><span class="p">,</span><span class="n">unicountvals_1_d</span><span class="o">=</span><span class="n">unicountvals_1_d</span><span class="p">,</span><span class="n">unicountvals_2_d</span><span class="o">=</span><span class="n">unicountvals_2_d</span><span class="p">)</span>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a>    
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a>        <span class="n">cdflabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$1-P(s&gt;0)$&#39;</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a>        <span class="n">subset</span><span class="p">[</span><span class="n">cdflabel</span><span class="p">]</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">dummy_part</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>        <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="n">cdflabel</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pthresh</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>        <span class="c1">#go from clone count pair (n1,n2) to index in unicountvals_1_d and unicountvals_2_d</span>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a>        <span class="n">data_pairs_ind_1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a>        <span class="n">data_pairs_ind_2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)):</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a>            <span class="n">data_pairs_ind_1</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="p">)</span><span class="o">==</span><span class="n">unicountvals_1_d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a>            <span class="n">data_pairs_ind_2</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="p">)</span><span class="o">==</span><span class="n">unicountvals_2_d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>   
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a>        <span class="c1">#posteriors over data clones</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>        <span class="n">Ps_n1n2ps_datpairs</span><span class="o">=</span><span class="n">Ps_n1n2ps</span><span class="p">[:,</span><span class="n">data_pairs_ind_1</span><span class="p">,</span><span class="n">data_pairs_ind_2</span><span class="p">]</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>    
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>        <span class="c1">#compute posterior metrics</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>        <span class="n">mean_est</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>        <span class="n">max_est</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>        <span class="n">slowvec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>        <span class="n">smedvec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a>        <span class="n">shighvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a>        <span class="n">pval</span><span class="o">=</span><span class="mf">0.025</span> <span class="c1">#double-sided comparison statistical test</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>        <span class="n">pvalvec</span><span class="o">=</span><span class="p">[</span><span class="n">pval</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">pval</span><span class="p">]</span> <span class="c1">#bound criteria defining slow, smed, and shigh, respectively</span>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ps_n1n2ps_datpairs</span><span class="p">)):</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a>            <span class="n">mean_est</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">svec</span><span class="o">*</span><span class="n">column</span><span class="p">)</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a>            <span class="n">max_est</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">svec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">column</span><span class="p">)]</span>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>            <span class="n">forwardcmf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>            <span class="n">backwardcmf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">column</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">forwardcmf</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">forwardcmf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">&gt;=</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a>            <span class="n">slowvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">svec</span><span class="p">[</span><span class="n">inds</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)])</span>  <span class="c1">#use mean in case there are two values</span>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a>            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">forwardcmf</span><span class="o">&gt;=</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">backwardcmf</span><span class="o">&gt;=</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a>            <span class="n">smedvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">svec</span><span class="p">[</span><span class="n">inds</span><span class="p">])</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a>            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">forwardcmf</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">forwardcmf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">&gt;=</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a>            <span class="n">shighvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">svec</span><span class="p">[</span><span class="n">inds</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)])</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a>    
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a>        <span class="n">colnames</span><span class="o">=</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\bar</span><span class="si">{s}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$s_</span><span class="si">{max}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$s_{3,high}$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$s_{2,med}$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$s_{1,low}$&#39;</span><span class="p">)</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">coldata</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="n">mean_est</span><span class="p">,</span><span class="n">max_est</span><span class="p">,</span><span class="n">shighvec</span><span class="p">,</span><span class="n">smedvec</span><span class="p">,</span><span class="n">slowvec</span><span class="p">)):</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a>            <span class="n">subset</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colnames</span><span class="p">[</span><span class="n">it</span><span class="p">],</span><span class="n">coldata</span><span class="p">)</span>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a>        <span class="n">oldcolnames</span><span class="o">=</span><span class="p">(</span> <span class="s1">&#39;AACDR3&#39;</span><span class="p">,</span>  <span class="s1">&#39;ntCDR3&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_fraction_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_fraction_2&#39;</span><span class="p">)</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a>        <span class="n">newcolnames</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;CDR3_AA&#39;</span><span class="p">,</span> <span class="s1">&#39;CDR3_nt&#39;</span><span class="p">,</span>        <span class="sa">r</span><span class="s1">&#39;$n_1$&#39;</span><span class="p">,</span>        <span class="sa">r</span><span class="s1">&#39;$n_2$&#39;</span><span class="p">,</span>           <span class="sa">r</span><span class="s1">&#39;$f_1$&#39;</span><span class="p">,</span>           <span class="sa">r</span><span class="s1">&#39;$f_2$&#39;</span><span class="p">)</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a>        <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">oldcolnames</span><span class="p">,</span> <span class="n">newcolnames</span><span class="p">)))</span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a>    
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a>        <span class="c1">#select only clones whose posterior median pass the given threshold</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a>        <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$s_{2,med}$&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">smedthresh</span><span class="p">]</span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a>    
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing to: &quot;</span><span class="o">+</span><span class="n">outpath</span><span class="p">)</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a>        <span class="k">if</span> <span class="n">print_expanded</span><span class="p">:</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a>            <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">cdflabel</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a>            <span class="n">strout</span><span class="o">=</span><span class="s1">&#39;expanded&#39;</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a>            <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">cdflabel</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a>            <span class="n">strout</span><span class="o">=</span><span class="s1">&#39;contracted&#39;</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a>        <span class="n">subset</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outpath</span><span class="o">+</span><span class="s1">&#39;top_&#39;</span><span class="o">+</span><span class="n">strout</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a>    <span class="k">def</span> <span class="nf">expansion_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">pval_threshold</span><span class="p">,</span> <span class="n">smed_threshold</span><span class="p">):</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a><span class="sd">        generate the table of clones that have been significantly detected to be responsive to an acute stimuli.    </span>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a><span class="sd">    </span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a><span class="sd">        Parameters</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a><span class="sd">        ----------</span>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a><span class="sd">        outpath  : str</span>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a><span class="sd">            Name of the directory where to store the output table</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a><span class="sd">        paras_1  : numpy array</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a><span class="sd">            parameters of the noise model that has been learned at time_1</span>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a><span class="sd">        paras_2  : numpy array</span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a><span class="sd">            parameters of the noise model that has been learned at time_2</span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a><span class="sd">        df       : pandas dataframe </span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a><span class="sd">            pandas dataframe merging the two RepSeq data at time_1 and time_2</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a><span class="sd">        noise_model : int</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a><span class="sd">            choice of noise model 0: Poisson, 1: negative Binomial, 2: negative Binomial + Poisson  </span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a><span class="sd">        pval_threshold : float</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a><span class="sd">            P-value threshold to detect and discriminate if a TCR clone has expanded </span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a><span class="sd">        smed_threshold : float</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a><span class="sd">            median of the log-fold change threshold to detect if a TCR clone has expanded </span>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a><span class="sd">        Returns</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a><span class="sd">        -------</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a><span class="sd">        data-frame - csv file</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a><span class="sd">            the output is a csv file of columns : $s_{1-low}$, $s_{2-med}$, $s_{3-high}$, $s_{max}$, $\bar{s}$, $f_1$, $f_2$, $n_1$, $n_2$, &#39;CDR3_nt&#39;, &#39;CDR3_AA&#39; and &#39;$p$-value&#39;</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>        <span class="n">L_surface</span><span class="p">,</span> <span class="n">Pn1n2_s_d</span><span class="p">,</span> <span class="n">Pn0n0_s_d</span><span class="p">,</span> <span class="n">svec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_dynamics_expansion</span><span class="p">(</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">)</span>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>        <span class="n">npoints</span><span class="o">=</span> <span class="mi">50</span> <span class="c1"># same as in learning_dynamics_expansion</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>        <span class="n">smax</span> <span class="o">=</span> <span class="mf">25.0</span>     
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>        <span class="n">s_step</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a>        <span class="n">alpvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.99</span><span class="p">),</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a>        <span class="n">sbarvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a>        <span class="n">maxinds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">L_surface</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">L_surface</span><span class="p">))</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a>        <span class="n">optsbar</span><span class="o">=</span><span class="n">sbarvec</span><span class="p">[</span><span class="n">maxinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>        <span class="n">optalp</span><span class="o">=</span><span class="n">alpvec</span><span class="p">[</span><span class="n">maxinds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>        <span class="n">optPs</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Ps</span><span class="p">(</span><span class="n">optalp</span><span class="p">,</span><span class="n">optsbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">s_step</span><span class="p">)</span>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>        <span class="n">pval_expanded</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_table</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">svec</span><span class="p">,</span> <span class="n">optPs</span><span class="p">,</span> <span class="n">Pn1n2_s_d</span><span class="p">,</span> <span class="n">Pn0n0_s_d</span><span class="p">,</span>  <span class="n">df</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">pval_expanded</span><span class="p">,</span> <span class="n">pval_threshold</span><span class="p">,</span> <span class="n">smed_threshold</span><span class="p">)</span>
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a><span class="c1">#============================================Generate Synthetic Data =============================================================</span>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a><span class="k">class</span> <span class="nc">Generator</span><span class="p">:</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a><span class="sd">    A class used to build an object to generate in-Silico (synthetic) RepSeq samples, in the case of replicates at</span>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a><span class="sd">    the same day and in the case of having 2 samples generated at an initial time for the first one and some time after (months, years)</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a><span class="sd">    for the second one using the geometric Brownian motion model decribed in https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1.</span>
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a><span class="sd">    ...</span>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a><span class="sd">    Methods</span>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a><span class="sd">    -------</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a><span class="sd">    gen_synthetic_data_Null(paras, noise_model, NreadsI,NreadsII,Nsamp):</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a><span class="sd">        generate in-silico same day RepSeq replicates.</span>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a><span class="sd">    generate_trajectories(tau, theta, method, paras_1, paras_2, t_ime, filename, NreadsI = &#39;1e6&#39;, NreadsII = &#39;1e6&#39;):</span>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a><span class="sd">        generate in-silico t_ime apart RepSeq samples.</span>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a>    <span class="k">def</span> <span class="nf">_get_rhof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha_rho</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">freq_nbins</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">freq_dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">):</span>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a><span class="sd">        generates power law (power is alpha_rho) clone frequency distribution over </span>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a><span class="sd">        freq_nbins discrete logarithmically spaced frequences between fmin and 1 of dtype freq_dtype</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a><span class="sd">        Outputs log probabilities obtained at log frequencies&#39;&#39;&#39;</span>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>        <span class="n">fmax</span><span class="o">=</span><span class="mf">1e0</span>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span><span class="n">freq_nbins</span><span class="p">)</span>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">logfvec</span><span class="p">))</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a>        <span class="n">logrhovec</span><span class="o">=</span><span class="n">logfvec</span><span class="o">*</span><span class="n">alpha_rho</span>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhovec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>        <span class="n">normconst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>        <span class="n">logrhovec</span><span class="o">-=</span><span class="n">normconst</span> 
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>        <span class="k">return</span> <span class="n">logrhovec</span><span class="p">,</span><span class="n">logfvec</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>    <span class="k">def</span> <span class="nf">_get_distsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmf</span><span class="p">,</span><span class="n">Nsamp</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint32&#39;</span><span class="p">):</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a><span class="sd">        generates Nsamp index samples of dtype (e.g. uint16 handles up to 65535 indices) from discrete probability mass function pmf.</span>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a><span class="sd">        Handles multi-dimensional domain. N.B. Output is sorted.</span>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a>        <span class="c1">#assert np.sum(pmf)==1, &quot;cmf not normalized!&quot;</span>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a>    
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>        <span class="n">sortindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pmf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="c1">#uses flattened array</span>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>        <span class="n">pmf</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>        <span class="n">pmf</span> <span class="o">=</span> <span class="n">pmf</span><span class="p">[</span><span class="n">sortindex</span><span class="p">]</span>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>        <span class="n">cmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>        <span class="n">choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">high</span> <span class="o">=</span> <span class="n">cmf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">)))</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cmf</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">sortindex</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>        <span class="n">sampled_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">index</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])],</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>        <span class="k">return</span> <span class="n">sampled_inds</span>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a>    
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>    <span class="k">def</span> <span class="nf">gen_synthetic_data_Null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span><span class="p">,</span><span class="n">Nsamp</span><span class="p">):</span>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a><span class="sd">        outputs an array of observed clone frequencies and corresponding dataframe of pair counts</span>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a><span class="sd">        for a null model learned from a dataset pair with NreadsI and NreadsII number of reads, respectively.</span>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a><span class="sd">        Crucial for RAM efficiency, sampling is conditioned on being observed in each of the three (n,0), (0,n&#39;), and n,n&#39;&gt;0 conditions</span>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a><span class="sd">        so that only Nsamp clones need to be sampled, rather than the N clones in the repertoire.</span>
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a><span class="sd">        Note that no explicit normalization is applied. It is assumed that the values in paras are consistent with N&lt;f&gt;=1 </span>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a><span class="sd">        (e.g. were obtained through the learning done in this package).</span>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a>    
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#power law exponent</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>        <span class="n">fmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a>            <span class="n">m_total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> 
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a>            <span class="n">r_c1</span><span class="o">=</span><span class="n">NreadsI</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a>            <span class="n">r_c2</span><span class="o">=</span><span class="n">NreadsII</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="L-2588"><a href="#L-2588"><span class="linenos">2588</span></a>            <span class="n">r_cvec</span><span class="o">=</span><span class="p">[</span><span class="n">r_c1</span><span class="p">,</span><span class="n">r_c2</span><span class="p">]</span>
</span><span id="L-2589"><a href="#L-2589"><span class="linenos">2589</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2590"><a href="#L-2590"><span class="linenos">2590</span></a>            <span class="n">beta_mv</span><span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2591"><a href="#L-2591"><span class="linenos">2591</span></a>            <span class="n">alpha_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-2592"><a href="#L-2592"><span class="linenos">2592</span></a>    
</span><span id="L-2593"><a href="#L-2593"><span class="linenos">2593</span></a>        <span class="n">logrhofvec</span><span class="p">,</span><span class="n">logfvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">fmin</span><span class="p">)</span>
</span><span id="L-2594"><a href="#L-2594"><span class="linenos">2594</span></a>        <span class="n">fvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2595"><a href="#L-2595"><span class="linenos">2595</span></a>        <span class="n">dlogf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
</span><span id="L-2596"><a href="#L-2596"><span class="linenos">2596</span></a>    
</span><span id="L-2597"><a href="#L-2597"><span class="linenos">2597</span></a>        <span class="c1">#generate measurement model distribution, Pn_f</span>
</span><span id="L-2598"><a href="#L-2598"><span class="linenos">2598</span></a>        <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span> <span class="c1">#len(logfvec) samplers</span>
</span><span id="L-2599"><a href="#L-2599"><span class="linenos">2599</span></a>    
</span><span id="L-2600"><a href="#L-2600"><span class="linenos">2600</span></a>        <span class="c1">#get value at n=0 to use for conditioning on n&gt;0 (and get full Pn_f here if noise_model=1,2)</span>
</span><span id="L-2601"><a href="#L-2601"><span class="linenos">2601</span></a>        <span class="n">m_max</span><span class="o">=</span><span class="mf">1e3</span> <span class="c1">#conditioned on n=0, so no edge effects</span>
</span><span id="L-2602"><a href="#L-2602"><span class="linenos">2602</span></a>    
</span><span id="L-2603"><a href="#L-2603"><span class="linenos">2603</span></a>        <span class="n">Nreadsvec</span><span class="o">=</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span><span class="p">)</span>
</span><span id="L-2604"><a href="#L-2604"><span class="linenos">2604</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-2605"><a href="#L-2605"><span class="linenos">2605</span></a>            <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fvec</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="L-2606"><a href="#L-2606"><span class="linenos">2606</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="L-2607"><a href="#L-2607"><span class="linenos">2607</span></a>                <span class="n">m1vec</span><span class="o">=</span><span class="n">Nreadsvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="L-2608"><a href="#L-2608"><span class="linenos">2608</span></a>                <span class="k">for</span> <span class="n">find</span><span class="p">,</span><span class="n">m1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m1vec</span><span class="p">):</span>
</span><span id="L-2609"><a href="#L-2609"><span class="linenos">2609</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
</span><span id="L-2610"><a href="#L-2610"><span class="linenos">2610</span></a>                <span class="n">logPn0_f</span><span class="o">=-</span><span class="n">m1vec</span>
</span><span id="L-2611"><a href="#L-2611"><span class="linenos">2611</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-2612"><a href="#L-2612"><span class="linenos">2612</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">Nreadsvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="L-2613"><a href="#L-2613"><span class="linenos">2613</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-2614"><a href="#L-2614"><span class="linenos">2614</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="L-2615"><a href="#L-2615"><span class="linenos">2615</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-2616"><a href="#L-2616"><span class="linenos">2616</span></a>                <span class="k">for</span> <span class="n">find</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">)):</span>
</span><span id="L-2617"><a href="#L-2617"><span class="linenos">2617</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-2618"><a href="#L-2618"><span class="linenos">2618</span></a>                <span class="n">Pn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">Pn_find</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">Pn_find</span> <span class="ow">in</span> <span class="n">Pn_f</span><span class="p">])</span>
</span><span id="L-2619"><a href="#L-2619"><span class="linenos">2619</span></a>                <span class="n">logPn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)</span>
</span><span id="L-2620"><a href="#L-2620"><span class="linenos">2620</span></a>            
</span><span id="L-2621"><a href="#L-2621"><span class="linenos">2621</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2622"><a href="#L-2622"><span class="linenos">2622</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="L-2623"><a href="#L-2623"><span class="linenos">2623</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-2624"><a href="#L-2624"><span class="linenos">2624</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="L-2625"><a href="#L-2625"><span class="linenos">2625</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-2626"><a href="#L-2626"><span class="linenos">2626</span></a>                <span class="n">Pn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fvec</span><span class="p">),))</span>
</span><span id="L-2627"><a href="#L-2627"><span class="linenos">2627</span></a>                <span class="k">for</span> <span class="n">find</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)):</span>
</span><span id="L-2628"><a href="#L-2628"><span class="linenos">2628</span></a>                    <span class="n">nbtmp</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">find</span><span class="p">],</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">find</span><span class="p">])</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-2629"><a href="#L-2629"><span class="linenos">2629</span></a>                    <span class="n">ptmp</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_cvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2630"><a href="#L-2630"><span class="linenos">2630</span></a>                    <span class="n">Pn0_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nbtmp</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ptmp</span><span class="p">)))</span>
</span><span id="L-2631"><a href="#L-2631"><span class="linenos">2631</span></a>                <span class="n">logPn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)</span>
</span><span id="L-2632"><a href="#L-2632"><span class="linenos">2632</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2633"><a href="#L-2633"><span class="linenos">2633</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1,or 2 only&#39;</span><span class="p">)</span>
</span><span id="L-2634"><a href="#L-2634"><span class="linenos">2634</span></a>            
</span><span id="L-2635"><a href="#L-2635"><span class="linenos">2635</span></a>            <span class="k">if</span> <span class="n">it</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2636"><a href="#L-2636"><span class="linenos">2636</span></a>                <span class="n">Pn1_f</span><span class="o">=</span><span class="n">Pn_f</span>
</span><span id="L-2637"><a href="#L-2637"><span class="linenos">2637</span></a>                <span class="n">logPn10_f</span><span class="o">=</span><span class="n">logPn0_f</span>
</span><span id="L-2638"><a href="#L-2638"><span class="linenos">2638</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2639"><a href="#L-2639"><span class="linenos">2639</span></a>                <span class="n">Pn2_f</span><span class="o">=</span><span class="n">Pn_f</span>
</span><span id="L-2640"><a href="#L-2640"><span class="linenos">2640</span></a>                <span class="n">logPn20_f</span><span class="o">=</span><span class="n">logPn0_f</span>
</span><span id="L-2641"><a href="#L-2641"><span class="linenos">2641</span></a>
</span><span id="L-2642"><a href="#L-2642"><span class="linenos">2642</span></a>        <span class="c1">#3-quadrant q|f conditional distribution (qx0:n1&gt;0,n2=0;q0x:n1=0,n2&gt;0;qxx:n1,n2&gt;0)</span>
</span><span id="L-2643"><a href="#L-2643"><span class="linenos">2643</span></a>        <span class="n">logPqx0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn10_f</span><span class="p">))</span><span class="o">+</span><span class="n">logPn20_f</span>
</span><span id="L-2644"><a href="#L-2644"><span class="linenos">2644</span></a>        <span class="n">logPq0x_f</span><span class="o">=</span><span class="n">logPn10_f</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn20_f</span><span class="p">))</span>
</span><span id="L-2645"><a href="#L-2645"><span class="linenos">2645</span></a>        <span class="n">logPqxx_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn10_f</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn20_f</span><span class="p">))</span>
</span><span id="L-2646"><a href="#L-2646"><span class="linenos">2646</span></a>        <span class="c1">#3-quadrant q,f joint distribution</span>
</span><span id="L-2647"><a href="#L-2647"><span class="linenos">2647</span></a>        <span class="n">logPfqx0</span><span class="o">=</span><span class="n">logPqx0_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="L-2648"><a href="#L-2648"><span class="linenos">2648</span></a>        <span class="n">logPfq0x</span><span class="o">=</span><span class="n">logPq0x_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="L-2649"><a href="#L-2649"><span class="linenos">2649</span></a>        <span class="n">logPfqxx</span><span class="o">=</span><span class="n">logPqxx_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="L-2650"><a href="#L-2650"><span class="linenos">2650</span></a>        <span class="c1">#3-quadrant q marginal distribution </span>
</span><span id="L-2651"><a href="#L-2651"><span class="linenos">2651</span></a>        <span class="n">Pqx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2652"><a href="#L-2652"><span class="linenos">2652</span></a>        <span class="n">Pq0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2653"><a href="#L-2653"><span class="linenos">2653</span></a>        <span class="n">Pqxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2654"><a href="#L-2654"><span class="linenos">2654</span></a>    
</span><span id="L-2655"><a href="#L-2655"><span class="linenos">2655</span></a>        <span class="c1">#3 quadrant conditional f|q distribution</span>
</span><span id="L-2656"><a href="#L-2656"><span class="linenos">2656</span></a>        <span class="n">Pf_qx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pqx0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2657"><a href="#L-2657"><span class="linenos">2657</span></a>        <span class="n">Pf_q0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pq0x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pq0x</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2658"><a href="#L-2658"><span class="linenos">2658</span></a>        <span class="n">Pf_qxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pqxx</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pqxx</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2659"><a href="#L-2659"><span class="linenos">2659</span></a>    
</span><span id="L-2660"><a href="#L-2660"><span class="linenos">2660</span></a>        <span class="c1">#3-quadrant q marginal distribution</span>
</span><span id="L-2661"><a href="#L-2661"><span class="linenos">2661</span></a>        <span class="n">newPqZ</span><span class="o">=</span><span class="n">Pqx0</span> <span class="o">+</span> <span class="n">Pq0x</span> <span class="o">+</span> <span class="n">Pqxx</span>
</span><span id="L-2662"><a href="#L-2662"><span class="linenos">2662</span></a>        <span class="n">Pqx0</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="L-2663"><a href="#L-2663"><span class="linenos">2663</span></a>        <span class="n">Pq0x</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="L-2664"><a href="#L-2664"><span class="linenos">2664</span></a>        <span class="n">Pqxx</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="L-2665"><a href="#L-2665"><span class="linenos">2665</span></a>
</span><span id="L-2666"><a href="#L-2666"><span class="linenos">2666</span></a>        <span class="n">Pfqx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="p">)</span>
</span><span id="L-2667"><a href="#L-2667"><span class="linenos">2667</span></a>        <span class="n">Pfq0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="p">)</span>
</span><span id="L-2668"><a href="#L-2668"><span class="linenos">2668</span></a>        <span class="n">Pfqxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="p">)</span>
</span><span id="L-2669"><a href="#L-2669"><span class="linenos">2669</span></a>    
</span><span id="L-2670"><a href="#L-2670"><span class="linenos">2670</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model probs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pq0x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pqxx</span><span class="p">))</span>
</span><span id="L-2671"><a href="#L-2671"><span class="linenos">2671</span></a>
</span><span id="L-2672"><a href="#L-2672"><span class="linenos">2672</span></a>        <span class="c1">#get samples </span>
</span><span id="L-2673"><a href="#L-2673"><span class="linenos">2673</span></a>        <span class="n">num_samples</span><span class="o">=</span><span class="n">Nsamp</span>
</span><span id="L-2674"><a href="#L-2674"><span class="linenos">2674</span></a>        <span class="n">q_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">,</span><span class="n">Pq0x</span><span class="p">,</span><span class="n">Pqxx</span><span class="p">))</span>
</span><span id="L-2675"><a href="#L-2675"><span class="linenos">2675</span></a>        <span class="n">vals</span><span class="p">,</span><span class="n">counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">q_samples</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2676"><a href="#L-2676"><span class="linenos">2676</span></a>        <span class="n">num_qx0</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2677"><a href="#L-2677"><span class="linenos">2677</span></a>        <span class="n">num_q0x</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2678"><a href="#L-2678"><span class="linenos">2678</span></a>        <span class="n">num_qxx</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-2679"><a href="#L-2679"><span class="linenos">2679</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qx0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_q0x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qxx</span><span class="p">))</span>
</span><span id="L-2680"><a href="#L-2680"><span class="linenos">2680</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q sampled probs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qx0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_q0x</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qxx</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">))))</span>
</span><span id="L-2681"><a href="#L-2681"><span class="linenos">2681</span></a>    
</span><span id="L-2682"><a href="#L-2682"><span class="linenos">2682</span></a>        <span class="c1">#x0</span>
</span><span id="L-2683"><a href="#L-2683"><span class="linenos">2683</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_qx0</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2684"><a href="#L-2684"><span class="linenos">2684</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_qx0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-2685"><a href="#L-2685"><span class="linenos">2685</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="L-2686"><a href="#L-2686"><span class="linenos">2686</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="L-2687"><a href="#L-2687"><span class="linenos">2687</span></a>        <span class="n">qx0_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="L-2688"><a href="#L-2688"><span class="linenos">2688</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2689"><a href="#L-2689"><span class="linenos">2689</span></a>        <span class="n">qx0_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,))</span>
</span><span id="L-2690"><a href="#L-2690"><span class="linenos">2690</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-2691"><a href="#L-2691"><span class="linenos">2691</span></a>            <span class="n">qx0_m_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,))</span>
</span><span id="L-2692"><a href="#L-2692"><span class="linenos">2692</span></a>            <span class="c1">#conditioning on n&gt;0 applies an m-dependent factor to Pm_f, which can&#39;t be incorporated into the ppf method used for noise_model 1 and 2. </span>
</span><span id="L-2693"><a href="#L-2693"><span class="linenos">2693</span></a>            <span class="c1">#We handle that here by using a custom finite range sampler, which has the drawback of having to define an upper limit. </span>
</span><span id="L-2694"><a href="#L-2694"><span class="linenos">2694</span></a>            <span class="c1">#This works so long as n_max/r_c&lt;&lt;m_max, so depends on highest counts in data (n_max). My data had max counts of 1e3-1e4.</span>
</span><span id="L-2695"><a href="#L-2695"><span class="linenos">2695</span></a>            <span class="c1">#Alternatively, could define a custom scipy RV class by defining it&#39;s PMF, but has to be array-compatible which requires care. </span>
</span><span id="L-2696"><a href="#L-2696"><span class="linenos">2696</span></a>            <span class="n">m_samp_max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">)</span> 
</span><span id="L-2697"><a href="#L-2697"><span class="linenos">2697</span></a>            <span class="n">mvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_samp_max</span><span class="p">)</span>   
</span><span id="L-2698"><a href="#L-2698"><span class="linenos">2698</span></a>    
</span><span id="L-2699"><a href="#L-2699"><span class="linenos">2699</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="L-2700"><a href="#L-2700"><span class="linenos">2700</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>      
</span><span id="L-2701"><a href="#L-2701"><span class="linenos">2701</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="L-2702"><a href="#L-2702"><span class="linenos">2702</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-2703"><a href="#L-2703"><span class="linenos">2703</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="L-2704"><a href="#L-2704"><span class="linenos">2704</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-2705"><a href="#L-2705"><span class="linenos">2705</span></a>                <span class="n">Pm1_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-2706"><a href="#L-2706"><span class="linenos">2706</span></a>            
</span><span id="L-2707"><a href="#L-2707"><span class="linenos">2707</span></a>                <span class="n">Pm1_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c1</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm1_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="L-2708"><a href="#L-2708"><span class="linenos">2708</span></a>                <span class="n">Pm1_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm1_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)))</span>
</span><span id="L-2709"><a href="#L-2709"><span class="linenos">2709</span></a>                <span class="n">qx0_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm1_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="L-2710"><a href="#L-2710"><span class="linenos">2710</span></a>            
</span><span id="L-2711"><a href="#L-2711"><span class="linenos">2711</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qx0_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2712"><a href="#L-2712"><span class="linenos">2712</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="L-2713"><a href="#L-2713"><span class="linenos">2713</span></a>                    <span class="n">Pn1_m1</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c1</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="L-2714"><a href="#L-2714"><span class="linenos">2714</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2715"><a href="#L-2715"><span class="linenos">2715</span></a>                    <span class="n">qx0_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="L-2716"><a href="#L-2716"><span class="linenos">2716</span></a> 
</span><span id="L-2717"><a href="#L-2717"><span class="linenos">2717</span></a>        
</span><span id="L-2718"><a href="#L-2718"><span class="linenos">2718</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2719"><a href="#L-2719"><span class="linenos">2719</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2720"><a href="#L-2720"><span class="linenos">2720</span></a>                <span class="n">qx0_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="L-2721"><a href="#L-2721"><span class="linenos">2721</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2722"><a href="#L-2722"><span class="linenos">2722</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1, or 2 only&#39;</span><span class="p">)</span>
</span><span id="L-2723"><a href="#L-2723"><span class="linenos">2723</span></a>        <span class="n">qx0_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">qx0_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span> 
</span><span id="L-2724"><a href="#L-2724"><span class="linenos">2724</span></a>    
</span><span id="L-2725"><a href="#L-2725"><span class="linenos">2725</span></a>        <span class="c1">#0x</span>
</span><span id="L-2726"><a href="#L-2726"><span class="linenos">2726</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_q0x</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2727"><a href="#L-2727"><span class="linenos">2727</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_q0x</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-2728"><a href="#L-2728"><span class="linenos">2728</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="L-2729"><a href="#L-2729"><span class="linenos">2729</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="L-2730"><a href="#L-2730"><span class="linenos">2730</span></a>        <span class="n">q0x_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="L-2731"><a href="#L-2731"><span class="linenos">2731</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2732"><a href="#L-2732"><span class="linenos">2732</span></a>        <span class="n">q0x_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,))</span>
</span><span id="L-2733"><a href="#L-2733"><span class="linenos">2733</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-2734"><a href="#L-2734"><span class="linenos">2734</span></a>            <span class="n">q0x_m_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,))</span>
</span><span id="L-2735"><a href="#L-2735"><span class="linenos">2735</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="L-2736"><a href="#L-2736"><span class="linenos">2736</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2737"><a href="#L-2737"><span class="linenos">2737</span></a>                <span class="n">m2</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="L-2738"><a href="#L-2738"><span class="linenos">2738</span></a>                <span class="n">v2</span><span class="o">=</span><span class="n">m2</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-2739"><a href="#L-2739"><span class="linenos">2739</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span>
</span><span id="L-2740"><a href="#L-2740"><span class="linenos">2740</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m2</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-2741"><a href="#L-2741"><span class="linenos">2741</span></a>                <span class="n">Pm2_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-2742"><a href="#L-2742"><span class="linenos">2742</span></a>            
</span><span id="L-2743"><a href="#L-2743"><span class="linenos">2743</span></a>                <span class="n">Pm2_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c2</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm2_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="L-2744"><a href="#L-2744"><span class="linenos">2744</span></a>                <span class="n">Pm2_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm2_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm2_f_adj</span><span class="p">)))</span>
</span><span id="L-2745"><a href="#L-2745"><span class="linenos">2745</span></a>                <span class="n">q0x_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm2_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="L-2746"><a href="#L-2746"><span class="linenos">2746</span></a>
</span><span id="L-2747"><a href="#L-2747"><span class="linenos">2747</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">q0x_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2748"><a href="#L-2748"><span class="linenos">2748</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="L-2749"><a href="#L-2749"><span class="linenos">2749</span></a>                    <span class="n">Pn2_m2</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="L-2750"><a href="#L-2750"><span class="linenos">2750</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2751"><a href="#L-2751"><span class="linenos">2751</span></a>                    <span class="n">q0x_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="L-2752"><a href="#L-2752"><span class="linenos">2752</span></a>        
</span><span id="L-2753"><a href="#L-2753"><span class="linenos">2753</span></a>                       
</span><span id="L-2754"><a href="#L-2754"><span class="linenos">2754</span></a>        
</span><span id="L-2755"><a href="#L-2755"><span class="linenos">2755</span></a>            <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2756"><a href="#L-2756"><span class="linenos">2756</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2757"><a href="#L-2757"><span class="linenos">2757</span></a>                <span class="n">q0x_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="L-2758"><a href="#L-2758"><span class="linenos">2758</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2759"><a href="#L-2759"><span class="linenos">2759</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1,or 2 only&#39;</span><span class="p">)</span>
</span><span id="L-2760"><a href="#L-2760"><span class="linenos">2760</span></a>        <span class="n">q0x_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="n">q0x_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>
</span><span id="L-2761"><a href="#L-2761"><span class="linenos">2761</span></a>    
</span><span id="L-2762"><a href="#L-2762"><span class="linenos">2762</span></a>        <span class="c1">#qxx</span>
</span><span id="L-2763"><a href="#L-2763"><span class="linenos">2763</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_qxx</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="L-2764"><a href="#L-2764"><span class="linenos">2764</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_qxx</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>        
</span><span id="L-2765"><a href="#L-2765"><span class="linenos">2765</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="L-2766"><a href="#L-2766"><span class="linenos">2766</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="L-2767"><a href="#L-2767"><span class="linenos">2767</span></a>        <span class="n">qxx_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="L-2768"><a href="#L-2768"><span class="linenos">2768</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2769"><a href="#L-2769"><span class="linenos">2769</span></a>        <span class="n">qxx_n1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="L-2770"><a href="#L-2770"><span class="linenos">2770</span></a>        <span class="n">qxx_n2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="L-2771"><a href="#L-2771"><span class="linenos">2771</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-2772"><a href="#L-2772"><span class="linenos">2772</span></a>            <span class="n">qxx_m1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="L-2773"><a href="#L-2773"><span class="linenos">2773</span></a>            <span class="n">qxx_m2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="L-2774"><a href="#L-2774"><span class="linenos">2774</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="L-2775"><a href="#L-2775"><span class="linenos">2775</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2776"><a href="#L-2776"><span class="linenos">2776</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="L-2777"><a href="#L-2777"><span class="linenos">2777</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-2778"><a href="#L-2778"><span class="linenos">2778</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="L-2779"><a href="#L-2779"><span class="linenos">2779</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-2780"><a href="#L-2780"><span class="linenos">2780</span></a>                <span class="n">Pm1_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-2781"><a href="#L-2781"><span class="linenos">2781</span></a>            
</span><span id="L-2782"><a href="#L-2782"><span class="linenos">2782</span></a>                <span class="n">Pm1_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c1</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm1_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="L-2783"><a href="#L-2783"><span class="linenos">2783</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2784"><a href="#L-2784"><span class="linenos">2784</span></a>                    <span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-2785"><a href="#L-2785"><span class="linenos">2785</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2786"><a href="#L-2786"><span class="linenos">2786</span></a>                    <span class="n">Pm1_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm1_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)))</span>
</span><span id="L-2787"><a href="#L-2787"><span class="linenos">2787</span></a>                    <span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm1_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="L-2788"><a href="#L-2788"><span class="linenos">2788</span></a>
</span><span id="L-2789"><a href="#L-2789"><span class="linenos">2789</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2790"><a href="#L-2790"><span class="linenos">2790</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="L-2791"><a href="#L-2791"><span class="linenos">2791</span></a>                    <span class="n">Pn1_m1</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c1</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="L-2792"><a href="#L-2792"><span class="linenos">2792</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2793"><a href="#L-2793"><span class="linenos">2793</span></a>                    <span class="n">qxx_n1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="L-2794"><a href="#L-2794"><span class="linenos">2794</span></a>                
</span><span id="L-2795"><a href="#L-2795"><span class="linenos">2795</span></a>                <span class="n">m2</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="L-2796"><a href="#L-2796"><span class="linenos">2796</span></a>                <span class="n">v2</span><span class="o">=</span><span class="n">m2</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="L-2797"><a href="#L-2797"><span class="linenos">2797</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span>
</span><span id="L-2798"><a href="#L-2798"><span class="linenos">2798</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m2</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">p</span>
</span><span id="L-2799"><a href="#L-2799"><span class="linenos">2799</span></a>                <span class="n">Pm2_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="L-2800"><a href="#L-2800"><span class="linenos">2800</span></a>            
</span><span id="L-2801"><a href="#L-2801"><span class="linenos">2801</span></a>                <span class="n">Pm2_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c2</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm2_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="L-2802"><a href="#L-2802"><span class="linenos">2802</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2803"><a href="#L-2803"><span class="linenos">2803</span></a>                    <span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-2804"><a href="#L-2804"><span class="linenos">2804</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2805"><a href="#L-2805"><span class="linenos">2805</span></a>                    <span class="n">Pm2_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm2_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm2_f_adj</span><span class="p">)))</span>
</span><span id="L-2806"><a href="#L-2806"><span class="linenos">2806</span></a>                    <span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm2_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="L-2807"><a href="#L-2807"><span class="linenos">2807</span></a>
</span><span id="L-2808"><a href="#L-2808"><span class="linenos">2808</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2809"><a href="#L-2809"><span class="linenos">2809</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="L-2810"><a href="#L-2810"><span class="linenos">2810</span></a>                    <span class="n">Pn2_m2</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="L-2811"><a href="#L-2811"><span class="linenos">2811</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2812"><a href="#L-2812"><span class="linenos">2812</span></a>                    <span class="n">qxx_n2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>    
</span><span id="L-2813"><a href="#L-2813"><span class="linenos">2813</span></a>
</span><span id="L-2814"><a href="#L-2814"><span class="linenos">2814</span></a>                          
</span><span id="L-2815"><a href="#L-2815"><span class="linenos">2815</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-2816"><a href="#L-2816"><span class="linenos">2816</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2817"><a href="#L-2817"><span class="linenos">2817</span></a>                <span class="n">qxx_n1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="L-2818"><a href="#L-2818"><span class="linenos">2818</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2819"><a href="#L-2819"><span class="linenos">2819</span></a>                <span class="n">qxx_n2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="L-2820"><a href="#L-2820"><span class="linenos">2820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2821"><a href="#L-2821"><span class="linenos">2821</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1, or 2 only&#39;</span><span class="p">)</span>
</span><span id="L-2822"><a href="#L-2822"><span class="linenos">2822</span></a>            
</span><span id="L-2823"><a href="#L-2823"><span class="linenos">2823</span></a>        <span class="n">qxx_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">qxx_n1_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">qxx_n2_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>
</span><span id="L-2824"><a href="#L-2824"><span class="linenos">2824</span></a>    
</span><span id="L-2825"><a href="#L-2825"><span class="linenos">2825</span></a>        <span class="n">pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">q0x_pair_samples</span><span class="p">,</span><span class="n">qx0_pair_samples</span><span class="p">,</span><span class="n">qxx_pair_samples</span><span class="p">))</span>
</span><span id="L-2826"><a href="#L-2826"><span class="linenos">2826</span></a>        <span class="n">f_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_f_samples</span><span class="p">,</span><span class="n">qx0_f_samples</span><span class="p">,</span><span class="n">qxx_f_samples</span><span class="p">))</span>
</span><span id="L-2827"><a href="#L-2827"><span class="linenos">2827</span></a>        <span class="n">output_m_samples</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-2828"><a href="#L-2828"><span class="linenos">2828</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">output_m_samples</span><span class="p">:</span>                
</span><span id="L-2829"><a href="#L-2829"><span class="linenos">2829</span></a>            <span class="n">m1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_m1_samples</span><span class="p">,</span><span class="n">qx0_m1_samples</span><span class="p">,</span><span class="n">qxx_m1_samples</span><span class="p">))</span>
</span><span id="L-2830"><a href="#L-2830"><span class="linenos">2830</span></a>            <span class="n">m2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_m2_samples</span><span class="p">,</span><span class="n">qx0_m2_samples</span><span class="p">,</span><span class="n">qxx_m2_samples</span><span class="p">))</span>
</span><span id="L-2831"><a href="#L-2831"><span class="linenos">2831</span></a>    
</span><span id="L-2832"><a href="#L-2832"><span class="linenos">2832</span></a>        <span class="n">pair_samples_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">:</span><span class="n">pair_samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">:</span><span class="n">pair_samples</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]})</span>
</span><span id="L-2833"><a href="#L-2833"><span class="linenos">2833</span></a>
</span><span id="L-2834"><a href="#L-2834"><span class="linenos">2834</span></a>        <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_fraction_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="L-2835"><a href="#L-2835"><span class="linenos">2835</span></a>        <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_fraction_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="L-2836"><a href="#L-2836"><span class="linenos">2836</span></a>    
</span><span id="L-2837"><a href="#L-2837"><span class="linenos">2837</span></a>        <span class="k">return</span> <span class="n">f_samples</span><span class="p">,</span><span class="n">pair_samples_df</span>
</span><span id="L-2838"><a href="#L-2838"><span class="linenos">2838</span></a>
</span><span id="L-2839"><a href="#L-2839"><span class="linenos">2839</span></a>
</span><span id="L-2840"><a href="#L-2840"><span class="linenos">2840</span></a>    <span class="k">def</span> <span class="nf">generate_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">t_ime</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">NreadsI</span> <span class="o">=</span> <span class="s1">&#39;1e6&#39;</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="s1">&#39;1e6&#39;</span><span class="p">):</span>
</span><span id="L-2841"><a href="#L-2841"><span class="linenos">2841</span></a>
</span><span id="L-2842"><a href="#L-2842"><span class="linenos">2842</span></a>
</span><span id="L-2843"><a href="#L-2843"><span class="linenos">2843</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2844"><a href="#L-2844"><span class="linenos">2844</span></a><span class="sd">        generate in-silico t_ime apart RepSeq samples.</span>
</span><span id="L-2845"><a href="#L-2845"><span class="linenos">2845</span></a><span class="sd">        </span>
</span><span id="L-2846"><a href="#L-2846"><span class="linenos">2846</span></a><span class="sd">        Parameters</span>
</span><span id="L-2847"><a href="#L-2847"><span class="linenos">2847</span></a><span class="sd">        ----------</span>
</span><span id="L-2848"><a href="#L-2848"><span class="linenos">2848</span></a><span class="sd">        paras_1  : numpy array</span>
</span><span id="L-2849"><a href="#L-2849"><span class="linenos">2849</span></a><span class="sd">            parameters of the noise model that has been learnt at time_1</span>
</span><span id="L-2850"><a href="#L-2850"><span class="linenos">2850</span></a><span class="sd">        paras_2  : numpy array</span>
</span><span id="L-2851"><a href="#L-2851"><span class="linenos">2851</span></a><span class="sd">            parameters of the noise model that has been learnt at time_2</span>
</span><span id="L-2852"><a href="#L-2852"><span class="linenos">2852</span></a><span class="sd">        method   : str</span>
</span><span id="L-2853"><a href="#L-2853"><span class="linenos">2853</span></a><span class="sd">            &#39;negative_binomial&#39; or &#39;poisson&#39;</span>
</span><span id="L-2854"><a href="#L-2854"><span class="linenos">2854</span></a><span class="sd">        tau      : float</span>
</span><span id="L-2855"><a href="#L-2855"><span class="linenos">2855</span></a><span class="sd">            first time-scale parameter of the dynamics</span>
</span><span id="L-2856"><a href="#L-2856"><span class="linenos">2856</span></a><span class="sd">        theta    : float</span>
</span><span id="L-2857"><a href="#L-2857"><span class="linenos">2857</span></a><span class="sd">            second time-scale parameter of the dynamics</span>
</span><span id="L-2858"><a href="#L-2858"><span class="linenos">2858</span></a><span class="sd">        t_ime    : float</span>
</span><span id="L-2859"><a href="#L-2859"><span class="linenos">2859</span></a><span class="sd">            number of years between both synthetic sampling (between time_1 and time_2)</span>
</span><span id="L-2860"><a href="#L-2860"><span class="linenos">2860</span></a><span class="sd">        filename : str</span>
</span><span id="L-2861"><a href="#L-2861"><span class="linenos">2861</span></a><span class="sd">            name of the file in which the dataframe is stored  </span>
</span><span id="L-2862"><a href="#L-2862"><span class="linenos">2862</span></a>
</span><span id="L-2863"><a href="#L-2863"><span class="linenos">2863</span></a><span class="sd">        Returns</span>
</span><span id="L-2864"><a href="#L-2864"><span class="linenos">2864</span></a><span class="sd">        -------</span>
</span><span id="L-2865"><a href="#L-2865"><span class="linenos">2865</span></a><span class="sd">        data-frame - csv file</span>
</span><span id="L-2866"><a href="#L-2866"><span class="linenos">2866</span></a><span class="sd">            the output is a csv file of columns : &#39;Clone_count_1&#39; (at time_1) &#39;Clone_count_2&#39; (at time_2) and the frequency counterparts &#39;Clone_frequency_1&#39; and &#39;Clone_frequency_2&#39;</span>
</span><span id="L-2867"><a href="#L-2867"><span class="linenos">2867</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2868"><a href="#L-2868"><span class="linenos">2868</span></a>
</span><span id="L-2869"><a href="#L-2869"><span class="linenos">2869</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span> 
</span><span id="L-2870"><a href="#L-2870"><span class="linenos">2870</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span><span id="L-2871"><a href="#L-2871"><span class="linenos">2871</span></a>
</span><span id="L-2872"><a href="#L-2872"><span class="linenos">2872</span></a>        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;negative_binomial&#39;</span>
</span><span id="L-2873"><a href="#L-2873"><span class="linenos">2873</span></a>
</span><span id="L-2874"><a href="#L-2874"><span class="linenos">2874</span></a>
</span><span id="L-2875"><a href="#L-2875"><span class="linenos">2875</span></a>        <span class="c1"># Synthetic data generation</span>
</span><span id="L-2876"><a href="#L-2876"><span class="linenos">2876</span></a>
</span><span id="L-2877"><a href="#L-2877"><span class="linenos">2877</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;execution starting...&#39;</span><span class="p">)</span>
</span><span id="L-2878"><a href="#L-2878"><span class="linenos">2878</span></a>
</span><span id="L-2879"><a href="#L-2879"><span class="linenos">2879</span></a>        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-2880"><a href="#L-2880"><span class="linenos">2880</span></a>
</span><span id="L-2881"><a href="#L-2881"><span class="linenos">2881</span></a>        <span class="c1">#Values of the parameters</span>
</span><span id="L-2882"><a href="#L-2882"><span class="linenos">2882</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau</span>
</span><span id="L-2883"><a href="#L-2883"><span class="linenos">2883</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">theta</span>
</span><span id="L-2884"><a href="#L-2884"><span class="linenos">2884</span></a>        <span class="n">N_0</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="L-2885"><a href="#L-2885"><span class="linenos">2885</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">)</span>
</span><span id="L-2886"><a href="#L-2886"><span class="linenos">2886</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NreadsII</span><span class="p">)</span>
</span><span id="L-2887"><a href="#L-2887"><span class="linenos">2887</span></a>
</span><span id="L-2888"><a href="#L-2888"><span class="linenos">2888</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_ime</span><span class="p">)</span>
</span><span id="L-2889"><a href="#L-2889"><span class="linenos">2889</span></a>
</span><span id="L-2890"><a href="#L-2890"><span class="linenos">2890</span></a>        <span class="k">if</span> <span class="n">NreadsI</span> <span class="o">==</span> <span class="n">NreadsII</span><span class="p">:</span>
</span><span id="L-2891"><a href="#L-2891"><span class="linenos">2891</span></a>            <span class="n">key_sym</span> <span class="o">=</span> <span class="s1">&#39;_sym_&#39;</span>
</span><span id="L-2892"><a href="#L-2892"><span class="linenos">2892</span></a>
</span><span id="L-2893"><a href="#L-2893"><span class="linenos">2893</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2894"><a href="#L-2894"><span class="linenos">2894</span></a>            <span class="n">key_sym</span> <span class="o">=</span> <span class="s1">&#39;_asym_&#39;</span>
</span><span id="L-2895"><a href="#L-2895"><span class="linenos">2895</span></a>
</span><span id="L-2896"><a href="#L-2896"><span class="linenos">2896</span></a>        <span class="c1"># Name of the directory</span>
</span><span id="L-2897"><a href="#L-2897"><span class="linenos">2897</span></a>
</span><span id="L-2898"><a href="#L-2898"><span class="linenos">2898</span></a>
</span><span id="L-2899"><a href="#L-2899"><span class="linenos">2899</span></a>        <span class="n">dirName</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span>    
</span><span id="L-2900"><a href="#L-2900"><span class="linenos">2900</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirName</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span><span id="L-2901"><a href="#L-2901"><span class="linenos">2901</span></a>
</span><span id="L-2902"><a href="#L-2902"><span class="linenos">2902</span></a>        <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_1</span> <span class="c1">#Just put a and b of the negative binomiale distribution [0.7, 1.1]</span>
</span><span id="L-2903"><a href="#L-2903"><span class="linenos">2903</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">/</span><span class="n">B</span>
</span><span id="L-2904"><a href="#L-2904"><span class="linenos">2904</span></a>        <span class="c1">#print(&#39;alpha : &#39; + str(alpha))</span>
</span><span id="L-2905"><a href="#L-2905"><span class="linenos">2905</span></a>
</span><span id="L-2906"><a href="#L-2906"><span class="linenos">2906</span></a>        <span class="c1">#1/ Generate log-population at initial time from steady-state distribution + GBM diffusion trajectories for 2 years</span>
</span><span id="L-2907"><a href="#L-2907"><span class="linenos">2907</span></a>        <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">Prop_Matrix_LB</span><span class="p">,</span> <span class="n">p_ext_LB</span><span class="p">,</span> <span class="n">results_extinction_LB</span><span class="p">,</span> <span class="n">time_vec_LB</span><span class="p">,</span> <span class="n">results_extinction_source_LB</span><span class="p">,</span> <span class="n">x_source_LB</span> <span class="o">=</span> <span class="n">_generator_diffusion_LB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">N_0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-2908"><a href="#L-2908"><span class="linenos">2908</span></a>        
</span><span id="L-2909"><a href="#L-2909"><span class="linenos">2909</span></a>        <span class="c1">#x_i_LB, x_f_LB, Prop_Matrix, p_ext, results_extinction  = generator_diffusion_LB(B, A, N_0, t)</span>
</span><span id="L-2910"><a href="#L-2910"><span class="linenos">2910</span></a>        <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_i_LB</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_f_LB</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_source_LB</span><span class="p">))</span>  <span class="c1">#N_cells_final_LB</span>
</span><span id="L-2911"><a href="#L-2911"><span class="linenos">2911</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NUMBER OF CELLS AT INITIAL TIME&#39;</span><span class="p">)</span>
</span><span id="L-2912"><a href="#L-2912"><span class="linenos">2912</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">N_cells_day_0_LB</span><span class="p">)</span>
</span><span id="L-2913"><a href="#L-2913"><span class="linenos">2913</span></a>
</span><span id="L-2914"><a href="#L-2914"><span class="linenos">2914</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NUMBER OF CELLS AT FINAL TIME&#39;</span><span class="p">)</span>
</span><span id="L-2915"><a href="#L-2915"><span class="linenos">2915</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="L-2916"><a href="#L-2916"><span class="linenos">2916</span></a>
</span><span id="L-2917"><a href="#L-2917"><span class="linenos">2917</span></a>        <span class="c1">#print(&#39;SHAPE_X_I &#39; +  str(np.shape(x_i_LB)))</span>
</span><span id="L-2918"><a href="#L-2918"><span class="linenos">2918</span></a>        <span class="c1">#print(&#39;SHAPE_X_F &#39; +  str(np.shape(x_f_LB)))</span>
</span><span id="L-2919"><a href="#L-2919"><span class="linenos">2919</span></a>
</span><span id="L-2920"><a href="#L-2920"><span class="linenos">2920</span></a>
</span><span id="L-2921"><a href="#L-2921"><span class="linenos">2921</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;negative_binomial&#39;</span><span class="p">:</span>
</span><span id="L-2922"><a href="#L-2922"><span class="linenos">2922</span></a>
</span><span id="L-2923"><a href="#L-2923"><span class="linenos">2923</span></a>            <span class="n">df_diffusion_LB</span>  <span class="o">=</span> <span class="n">_experimental_sampling_diffusion_NegBin</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="L-2924"><a href="#L-2924"><span class="linenos">2924</span></a>            <span class="n">df_diffusion_LB</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span> <span class="p">,</span> <span class="n">sep</span><span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2925"><a href="#L-2925"><span class="linenos">2925</span></a>
</span><span id="L-2926"><a href="#L-2926"><span class="linenos">2926</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;poisson&#39;</span><span class="p">:</span> 
</span><span id="L-2927"><a href="#L-2927"><span class="linenos">2927</span></a>
</span><span id="L-2928"><a href="#L-2928"><span class="linenos">2928</span></a>            <span class="n">df_diffusion_LB</span>  <span class="o">=</span> <span class="n">_experimental_sampling_diffusion_Poisson</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="L-2929"><a href="#L-2929"><span class="linenos">2929</span></a>            <span class="n">df_diffusion_LB</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span> <span class="p">,</span> <span class="n">sep</span><span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-2930"><a href="#L-2930"><span class="linenos">2930</span></a>
</span><span id="L-2931"><a href="#L-2931"><span class="linenos">2931</span></a>
</span><span id="L-2932"><a href="#L-2932"><span class="linenos">2932</span></a>
</span><span id="L-2933"><a href="#L-2933"><span class="linenos">2933</span></a>
</span><span id="L-2934"><a href="#L-2934"><span class="linenos">2934</span></a>
</span><span id="L-2935"><a href="#L-2935"><span class="linenos">2935</span></a>
</span><span id="L-2936"><a href="#L-2936"><span class="linenos">2936</span></a>   
</span></pre></div>


            </section>
                <section id="longitudinal_analysis">
                            <input id="longitudinal_analysis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">longitudinal_analysis</span>:

                <label class="view-source-button" for="longitudinal_analysis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis-745"><a href="#longitudinal_analysis-745"><span class="linenos"> 745</span></a><span class="k">class</span> <span class="nc">longitudinal_analysis</span><span class="p">():</span>
</span><span id="longitudinal_analysis-746"><a href="#longitudinal_analysis-746"><span class="linenos"> 746</span></a>
</span><span id="longitudinal_analysis-747"><a href="#longitudinal_analysis-747"><span class="linenos"> 747</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-748"><a href="#longitudinal_analysis-748"><span class="linenos"> 748</span></a><span class="sd">    A class used to represent longitudinal RepSeq data and pre-analysis of the longitudinal data associated with</span>
</span><span id="longitudinal_analysis-749"><a href="#longitudinal_analysis-749"><span class="linenos"> 749</span></a><span class="sd">    one individual.</span>
</span><span id="longitudinal_analysis-750"><a href="#longitudinal_analysis-750"><span class="linenos"> 750</span></a>
</span><span id="longitudinal_analysis-751"><a href="#longitudinal_analysis-751"><span class="linenos"> 751</span></a><span class="sd">    ...</span>
</span><span id="longitudinal_analysis-752"><a href="#longitudinal_analysis-752"><span class="linenos"> 752</span></a>
</span><span id="longitudinal_analysis-753"><a href="#longitudinal_analysis-753"><span class="linenos"> 753</span></a><span class="sd">    Attributes</span>
</span><span id="longitudinal_analysis-754"><a href="#longitudinal_analysis-754"><span class="linenos"> 754</span></a><span class="sd">    ----------</span>
</span><span id="longitudinal_analysis-755"><a href="#longitudinal_analysis-755"><span class="linenos"> 755</span></a><span class="sd">    patient : str</span>
</span><span id="longitudinal_analysis-756"><a href="#longitudinal_analysis-756"><span class="linenos"> 756</span></a><span class="sd">        the patient label associated with the data</span>
</span><span id="longitudinal_analysis-757"><a href="#longitudinal_analysis-757"><span class="linenos"> 757</span></a><span class="sd">    data_foler : str</span>
</span><span id="longitudinal_analysis-758"><a href="#longitudinal_analysis-758"><span class="linenos"> 758</span></a><span class="sd">        the name of the animal</span>
</span><span id="longitudinal_analysis-759"><a href="#longitudinal_analysis-759"><span class="linenos"> 759</span></a><span class="sd">    replicate_1D : str</span>
</span><span id="longitudinal_analysis-760"><a href="#longitudinal_analysis-760"><span class="linenos"> 760</span></a><span class="sd">        the default first replicate label is &#39;_F1&#39; but can be modified by the user to match the used data</span>
</span><span id="longitudinal_analysis-761"><a href="#longitudinal_analysis-761"><span class="linenos"> 761</span></a><span class="sd">    replicate_2D : str</span>
</span><span id="longitudinal_analysis-762"><a href="#longitudinal_analysis-762"><span class="linenos"> 762</span></a><span class="sd">        the default first replicate label is &#39;_F2&#39; but can be modified by the user to match the used data</span>
</span><span id="longitudinal_analysis-763"><a href="#longitudinal_analysis-763"><span class="linenos"> 763</span></a>
</span><span id="longitudinal_analysis-764"><a href="#longitudinal_analysis-764"><span class="linenos"> 764</span></a><span class="sd">    Methods</span>
</span><span id="longitudinal_analysis-765"><a href="#longitudinal_analysis-765"><span class="linenos"> 765</span></a><span class="sd">    -------</span>
</span><span id="longitudinal_analysis-766"><a href="#longitudinal_analysis-766"><span class="linenos"> 766</span></a><span class="sd">    import_clones()</span>
</span><span id="longitudinal_analysis-767"><a href="#longitudinal_analysis-767"><span class="linenos"> 767</span></a><span class="sd">        to import all the clonotypes of a given patient and store them in a dictionary.</span>
</span><span id="longitudinal_analysis-768"><a href="#longitudinal_analysis-768"><span class="linenos"> 768</span></a><span class="sd">        It returns also the list of #ordered time points of the longitudinal dataset.</span>
</span><span id="longitudinal_analysis-769"><a href="#longitudinal_analysis-769"><span class="linenos"> 769</span></a>
</span><span id="longitudinal_analysis-770"><a href="#longitudinal_analysis-770"><span class="linenos"> 770</span></a><span class="sd">    merge_replicates(ntCDR3 = &#39;N. Seq. CDR3&#39;)</span>
</span><span id="longitudinal_analysis-771"><a href="#longitudinal_analysis-771"><span class="linenos"> 771</span></a><span class="sd">        tool to merge biological replicate 1 and biological replicate 2 data</span>
</span><span id="longitudinal_analysis-772"><a href="#longitudinal_analysis-772"><span class="linenos"> 772</span></a>
</span><span id="longitudinal_analysis-773"><a href="#longitudinal_analysis-773"><span class="linenos"> 773</span></a><span class="sd">    persistence_clones(ntCDR3 = &#39;N. Seq. CDR3&#39;)</span>
</span><span id="longitudinal_analysis-774"><a href="#longitudinal_analysis-774"><span class="linenos"> 774</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="longitudinal_analysis-775"><a href="#longitudinal_analysis-775"><span class="linenos"> 775</span></a>
</span><span id="longitudinal_analysis-776"><a href="#longitudinal_analysis-776"><span class="linenos"> 776</span></a><span class="sd">    plot_hist_persistence(filename,  ntCDR3 = &#39;N. Seq. CDR3&#39;, fontsize = 12)</span>
</span><span id="longitudinal_analysis-777"><a href="#longitudinal_analysis-777"><span class="linenos"> 777</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="longitudinal_analysis-778"><a href="#longitudinal_analysis-778"><span class="linenos"> 778</span></a>
</span><span id="longitudinal_analysis-779"><a href="#longitudinal_analysis-779"><span class="linenos"> 779</span></a><span class="sd">    get_top_clones_set(n_top_clones, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;)</span>
</span><span id="longitudinal_analysis-780"><a href="#longitudinal_analysis-780"><span class="linenos"> 780</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="longitudinal_analysis-781"><a href="#longitudinal_analysis-781"><span class="linenos"> 781</span></a>
</span><span id="longitudinal_analysis-782"><a href="#longitudinal_analysis-782"><span class="linenos"> 782</span></a><span class="sd">    build_traj_frame(top_clones_set, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;)</span>
</span><span id="longitudinal_analysis-783"><a href="#longitudinal_analysis-783"><span class="linenos"> 783</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="longitudinal_analysis-784"><a href="#longitudinal_analysis-784"><span class="linenos"> 784</span></a>
</span><span id="longitudinal_analysis-785"><a href="#longitudinal_analysis-785"><span class="linenos"> 785</span></a><span class="sd">    plot_trajectories(n_top_clones, filename, colormap = &#39;viridis&#39;, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;)</span>
</span><span id="longitudinal_analysis-786"><a href="#longitudinal_analysis-786"><span class="linenos"> 786</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="longitudinal_analysis-787"><a href="#longitudinal_analysis-787"><span class="linenos"> 787</span></a>
</span><span id="longitudinal_analysis-788"><a href="#longitudinal_analysis-788"><span class="linenos"> 788</span></a><span class="sd">    PCA_traj(n_top_clones, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;, nclus = 3)</span>
</span><span id="longitudinal_analysis-789"><a href="#longitudinal_analysis-789"><span class="linenos"> 789</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="longitudinal_analysis-790"><a href="#longitudinal_analysis-790"><span class="linenos"> 790</span></a>
</span><span id="longitudinal_analysis-791"><a href="#longitudinal_analysis-791"><span class="linenos"> 791</span></a><span class="sd">    plot_clusters2D(n_top_clones, filename, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;, nclus = 3, colormap = &#39;viridis&#39;)</span>
</span><span id="longitudinal_analysis-792"><a href="#longitudinal_analysis-792"><span class="linenos"> 792</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="longitudinal_analysis-793"><a href="#longitudinal_analysis-793"><span class="linenos"> 793</span></a>
</span><span id="longitudinal_analysis-794"><a href="#longitudinal_analysis-794"><span class="linenos"> 794</span></a><span class="sd">    plot_traj_clusters(n_top_clones, filename, ntCDR3 = &#39;N. Seq. CDR3&#39;, clone_count = &#39;Clone count&#39;, nclus = 3, colormap = &#39;viridis&#39;)</span>
</span><span id="longitudinal_analysis-795"><a href="#longitudinal_analysis-795"><span class="linenos"> 795</span></a><span class="sd">        TODESCRIBE</span>
</span><span id="longitudinal_analysis-796"><a href="#longitudinal_analysis-796"><span class="linenos"> 796</span></a>
</span><span id="longitudinal_analysis-797"><a href="#longitudinal_analysis-797"><span class="linenos"> 797</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-798"><a href="#longitudinal_analysis-798"><span class="linenos"> 798</span></a>
</span><span id="longitudinal_analysis-799"><a href="#longitudinal_analysis-799"><span class="linenos"> 799</span></a>
</span><span id="longitudinal_analysis-800"><a href="#longitudinal_analysis-800"><span class="linenos"> 800</span></a>
</span><span id="longitudinal_analysis-801"><a href="#longitudinal_analysis-801"><span class="linenos"> 801</span></a>
</span><span id="longitudinal_analysis-802"><a href="#longitudinal_analysis-802"><span class="linenos"> 802</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">,</span> <span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="s1">&#39;_F1&#39;</span><span class="p">,</span> <span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="s1">&#39;_F2&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis-803"><a href="#longitudinal_analysis-803"><span class="linenos"> 803</span></a>
</span><span id="longitudinal_analysis-804"><a href="#longitudinal_analysis-804"><span class="linenos"> 804</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="o">=</span> <span class="n">patient</span>
</span><span id="longitudinal_analysis-805"><a href="#longitudinal_analysis-805"><span class="linenos"> 805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span> <span class="o">=</span> <span class="n">data_folder</span>
</span><span id="longitudinal_analysis-806"><a href="#longitudinal_analysis-806"><span class="linenos"> 806</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="n">replicate_1_ID</span>
</span><span id="longitudinal_analysis-807"><a href="#longitudinal_analysis-807"><span class="linenos"> 807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="n">replicate_2_ID</span>
</span><span id="longitudinal_analysis-808"><a href="#longitudinal_analysis-808"><span class="linenos"> 808</span></a>
</span><span id="longitudinal_analysis-809"><a href="#longitudinal_analysis-809"><span class="linenos"> 809</span></a>
</span><span id="longitudinal_analysis-810"><a href="#longitudinal_analysis-810"><span class="linenos"> 810</span></a>    <span class="k">def</span> <span class="nf">import_clones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="longitudinal_analysis-811"><a href="#longitudinal_analysis-811"><span class="linenos"> 811</span></a>
</span><span id="longitudinal_analysis-812"><a href="#longitudinal_analysis-812"><span class="linenos"> 812</span></a>        <span class="sd">&quot;&quot;&quot; </span>
</span><span id="longitudinal_analysis-813"><a href="#longitudinal_analysis-813"><span class="linenos"> 813</span></a><span class="sd">        to import all the clonotypes of a given patient and store them in a dictionary.</span>
</span><span id="longitudinal_analysis-814"><a href="#longitudinal_analysis-814"><span class="linenos"> 814</span></a><span class="sd">        It returns also the list of #ordered time points of the longitudinal dataset.</span>
</span><span id="longitudinal_analysis-815"><a href="#longitudinal_analysis-815"><span class="linenos"> 815</span></a>
</span><span id="longitudinal_analysis-816"><a href="#longitudinal_analysis-816"><span class="linenos"> 816</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-817"><a href="#longitudinal_analysis-817"><span class="linenos"> 817</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-818"><a href="#longitudinal_analysis-818"><span class="linenos"> 818</span></a><span class="sd">        patient : str</span>
</span><span id="longitudinal_analysis-819"><a href="#longitudinal_analysis-819"><span class="linenos"> 819</span></a><span class="sd">            The ID of the patient</span>
</span><span id="longitudinal_analysis-820"><a href="#longitudinal_analysis-820"><span class="linenos"> 820</span></a><span class="sd">        data_folder : str</span>
</span><span id="longitudinal_analysis-821"><a href="#longitudinal_analysis-821"><span class="linenos"> 821</span></a><span class="sd">            The name of the folder to find data</span>
</span><span id="longitudinal_analysis-822"><a href="#longitudinal_analysis-822"><span class="linenos"> 822</span></a>
</span><span id="longitudinal_analysis-823"><a href="#longitudinal_analysis-823"><span class="linenos"> 823</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-824"><a href="#longitudinal_analysis-824"><span class="linenos"> 824</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-825"><a href="#longitudinal_analysis-825"><span class="linenos"> 825</span></a><span class="sd">        clones</span>
</span><span id="longitudinal_analysis-826"><a href="#longitudinal_analysis-826"><span class="linenos"> 826</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient.</span>
</span><span id="longitudinal_analysis-827"><a href="#longitudinal_analysis-827"><span class="linenos"> 827</span></a><span class="sd">           </span>
</span><span id="longitudinal_analysis-828"><a href="#longitudinal_analysis-828"><span class="linenos"> 828</span></a><span class="sd">        times</span>
</span><span id="longitudinal_analysis-829"><a href="#longitudinal_analysis-829"><span class="linenos"> 829</span></a><span class="sd">            a numpy vector containing all the RepSeq sampling times ordered.</span>
</span><span id="longitudinal_analysis-830"><a href="#longitudinal_analysis-830"><span class="linenos"> 830</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-831"><a href="#longitudinal_analysis-831"><span class="linenos"> 831</span></a>
</span><span id="longitudinal_analysis-832"><a href="#longitudinal_analysis-832"><span class="linenos"> 832</span></a>        <span class="n">patient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span>
</span><span id="longitudinal_analysis-833"><a href="#longitudinal_analysis-833"><span class="linenos"> 833</span></a>        <span class="n">data_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span>
</span><span id="longitudinal_analysis-834"><a href="#longitudinal_analysis-834"><span class="linenos"> 834</span></a>        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="longitudinal_analysis-835"><a href="#longitudinal_analysis-835"><span class="linenos"> 835</span></a>        <span class="n">clones</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="longitudinal_analysis-836"><a href="#longitudinal_analysis-836"><span class="linenos"> 836</span></a>
</span><span id="longitudinal_analysis-837"><a href="#longitudinal_analysis-837"><span class="linenos"> 837</span></a>        <span class="c1"># Iteration over all the file in the folder</span>
</span><span id="longitudinal_analysis-838"><a href="#longitudinal_analysis-838"><span class="linenos"> 838</span></a>        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">):</span>
</span><span id="longitudinal_analysis-839"><a href="#longitudinal_analysis-839"><span class="linenos"> 839</span></a>        <span class="c1"># If the name before the underscore corresponds to the chosen patient..</span>
</span><span id="longitudinal_analysis-840"><a href="#longitudinal_analysis-840"><span class="linenos"> 840</span></a>            <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">patient</span><span class="p">:</span>
</span><span id="longitudinal_analysis-841"><a href="#longitudinal_analysis-841"><span class="linenos"> 841</span></a>                <span class="c1"># Import the table</span>
</span><span id="longitudinal_analysis-842"><a href="#longitudinal_analysis-842"><span class="linenos"> 842</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_folder</span><span class="o">+</span><span class="n">file_name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;zip&#39;</span><span class="p">))</span>
</span><span id="longitudinal_analysis-843"><a href="#longitudinal_analysis-843"><span class="linenos"> 843</span></a>                <span class="c1"># Store it in a dictionary where the key contains the patient, the time</span>
</span><span id="longitudinal_analysis-844"><a href="#longitudinal_analysis-844"><span class="linenos"> 844</span></a>                <span class="c1"># and the replicate.</span>
</span><span id="longitudinal_analysis-845"><a href="#longitudinal_analysis-845"><span class="linenos"> 845</span></a>                <span class="n">clones</span><span class="p">[</span><span class="n">file_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">]]</span> <span class="o">=</span> <span class="n">frame</span>
</span><span id="longitudinal_analysis-846"><a href="#longitudinal_analysis-846"><span class="linenos"> 846</span></a>                <span class="c1"># Reading the time from the name and storing it</span>
</span><span id="longitudinal_analysis-847"><a href="#longitudinal_analysis-847"><span class="linenos"> 847</span></a>                <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="longitudinal_analysis-848"><a href="#longitudinal_analysis-848"><span class="linenos"> 848</span></a>                <span class="c1">#print(&#39;Clonotypes&#39;,file_name[:-10],&#39;imported&#39;)</span>
</span><span id="longitudinal_analysis-849"><a href="#longitudinal_analysis-849"><span class="linenos"> 849</span></a>
</span><span id="longitudinal_analysis-850"><a href="#longitudinal_analysis-850"><span class="linenos"> 850</span></a>        <span class="c1"># Sorting the unique times</span>
</span><span id="longitudinal_analysis-851"><a href="#longitudinal_analysis-851"><span class="linenos"> 851</span></a>        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">times</span><span class="p">)))</span>
</span><span id="longitudinal_analysis-852"><a href="#longitudinal_analysis-852"><span class="linenos"> 852</span></a>        <span class="k">return</span> <span class="n">clones</span><span class="p">,</span> <span class="n">times</span>
</span><span id="longitudinal_analysis-853"><a href="#longitudinal_analysis-853"><span class="linenos"> 853</span></a>
</span><span id="longitudinal_analysis-854"><a href="#longitudinal_analysis-854"><span class="linenos"> 854</span></a>    <span class="k">def</span> <span class="nf">merge_replicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis-855"><a href="#longitudinal_analysis-855"><span class="linenos"> 855</span></a>        
</span><span id="longitudinal_analysis-856"><a href="#longitudinal_analysis-856"><span class="linenos"> 856</span></a>        <span class="sd">&#39;&#39;&#39; Creating the dataframes for the merged replicates. After this operation the </span>
</span><span id="longitudinal_analysis-857"><a href="#longitudinal_analysis-857"><span class="linenos"> 857</span></a><span class="sd">        clones_merged dictionary contains the the merged table of the first and second</span>
</span><span id="longitudinal_analysis-858"><a href="#longitudinal_analysis-858"><span class="linenos"> 858</span></a><span class="sd">        replicate. The indexes are the same as before without the F1/2 label.</span>
</span><span id="longitudinal_analysis-859"><a href="#longitudinal_analysis-859"><span class="linenos"> 859</span></a>
</span><span id="longitudinal_analysis-860"><a href="#longitudinal_analysis-860"><span class="linenos"> 860</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-861"><a href="#longitudinal_analysis-861"><span class="linenos"> 861</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-862"><a href="#longitudinal_analysis-862"><span class="linenos"> 862</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis-863"><a href="#longitudinal_analysis-863"><span class="linenos"> 863</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;. </span>
</span><span id="longitudinal_analysis-864"><a href="#longitudinal_analysis-864"><span class="linenos"> 864</span></a>
</span><span id="longitudinal_analysis-865"><a href="#longitudinal_analysis-865"><span class="linenos"> 865</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-866"><a href="#longitudinal_analysis-866"><span class="linenos"> 866</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-867"><a href="#longitudinal_analysis-867"><span class="linenos"> 867</span></a><span class="sd">        clones_merged</span>
</span><span id="longitudinal_analysis-868"><a href="#longitudinal_analysis-868"><span class="linenos"> 868</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient that were merged for both replicates.</span>
</span><span id="longitudinal_analysis-869"><a href="#longitudinal_analysis-869"><span class="linenos"> 869</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="longitudinal_analysis-870"><a href="#longitudinal_analysis-870"><span class="linenos"> 870</span></a>
</span><span id="longitudinal_analysis-871"><a href="#longitudinal_analysis-871"><span class="linenos"> 871</span></a>        <span class="n">patient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span>
</span><span id="longitudinal_analysis-872"><a href="#longitudinal_analysis-872"><span class="linenos"> 872</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis-873"><a href="#longitudinal_analysis-873"><span class="linenos"> 873</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="longitudinal_analysis-874"><a href="#longitudinal_analysis-874"><span class="linenos"> 874</span></a>
</span><span id="longitudinal_analysis-875"><a href="#longitudinal_analysis-875"><span class="linenos"> 875</span></a>        <span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicate_1_ID</span> 
</span><span id="longitudinal_analysis-876"><a href="#longitudinal_analysis-876"><span class="linenos"> 876</span></a>        <span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicate_2_ID</span>
</span><span id="longitudinal_analysis-877"><a href="#longitudinal_analysis-877"><span class="linenos"> 877</span></a>
</span><span id="longitudinal_analysis-878"><a href="#longitudinal_analysis-878"><span class="linenos"> 878</span></a>        <span class="c1"># Iteration over the times</span>
</span><span id="longitudinal_analysis-879"><a href="#longitudinal_analysis-879"><span class="linenos"> 879</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
</span><span id="longitudinal_analysis-880"><a href="#longitudinal_analysis-880"><span class="linenos"> 880</span></a>            <span class="c1"># Building the ids correponding at 1st and 2nd replicate at given time point</span>
</span><span id="longitudinal_analysis-881"><a href="#longitudinal_analysis-881"><span class="linenos"> 881</span></a>            <span class="n">id_F1</span> <span class="o">=</span> <span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">replicate_1_ID</span>
</span><span id="longitudinal_analysis-882"><a href="#longitudinal_analysis-882"><span class="linenos"> 882</span></a>            <span class="n">id_F2</span> <span class="o">=</span> <span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">replicate_2_ID</span>
</span><span id="longitudinal_analysis-883"><a href="#longitudinal_analysis-883"><span class="linenos"> 883</span></a>            <span class="c1"># Below all the rows of one table are appended to the rows of the other</span>
</span><span id="longitudinal_analysis-884"><a href="#longitudinal_analysis-884"><span class="linenos"> 884</span></a>            <span class="n">merged_replicates</span> <span class="o">=</span> <span class="n">clones</span><span class="p">[</span><span class="n">id_F1</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">clones</span><span class="p">[</span><span class="n">id_F2</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis-885"><a href="#longitudinal_analysis-885"><span class="linenos"> 885</span></a>            <span class="c1"># But there are common clonotypes that now appear in two different rows </span>
</span><span id="longitudinal_analysis-886"><a href="#longitudinal_analysis-886"><span class="linenos"> 886</span></a>            <span class="c1"># (one for the first and one for the second replicate)! </span>
</span><span id="longitudinal_analysis-887"><a href="#longitudinal_analysis-887"><span class="linenos"> 887</span></a>            <span class="c1"># Below we collapse those common sequences and the counts of the two are summed </span>
</span><span id="longitudinal_analysis-888"><a href="#longitudinal_analysis-888"><span class="linenos"> 888</span></a>            <span class="n">merged_replicates</span> <span class="o">=</span> <span class="n">merged_replicates</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ntCDR3</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Clone count&#39;</span><span class="p">:</span><span class="nb">sum</span><span class="p">})</span>
</span><span id="longitudinal_analysis-889"><a href="#longitudinal_analysis-889"><span class="linenos"> 889</span></a>            <span class="c1"># The merged table is then added to the dictionary</span>
</span><span id="longitudinal_analysis-890"><a href="#longitudinal_analysis-890"><span class="linenos"> 890</span></a>            <span class="n">clones_merged</span><span class="p">[</span><span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">merged_replicates</span>
</span><span id="longitudinal_analysis-891"><a href="#longitudinal_analysis-891"><span class="linenos"> 891</span></a>
</span><span id="longitudinal_analysis-892"><a href="#longitudinal_analysis-892"><span class="linenos"> 892</span></a>        <span class="k">return</span> <span class="n">clones_merged</span>
</span><span id="longitudinal_analysis-893"><a href="#longitudinal_analysis-893"><span class="linenos"> 893</span></a>
</span><span id="longitudinal_analysis-894"><a href="#longitudinal_analysis-894"><span class="linenos"> 894</span></a>    <span class="k">def</span> <span class="nf">persistence_clones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis-895"><a href="#longitudinal_analysis-895"><span class="linenos"> 895</span></a>
</span><span id="longitudinal_analysis-896"><a href="#longitudinal_analysis-896"><span class="linenos"> 896</span></a>        <span class="sd">&quot;&quot;&quot;A list of all the clonotypes appearing in all the time points is created.</span>
</span><span id="longitudinal_analysis-897"><a href="#longitudinal_analysis-897"><span class="linenos"> 897</span></a><span class="sd">        Note that if one clonotype is present in 2 or more points, it will be repeated</span>
</span><span id="longitudinal_analysis-898"><a href="#longitudinal_analysis-898"><span class="linenos"> 898</span></a><span class="sd">        twice in the list.</span>
</span><span id="longitudinal_analysis-899"><a href="#longitudinal_analysis-899"><span class="linenos"> 899</span></a>
</span><span id="longitudinal_analysis-900"><a href="#longitudinal_analysis-900"><span class="linenos"> 900</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-901"><a href="#longitudinal_analysis-901"><span class="linenos"> 901</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-902"><a href="#longitudinal_analysis-902"><span class="linenos"> 902</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis-903"><a href="#longitudinal_analysis-903"><span class="linenos"> 903</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;. </span>
</span><span id="longitudinal_analysis-904"><a href="#longitudinal_analysis-904"><span class="linenos"> 904</span></a>
</span><span id="longitudinal_analysis-905"><a href="#longitudinal_analysis-905"><span class="linenos"> 905</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-906"><a href="#longitudinal_analysis-906"><span class="linenos"> 906</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-907"><a href="#longitudinal_analysis-907"><span class="linenos"> 907</span></a><span class="sd">        unique_clones</span>
</span><span id="longitudinal_analysis-908"><a href="#longitudinal_analysis-908"><span class="linenos"> 908</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient that were merged for both replicates.</span>
</span><span id="longitudinal_analysis-909"><a href="#longitudinal_analysis-909"><span class="linenos"> 909</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis-910"><a href="#longitudinal_analysis-910"><span class="linenos"> 910</span></a><span class="sd">        time_occurence</span>
</span><span id="longitudinal_analysis-911"><a href="#longitudinal_analysis-911"><span class="linenos"> 911</span></a>
</span><span id="longitudinal_analysis-912"><a href="#longitudinal_analysis-912"><span class="linenos"> 912</span></a>
</span><span id="longitudinal_analysis-913"><a href="#longitudinal_analysis-913"><span class="linenos"> 913</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-914"><a href="#longitudinal_analysis-914"><span class="linenos"> 914</span></a>
</span><span id="longitudinal_analysis-915"><a href="#longitudinal_analysis-915"><span class="linenos"> 915</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="longitudinal_analysis-916"><a href="#longitudinal_analysis-916"><span class="linenos"> 916</span></a>        <span class="n">all_clones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="longitudinal_analysis-917"><a href="#longitudinal_analysis-917"><span class="linenos"> 917</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="longitudinal_analysis-918"><a href="#longitudinal_analysis-918"><span class="linenos"> 918</span></a>            <span class="n">all_clones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_clones</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="longitudinal_analysis-919"><a href="#longitudinal_analysis-919"><span class="linenos"> 919</span></a>
</span><span id="longitudinal_analysis-920"><a href="#longitudinal_analysis-920"><span class="linenos"> 920</span></a>        <span class="c1"># The following function returns the list of unique clonotypes and the number of</span>
</span><span id="longitudinal_analysis-921"><a href="#longitudinal_analysis-921"><span class="linenos"> 921</span></a>        <span class="c1"># repetitions for each of them. </span>
</span><span id="longitudinal_analysis-922"><a href="#longitudinal_analysis-922"><span class="linenos"> 922</span></a>        <span class="c1"># Note that the number of repetitions is exactly the time occurrence</span>
</span><span id="longitudinal_analysis-923"><a href="#longitudinal_analysis-923"><span class="linenos"> 923</span></a>        <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_clones</span><span class="p">,</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="longitudinal_analysis-924"><a href="#longitudinal_analysis-924"><span class="linenos"> 924</span></a>
</span><span id="longitudinal_analysis-925"><a href="#longitudinal_analysis-925"><span class="linenos"> 925</span></a>        <span class="k">return</span> <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span>
</span><span id="longitudinal_analysis-926"><a href="#longitudinal_analysis-926"><span class="linenos"> 926</span></a>
</span><span id="longitudinal_analysis-927"><a href="#longitudinal_analysis-927"><span class="linenos"> 927</span></a>
</span><span id="longitudinal_analysis-928"><a href="#longitudinal_analysis-928"><span class="linenos"> 928</span></a>    <span class="k">def</span> <span class="nf">plot_hist_persistence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>  <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
</span><span id="longitudinal_analysis-929"><a href="#longitudinal_analysis-929"><span class="linenos"> 929</span></a>
</span><span id="longitudinal_analysis-930"><a href="#longitudinal_analysis-930"><span class="linenos"> 930</span></a>        <span class="sd">&quot;&quot;&quot; TOFILL</span>
</span><span id="longitudinal_analysis-931"><a href="#longitudinal_analysis-931"><span class="linenos"> 931</span></a>
</span><span id="longitudinal_analysis-932"><a href="#longitudinal_analysis-932"><span class="linenos"> 932</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-933"><a href="#longitudinal_analysis-933"><span class="linenos"> 933</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-934"><a href="#longitudinal_analysis-934"><span class="linenos"> 934</span></a><span class="sd">        filename : str</span>
</span><span id="longitudinal_analysis-935"><a href="#longitudinal_analysis-935"><span class="linenos"> 935</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-936"><a href="#longitudinal_analysis-936"><span class="linenos"> 936</span></a>
</span><span id="longitudinal_analysis-937"><a href="#longitudinal_analysis-937"><span class="linenos"> 937</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis-938"><a href="#longitudinal_analysis-938"><span class="linenos"> 938</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="longitudinal_analysis-939"><a href="#longitudinal_analysis-939"><span class="linenos"> 939</span></a>
</span><span id="longitudinal_analysis-940"><a href="#longitudinal_analysis-940"><span class="linenos"> 940</span></a><span class="sd">        fontsize : float</span>
</span><span id="longitudinal_analysis-941"><a href="#longitudinal_analysis-941"><span class="linenos"> 941</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-942"><a href="#longitudinal_analysis-942"><span class="linenos"> 942</span></a>
</span><span id="longitudinal_analysis-943"><a href="#longitudinal_analysis-943"><span class="linenos"> 943</span></a>
</span><span id="longitudinal_analysis-944"><a href="#longitudinal_analysis-944"><span class="linenos"> 944</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-945"><a href="#longitudinal_analysis-945"><span class="linenos"> 945</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-946"><a href="#longitudinal_analysis-946"><span class="linenos"> 946</span></a><span class="sd">        plot</span>
</span><span id="longitudinal_analysis-947"><a href="#longitudinal_analysis-947"><span class="linenos"> 947</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis-948"><a href="#longitudinal_analysis-948"><span class="linenos"> 948</span></a>
</span><span id="longitudinal_analysis-949"><a href="#longitudinal_analysis-949"><span class="linenos"> 949</span></a>
</span><span id="longitudinal_analysis-950"><a href="#longitudinal_analysis-950"><span class="linenos"> 950</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-951"><a href="#longitudinal_analysis-951"><span class="linenos"> 951</span></a>
</span><span id="longitudinal_analysis-952"><a href="#longitudinal_analysis-952"><span class="linenos"> 952</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis-953"><a href="#longitudinal_analysis-953"><span class="linenos"> 953</span></a>        <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis-954"><a href="#longitudinal_analysis-954"><span class="linenos"> 954</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis-955"><a href="#longitudinal_analysis-955"><span class="linenos"> 955</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis-956"><a href="#longitudinal_analysis-956"><span class="linenos"> 956</span></a>
</span><span id="longitudinal_analysis-957"><a href="#longitudinal_analysis-957"><span class="linenos"> 957</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="longitudinal_analysis-958"><a href="#longitudinal_analysis-958"><span class="linenos"> 958</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis-959"><a href="#longitudinal_analysis-959"><span class="linenos"> 959</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time occurrence&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis-960"><a href="#longitudinal_analysis-960"><span class="linenos"> 960</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis-961"><a href="#longitudinal_analysis-961"><span class="linenos"> 961</span></a>        <span class="n">h</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">time_occurrence</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="longitudinal_analysis-962"><a href="#longitudinal_analysis-962"><span class="linenos"> 962</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis-963"><a href="#longitudinal_analysis-963"><span class="linenos"> 963</span></a>
</span><span id="longitudinal_analysis-964"><a href="#longitudinal_analysis-964"><span class="linenos"> 964</span></a>    <span class="k">def</span> <span class="nf">get_top_clones_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis-965"><a href="#longitudinal_analysis-965"><span class="linenos"> 965</span></a>        
</span><span id="longitudinal_analysis-966"><a href="#longitudinal_analysis-966"><span class="linenos"> 966</span></a>        <span class="sd">&quot;&quot;&quot; TOFILL</span>
</span><span id="longitudinal_analysis-967"><a href="#longitudinal_analysis-967"><span class="linenos"> 967</span></a>
</span><span id="longitudinal_analysis-968"><a href="#longitudinal_analysis-968"><span class="linenos"> 968</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-969"><a href="#longitudinal_analysis-969"><span class="linenos"> 969</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-970"><a href="#longitudinal_analysis-970"><span class="linenos"> 970</span></a><span class="sd">        filename : str</span>
</span><span id="longitudinal_analysis-971"><a href="#longitudinal_analysis-971"><span class="linenos"> 971</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-972"><a href="#longitudinal_analysis-972"><span class="linenos"> 972</span></a>
</span><span id="longitudinal_analysis-973"><a href="#longitudinal_analysis-973"><span class="linenos"> 973</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis-974"><a href="#longitudinal_analysis-974"><span class="linenos"> 974</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="longitudinal_analysis-975"><a href="#longitudinal_analysis-975"><span class="linenos"> 975</span></a>
</span><span id="longitudinal_analysis-976"><a href="#longitudinal_analysis-976"><span class="linenos"> 976</span></a><span class="sd">        fontsize : float</span>
</span><span id="longitudinal_analysis-977"><a href="#longitudinal_analysis-977"><span class="linenos"> 977</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-978"><a href="#longitudinal_analysis-978"><span class="linenos"> 978</span></a>
</span><span id="longitudinal_analysis-979"><a href="#longitudinal_analysis-979"><span class="linenos"> 979</span></a>
</span><span id="longitudinal_analysis-980"><a href="#longitudinal_analysis-980"><span class="linenos"> 980</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-981"><a href="#longitudinal_analysis-981"><span class="linenos"> 981</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-982"><a href="#longitudinal_analysis-982"><span class="linenos"> 982</span></a><span class="sd">        plot</span>
</span><span id="longitudinal_analysis-983"><a href="#longitudinal_analysis-983"><span class="linenos"> 983</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis-984"><a href="#longitudinal_analysis-984"><span class="linenos"> 984</span></a>
</span><span id="longitudinal_analysis-985"><a href="#longitudinal_analysis-985"><span class="linenos"> 985</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis-986"><a href="#longitudinal_analysis-986"><span class="linenos"> 986</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-987"><a href="#longitudinal_analysis-987"><span class="linenos"> 987</span></a>
</span><span id="longitudinal_analysis-988"><a href="#longitudinal_analysis-988"><span class="linenos"> 988</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="longitudinal_analysis-989"><a href="#longitudinal_analysis-989"><span class="linenos"> 989</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="longitudinal_analysis-990"><a href="#longitudinal_analysis-990"><span class="linenos"> 990</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="longitudinal_analysis-991"><a href="#longitudinal_analysis-991"><span class="linenos"> 991</span></a>            <span class="n">top_clones_at_time</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">clone_count</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="n">n_top_clones</span><span class="p">]</span>
</span><span id="longitudinal_analysis-992"><a href="#longitudinal_analysis-992"><span class="linenos"> 992</span></a>            <span class="n">top_clones</span> <span class="o">=</span> <span class="n">top_clones</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">top_clones_at_time</span><span class="p">[</span><span class="n">ntCDR3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="longitudinal_analysis-993"><a href="#longitudinal_analysis-993"><span class="linenos"> 993</span></a>        <span class="k">return</span> <span class="n">top_clones</span>
</span><span id="longitudinal_analysis-994"><a href="#longitudinal_analysis-994"><span class="linenos"> 994</span></a>
</span><span id="longitudinal_analysis-995"><a href="#longitudinal_analysis-995"><span class="linenos"> 995</span></a>    <span class="k">def</span> <span class="nf">build_traj_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_clones_set</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis-996"><a href="#longitudinal_analysis-996"><span class="linenos"> 996</span></a>        
</span><span id="longitudinal_analysis-997"><a href="#longitudinal_analysis-997"><span class="linenos"> 997</span></a>        <span class="sd">&quot;&quot;&quot; </span>
</span><span id="longitudinal_analysis-998"><a href="#longitudinal_analysis-998"><span class="linenos"> 998</span></a><span class="sd">        This builds a dataframe containing the count at all the time points for each </span>
</span><span id="longitudinal_analysis-999"><a href="#longitudinal_analysis-999"><span class="linenos"> 999</span></a><span class="sd">        of the clonotypes specified in top_clones_set.</span>
</span><span id="longitudinal_analysis-1000"><a href="#longitudinal_analysis-1000"><span class="linenos">1000</span></a><span class="sd">        The dataframe has also a field that contains the cumulative count.</span>
</span><span id="longitudinal_analysis-1001"><a href="#longitudinal_analysis-1001"><span class="linenos">1001</span></a><span class="sd">        The trajectory dataframe is initialised with indexes as the clonotypes in</span>
</span><span id="longitudinal_analysis-1002"><a href="#longitudinal_analysis-1002"><span class="linenos">1002</span></a><span class="sd">        top_clones_set</span>
</span><span id="longitudinal_analysis-1003"><a href="#longitudinal_analysis-1003"><span class="linenos">1003</span></a>
</span><span id="longitudinal_analysis-1004"><a href="#longitudinal_analysis-1004"><span class="linenos">1004</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-1005"><a href="#longitudinal_analysis-1005"><span class="linenos">1005</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-1006"><a href="#longitudinal_analysis-1006"><span class="linenos">1006</span></a><span class="sd">        top_clones_set : TOFILL</span>
</span><span id="longitudinal_analysis-1007"><a href="#longitudinal_analysis-1007"><span class="linenos">1007</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1008"><a href="#longitudinal_analysis-1008"><span class="linenos">1008</span></a>
</span><span id="longitudinal_analysis-1009"><a href="#longitudinal_analysis-1009"><span class="linenos">1009</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis-1010"><a href="#longitudinal_analysis-1010"><span class="linenos">1010</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="longitudinal_analysis-1011"><a href="#longitudinal_analysis-1011"><span class="linenos">1011</span></a>
</span><span id="longitudinal_analysis-1012"><a href="#longitudinal_analysis-1012"><span class="linenos">1012</span></a><span class="sd">        clone_count : str </span>
</span><span id="longitudinal_analysis-1013"><a href="#longitudinal_analysis-1013"><span class="linenos">1013</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1014"><a href="#longitudinal_analysis-1014"><span class="linenos">1014</span></a>
</span><span id="longitudinal_analysis-1015"><a href="#longitudinal_analysis-1015"><span class="linenos">1015</span></a>
</span><span id="longitudinal_analysis-1016"><a href="#longitudinal_analysis-1016"><span class="linenos">1016</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-1017"><a href="#longitudinal_analysis-1017"><span class="linenos">1017</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-1018"><a href="#longitudinal_analysis-1018"><span class="linenos">1018</span></a><span class="sd">        traj_frame</span>
</span><span id="longitudinal_analysis-1019"><a href="#longitudinal_analysis-1019"><span class="linenos">1019</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis-1020"><a href="#longitudinal_analysis-1020"><span class="linenos">1020</span></a>
</span><span id="longitudinal_analysis-1021"><a href="#longitudinal_analysis-1021"><span class="linenos">1021</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1022"><a href="#longitudinal_analysis-1022"><span class="linenos">1022</span></a>
</span><span id="longitudinal_analysis-1023"><a href="#longitudinal_analysis-1023"><span class="linenos">1023</span></a>
</span><span id="longitudinal_analysis-1024"><a href="#longitudinal_analysis-1024"><span class="linenos">1024</span></a>
</span><span id="longitudinal_analysis-1025"><a href="#longitudinal_analysis-1025"><span class="linenos">1025</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="longitudinal_analysis-1026"><a href="#longitudinal_analysis-1026"><span class="linenos">1026</span></a>
</span><span id="longitudinal_analysis-1027"><a href="#longitudinal_analysis-1027"><span class="linenos">1027</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">top_clones_set</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1028"><a href="#longitudinal_analysis-1028"><span class="linenos">1028</span></a>        <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="longitudinal_analysis-1029"><a href="#longitudinal_analysis-1029"><span class="linenos">1029</span></a>
</span><span id="longitudinal_analysis-1030"><a href="#longitudinal_analysis-1030"><span class="linenos">1030</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
</span><span id="longitudinal_analysis-1031"><a href="#longitudinal_analysis-1031"><span class="linenos">1031</span></a>
</span><span id="longitudinal_analysis-1032"><a href="#longitudinal_analysis-1032"><span class="linenos">1032</span></a>            <span class="c1"># Getting the time from the index of clones_merged</span>
</span><span id="longitudinal_analysis-1033"><a href="#longitudinal_analysis-1033"><span class="linenos">1033</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">id_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="longitudinal_analysis-1034"><a href="#longitudinal_analysis-1034"><span class="linenos">1034</span></a>            <span class="c1"># Selecting the clonotypes that are both in the frame at the given time </span>
</span><span id="longitudinal_analysis-1035"><a href="#longitudinal_analysis-1035"><span class="linenos">1035</span></a>            <span class="c1"># point and in the list of top_clones_set</span>
</span><span id="longitudinal_analysis-1036"><a href="#longitudinal_analysis-1036"><span class="linenos">1036</span></a>            <span class="n">top_clones_at_time</span> <span class="o">=</span> <span class="n">top_clones_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="n">ntCDR3</span><span class="p">]))</span>
</span><span id="longitudinal_analysis-1037"><a href="#longitudinal_analysis-1037"><span class="linenos">1037</span></a>            <span class="c1"># Creating a sub-dataframe containing only the clone in top_clones_at_time</span>
</span><span id="longitudinal_analysis-1038"><a href="#longitudinal_analysis-1038"><span class="linenos">1038</span></a>            <span class="n">clones_at_time</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">ntCDR3</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_clones_at_time</span><span class="p">]</span>
</span><span id="longitudinal_analysis-1039"><a href="#longitudinal_analysis-1039"><span class="linenos">1039</span></a>            <span class="c1"># Creating a new column in the trajectory frames for the counts at that time</span>
</span><span id="longitudinal_analysis-1040"><a href="#longitudinal_analysis-1040"><span class="linenos">1040</span></a>            <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">clones_at_time</span><span class="p">[</span><span class="n">clone_count</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="longitudinal_analysis-1041"><a href="#longitudinal_analysis-1041"><span class="linenos">1041</span></a>            <span class="c1"># The clonotypes not present at that time are NaN. Below we convert NaN in 0s</span>
</span><span id="longitudinal_analysis-1042"><a href="#longitudinal_analysis-1042"><span class="linenos">1042</span></a>            <span class="n">traj_frame</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1043"><a href="#longitudinal_analysis-1043"><span class="linenos">1043</span></a>            <span class="c1"># The cumulative count for each clonotype is updated</span>
</span><span id="longitudinal_analysis-1044"><a href="#longitudinal_analysis-1044"><span class="linenos">1044</span></a>            <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>
</span><span id="longitudinal_analysis-1045"><a href="#longitudinal_analysis-1045"><span class="linenos">1045</span></a>        
</span><span id="longitudinal_analysis-1046"><a href="#longitudinal_analysis-1046"><span class="linenos">1046</span></a>        <span class="k">return</span> <span class="n">traj_frame</span> 
</span><span id="longitudinal_analysis-1047"><a href="#longitudinal_analysis-1047"><span class="linenos">1047</span></a>
</span><span id="longitudinal_analysis-1048"><a href="#longitudinal_analysis-1048"><span class="linenos">1048</span></a>
</span><span id="longitudinal_analysis-1049"><a href="#longitudinal_analysis-1049"><span class="linenos">1049</span></a>
</span><span id="longitudinal_analysis-1050"><a href="#longitudinal_analysis-1050"><span class="linenos">1050</span></a>    <span class="c1"># Plot clonal trajectories</span>
</span><span id="longitudinal_analysis-1051"><a href="#longitudinal_analysis-1051"><span class="linenos">1051</span></a>
</span><span id="longitudinal_analysis-1052"><a href="#longitudinal_analysis-1052"><span class="linenos">1052</span></a>
</span><span id="longitudinal_analysis-1053"><a href="#longitudinal_analysis-1053"><span class="linenos">1053</span></a>    <span class="k">def</span> <span class="nf">plot_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis-1054"><a href="#longitudinal_analysis-1054"><span class="linenos">1054</span></a>
</span><span id="longitudinal_analysis-1055"><a href="#longitudinal_analysis-1055"><span class="linenos">1055</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1056"><a href="#longitudinal_analysis-1056"><span class="linenos">1056</span></a><span class="sd">        Function to plot the trajectories of the first top n clones using your favorite colormap</span>
</span><span id="longitudinal_analysis-1057"><a href="#longitudinal_analysis-1057"><span class="linenos">1057</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis-1058"><a href="#longitudinal_analysis-1058"><span class="linenos">1058</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-1059"><a href="#longitudinal_analysis-1059"><span class="linenos">1059</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-1060"><a href="#longitudinal_analysis-1060"><span class="linenos">1060</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="longitudinal_analysis-1061"><a href="#longitudinal_analysis-1061"><span class="linenos">1061</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1062"><a href="#longitudinal_analysis-1062"><span class="linenos">1062</span></a>
</span><span id="longitudinal_analysis-1063"><a href="#longitudinal_analysis-1063"><span class="linenos">1063</span></a><span class="sd">        filename  : str</span>
</span><span id="longitudinal_analysis-1064"><a href="#longitudinal_analysis-1064"><span class="linenos">1064</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1065"><a href="#longitudinal_analysis-1065"><span class="linenos">1065</span></a>
</span><span id="longitudinal_analysis-1066"><a href="#longitudinal_analysis-1066"><span class="linenos">1066</span></a><span class="sd">        colormap : TOFILL</span>
</span><span id="longitudinal_analysis-1067"><a href="#longitudinal_analysis-1067"><span class="linenos">1067</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1068"><a href="#longitudinal_analysis-1068"><span class="linenos">1068</span></a>
</span><span id="longitudinal_analysis-1069"><a href="#longitudinal_analysis-1069"><span class="linenos">1069</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="longitudinal_analysis-1070"><a href="#longitudinal_analysis-1070"><span class="linenos">1070</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1071"><a href="#longitudinal_analysis-1071"><span class="linenos">1071</span></a>
</span><span id="longitudinal_analysis-1072"><a href="#longitudinal_analysis-1072"><span class="linenos">1072</span></a><span class="sd">        clone_count : str</span>
</span><span id="longitudinal_analysis-1073"><a href="#longitudinal_analysis-1073"><span class="linenos">1073</span></a>
</span><span id="longitudinal_analysis-1074"><a href="#longitudinal_analysis-1074"><span class="linenos">1074</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1075"><a href="#longitudinal_analysis-1075"><span class="linenos">1075</span></a>
</span><span id="longitudinal_analysis-1076"><a href="#longitudinal_analysis-1076"><span class="linenos">1076</span></a>
</span><span id="longitudinal_analysis-1077"><a href="#longitudinal_analysis-1077"><span class="linenos">1077</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-1078"><a href="#longitudinal_analysis-1078"><span class="linenos">1078</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-1079"><a href="#longitudinal_analysis-1079"><span class="linenos">1079</span></a><span class="sd">        plot </span>
</span><span id="longitudinal_analysis-1080"><a href="#longitudinal_analysis-1080"><span class="linenos">1080</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis-1081"><a href="#longitudinal_analysis-1081"><span class="linenos">1081</span></a>
</span><span id="longitudinal_analysis-1082"><a href="#longitudinal_analysis-1082"><span class="linenos">1082</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1083"><a href="#longitudinal_analysis-1083"><span class="linenos">1083</span></a>
</span><span id="longitudinal_analysis-1084"><a href="#longitudinal_analysis-1084"><span class="linenos">1084</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1085"><a href="#longitudinal_analysis-1085"><span class="linenos">1085</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis-1086"><a href="#longitudinal_analysis-1086"><span class="linenos">1086</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="longitudinal_analysis-1087"><a href="#longitudinal_analysis-1087"><span class="linenos">1087</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="longitudinal_analysis-1088"><a href="#longitudinal_analysis-1088"><span class="linenos">1088</span></a>
</span><span id="longitudinal_analysis-1089"><a href="#longitudinal_analysis-1089"><span class="linenos">1089</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1090"><a href="#longitudinal_analysis-1090"><span class="linenos">1090</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1091"><a href="#longitudinal_analysis-1091"><span class="linenos">1091</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="longitudinal_analysis-1092"><a href="#longitudinal_analysis-1092"><span class="linenos">1092</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1093"><a href="#longitudinal_analysis-1093"><span class="linenos">1093</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1094"><a href="#longitudinal_analysis-1094"><span class="linenos">1094</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1095"><a href="#longitudinal_analysis-1095"><span class="linenos">1095</span></a>
</span><span id="longitudinal_analysis-1096"><a href="#longitudinal_analysis-1096"><span class="linenos">1096</span></a>        <span class="n">log_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1097"><a href="#longitudinal_analysis-1097"><span class="linenos">1097</span></a>        <span class="n">max_log_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1098"><a href="#longitudinal_analysis-1098"><span class="linenos">1098</span></a>        <span class="n">min_log_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1099"><a href="#longitudinal_analysis-1099"><span class="linenos">1099</span></a>
</span><span id="longitudinal_analysis-1100"><a href="#longitudinal_analysis-1100"><span class="linenos">1100</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="longitudinal_analysis-1101"><a href="#longitudinal_analysis-1101"><span class="linenos">1101</span></a>            <span class="n">traj</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="longitudinal_analysis-1102"><a href="#longitudinal_analysis-1102"><span class="linenos">1102</span></a>            <span class="n">log_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">])</span>
</span><span id="longitudinal_analysis-1103"><a href="#longitudinal_analysis-1103"><span class="linenos">1103</span></a>            <span class="n">norm_log_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_count</span><span class="o">-</span><span class="n">min_log_count</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">max_log_count</span><span class="o">-</span><span class="n">min_log_count</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1104"><a href="#longitudinal_analysis-1104"><span class="linenos">1104</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">traj</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm_log_count</span><span class="p">))</span> <span class="c1"># I am adding 1 to define a kind of pseudo-count here and avoid 0 values</span>
</span><span id="longitudinal_analysis-1105"><a href="#longitudinal_analysis-1105"><span class="linenos">1105</span></a>
</span><span id="longitudinal_analysis-1106"><a href="#longitudinal_analysis-1106"><span class="linenos">1106</span></a>
</span><span id="longitudinal_analysis-1107"><a href="#longitudinal_analysis-1107"><span class="linenos">1107</span></a>        <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">log_counts</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)))</span>
</span><span id="longitudinal_analysis-1108"><a href="#longitudinal_analysis-1108"><span class="linenos">1108</span></a>        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1109"><a href="#longitudinal_analysis-1109"><span class="linenos">1109</span></a>        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Log10 cumulative count&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1110"><a href="#longitudinal_analysis-1110"><span class="linenos">1110</span></a>
</span><span id="longitudinal_analysis-1111"><a href="#longitudinal_analysis-1111"><span class="linenos">1111</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1112"><a href="#longitudinal_analysis-1112"><span class="linenos">1112</span></a>
</span><span id="longitudinal_analysis-1113"><a href="#longitudinal_analysis-1113"><span class="linenos">1113</span></a>    <span class="k">def</span> <span class="nf">PCA_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="longitudinal_analysis-1114"><a href="#longitudinal_analysis-1114"><span class="linenos">1114</span></a>
</span><span id="longitudinal_analysis-1115"><a href="#longitudinal_analysis-1115"><span class="linenos">1115</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1116"><a href="#longitudinal_analysis-1116"><span class="linenos">1116</span></a><span class="sd">        Perform PCA computation over the normalized trajectories of n_top_clones TCR clones</span>
</span><span id="longitudinal_analysis-1117"><a href="#longitudinal_analysis-1117"><span class="linenos">1117</span></a><span class="sd">        nclus: number of clusters of clonal dynamics, by default this number is set to 3</span>
</span><span id="longitudinal_analysis-1118"><a href="#longitudinal_analysis-1118"><span class="linenos">1118</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis-1119"><a href="#longitudinal_analysis-1119"><span class="linenos">1119</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-1120"><a href="#longitudinal_analysis-1120"><span class="linenos">1120</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-1121"><a href="#longitudinal_analysis-1121"><span class="linenos">1121</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="longitudinal_analysis-1122"><a href="#longitudinal_analysis-1122"><span class="linenos">1122</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1123"><a href="#longitudinal_analysis-1123"><span class="linenos">1123</span></a>
</span><span id="longitudinal_analysis-1124"><a href="#longitudinal_analysis-1124"><span class="linenos">1124</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="longitudinal_analysis-1125"><a href="#longitudinal_analysis-1125"><span class="linenos">1125</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1126"><a href="#longitudinal_analysis-1126"><span class="linenos">1126</span></a>
</span><span id="longitudinal_analysis-1127"><a href="#longitudinal_analysis-1127"><span class="linenos">1127</span></a><span class="sd">        clone_count : str</span>
</span><span id="longitudinal_analysis-1128"><a href="#longitudinal_analysis-1128"><span class="linenos">1128</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1129"><a href="#longitudinal_analysis-1129"><span class="linenos">1129</span></a>
</span><span id="longitudinal_analysis-1130"><a href="#longitudinal_analysis-1130"><span class="linenos">1130</span></a><span class="sd">        nclus : float</span>
</span><span id="longitudinal_analysis-1131"><a href="#longitudinal_analysis-1131"><span class="linenos">1131</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1132"><a href="#longitudinal_analysis-1132"><span class="linenos">1132</span></a>
</span><span id="longitudinal_analysis-1133"><a href="#longitudinal_analysis-1133"><span class="linenos">1133</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis-1134"><a href="#longitudinal_analysis-1134"><span class="linenos">1134</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-1135"><a href="#longitudinal_analysis-1135"><span class="linenos">1135</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-1136"><a href="#longitudinal_analysis-1136"><span class="linenos">1136</span></a><span class="sd">        pca </span>
</span><span id="longitudinal_analysis-1137"><a href="#longitudinal_analysis-1137"><span class="linenos">1137</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis-1138"><a href="#longitudinal_analysis-1138"><span class="linenos">1138</span></a>
</span><span id="longitudinal_analysis-1139"><a href="#longitudinal_analysis-1139"><span class="linenos">1139</span></a><span class="sd">        clustering</span>
</span><span id="longitudinal_analysis-1140"><a href="#longitudinal_analysis-1140"><span class="linenos">1140</span></a>
</span><span id="longitudinal_analysis-1141"><a href="#longitudinal_analysis-1141"><span class="linenos">1141</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1142"><a href="#longitudinal_analysis-1142"><span class="linenos">1142</span></a>
</span><span id="longitudinal_analysis-1143"><a href="#longitudinal_analysis-1143"><span class="linenos">1143</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="longitudinal_analysis-1144"><a href="#longitudinal_analysis-1144"><span class="linenos">1144</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="longitudinal_analysis-1145"><a href="#longitudinal_analysis-1145"><span class="linenos">1145</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="longitudinal_analysis-1146"><a href="#longitudinal_analysis-1146"><span class="linenos">1146</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="longitudinal_analysis-1147"><a href="#longitudinal_analysis-1147"><span class="linenos">1147</span></a>
</span><span id="longitudinal_analysis-1148"><a href="#longitudinal_analysis-1148"><span class="linenos">1148</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="longitudinal_analysis-1149"><a href="#longitudinal_analysis-1149"><span class="linenos">1149</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="longitudinal_analysis-1150"><a href="#longitudinal_analysis-1150"><span class="linenos">1150</span></a>
</span><span id="longitudinal_analysis-1151"><a href="#longitudinal_analysis-1151"><span class="linenos">1151</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="longitudinal_analysis-1152"><a href="#longitudinal_analysis-1152"><span class="linenos">1152</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="longitudinal_analysis-1153"><a href="#longitudinal_analysis-1153"><span class="linenos">1153</span></a>
</span><span id="longitudinal_analysis-1154"><a href="#longitudinal_analysis-1154"><span class="linenos">1154</span></a>        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">norm_traj_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1155"><a href="#longitudinal_analysis-1155"><span class="linenos">1155</span></a>        <span class="n">clustering</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">nclus</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1156"><a href="#longitudinal_analysis-1156"><span class="linenos">1156</span></a>        <span class="n">clustering</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1157"><a href="#longitudinal_analysis-1157"><span class="linenos">1157</span></a>
</span><span id="longitudinal_analysis-1158"><a href="#longitudinal_analysis-1158"><span class="linenos">1158</span></a>        <span class="k">return</span> <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span>
</span><span id="longitudinal_analysis-1159"><a href="#longitudinal_analysis-1159"><span class="linenos">1159</span></a>
</span><span id="longitudinal_analysis-1160"><a href="#longitudinal_analysis-1160"><span class="linenos">1160</span></a>
</span><span id="longitudinal_analysis-1161"><a href="#longitudinal_analysis-1161"><span class="linenos">1161</span></a>    <span class="k">def</span> <span class="nf">plot_clusters2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis-1162"><a href="#longitudinal_analysis-1162"><span class="linenos">1162</span></a>
</span><span id="longitudinal_analysis-1163"><a href="#longitudinal_analysis-1163"><span class="linenos">1163</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1164"><a href="#longitudinal_analysis-1164"><span class="linenos">1164</span></a><span class="sd">        TOFILL</span>
</span><span id="longitudinal_analysis-1165"><a href="#longitudinal_analysis-1165"><span class="linenos">1165</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis-1166"><a href="#longitudinal_analysis-1166"><span class="linenos">1166</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-1167"><a href="#longitudinal_analysis-1167"><span class="linenos">1167</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-1168"><a href="#longitudinal_analysis-1168"><span class="linenos">1168</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="longitudinal_analysis-1169"><a href="#longitudinal_analysis-1169"><span class="linenos">1169</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1170"><a href="#longitudinal_analysis-1170"><span class="linenos">1170</span></a>
</span><span id="longitudinal_analysis-1171"><a href="#longitudinal_analysis-1171"><span class="linenos">1171</span></a><span class="sd">        filename  : str</span>
</span><span id="longitudinal_analysis-1172"><a href="#longitudinal_analysis-1172"><span class="linenos">1172</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1173"><a href="#longitudinal_analysis-1173"><span class="linenos">1173</span></a>
</span><span id="longitudinal_analysis-1174"><a href="#longitudinal_analysis-1174"><span class="linenos">1174</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="longitudinal_analysis-1175"><a href="#longitudinal_analysis-1175"><span class="linenos">1175</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1176"><a href="#longitudinal_analysis-1176"><span class="linenos">1176</span></a>
</span><span id="longitudinal_analysis-1177"><a href="#longitudinal_analysis-1177"><span class="linenos">1177</span></a><span class="sd">        clone_count : str</span>
</span><span id="longitudinal_analysis-1178"><a href="#longitudinal_analysis-1178"><span class="linenos">1178</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1179"><a href="#longitudinal_analysis-1179"><span class="linenos">1179</span></a>
</span><span id="longitudinal_analysis-1180"><a href="#longitudinal_analysis-1180"><span class="linenos">1180</span></a><span class="sd">        nclus : float</span>
</span><span id="longitudinal_analysis-1181"><a href="#longitudinal_analysis-1181"><span class="linenos">1181</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1182"><a href="#longitudinal_analysis-1182"><span class="linenos">1182</span></a>
</span><span id="longitudinal_analysis-1183"><a href="#longitudinal_analysis-1183"><span class="linenos">1183</span></a><span class="sd">        colormap : str</span>
</span><span id="longitudinal_analysis-1184"><a href="#longitudinal_analysis-1184"><span class="linenos">1184</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1185"><a href="#longitudinal_analysis-1185"><span class="linenos">1185</span></a>
</span><span id="longitudinal_analysis-1186"><a href="#longitudinal_analysis-1186"><span class="linenos">1186</span></a>
</span><span id="longitudinal_analysis-1187"><a href="#longitudinal_analysis-1187"><span class="linenos">1187</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-1188"><a href="#longitudinal_analysis-1188"><span class="linenos">1188</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-1189"><a href="#longitudinal_analysis-1189"><span class="linenos">1189</span></a><span class="sd">        plot </span>
</span><span id="longitudinal_analysis-1190"><a href="#longitudinal_analysis-1190"><span class="linenos">1190</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis-1191"><a href="#longitudinal_analysis-1191"><span class="linenos">1191</span></a>
</span><span id="longitudinal_analysis-1192"><a href="#longitudinal_analysis-1192"><span class="linenos">1192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1193"><a href="#longitudinal_analysis-1193"><span class="linenos">1193</span></a>
</span><span id="longitudinal_analysis-1194"><a href="#longitudinal_analysis-1194"><span class="linenos">1194</span></a>
</span><span id="longitudinal_analysis-1195"><a href="#longitudinal_analysis-1195"><span class="linenos">1195</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1196"><a href="#longitudinal_analysis-1196"><span class="linenos">1196</span></a>        <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PCA_traj</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1197"><a href="#longitudinal_analysis-1197"><span class="linenos">1197</span></a>
</span><span id="longitudinal_analysis-1198"><a href="#longitudinal_analysis-1198"><span class="linenos">1198</span></a>
</span><span id="longitudinal_analysis-1199"><a href="#longitudinal_analysis-1199"><span class="linenos">1199</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="longitudinal_analysis-1200"><a href="#longitudinal_analysis-1200"><span class="linenos">1200</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="longitudinal_analysis-1201"><a href="#longitudinal_analysis-1201"><span class="linenos">1201</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="longitudinal_analysis-1202"><a href="#longitudinal_analysis-1202"><span class="linenos">1202</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="longitudinal_analysis-1203"><a href="#longitudinal_analysis-1203"><span class="linenos">1203</span></a>
</span><span id="longitudinal_analysis-1204"><a href="#longitudinal_analysis-1204"><span class="linenos">1204</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="longitudinal_analysis-1205"><a href="#longitudinal_analysis-1205"><span class="linenos">1205</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="longitudinal_analysis-1206"><a href="#longitudinal_analysis-1206"><span class="linenos">1206</span></a>
</span><span id="longitudinal_analysis-1207"><a href="#longitudinal_analysis-1207"><span class="linenos">1207</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="longitudinal_analysis-1208"><a href="#longitudinal_analysis-1208"><span class="linenos">1208</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="longitudinal_analysis-1209"><a href="#longitudinal_analysis-1209"><span class="linenos">1209</span></a>
</span><span id="longitudinal_analysis-1210"><a href="#longitudinal_analysis-1210"><span class="linenos">1210</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="longitudinal_analysis-1211"><a href="#longitudinal_analysis-1211"><span class="linenos">1211</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PCA components (</span><span class="si">%i</span><span class="s1"> trajs)&#39;</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">norm_traj_matrix</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1212"><a href="#longitudinal_analysis-1212"><span class="linenos">1212</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;First component (expl var: </span><span class="si">%3.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1213"><a href="#longitudinal_analysis-1213"><span class="linenos">1213</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Second component (expl var: </span><span class="si">%3.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1214"><a href="#longitudinal_analysis-1214"><span class="linenos">1214</span></a>        <span class="k">for</span> <span class="n">c_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">):</span>
</span><span id="longitudinal_analysis-1215"><a href="#longitudinal_analysis-1215"><span class="linenos">1215</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">c_ind</span><span class="p">]</span>
</span><span id="longitudinal_analysis-1216"><a href="#longitudinal_analysis-1216"><span class="linenos">1216</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">c_ind</span><span class="p">]</span>
</span><span id="longitudinal_analysis-1217"><a href="#longitudinal_analysis-1217"><span class="linenos">1217</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c_ind</span><span class="o">/</span><span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">))</span>
</span><span id="longitudinal_analysis-1218"><a href="#longitudinal_analysis-1218"><span class="linenos">1218</span></a>
</span><span id="longitudinal_analysis-1219"><a href="#longitudinal_analysis-1219"><span class="linenos">1219</span></a>
</span><span id="longitudinal_analysis-1220"><a href="#longitudinal_analysis-1220"><span class="linenos">1220</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1221"><a href="#longitudinal_analysis-1221"><span class="linenos">1221</span></a>
</span><span id="longitudinal_analysis-1222"><a href="#longitudinal_analysis-1222"><span class="linenos">1222</span></a>
</span><span id="longitudinal_analysis-1223"><a href="#longitudinal_analysis-1223"><span class="linenos">1223</span></a>    <span class="k">def</span> <span class="nf">plot_traj_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis-1224"><a href="#longitudinal_analysis-1224"><span class="linenos">1224</span></a>
</span><span id="longitudinal_analysis-1225"><a href="#longitudinal_analysis-1225"><span class="linenos">1225</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1226"><a href="#longitudinal_analysis-1226"><span class="linenos">1226</span></a><span class="sd">        TOFILL</span>
</span><span id="longitudinal_analysis-1227"><a href="#longitudinal_analysis-1227"><span class="linenos">1227</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis-1228"><a href="#longitudinal_analysis-1228"><span class="linenos">1228</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis-1229"><a href="#longitudinal_analysis-1229"><span class="linenos">1229</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis-1230"><a href="#longitudinal_analysis-1230"><span class="linenos">1230</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="longitudinal_analysis-1231"><a href="#longitudinal_analysis-1231"><span class="linenos">1231</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1232"><a href="#longitudinal_analysis-1232"><span class="linenos">1232</span></a>
</span><span id="longitudinal_analysis-1233"><a href="#longitudinal_analysis-1233"><span class="linenos">1233</span></a><span class="sd">        filename  : str</span>
</span><span id="longitudinal_analysis-1234"><a href="#longitudinal_analysis-1234"><span class="linenos">1234</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1235"><a href="#longitudinal_analysis-1235"><span class="linenos">1235</span></a>
</span><span id="longitudinal_analysis-1236"><a href="#longitudinal_analysis-1236"><span class="linenos">1236</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="longitudinal_analysis-1237"><a href="#longitudinal_analysis-1237"><span class="linenos">1237</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1238"><a href="#longitudinal_analysis-1238"><span class="linenos">1238</span></a>
</span><span id="longitudinal_analysis-1239"><a href="#longitudinal_analysis-1239"><span class="linenos">1239</span></a><span class="sd">        clone_count : str</span>
</span><span id="longitudinal_analysis-1240"><a href="#longitudinal_analysis-1240"><span class="linenos">1240</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis-1241"><a href="#longitudinal_analysis-1241"><span class="linenos">1241</span></a>
</span><span id="longitudinal_analysis-1242"><a href="#longitudinal_analysis-1242"><span class="linenos">1242</span></a><span class="sd">        nclus : float</span>
</span><span id="longitudinal_analysis-1243"><a href="#longitudinal_analysis-1243"><span class="linenos">1243</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1244"><a href="#longitudinal_analysis-1244"><span class="linenos">1244</span></a>
</span><span id="longitudinal_analysis-1245"><a href="#longitudinal_analysis-1245"><span class="linenos">1245</span></a><span class="sd">        colormap : str</span>
</span><span id="longitudinal_analysis-1246"><a href="#longitudinal_analysis-1246"><span class="linenos">1246</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis-1247"><a href="#longitudinal_analysis-1247"><span class="linenos">1247</span></a>
</span><span id="longitudinal_analysis-1248"><a href="#longitudinal_analysis-1248"><span class="linenos">1248</span></a>
</span><span id="longitudinal_analysis-1249"><a href="#longitudinal_analysis-1249"><span class="linenos">1249</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis-1250"><a href="#longitudinal_analysis-1250"><span class="linenos">1250</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis-1251"><a href="#longitudinal_analysis-1251"><span class="linenos">1251</span></a><span class="sd">        plot </span>
</span><span id="longitudinal_analysis-1252"><a href="#longitudinal_analysis-1252"><span class="linenos">1252</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis-1253"><a href="#longitudinal_analysis-1253"><span class="linenos">1253</span></a>
</span><span id="longitudinal_analysis-1254"><a href="#longitudinal_analysis-1254"><span class="linenos">1254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis-1255"><a href="#longitudinal_analysis-1255"><span class="linenos">1255</span></a>
</span><span id="longitudinal_analysis-1256"><a href="#longitudinal_analysis-1256"><span class="linenos">1256</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1257"><a href="#longitudinal_analysis-1257"><span class="linenos">1257</span></a>        <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PCA_traj</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1258"><a href="#longitudinal_analysis-1258"><span class="linenos">1258</span></a>
</span><span id="longitudinal_analysis-1259"><a href="#longitudinal_analysis-1259"><span class="linenos">1259</span></a>        <span class="n">n_cl</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span>
</span><span id="longitudinal_analysis-1260"><a href="#longitudinal_analysis-1260"><span class="linenos">1260</span></a>
</span><span id="longitudinal_analysis-1261"><a href="#longitudinal_analysis-1261"><span class="linenos">1261</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="longitudinal_analysis-1262"><a href="#longitudinal_analysis-1262"><span class="linenos">1262</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="longitudinal_analysis-1263"><a href="#longitudinal_analysis-1263"><span class="linenos">1263</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="longitudinal_analysis-1264"><a href="#longitudinal_analysis-1264"><span class="linenos">1264</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="longitudinal_analysis-1265"><a href="#longitudinal_analysis-1265"><span class="linenos">1265</span></a>
</span><span id="longitudinal_analysis-1266"><a href="#longitudinal_analysis-1266"><span class="linenos">1266</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="longitudinal_analysis-1267"><a href="#longitudinal_analysis-1267"><span class="linenos">1267</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="longitudinal_analysis-1268"><a href="#longitudinal_analysis-1268"><span class="linenos">1268</span></a>
</span><span id="longitudinal_analysis-1269"><a href="#longitudinal_analysis-1269"><span class="linenos">1269</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="longitudinal_analysis-1270"><a href="#longitudinal_analysis-1270"><span class="linenos">1270</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="longitudinal_analysis-1271"><a href="#longitudinal_analysis-1271"><span class="linenos">1271</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis-1272"><a href="#longitudinal_analysis-1272"><span class="linenos">1272</span></a>
</span><span id="longitudinal_analysis-1273"><a href="#longitudinal_analysis-1273"><span class="linenos">1273</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_cl</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">n_cl</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="longitudinal_analysis-1274"><a href="#longitudinal_analysis-1274"><span class="linenos">1274</span></a>        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cl</span><span class="p">):</span>
</span><span id="longitudinal_analysis-1275"><a href="#longitudinal_analysis-1275"><span class="linenos">1275</span></a>            <span class="n">trajs</span> <span class="o">=</span> <span class="n">norm_traj_matrix</span><span class="p">[</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">cl</span><span class="p">]</span>
</span><span id="longitudinal_analysis-1276"><a href="#longitudinal_analysis-1276"><span class="linenos">1276</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1277"><a href="#longitudinal_analysis-1277"><span class="linenos">1277</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1278"><a href="#longitudinal_analysis-1278"><span class="linenos">1278</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1279"><a href="#longitudinal_analysis-1279"><span class="linenos">1279</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1280"><a href="#longitudinal_analysis-1280"><span class="linenos">1280</span></a>            <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
</span><span id="longitudinal_analysis-1281"><a href="#longitudinal_analysis-1281"><span class="linenos">1281</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">cl</span><span class="o">/</span><span class="n">n_cl</span><span class="p">))</span>
</span><span id="longitudinal_analysis-1282"><a href="#longitudinal_analysis-1282"><span class="linenos">1282</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="longitudinal_analysis-1283"><a href="#longitudinal_analysis-1283"><span class="linenos">1283</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
</span><span id="longitudinal_analysis-1284"><a href="#longitudinal_analysis-1284"><span class="linenos">1284</span></a>                                <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">cl</span><span class="o">/</span><span class="n">n_cl</span><span class="p">))</span>
</span><span id="longitudinal_analysis-1285"><a href="#longitudinal_analysis-1285"><span class="linenos">1285</span></a>            <span class="c1">#axs[1][cl].fill_between(times, np.quantile(trajs, 0.75, axis=0), np.quantile(trajs, 0.25, axis=0), color=colors[cl])</span>
</span><span id="longitudinal_analysis-1286"><a href="#longitudinal_analysis-1286"><span class="linenos">1286</span></a>               
</span><span id="longitudinal_analysis-1287"><a href="#longitudinal_analysis-1287"><span class="linenos">1287</span></a>
</span><span id="longitudinal_analysis-1288"><a href="#longitudinal_analysis-1288"><span class="linenos">1288</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span> 
</span><span id="longitudinal_analysis-1289"><a href="#longitudinal_analysis-1289"><span class="linenos">1289</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>A class used to represent longitudinal RepSeq data and pre-analysis of the longitudinal data associated with
one individual.</p>

<p>...</p>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>patient</strong> (str):
the patient label associated with the data</li>
<li><strong>data_foler</strong> (str):
the name of the animal</li>
<li><strong>replicate_1D</strong> (str):
the default first replicate label is '_F1' but can be modified by the user to match the used data</li>
<li><strong>replicate_2D</strong> (str):
the default first replicate label is '_F2' but can be modified by the user to match the used data</li>
</ul>

<h6 id="methods">Methods</h6>

<p>import_clones()
    to import all the clonotypes of a given patient and store them in a dictionary.
    It returns also the list of #ordered time points of the longitudinal dataset.</p>

<p>merge_replicates(ntCDR3 = 'N. Seq. CDR3')
    tool to merge biological replicate 1 and biological replicate 2 data</p>

<p>persistence_clones(ntCDR3 = 'N. Seq. CDR3')
    TODESCRIBE</p>

<p>plot_hist_persistence(filename,  ntCDR3 = 'N. Seq. CDR3', fontsize = 12)
    TODESCRIBE</p>

<p>get_top_clones_set(n_top_clones, ntCDR3 = 'N. Seq. CDR3', clone_count = 'Clone count')
    TODESCRIBE</p>

<p>build_traj_frame(top_clones_set, ntCDR3 = 'N. Seq. CDR3', clone_count = 'Clone count')
    TODESCRIBE</p>

<p>plot_trajectories(n_top_clones, filename, colormap = 'viridis', ntCDR3 = 'N. Seq. CDR3', clone_count = 'Clone count')
    TODESCRIBE</p>

<p>PCA_traj(n_top_clones, ntCDR3 = 'N. Seq. CDR3', clone_count = 'Clone count', nclus = 3)
    TODESCRIBE</p>

<p>plot_clusters2D(n_top_clones, filename, ntCDR3 = 'N. Seq. CDR3', clone_count = 'Clone count', nclus = 3, colormap = 'viridis')
    TODESCRIBE</p>

<p>plot_traj_clusters(n_top_clones, filename, ntCDR3 = 'N. Seq. CDR3', clone_count = 'Clone count', nclus = 3, colormap = 'viridis')
    TODESCRIBE</p>
</div>


                            <div id="longitudinal_analysis.__init__" class="classattr">
                                        <input id="longitudinal_analysis.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">longitudinal_analysis</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">patient</span>, </span><span class="param"><span class="n">data_folder</span>, </span><span class="param"><span class="n">replicate_1_ID</span><span class="o">=</span><span class="s1">&#39;_F1&#39;</span>, </span><span class="param"><span class="n">replicate_2_ID</span><span class="o">=</span><span class="s1">&#39;_F2&#39;</span></span>)</span>

                <label class="view-source-button" for="longitudinal_analysis.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.__init__-802"><a href="#longitudinal_analysis.__init__-802"><span class="linenos">802</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span> <span class="n">data_folder</span><span class="p">,</span> <span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="s1">&#39;_F1&#39;</span><span class="p">,</span> <span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="s1">&#39;_F2&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis.__init__-803"><a href="#longitudinal_analysis.__init__-803"><span class="linenos">803</span></a>
</span><span id="longitudinal_analysis.__init__-804"><a href="#longitudinal_analysis.__init__-804"><span class="linenos">804</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patient</span> <span class="o">=</span> <span class="n">patient</span>
</span><span id="longitudinal_analysis.__init__-805"><a href="#longitudinal_analysis.__init__-805"><span class="linenos">805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span> <span class="o">=</span> <span class="n">data_folder</span>
</span><span id="longitudinal_analysis.__init__-806"><a href="#longitudinal_analysis.__init__-806"><span class="linenos">806</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="n">replicate_1_ID</span>
</span><span id="longitudinal_analysis.__init__-807"><a href="#longitudinal_analysis.__init__-807"><span class="linenos">807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="n">replicate_2_ID</span>
</span></pre></div>


    

                            </div>
                            <div id="longitudinal_analysis.import_clones" class="classattr">
                                        <input id="longitudinal_analysis.import_clones-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_clones</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.import_clones-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.import_clones"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.import_clones-810"><a href="#longitudinal_analysis.import_clones-810"><span class="linenos">810</span></a>    <span class="k">def</span> <span class="nf">import_clones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="longitudinal_analysis.import_clones-811"><a href="#longitudinal_analysis.import_clones-811"><span class="linenos">811</span></a>
</span><span id="longitudinal_analysis.import_clones-812"><a href="#longitudinal_analysis.import_clones-812"><span class="linenos">812</span></a>        <span class="sd">&quot;&quot;&quot; </span>
</span><span id="longitudinal_analysis.import_clones-813"><a href="#longitudinal_analysis.import_clones-813"><span class="linenos">813</span></a><span class="sd">        to import all the clonotypes of a given patient and store them in a dictionary.</span>
</span><span id="longitudinal_analysis.import_clones-814"><a href="#longitudinal_analysis.import_clones-814"><span class="linenos">814</span></a><span class="sd">        It returns also the list of #ordered time points of the longitudinal dataset.</span>
</span><span id="longitudinal_analysis.import_clones-815"><a href="#longitudinal_analysis.import_clones-815"><span class="linenos">815</span></a>
</span><span id="longitudinal_analysis.import_clones-816"><a href="#longitudinal_analysis.import_clones-816"><span class="linenos">816</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.import_clones-817"><a href="#longitudinal_analysis.import_clones-817"><span class="linenos">817</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.import_clones-818"><a href="#longitudinal_analysis.import_clones-818"><span class="linenos">818</span></a><span class="sd">        patient : str</span>
</span><span id="longitudinal_analysis.import_clones-819"><a href="#longitudinal_analysis.import_clones-819"><span class="linenos">819</span></a><span class="sd">            The ID of the patient</span>
</span><span id="longitudinal_analysis.import_clones-820"><a href="#longitudinal_analysis.import_clones-820"><span class="linenos">820</span></a><span class="sd">        data_folder : str</span>
</span><span id="longitudinal_analysis.import_clones-821"><a href="#longitudinal_analysis.import_clones-821"><span class="linenos">821</span></a><span class="sd">            The name of the folder to find data</span>
</span><span id="longitudinal_analysis.import_clones-822"><a href="#longitudinal_analysis.import_clones-822"><span class="linenos">822</span></a>
</span><span id="longitudinal_analysis.import_clones-823"><a href="#longitudinal_analysis.import_clones-823"><span class="linenos">823</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.import_clones-824"><a href="#longitudinal_analysis.import_clones-824"><span class="linenos">824</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.import_clones-825"><a href="#longitudinal_analysis.import_clones-825"><span class="linenos">825</span></a><span class="sd">        clones</span>
</span><span id="longitudinal_analysis.import_clones-826"><a href="#longitudinal_analysis.import_clones-826"><span class="linenos">826</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient.</span>
</span><span id="longitudinal_analysis.import_clones-827"><a href="#longitudinal_analysis.import_clones-827"><span class="linenos">827</span></a><span class="sd">           </span>
</span><span id="longitudinal_analysis.import_clones-828"><a href="#longitudinal_analysis.import_clones-828"><span class="linenos">828</span></a><span class="sd">        times</span>
</span><span id="longitudinal_analysis.import_clones-829"><a href="#longitudinal_analysis.import_clones-829"><span class="linenos">829</span></a><span class="sd">            a numpy vector containing all the RepSeq sampling times ordered.</span>
</span><span id="longitudinal_analysis.import_clones-830"><a href="#longitudinal_analysis.import_clones-830"><span class="linenos">830</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.import_clones-831"><a href="#longitudinal_analysis.import_clones-831"><span class="linenos">831</span></a>
</span><span id="longitudinal_analysis.import_clones-832"><a href="#longitudinal_analysis.import_clones-832"><span class="linenos">832</span></a>        <span class="n">patient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span>
</span><span id="longitudinal_analysis.import_clones-833"><a href="#longitudinal_analysis.import_clones-833"><span class="linenos">833</span></a>        <span class="n">data_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_folder</span>
</span><span id="longitudinal_analysis.import_clones-834"><a href="#longitudinal_analysis.import_clones-834"><span class="linenos">834</span></a>        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="longitudinal_analysis.import_clones-835"><a href="#longitudinal_analysis.import_clones-835"><span class="linenos">835</span></a>        <span class="n">clones</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="longitudinal_analysis.import_clones-836"><a href="#longitudinal_analysis.import_clones-836"><span class="linenos">836</span></a>
</span><span id="longitudinal_analysis.import_clones-837"><a href="#longitudinal_analysis.import_clones-837"><span class="linenos">837</span></a>        <span class="c1"># Iteration over all the file in the folder</span>
</span><span id="longitudinal_analysis.import_clones-838"><a href="#longitudinal_analysis.import_clones-838"><span class="linenos">838</span></a>        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">):</span>
</span><span id="longitudinal_analysis.import_clones-839"><a href="#longitudinal_analysis.import_clones-839"><span class="linenos">839</span></a>        <span class="c1"># If the name before the underscore corresponds to the chosen patient..</span>
</span><span id="longitudinal_analysis.import_clones-840"><a href="#longitudinal_analysis.import_clones-840"><span class="linenos">840</span></a>            <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">patient</span><span class="p">:</span>
</span><span id="longitudinal_analysis.import_clones-841"><a href="#longitudinal_analysis.import_clones-841"><span class="linenos">841</span></a>                <span class="c1"># Import the table</span>
</span><span id="longitudinal_analysis.import_clones-842"><a href="#longitudinal_analysis.import_clones-842"><span class="linenos">842</span></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_folder</span><span class="o">+</span><span class="n">file_name</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;zip&#39;</span><span class="p">))</span>
</span><span id="longitudinal_analysis.import_clones-843"><a href="#longitudinal_analysis.import_clones-843"><span class="linenos">843</span></a>                <span class="c1"># Store it in a dictionary where the key contains the patient, the time</span>
</span><span id="longitudinal_analysis.import_clones-844"><a href="#longitudinal_analysis.import_clones-844"><span class="linenos">844</span></a>                <span class="c1"># and the replicate.</span>
</span><span id="longitudinal_analysis.import_clones-845"><a href="#longitudinal_analysis.import_clones-845"><span class="linenos">845</span></a>                <span class="n">clones</span><span class="p">[</span><span class="n">file_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">10</span><span class="p">]]</span> <span class="o">=</span> <span class="n">frame</span>
</span><span id="longitudinal_analysis.import_clones-846"><a href="#longitudinal_analysis.import_clones-846"><span class="linenos">846</span></a>                <span class="c1"># Reading the time from the name and storing it</span>
</span><span id="longitudinal_analysis.import_clones-847"><a href="#longitudinal_analysis.import_clones-847"><span class="linenos">847</span></a>                <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="longitudinal_analysis.import_clones-848"><a href="#longitudinal_analysis.import_clones-848"><span class="linenos">848</span></a>                <span class="c1">#print(&#39;Clonotypes&#39;,file_name[:-10],&#39;imported&#39;)</span>
</span><span id="longitudinal_analysis.import_clones-849"><a href="#longitudinal_analysis.import_clones-849"><span class="linenos">849</span></a>
</span><span id="longitudinal_analysis.import_clones-850"><a href="#longitudinal_analysis.import_clones-850"><span class="linenos">850</span></a>        <span class="c1"># Sorting the unique times</span>
</span><span id="longitudinal_analysis.import_clones-851"><a href="#longitudinal_analysis.import_clones-851"><span class="linenos">851</span></a>        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">times</span><span class="p">)))</span>
</span><span id="longitudinal_analysis.import_clones-852"><a href="#longitudinal_analysis.import_clones-852"><span class="linenos">852</span></a>        <span class="k">return</span> <span class="n">clones</span><span class="p">,</span> <span class="n">times</span>
</span></pre></div>


            <div class="docstring"><p>to import all the clonotypes of a given patient and store them in a dictionary.
It returns also the list of #ordered time points of the longitudinal dataset.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>patient</strong> (str):
The ID of the patient</li>
<li><strong>data_folder</strong> (str):
The name of the folder to find data</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>clones</strong>: a dictionary of data_frames giving all the samples of the patient.</li>
<li><strong>times</strong>: a numpy vector containing all the RepSeq sampling times ordered.</li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.merge_replicates" class="classattr">
                                        <input id="longitudinal_analysis.merge_replicates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">merge_replicates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.merge_replicates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.merge_replicates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.merge_replicates-854"><a href="#longitudinal_analysis.merge_replicates-854"><span class="linenos">854</span></a>    <span class="k">def</span> <span class="nf">merge_replicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis.merge_replicates-855"><a href="#longitudinal_analysis.merge_replicates-855"><span class="linenos">855</span></a>        
</span><span id="longitudinal_analysis.merge_replicates-856"><a href="#longitudinal_analysis.merge_replicates-856"><span class="linenos">856</span></a>        <span class="sd">&#39;&#39;&#39; Creating the dataframes for the merged replicates. After this operation the </span>
</span><span id="longitudinal_analysis.merge_replicates-857"><a href="#longitudinal_analysis.merge_replicates-857"><span class="linenos">857</span></a><span class="sd">        clones_merged dictionary contains the the merged table of the first and second</span>
</span><span id="longitudinal_analysis.merge_replicates-858"><a href="#longitudinal_analysis.merge_replicates-858"><span class="linenos">858</span></a><span class="sd">        replicate. The indexes are the same as before without the F1/2 label.</span>
</span><span id="longitudinal_analysis.merge_replicates-859"><a href="#longitudinal_analysis.merge_replicates-859"><span class="linenos">859</span></a>
</span><span id="longitudinal_analysis.merge_replicates-860"><a href="#longitudinal_analysis.merge_replicates-860"><span class="linenos">860</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.merge_replicates-861"><a href="#longitudinal_analysis.merge_replicates-861"><span class="linenos">861</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.merge_replicates-862"><a href="#longitudinal_analysis.merge_replicates-862"><span class="linenos">862</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis.merge_replicates-863"><a href="#longitudinal_analysis.merge_replicates-863"><span class="linenos">863</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;. </span>
</span><span id="longitudinal_analysis.merge_replicates-864"><a href="#longitudinal_analysis.merge_replicates-864"><span class="linenos">864</span></a>
</span><span id="longitudinal_analysis.merge_replicates-865"><a href="#longitudinal_analysis.merge_replicates-865"><span class="linenos">865</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.merge_replicates-866"><a href="#longitudinal_analysis.merge_replicates-866"><span class="linenos">866</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.merge_replicates-867"><a href="#longitudinal_analysis.merge_replicates-867"><span class="linenos">867</span></a><span class="sd">        clones_merged</span>
</span><span id="longitudinal_analysis.merge_replicates-868"><a href="#longitudinal_analysis.merge_replicates-868"><span class="linenos">868</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient that were merged for both replicates.</span>
</span><span id="longitudinal_analysis.merge_replicates-869"><a href="#longitudinal_analysis.merge_replicates-869"><span class="linenos">869</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="longitudinal_analysis.merge_replicates-870"><a href="#longitudinal_analysis.merge_replicates-870"><span class="linenos">870</span></a>
</span><span id="longitudinal_analysis.merge_replicates-871"><a href="#longitudinal_analysis.merge_replicates-871"><span class="linenos">871</span></a>        <span class="n">patient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient</span>
</span><span id="longitudinal_analysis.merge_replicates-872"><a href="#longitudinal_analysis.merge_replicates-872"><span class="linenos">872</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis.merge_replicates-873"><a href="#longitudinal_analysis.merge_replicates-873"><span class="linenos">873</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="longitudinal_analysis.merge_replicates-874"><a href="#longitudinal_analysis.merge_replicates-874"><span class="linenos">874</span></a>
</span><span id="longitudinal_analysis.merge_replicates-875"><a href="#longitudinal_analysis.merge_replicates-875"><span class="linenos">875</span></a>        <span class="n">replicate_1_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicate_1_ID</span> 
</span><span id="longitudinal_analysis.merge_replicates-876"><a href="#longitudinal_analysis.merge_replicates-876"><span class="linenos">876</span></a>        <span class="n">replicate_2_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replicate_2_ID</span>
</span><span id="longitudinal_analysis.merge_replicates-877"><a href="#longitudinal_analysis.merge_replicates-877"><span class="linenos">877</span></a>
</span><span id="longitudinal_analysis.merge_replicates-878"><a href="#longitudinal_analysis.merge_replicates-878"><span class="linenos">878</span></a>        <span class="c1"># Iteration over the times</span>
</span><span id="longitudinal_analysis.merge_replicates-879"><a href="#longitudinal_analysis.merge_replicates-879"><span class="linenos">879</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
</span><span id="longitudinal_analysis.merge_replicates-880"><a href="#longitudinal_analysis.merge_replicates-880"><span class="linenos">880</span></a>            <span class="c1"># Building the ids correponding at 1st and 2nd replicate at given time point</span>
</span><span id="longitudinal_analysis.merge_replicates-881"><a href="#longitudinal_analysis.merge_replicates-881"><span class="linenos">881</span></a>            <span class="n">id_F1</span> <span class="o">=</span> <span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">replicate_1_ID</span>
</span><span id="longitudinal_analysis.merge_replicates-882"><a href="#longitudinal_analysis.merge_replicates-882"><span class="linenos">882</span></a>            <span class="n">id_F2</span> <span class="o">=</span> <span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">replicate_2_ID</span>
</span><span id="longitudinal_analysis.merge_replicates-883"><a href="#longitudinal_analysis.merge_replicates-883"><span class="linenos">883</span></a>            <span class="c1"># Below all the rows of one table are appended to the rows of the other</span>
</span><span id="longitudinal_analysis.merge_replicates-884"><a href="#longitudinal_analysis.merge_replicates-884"><span class="linenos">884</span></a>            <span class="n">merged_replicates</span> <span class="o">=</span> <span class="n">clones</span><span class="p">[</span><span class="n">id_F1</span><span class="p">]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">clones</span><span class="p">[</span><span class="n">id_F2</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis.merge_replicates-885"><a href="#longitudinal_analysis.merge_replicates-885"><span class="linenos">885</span></a>            <span class="c1"># But there are common clonotypes that now appear in two different rows </span>
</span><span id="longitudinal_analysis.merge_replicates-886"><a href="#longitudinal_analysis.merge_replicates-886"><span class="linenos">886</span></a>            <span class="c1"># (one for the first and one for the second replicate)! </span>
</span><span id="longitudinal_analysis.merge_replicates-887"><a href="#longitudinal_analysis.merge_replicates-887"><span class="linenos">887</span></a>            <span class="c1"># Below we collapse those common sequences and the counts of the two are summed </span>
</span><span id="longitudinal_analysis.merge_replicates-888"><a href="#longitudinal_analysis.merge_replicates-888"><span class="linenos">888</span></a>            <span class="n">merged_replicates</span> <span class="o">=</span> <span class="n">merged_replicates</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ntCDR3</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Clone count&#39;</span><span class="p">:</span><span class="nb">sum</span><span class="p">})</span>
</span><span id="longitudinal_analysis.merge_replicates-889"><a href="#longitudinal_analysis.merge_replicates-889"><span class="linenos">889</span></a>            <span class="c1"># The merged table is then added to the dictionary</span>
</span><span id="longitudinal_analysis.merge_replicates-890"><a href="#longitudinal_analysis.merge_replicates-890"><span class="linenos">890</span></a>            <span class="n">clones_merged</span><span class="p">[</span><span class="n">patient</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">merged_replicates</span>
</span><span id="longitudinal_analysis.merge_replicates-891"><a href="#longitudinal_analysis.merge_replicates-891"><span class="linenos">891</span></a>
</span><span id="longitudinal_analysis.merge_replicates-892"><a href="#longitudinal_analysis.merge_replicates-892"><span class="linenos">892</span></a>        <span class="k">return</span> <span class="n">clones_merged</span>
</span></pre></div>


            <div class="docstring"><p>Creating the dataframes for the merged replicates. After this operation the 
clones_merged dictionary contains the the merged table of the first and second
replicate. The indexes are the same as before without the F1/2 label.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ntCDR3</strong> (str):
The label of the TCR nucleotide sequences columns, the default value is 'N. Seq. CDR3'.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>clones_merged</strong>: a dictionary of data_frames giving all the samples of the patient that were merged for both replicates.</li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.persistence_clones" class="classattr">
                                        <input id="longitudinal_analysis.persistence_clones-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">persistence_clones</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.persistence_clones-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.persistence_clones"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.persistence_clones-894"><a href="#longitudinal_analysis.persistence_clones-894"><span class="linenos">894</span></a>    <span class="k">def</span> <span class="nf">persistence_clones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis.persistence_clones-895"><a href="#longitudinal_analysis.persistence_clones-895"><span class="linenos">895</span></a>
</span><span id="longitudinal_analysis.persistence_clones-896"><a href="#longitudinal_analysis.persistence_clones-896"><span class="linenos">896</span></a>        <span class="sd">&quot;&quot;&quot;A list of all the clonotypes appearing in all the time points is created.</span>
</span><span id="longitudinal_analysis.persistence_clones-897"><a href="#longitudinal_analysis.persistence_clones-897"><span class="linenos">897</span></a><span class="sd">        Note that if one clonotype is present in 2 or more points, it will be repeated</span>
</span><span id="longitudinal_analysis.persistence_clones-898"><a href="#longitudinal_analysis.persistence_clones-898"><span class="linenos">898</span></a><span class="sd">        twice in the list.</span>
</span><span id="longitudinal_analysis.persistence_clones-899"><a href="#longitudinal_analysis.persistence_clones-899"><span class="linenos">899</span></a>
</span><span id="longitudinal_analysis.persistence_clones-900"><a href="#longitudinal_analysis.persistence_clones-900"><span class="linenos">900</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.persistence_clones-901"><a href="#longitudinal_analysis.persistence_clones-901"><span class="linenos">901</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.persistence_clones-902"><a href="#longitudinal_analysis.persistence_clones-902"><span class="linenos">902</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis.persistence_clones-903"><a href="#longitudinal_analysis.persistence_clones-903"><span class="linenos">903</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;. </span>
</span><span id="longitudinal_analysis.persistence_clones-904"><a href="#longitudinal_analysis.persistence_clones-904"><span class="linenos">904</span></a>
</span><span id="longitudinal_analysis.persistence_clones-905"><a href="#longitudinal_analysis.persistence_clones-905"><span class="linenos">905</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.persistence_clones-906"><a href="#longitudinal_analysis.persistence_clones-906"><span class="linenos">906</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.persistence_clones-907"><a href="#longitudinal_analysis.persistence_clones-907"><span class="linenos">907</span></a><span class="sd">        unique_clones</span>
</span><span id="longitudinal_analysis.persistence_clones-908"><a href="#longitudinal_analysis.persistence_clones-908"><span class="linenos">908</span></a><span class="sd">            a dictionary of data_frames giving all the samples of the patient that were merged for both replicates.</span>
</span><span id="longitudinal_analysis.persistence_clones-909"><a href="#longitudinal_analysis.persistence_clones-909"><span class="linenos">909</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis.persistence_clones-910"><a href="#longitudinal_analysis.persistence_clones-910"><span class="linenos">910</span></a><span class="sd">        time_occurence</span>
</span><span id="longitudinal_analysis.persistence_clones-911"><a href="#longitudinal_analysis.persistence_clones-911"><span class="linenos">911</span></a>
</span><span id="longitudinal_analysis.persistence_clones-912"><a href="#longitudinal_analysis.persistence_clones-912"><span class="linenos">912</span></a>
</span><span id="longitudinal_analysis.persistence_clones-913"><a href="#longitudinal_analysis.persistence_clones-913"><span class="linenos">913</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.persistence_clones-914"><a href="#longitudinal_analysis.persistence_clones-914"><span class="linenos">914</span></a>
</span><span id="longitudinal_analysis.persistence_clones-915"><a href="#longitudinal_analysis.persistence_clones-915"><span class="linenos">915</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="longitudinal_analysis.persistence_clones-916"><a href="#longitudinal_analysis.persistence_clones-916"><span class="linenos">916</span></a>        <span class="n">all_clones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
</span><span id="longitudinal_analysis.persistence_clones-917"><a href="#longitudinal_analysis.persistence_clones-917"><span class="linenos">917</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="longitudinal_analysis.persistence_clones-918"><a href="#longitudinal_analysis.persistence_clones-918"><span class="linenos">918</span></a>            <span class="n">all_clones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_clones</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="longitudinal_analysis.persistence_clones-919"><a href="#longitudinal_analysis.persistence_clones-919"><span class="linenos">919</span></a>
</span><span id="longitudinal_analysis.persistence_clones-920"><a href="#longitudinal_analysis.persistence_clones-920"><span class="linenos">920</span></a>        <span class="c1"># The following function returns the list of unique clonotypes and the number of</span>
</span><span id="longitudinal_analysis.persistence_clones-921"><a href="#longitudinal_analysis.persistence_clones-921"><span class="linenos">921</span></a>        <span class="c1"># repetitions for each of them. </span>
</span><span id="longitudinal_analysis.persistence_clones-922"><a href="#longitudinal_analysis.persistence_clones-922"><span class="linenos">922</span></a>        <span class="c1"># Note that the number of repetitions is exactly the time occurrence</span>
</span><span id="longitudinal_analysis.persistence_clones-923"><a href="#longitudinal_analysis.persistence_clones-923"><span class="linenos">923</span></a>        <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_clones</span><span class="p">,</span> <span class="n">return_counts</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="longitudinal_analysis.persistence_clones-924"><a href="#longitudinal_analysis.persistence_clones-924"><span class="linenos">924</span></a>
</span><span id="longitudinal_analysis.persistence_clones-925"><a href="#longitudinal_analysis.persistence_clones-925"><span class="linenos">925</span></a>        <span class="k">return</span> <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span>
</span></pre></div>


            <div class="docstring"><p>A list of all the clonotypes appearing in all the time points is created.
Note that if one clonotype is present in 2 or more points, it will be repeated
twice in the list.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ntCDR3</strong> (str):
The label of the TCR nucleotide sequences columns, the default value is 'N. Seq. CDR3'.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>unique_clones</strong>: a dictionary of data_frames giving all the samples of the patient that were merged for both replicates.</li>
<li><strong>time_occurence</strong></li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.plot_hist_persistence" class="classattr">
                                        <input id="longitudinal_analysis.plot_hist_persistence-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_hist_persistence</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">filename</span>, </span><span class="param"><span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span>, </span><span class="param"><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.plot_hist_persistence-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.plot_hist_persistence"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.plot_hist_persistence-928"><a href="#longitudinal_analysis.plot_hist_persistence-928"><span class="linenos">928</span></a>    <span class="k">def</span> <span class="nf">plot_hist_persistence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>  <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">):</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-929"><a href="#longitudinal_analysis.plot_hist_persistence-929"><span class="linenos">929</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-930"><a href="#longitudinal_analysis.plot_hist_persistence-930"><span class="linenos">930</span></a>        <span class="sd">&quot;&quot;&quot; TOFILL</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-931"><a href="#longitudinal_analysis.plot_hist_persistence-931"><span class="linenos">931</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-932"><a href="#longitudinal_analysis.plot_hist_persistence-932"><span class="linenos">932</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-933"><a href="#longitudinal_analysis.plot_hist_persistence-933"><span class="linenos">933</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-934"><a href="#longitudinal_analysis.plot_hist_persistence-934"><span class="linenos">934</span></a><span class="sd">        filename : str</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-935"><a href="#longitudinal_analysis.plot_hist_persistence-935"><span class="linenos">935</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-936"><a href="#longitudinal_analysis.plot_hist_persistence-936"><span class="linenos">936</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-937"><a href="#longitudinal_analysis.plot_hist_persistence-937"><span class="linenos">937</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-938"><a href="#longitudinal_analysis.plot_hist_persistence-938"><span class="linenos">938</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-939"><a href="#longitudinal_analysis.plot_hist_persistence-939"><span class="linenos">939</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-940"><a href="#longitudinal_analysis.plot_hist_persistence-940"><span class="linenos">940</span></a><span class="sd">        fontsize : float</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-941"><a href="#longitudinal_analysis.plot_hist_persistence-941"><span class="linenos">941</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-942"><a href="#longitudinal_analysis.plot_hist_persistence-942"><span class="linenos">942</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-943"><a href="#longitudinal_analysis.plot_hist_persistence-943"><span class="linenos">943</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-944"><a href="#longitudinal_analysis.plot_hist_persistence-944"><span class="linenos">944</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-945"><a href="#longitudinal_analysis.plot_hist_persistence-945"><span class="linenos">945</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-946"><a href="#longitudinal_analysis.plot_hist_persistence-946"><span class="linenos">946</span></a><span class="sd">        plot</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-947"><a href="#longitudinal_analysis.plot_hist_persistence-947"><span class="linenos">947</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-948"><a href="#longitudinal_analysis.plot_hist_persistence-948"><span class="linenos">948</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-949"><a href="#longitudinal_analysis.plot_hist_persistence-949"><span class="linenos">949</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-950"><a href="#longitudinal_analysis.plot_hist_persistence-950"><span class="linenos">950</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-951"><a href="#longitudinal_analysis.plot_hist_persistence-951"><span class="linenos">951</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-952"><a href="#longitudinal_analysis.plot_hist_persistence-952"><span class="linenos">952</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-953"><a href="#longitudinal_analysis.plot_hist_persistence-953"><span class="linenos">953</span></a>        <span class="n">unique_clones</span><span class="p">,</span> <span class="n">time_occurrence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistence_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-954"><a href="#longitudinal_analysis.plot_hist_persistence-954"><span class="linenos">954</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-955"><a href="#longitudinal_analysis.plot_hist_persistence-955"><span class="linenos">955</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-956"><a href="#longitudinal_analysis.plot_hist_persistence-956"><span class="linenos">956</span></a>
</span><span id="longitudinal_analysis.plot_hist_persistence-957"><a href="#longitudinal_analysis.plot_hist_persistence-957"><span class="linenos">957</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-958"><a href="#longitudinal_analysis.plot_hist_persistence-958"><span class="linenos">958</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-959"><a href="#longitudinal_analysis.plot_hist_persistence-959"><span class="linenos">959</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time occurrence&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-960"><a href="#longitudinal_analysis.plot_hist_persistence-960"><span class="linenos">960</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-961"><a href="#longitudinal_analysis.plot_hist_persistence-961"><span class="linenos">961</span></a>        <span class="n">h</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">time_occurrence</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_hist_persistence-962"><a href="#longitudinal_analysis.plot_hist_persistence-962"><span class="linenos">962</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>TOFILL</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>filename</strong> (str):
TOFILL</li>
<li><strong>ntCDR3</strong> (str):
The label of the TCR nucleotide sequences columns, the default value is 'N. Seq. CDR3'.</li>
<li><strong>fontsize</strong> (float):
TOFILL</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>plot</strong>: TO DESCRIBE</li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.get_top_clones_set" class="classattr">
                                        <input id="longitudinal_analysis.get_top_clones_set-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_top_clones_set</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">n_top_clones</span>, </span><span class="param"><span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span>, </span><span class="param"><span class="n">clone_count</span><span class="o">=</span><span class="s1">&#39;Clone count&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.get_top_clones_set-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.get_top_clones_set"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.get_top_clones_set-964"><a href="#longitudinal_analysis.get_top_clones_set-964"><span class="linenos">964</span></a>    <span class="k">def</span> <span class="nf">get_top_clones_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis.get_top_clones_set-965"><a href="#longitudinal_analysis.get_top_clones_set-965"><span class="linenos">965</span></a>        
</span><span id="longitudinal_analysis.get_top_clones_set-966"><a href="#longitudinal_analysis.get_top_clones_set-966"><span class="linenos">966</span></a>        <span class="sd">&quot;&quot;&quot; TOFILL</span>
</span><span id="longitudinal_analysis.get_top_clones_set-967"><a href="#longitudinal_analysis.get_top_clones_set-967"><span class="linenos">967</span></a>
</span><span id="longitudinal_analysis.get_top_clones_set-968"><a href="#longitudinal_analysis.get_top_clones_set-968"><span class="linenos">968</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.get_top_clones_set-969"><a href="#longitudinal_analysis.get_top_clones_set-969"><span class="linenos">969</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.get_top_clones_set-970"><a href="#longitudinal_analysis.get_top_clones_set-970"><span class="linenos">970</span></a><span class="sd">        filename : str</span>
</span><span id="longitudinal_analysis.get_top_clones_set-971"><a href="#longitudinal_analysis.get_top_clones_set-971"><span class="linenos">971</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.get_top_clones_set-972"><a href="#longitudinal_analysis.get_top_clones_set-972"><span class="linenos">972</span></a>
</span><span id="longitudinal_analysis.get_top_clones_set-973"><a href="#longitudinal_analysis.get_top_clones_set-973"><span class="linenos">973</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis.get_top_clones_set-974"><a href="#longitudinal_analysis.get_top_clones_set-974"><span class="linenos">974</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="longitudinal_analysis.get_top_clones_set-975"><a href="#longitudinal_analysis.get_top_clones_set-975"><span class="linenos">975</span></a>
</span><span id="longitudinal_analysis.get_top_clones_set-976"><a href="#longitudinal_analysis.get_top_clones_set-976"><span class="linenos">976</span></a><span class="sd">        fontsize : float</span>
</span><span id="longitudinal_analysis.get_top_clones_set-977"><a href="#longitudinal_analysis.get_top_clones_set-977"><span class="linenos">977</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.get_top_clones_set-978"><a href="#longitudinal_analysis.get_top_clones_set-978"><span class="linenos">978</span></a>
</span><span id="longitudinal_analysis.get_top_clones_set-979"><a href="#longitudinal_analysis.get_top_clones_set-979"><span class="linenos">979</span></a>
</span><span id="longitudinal_analysis.get_top_clones_set-980"><a href="#longitudinal_analysis.get_top_clones_set-980"><span class="linenos">980</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.get_top_clones_set-981"><a href="#longitudinal_analysis.get_top_clones_set-981"><span class="linenos">981</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.get_top_clones_set-982"><a href="#longitudinal_analysis.get_top_clones_set-982"><span class="linenos">982</span></a><span class="sd">        plot</span>
</span><span id="longitudinal_analysis.get_top_clones_set-983"><a href="#longitudinal_analysis.get_top_clones_set-983"><span class="linenos">983</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis.get_top_clones_set-984"><a href="#longitudinal_analysis.get_top_clones_set-984"><span class="linenos">984</span></a>
</span><span id="longitudinal_analysis.get_top_clones_set-985"><a href="#longitudinal_analysis.get_top_clones_set-985"><span class="linenos">985</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis.get_top_clones_set-986"><a href="#longitudinal_analysis.get_top_clones_set-986"><span class="linenos">986</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.get_top_clones_set-987"><a href="#longitudinal_analysis.get_top_clones_set-987"><span class="linenos">987</span></a>
</span><span id="longitudinal_analysis.get_top_clones_set-988"><a href="#longitudinal_analysis.get_top_clones_set-988"><span class="linenos">988</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="longitudinal_analysis.get_top_clones_set-989"><a href="#longitudinal_analysis.get_top_clones_set-989"><span class="linenos">989</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="longitudinal_analysis.get_top_clones_set-990"><a href="#longitudinal_analysis.get_top_clones_set-990"><span class="linenos">990</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="longitudinal_analysis.get_top_clones_set-991"><a href="#longitudinal_analysis.get_top_clones_set-991"><span class="linenos">991</span></a>            <span class="n">top_clones_at_time</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">clone_count</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="n">n_top_clones</span><span class="p">]</span>
</span><span id="longitudinal_analysis.get_top_clones_set-992"><a href="#longitudinal_analysis.get_top_clones_set-992"><span class="linenos">992</span></a>            <span class="n">top_clones</span> <span class="o">=</span> <span class="n">top_clones</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">top_clones_at_time</span><span class="p">[</span><span class="n">ntCDR3</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="longitudinal_analysis.get_top_clones_set-993"><a href="#longitudinal_analysis.get_top_clones_set-993"><span class="linenos">993</span></a>        <span class="k">return</span> <span class="n">top_clones</span>
</span></pre></div>


            <div class="docstring"><p>TOFILL</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>filename</strong> (str):
TOFILL</li>
<li><strong>ntCDR3</strong> (str):
The label of the TCR nucleotide sequences columns, the default value is 'N. Seq. CDR3'.</li>
<li><strong>fontsize</strong> (float):
TOFILL</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>plot</strong>: TO DESCRIBE</li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.build_traj_frame" class="classattr">
                                        <input id="longitudinal_analysis.build_traj_frame-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_traj_frame</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">top_clones_set</span>,</span><span class="param">	<span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span>,</span><span class="param">	<span class="n">clone_count</span><span class="o">=</span><span class="s1">&#39;Clone count&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.build_traj_frame-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.build_traj_frame"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.build_traj_frame-995"><a href="#longitudinal_analysis.build_traj_frame-995"><span class="linenos"> 995</span></a>    <span class="k">def</span> <span class="nf">build_traj_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_clones_set</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis.build_traj_frame-996"><a href="#longitudinal_analysis.build_traj_frame-996"><span class="linenos"> 996</span></a>        
</span><span id="longitudinal_analysis.build_traj_frame-997"><a href="#longitudinal_analysis.build_traj_frame-997"><span class="linenos"> 997</span></a>        <span class="sd">&quot;&quot;&quot; </span>
</span><span id="longitudinal_analysis.build_traj_frame-998"><a href="#longitudinal_analysis.build_traj_frame-998"><span class="linenos"> 998</span></a><span class="sd">        This builds a dataframe containing the count at all the time points for each </span>
</span><span id="longitudinal_analysis.build_traj_frame-999"><a href="#longitudinal_analysis.build_traj_frame-999"><span class="linenos"> 999</span></a><span class="sd">        of the clonotypes specified in top_clones_set.</span>
</span><span id="longitudinal_analysis.build_traj_frame-1000"><a href="#longitudinal_analysis.build_traj_frame-1000"><span class="linenos">1000</span></a><span class="sd">        The dataframe has also a field that contains the cumulative count.</span>
</span><span id="longitudinal_analysis.build_traj_frame-1001"><a href="#longitudinal_analysis.build_traj_frame-1001"><span class="linenos">1001</span></a><span class="sd">        The trajectory dataframe is initialised with indexes as the clonotypes in</span>
</span><span id="longitudinal_analysis.build_traj_frame-1002"><a href="#longitudinal_analysis.build_traj_frame-1002"><span class="linenos">1002</span></a><span class="sd">        top_clones_set</span>
</span><span id="longitudinal_analysis.build_traj_frame-1003"><a href="#longitudinal_analysis.build_traj_frame-1003"><span class="linenos">1003</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1004"><a href="#longitudinal_analysis.build_traj_frame-1004"><span class="linenos">1004</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.build_traj_frame-1005"><a href="#longitudinal_analysis.build_traj_frame-1005"><span class="linenos">1005</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.build_traj_frame-1006"><a href="#longitudinal_analysis.build_traj_frame-1006"><span class="linenos">1006</span></a><span class="sd">        top_clones_set : TOFILL</span>
</span><span id="longitudinal_analysis.build_traj_frame-1007"><a href="#longitudinal_analysis.build_traj_frame-1007"><span class="linenos">1007</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.build_traj_frame-1008"><a href="#longitudinal_analysis.build_traj_frame-1008"><span class="linenos">1008</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1009"><a href="#longitudinal_analysis.build_traj_frame-1009"><span class="linenos">1009</span></a><span class="sd">        ntCDR3  : str</span>
</span><span id="longitudinal_analysis.build_traj_frame-1010"><a href="#longitudinal_analysis.build_traj_frame-1010"><span class="linenos">1010</span></a><span class="sd">            The label of the TCR nucleotide sequences columns, the default value is &#39;N. Seq. CDR3&#39;.</span>
</span><span id="longitudinal_analysis.build_traj_frame-1011"><a href="#longitudinal_analysis.build_traj_frame-1011"><span class="linenos">1011</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1012"><a href="#longitudinal_analysis.build_traj_frame-1012"><span class="linenos">1012</span></a><span class="sd">        clone_count : str </span>
</span><span id="longitudinal_analysis.build_traj_frame-1013"><a href="#longitudinal_analysis.build_traj_frame-1013"><span class="linenos">1013</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.build_traj_frame-1014"><a href="#longitudinal_analysis.build_traj_frame-1014"><span class="linenos">1014</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1015"><a href="#longitudinal_analysis.build_traj_frame-1015"><span class="linenos">1015</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1016"><a href="#longitudinal_analysis.build_traj_frame-1016"><span class="linenos">1016</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.build_traj_frame-1017"><a href="#longitudinal_analysis.build_traj_frame-1017"><span class="linenos">1017</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.build_traj_frame-1018"><a href="#longitudinal_analysis.build_traj_frame-1018"><span class="linenos">1018</span></a><span class="sd">        traj_frame</span>
</span><span id="longitudinal_analysis.build_traj_frame-1019"><a href="#longitudinal_analysis.build_traj_frame-1019"><span class="linenos">1019</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis.build_traj_frame-1020"><a href="#longitudinal_analysis.build_traj_frame-1020"><span class="linenos">1020</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1021"><a href="#longitudinal_analysis.build_traj_frame-1021"><span class="linenos">1021</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.build_traj_frame-1022"><a href="#longitudinal_analysis.build_traj_frame-1022"><span class="linenos">1022</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1023"><a href="#longitudinal_analysis.build_traj_frame-1023"><span class="linenos">1023</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1024"><a href="#longitudinal_analysis.build_traj_frame-1024"><span class="linenos">1024</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1025"><a href="#longitudinal_analysis.build_traj_frame-1025"><span class="linenos">1025</span></a>        <span class="n">clones_merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_replicates</span><span class="p">()</span>
</span><span id="longitudinal_analysis.build_traj_frame-1026"><a href="#longitudinal_analysis.build_traj_frame-1026"><span class="linenos">1026</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1027"><a href="#longitudinal_analysis.build_traj_frame-1027"><span class="linenos">1027</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">top_clones_set</span><span class="p">)</span>
</span><span id="longitudinal_analysis.build_traj_frame-1028"><a href="#longitudinal_analysis.build_traj_frame-1028"><span class="linenos">1028</span></a>        <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="longitudinal_analysis.build_traj_frame-1029"><a href="#longitudinal_analysis.build_traj_frame-1029"><span class="linenos">1029</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1030"><a href="#longitudinal_analysis.build_traj_frame-1030"><span class="linenos">1030</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">clones_merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
</span><span id="longitudinal_analysis.build_traj_frame-1031"><a href="#longitudinal_analysis.build_traj_frame-1031"><span class="linenos">1031</span></a>
</span><span id="longitudinal_analysis.build_traj_frame-1032"><a href="#longitudinal_analysis.build_traj_frame-1032"><span class="linenos">1032</span></a>            <span class="c1"># Getting the time from the index of clones_merged</span>
</span><span id="longitudinal_analysis.build_traj_frame-1033"><a href="#longitudinal_analysis.build_traj_frame-1033"><span class="linenos">1033</span></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">id_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="longitudinal_analysis.build_traj_frame-1034"><a href="#longitudinal_analysis.build_traj_frame-1034"><span class="linenos">1034</span></a>            <span class="c1"># Selecting the clonotypes that are both in the frame at the given time </span>
</span><span id="longitudinal_analysis.build_traj_frame-1035"><a href="#longitudinal_analysis.build_traj_frame-1035"><span class="linenos">1035</span></a>            <span class="c1"># point and in the list of top_clones_set</span>
</span><span id="longitudinal_analysis.build_traj_frame-1036"><a href="#longitudinal_analysis.build_traj_frame-1036"><span class="linenos">1036</span></a>            <span class="n">top_clones_at_time</span> <span class="o">=</span> <span class="n">top_clones_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="n">ntCDR3</span><span class="p">]))</span>
</span><span id="longitudinal_analysis.build_traj_frame-1037"><a href="#longitudinal_analysis.build_traj_frame-1037"><span class="linenos">1037</span></a>            <span class="c1"># Creating a sub-dataframe containing only the clone in top_clones_at_time</span>
</span><span id="longitudinal_analysis.build_traj_frame-1038"><a href="#longitudinal_analysis.build_traj_frame-1038"><span class="linenos">1038</span></a>            <span class="n">clones_at_time</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">ntCDR3</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">top_clones_at_time</span><span class="p">]</span>
</span><span id="longitudinal_analysis.build_traj_frame-1039"><a href="#longitudinal_analysis.build_traj_frame-1039"><span class="linenos">1039</span></a>            <span class="c1"># Creating a new column in the trajectory frames for the counts at that time</span>
</span><span id="longitudinal_analysis.build_traj_frame-1040"><a href="#longitudinal_analysis.build_traj_frame-1040"><span class="linenos">1040</span></a>            <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">clones_at_time</span><span class="p">[</span><span class="n">clone_count</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="longitudinal_analysis.build_traj_frame-1041"><a href="#longitudinal_analysis.build_traj_frame-1041"><span class="linenos">1041</span></a>            <span class="c1"># The clonotypes not present at that time are NaN. Below we convert NaN in 0s</span>
</span><span id="longitudinal_analysis.build_traj_frame-1042"><a href="#longitudinal_analysis.build_traj_frame-1042"><span class="linenos">1042</span></a>            <span class="n">traj_frame</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="longitudinal_analysis.build_traj_frame-1043"><a href="#longitudinal_analysis.build_traj_frame-1043"><span class="linenos">1043</span></a>            <span class="c1"># The cumulative count for each clonotype is updated</span>
</span><span id="longitudinal_analysis.build_traj_frame-1044"><a href="#longitudinal_analysis.build_traj_frame-1044"><span class="linenos">1044</span></a>            <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>
</span><span id="longitudinal_analysis.build_traj_frame-1045"><a href="#longitudinal_analysis.build_traj_frame-1045"><span class="linenos">1045</span></a>        
</span><span id="longitudinal_analysis.build_traj_frame-1046"><a href="#longitudinal_analysis.build_traj_frame-1046"><span class="linenos">1046</span></a>        <span class="k">return</span> <span class="n">traj_frame</span> 
</span></pre></div>


            <div class="docstring"><p>This builds a dataframe containing the count at all the time points for each 
of the clonotypes specified in top_clones_set.
The dataframe has also a field that contains the cumulative count.
The trajectory dataframe is initialised with indexes as the clonotypes in
top_clones_set</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>top_clones_set</strong> (TOFILL):
TOFILL</li>
<li><strong>ntCDR3</strong> (str):
The label of the TCR nucleotide sequences columns, the default value is 'N. Seq. CDR3'.</li>
<li><strong>clone_count</strong> (str):
TOFILL</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>traj_frame</strong>: TO DESCRIBE</li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.plot_trajectories" class="classattr">
                                        <input id="longitudinal_analysis.plot_trajectories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_trajectories</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">n_top_clones</span>,</span><span class="param">	<span class="n">filename</span>,</span><span class="param">	<span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span>,</span><span class="param">	<span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span>,</span><span class="param">	<span class="n">clone_count</span><span class="o">=</span><span class="s1">&#39;Clone count&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.plot_trajectories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.plot_trajectories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.plot_trajectories-1053"><a href="#longitudinal_analysis.plot_trajectories-1053"><span class="linenos">1053</span></a>    <span class="k">def</span> <span class="nf">plot_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis.plot_trajectories-1054"><a href="#longitudinal_analysis.plot_trajectories-1054"><span class="linenos">1054</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1055"><a href="#longitudinal_analysis.plot_trajectories-1055"><span class="linenos">1055</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.plot_trajectories-1056"><a href="#longitudinal_analysis.plot_trajectories-1056"><span class="linenos">1056</span></a><span class="sd">        Function to plot the trajectories of the first top n clones using your favorite colormap</span>
</span><span id="longitudinal_analysis.plot_trajectories-1057"><a href="#longitudinal_analysis.plot_trajectories-1057"><span class="linenos">1057</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis.plot_trajectories-1058"><a href="#longitudinal_analysis.plot_trajectories-1058"><span class="linenos">1058</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.plot_trajectories-1059"><a href="#longitudinal_analysis.plot_trajectories-1059"><span class="linenos">1059</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.plot_trajectories-1060"><a href="#longitudinal_analysis.plot_trajectories-1060"><span class="linenos">1060</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="longitudinal_analysis.plot_trajectories-1061"><a href="#longitudinal_analysis.plot_trajectories-1061"><span class="linenos">1061</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_trajectories-1062"><a href="#longitudinal_analysis.plot_trajectories-1062"><span class="linenos">1062</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1063"><a href="#longitudinal_analysis.plot_trajectories-1063"><span class="linenos">1063</span></a><span class="sd">        filename  : str</span>
</span><span id="longitudinal_analysis.plot_trajectories-1064"><a href="#longitudinal_analysis.plot_trajectories-1064"><span class="linenos">1064</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_trajectories-1065"><a href="#longitudinal_analysis.plot_trajectories-1065"><span class="linenos">1065</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1066"><a href="#longitudinal_analysis.plot_trajectories-1066"><span class="linenos">1066</span></a><span class="sd">        colormap : TOFILL</span>
</span><span id="longitudinal_analysis.plot_trajectories-1067"><a href="#longitudinal_analysis.plot_trajectories-1067"><span class="linenos">1067</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.plot_trajectories-1068"><a href="#longitudinal_analysis.plot_trajectories-1068"><span class="linenos">1068</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1069"><a href="#longitudinal_analysis.plot_trajectories-1069"><span class="linenos">1069</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="longitudinal_analysis.plot_trajectories-1070"><a href="#longitudinal_analysis.plot_trajectories-1070"><span class="linenos">1070</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.plot_trajectories-1071"><a href="#longitudinal_analysis.plot_trajectories-1071"><span class="linenos">1071</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1072"><a href="#longitudinal_analysis.plot_trajectories-1072"><span class="linenos">1072</span></a><span class="sd">        clone_count : str</span>
</span><span id="longitudinal_analysis.plot_trajectories-1073"><a href="#longitudinal_analysis.plot_trajectories-1073"><span class="linenos">1073</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1074"><a href="#longitudinal_analysis.plot_trajectories-1074"><span class="linenos">1074</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.plot_trajectories-1075"><a href="#longitudinal_analysis.plot_trajectories-1075"><span class="linenos">1075</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1076"><a href="#longitudinal_analysis.plot_trajectories-1076"><span class="linenos">1076</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1077"><a href="#longitudinal_analysis.plot_trajectories-1077"><span class="linenos">1077</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.plot_trajectories-1078"><a href="#longitudinal_analysis.plot_trajectories-1078"><span class="linenos">1078</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.plot_trajectories-1079"><a href="#longitudinal_analysis.plot_trajectories-1079"><span class="linenos">1079</span></a><span class="sd">        plot </span>
</span><span id="longitudinal_analysis.plot_trajectories-1080"><a href="#longitudinal_analysis.plot_trajectories-1080"><span class="linenos">1080</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis.plot_trajectories-1081"><a href="#longitudinal_analysis.plot_trajectories-1081"><span class="linenos">1081</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1082"><a href="#longitudinal_analysis.plot_trajectories-1082"><span class="linenos">1082</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.plot_trajectories-1083"><a href="#longitudinal_analysis.plot_trajectories-1083"><span class="linenos">1083</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1084"><a href="#longitudinal_analysis.plot_trajectories-1084"><span class="linenos">1084</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1085"><a href="#longitudinal_analysis.plot_trajectories-1085"><span class="linenos">1085</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis.plot_trajectories-1086"><a href="#longitudinal_analysis.plot_trajectories-1086"><span class="linenos">1086</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1087"><a href="#longitudinal_analysis.plot_trajectories-1087"><span class="linenos">1087</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1088"><a href="#longitudinal_analysis.plot_trajectories-1088"><span class="linenos">1088</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1089"><a href="#longitudinal_analysis.plot_trajectories-1089"><span class="linenos">1089</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1090"><a href="#longitudinal_analysis.plot_trajectories-1090"><span class="linenos">1090</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1091"><a href="#longitudinal_analysis.plot_trajectories-1091"><span class="linenos">1091</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="longitudinal_analysis.plot_trajectories-1092"><a href="#longitudinal_analysis.plot_trajectories-1092"><span class="linenos">1092</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1093"><a href="#longitudinal_analysis.plot_trajectories-1093"><span class="linenos">1093</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1094"><a href="#longitudinal_analysis.plot_trajectories-1094"><span class="linenos">1094</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1095"><a href="#longitudinal_analysis.plot_trajectories-1095"><span class="linenos">1095</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1096"><a href="#longitudinal_analysis.plot_trajectories-1096"><span class="linenos">1096</span></a>        <span class="n">log_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">traj_frame</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1097"><a href="#longitudinal_analysis.plot_trajectories-1097"><span class="linenos">1097</span></a>        <span class="n">max_log_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1098"><a href="#longitudinal_analysis.plot_trajectories-1098"><span class="linenos">1098</span></a>        <span class="n">min_log_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1099"><a href="#longitudinal_analysis.plot_trajectories-1099"><span class="linenos">1099</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1100"><a href="#longitudinal_analysis.plot_trajectories-1100"><span class="linenos">1100</span></a>        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="longitudinal_analysis.plot_trajectories-1101"><a href="#longitudinal_analysis.plot_trajectories-1101"><span class="linenos">1101</span></a>            <span class="n">traj</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="longitudinal_analysis.plot_trajectories-1102"><a href="#longitudinal_analysis.plot_trajectories-1102"><span class="linenos">1102</span></a>            <span class="n">log_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">])</span>
</span><span id="longitudinal_analysis.plot_trajectories-1103"><a href="#longitudinal_analysis.plot_trajectories-1103"><span class="linenos">1103</span></a>            <span class="n">norm_log_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_count</span><span class="o">-</span><span class="n">min_log_count</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">max_log_count</span><span class="o">-</span><span class="n">min_log_count</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1104"><a href="#longitudinal_analysis.plot_trajectories-1104"><span class="linenos">1104</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">traj</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm_log_count</span><span class="p">))</span> <span class="c1"># I am adding 1 to define a kind of pseudo-count here and avoid 0 values</span>
</span><span id="longitudinal_analysis.plot_trajectories-1105"><a href="#longitudinal_analysis.plot_trajectories-1105"><span class="linenos">1105</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1106"><a href="#longitudinal_analysis.plot_trajectories-1106"><span class="linenos">1106</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1107"><a href="#longitudinal_analysis.plot_trajectories-1107"><span class="linenos">1107</span></a>        <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">log_counts</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">log_counts</span><span class="p">)))</span>
</span><span id="longitudinal_analysis.plot_trajectories-1108"><a href="#longitudinal_analysis.plot_trajectories-1108"><span class="linenos">1108</span></a>        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1109"><a href="#longitudinal_analysis.plot_trajectories-1109"><span class="linenos">1109</span></a>        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Log10 cumulative count&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_trajectories-1110"><a href="#longitudinal_analysis.plot_trajectories-1110"><span class="linenos">1110</span></a>
</span><span id="longitudinal_analysis.plot_trajectories-1111"><a href="#longitudinal_analysis.plot_trajectories-1111"><span class="linenos">1111</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Function to plot the trajectories of the first top n clones using your favorite colormap</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>n_top_clones</strong> (TOFILL):
TOFILL</li>
<li><strong>filename</strong> (str):
TOFILL</li>
<li><strong>colormap</strong> (TOFILL):
TOFILL, default one</li>
<li><strong>ntCDR3</strong> (str):
TOFILL, default one</li>
<li><strong>clone_count</strong> (str):
TOFILL, default one</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>plot</strong>: TO DESCRIBE</li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.PCA_traj" class="classattr">
                                        <input id="longitudinal_analysis.PCA_traj-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">PCA_traj</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">n_top_clones</span>,</span><span class="param">	<span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span>,</span><span class="param">	<span class="n">clone_count</span><span class="o">=</span><span class="s1">&#39;Clone count&#39;</span>,</span><span class="param">	<span class="n">nclus</span><span class="o">=</span><span class="mi">3</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.PCA_traj-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.PCA_traj"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.PCA_traj-1113"><a href="#longitudinal_analysis.PCA_traj-1113"><span class="linenos">1113</span></a>    <span class="k">def</span> <span class="nf">PCA_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
</span><span id="longitudinal_analysis.PCA_traj-1114"><a href="#longitudinal_analysis.PCA_traj-1114"><span class="linenos">1114</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1115"><a href="#longitudinal_analysis.PCA_traj-1115"><span class="linenos">1115</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.PCA_traj-1116"><a href="#longitudinal_analysis.PCA_traj-1116"><span class="linenos">1116</span></a><span class="sd">        Perform PCA computation over the normalized trajectories of n_top_clones TCR clones</span>
</span><span id="longitudinal_analysis.PCA_traj-1117"><a href="#longitudinal_analysis.PCA_traj-1117"><span class="linenos">1117</span></a><span class="sd">        nclus: number of clusters of clonal dynamics, by default this number is set to 3</span>
</span><span id="longitudinal_analysis.PCA_traj-1118"><a href="#longitudinal_analysis.PCA_traj-1118"><span class="linenos">1118</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis.PCA_traj-1119"><a href="#longitudinal_analysis.PCA_traj-1119"><span class="linenos">1119</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.PCA_traj-1120"><a href="#longitudinal_analysis.PCA_traj-1120"><span class="linenos">1120</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.PCA_traj-1121"><a href="#longitudinal_analysis.PCA_traj-1121"><span class="linenos">1121</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="longitudinal_analysis.PCA_traj-1122"><a href="#longitudinal_analysis.PCA_traj-1122"><span class="linenos">1122</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.PCA_traj-1123"><a href="#longitudinal_analysis.PCA_traj-1123"><span class="linenos">1123</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1124"><a href="#longitudinal_analysis.PCA_traj-1124"><span class="linenos">1124</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="longitudinal_analysis.PCA_traj-1125"><a href="#longitudinal_analysis.PCA_traj-1125"><span class="linenos">1125</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.PCA_traj-1126"><a href="#longitudinal_analysis.PCA_traj-1126"><span class="linenos">1126</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1127"><a href="#longitudinal_analysis.PCA_traj-1127"><span class="linenos">1127</span></a><span class="sd">        clone_count : str</span>
</span><span id="longitudinal_analysis.PCA_traj-1128"><a href="#longitudinal_analysis.PCA_traj-1128"><span class="linenos">1128</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.PCA_traj-1129"><a href="#longitudinal_analysis.PCA_traj-1129"><span class="linenos">1129</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1130"><a href="#longitudinal_analysis.PCA_traj-1130"><span class="linenos">1130</span></a><span class="sd">        nclus : float</span>
</span><span id="longitudinal_analysis.PCA_traj-1131"><a href="#longitudinal_analysis.PCA_traj-1131"><span class="linenos">1131</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.PCA_traj-1132"><a href="#longitudinal_analysis.PCA_traj-1132"><span class="linenos">1132</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1133"><a href="#longitudinal_analysis.PCA_traj-1133"><span class="linenos">1133</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis.PCA_traj-1134"><a href="#longitudinal_analysis.PCA_traj-1134"><span class="linenos">1134</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.PCA_traj-1135"><a href="#longitudinal_analysis.PCA_traj-1135"><span class="linenos">1135</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.PCA_traj-1136"><a href="#longitudinal_analysis.PCA_traj-1136"><span class="linenos">1136</span></a><span class="sd">        pca </span>
</span><span id="longitudinal_analysis.PCA_traj-1137"><a href="#longitudinal_analysis.PCA_traj-1137"><span class="linenos">1137</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis.PCA_traj-1138"><a href="#longitudinal_analysis.PCA_traj-1138"><span class="linenos">1138</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1139"><a href="#longitudinal_analysis.PCA_traj-1139"><span class="linenos">1139</span></a><span class="sd">        clustering</span>
</span><span id="longitudinal_analysis.PCA_traj-1140"><a href="#longitudinal_analysis.PCA_traj-1140"><span class="linenos">1140</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1141"><a href="#longitudinal_analysis.PCA_traj-1141"><span class="linenos">1141</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.PCA_traj-1142"><a href="#longitudinal_analysis.PCA_traj-1142"><span class="linenos">1142</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1143"><a href="#longitudinal_analysis.PCA_traj-1143"><span class="linenos">1143</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="longitudinal_analysis.PCA_traj-1144"><a href="#longitudinal_analysis.PCA_traj-1144"><span class="linenos">1144</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="longitudinal_analysis.PCA_traj-1145"><a href="#longitudinal_analysis.PCA_traj-1145"><span class="linenos">1145</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="longitudinal_analysis.PCA_traj-1146"><a href="#longitudinal_analysis.PCA_traj-1146"><span class="linenos">1146</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="longitudinal_analysis.PCA_traj-1147"><a href="#longitudinal_analysis.PCA_traj-1147"><span class="linenos">1147</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1148"><a href="#longitudinal_analysis.PCA_traj-1148"><span class="linenos">1148</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="longitudinal_analysis.PCA_traj-1149"><a href="#longitudinal_analysis.PCA_traj-1149"><span class="linenos">1149</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="longitudinal_analysis.PCA_traj-1150"><a href="#longitudinal_analysis.PCA_traj-1150"><span class="linenos">1150</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1151"><a href="#longitudinal_analysis.PCA_traj-1151"><span class="linenos">1151</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="longitudinal_analysis.PCA_traj-1152"><a href="#longitudinal_analysis.PCA_traj-1152"><span class="linenos">1152</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="longitudinal_analysis.PCA_traj-1153"><a href="#longitudinal_analysis.PCA_traj-1153"><span class="linenos">1153</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1154"><a href="#longitudinal_analysis.PCA_traj-1154"><span class="linenos">1154</span></a>        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">norm_traj_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="longitudinal_analysis.PCA_traj-1155"><a href="#longitudinal_analysis.PCA_traj-1155"><span class="linenos">1155</span></a>        <span class="n">clustering</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">nclus</span><span class="p">)</span>
</span><span id="longitudinal_analysis.PCA_traj-1156"><a href="#longitudinal_analysis.PCA_traj-1156"><span class="linenos">1156</span></a>        <span class="n">clustering</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="longitudinal_analysis.PCA_traj-1157"><a href="#longitudinal_analysis.PCA_traj-1157"><span class="linenos">1157</span></a>
</span><span id="longitudinal_analysis.PCA_traj-1158"><a href="#longitudinal_analysis.PCA_traj-1158"><span class="linenos">1158</span></a>        <span class="k">return</span> <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span>
</span></pre></div>


            <div class="docstring"><p>Perform PCA computation over the normalized trajectories of n_top_clones TCR clones
nclus: number of clusters of clonal dynamics, by default this number is set to 3</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>n_top_clones</strong> (TOFILL):
TOFILL</li>
<li><strong>ntCDR3</strong> (str):
TOFILL, default one</li>
<li><strong>clone_count</strong> (str):
TOFILL, default one</li>
<li><strong>nclus</strong> (float):
TOFILL</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>pca</strong>: TO DESCRIBE</li>
<li><strong>clustering</strong></li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.plot_clusters2D" class="classattr">
                                        <input id="longitudinal_analysis.plot_clusters2D-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_clusters2D</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">n_top_clones</span>,</span><span class="param">	<span class="n">filename</span>,</span><span class="param">	<span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span>,</span><span class="param">	<span class="n">clone_count</span><span class="o">=</span><span class="s1">&#39;Clone count&#39;</span>,</span><span class="param">	<span class="n">nclus</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.plot_clusters2D-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.plot_clusters2D"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.plot_clusters2D-1161"><a href="#longitudinal_analysis.plot_clusters2D-1161"><span class="linenos">1161</span></a>    <span class="k">def</span> <span class="nf">plot_clusters2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1162"><a href="#longitudinal_analysis.plot_clusters2D-1162"><span class="linenos">1162</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1163"><a href="#longitudinal_analysis.plot_clusters2D-1163"><span class="linenos">1163</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1164"><a href="#longitudinal_analysis.plot_clusters2D-1164"><span class="linenos">1164</span></a><span class="sd">        TOFILL</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1165"><a href="#longitudinal_analysis.plot_clusters2D-1165"><span class="linenos">1165</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis.plot_clusters2D-1166"><a href="#longitudinal_analysis.plot_clusters2D-1166"><span class="linenos">1166</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1167"><a href="#longitudinal_analysis.plot_clusters2D-1167"><span class="linenos">1167</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1168"><a href="#longitudinal_analysis.plot_clusters2D-1168"><span class="linenos">1168</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1169"><a href="#longitudinal_analysis.plot_clusters2D-1169"><span class="linenos">1169</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1170"><a href="#longitudinal_analysis.plot_clusters2D-1170"><span class="linenos">1170</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1171"><a href="#longitudinal_analysis.plot_clusters2D-1171"><span class="linenos">1171</span></a><span class="sd">        filename  : str</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1172"><a href="#longitudinal_analysis.plot_clusters2D-1172"><span class="linenos">1172</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1173"><a href="#longitudinal_analysis.plot_clusters2D-1173"><span class="linenos">1173</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1174"><a href="#longitudinal_analysis.plot_clusters2D-1174"><span class="linenos">1174</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1175"><a href="#longitudinal_analysis.plot_clusters2D-1175"><span class="linenos">1175</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1176"><a href="#longitudinal_analysis.plot_clusters2D-1176"><span class="linenos">1176</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1177"><a href="#longitudinal_analysis.plot_clusters2D-1177"><span class="linenos">1177</span></a><span class="sd">        clone_count : str</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1178"><a href="#longitudinal_analysis.plot_clusters2D-1178"><span class="linenos">1178</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1179"><a href="#longitudinal_analysis.plot_clusters2D-1179"><span class="linenos">1179</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1180"><a href="#longitudinal_analysis.plot_clusters2D-1180"><span class="linenos">1180</span></a><span class="sd">        nclus : float</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1181"><a href="#longitudinal_analysis.plot_clusters2D-1181"><span class="linenos">1181</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1182"><a href="#longitudinal_analysis.plot_clusters2D-1182"><span class="linenos">1182</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1183"><a href="#longitudinal_analysis.plot_clusters2D-1183"><span class="linenos">1183</span></a><span class="sd">        colormap : str</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1184"><a href="#longitudinal_analysis.plot_clusters2D-1184"><span class="linenos">1184</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1185"><a href="#longitudinal_analysis.plot_clusters2D-1185"><span class="linenos">1185</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1186"><a href="#longitudinal_analysis.plot_clusters2D-1186"><span class="linenos">1186</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1187"><a href="#longitudinal_analysis.plot_clusters2D-1187"><span class="linenos">1187</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1188"><a href="#longitudinal_analysis.plot_clusters2D-1188"><span class="linenos">1188</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1189"><a href="#longitudinal_analysis.plot_clusters2D-1189"><span class="linenos">1189</span></a><span class="sd">        plot </span>
</span><span id="longitudinal_analysis.plot_clusters2D-1190"><a href="#longitudinal_analysis.plot_clusters2D-1190"><span class="linenos">1190</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1191"><a href="#longitudinal_analysis.plot_clusters2D-1191"><span class="linenos">1191</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1192"><a href="#longitudinal_analysis.plot_clusters2D-1192"><span class="linenos">1192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1193"><a href="#longitudinal_analysis.plot_clusters2D-1193"><span class="linenos">1193</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1194"><a href="#longitudinal_analysis.plot_clusters2D-1194"><span class="linenos">1194</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1195"><a href="#longitudinal_analysis.plot_clusters2D-1195"><span class="linenos">1195</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1196"><a href="#longitudinal_analysis.plot_clusters2D-1196"><span class="linenos">1196</span></a>        <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PCA_traj</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1197"><a href="#longitudinal_analysis.plot_clusters2D-1197"><span class="linenos">1197</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1198"><a href="#longitudinal_analysis.plot_clusters2D-1198"><span class="linenos">1198</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1199"><a href="#longitudinal_analysis.plot_clusters2D-1199"><span class="linenos">1199</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1200"><a href="#longitudinal_analysis.plot_clusters2D-1200"><span class="linenos">1200</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1201"><a href="#longitudinal_analysis.plot_clusters2D-1201"><span class="linenos">1201</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1202"><a href="#longitudinal_analysis.plot_clusters2D-1202"><span class="linenos">1202</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1203"><a href="#longitudinal_analysis.plot_clusters2D-1203"><span class="linenos">1203</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1204"><a href="#longitudinal_analysis.plot_clusters2D-1204"><span class="linenos">1204</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1205"><a href="#longitudinal_analysis.plot_clusters2D-1205"><span class="linenos">1205</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1206"><a href="#longitudinal_analysis.plot_clusters2D-1206"><span class="linenos">1206</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1207"><a href="#longitudinal_analysis.plot_clusters2D-1207"><span class="linenos">1207</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1208"><a href="#longitudinal_analysis.plot_clusters2D-1208"><span class="linenos">1208</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1209"><a href="#longitudinal_analysis.plot_clusters2D-1209"><span class="linenos">1209</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1210"><a href="#longitudinal_analysis.plot_clusters2D-1210"><span class="linenos">1210</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1211"><a href="#longitudinal_analysis.plot_clusters2D-1211"><span class="linenos">1211</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PCA components (</span><span class="si">%i</span><span class="s1"> trajs)&#39;</span> <span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">norm_traj_matrix</span><span class="p">),</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1212"><a href="#longitudinal_analysis.plot_clusters2D-1212"><span class="linenos">1212</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;First component (expl var: </span><span class="si">%3.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1213"><a href="#longitudinal_analysis.plot_clusters2D-1213"><span class="linenos">1213</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Second component (expl var: </span><span class="si">%3.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">25</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1214"><a href="#longitudinal_analysis.plot_clusters2D-1214"><span class="linenos">1214</span></a>        <span class="k">for</span> <span class="n">c_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">):</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1215"><a href="#longitudinal_analysis.plot_clusters2D-1215"><span class="linenos">1215</span></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">c_ind</span><span class="p">]</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1216"><a href="#longitudinal_analysis.plot_clusters2D-1216"><span class="linenos">1216</span></a>            <span class="n">y</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">c_ind</span><span class="p">]</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1217"><a href="#longitudinal_analysis.plot_clusters2D-1217"><span class="linenos">1217</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">c_ind</span><span class="o">/</span><span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">))</span>
</span><span id="longitudinal_analysis.plot_clusters2D-1218"><a href="#longitudinal_analysis.plot_clusters2D-1218"><span class="linenos">1218</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1219"><a href="#longitudinal_analysis.plot_clusters2D-1219"><span class="linenos">1219</span></a>
</span><span id="longitudinal_analysis.plot_clusters2D-1220"><a href="#longitudinal_analysis.plot_clusters2D-1220"><span class="linenos">1220</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>TOFILL</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>n_top_clones</strong> (TOFILL):
TOFILL</li>
<li><strong>filename</strong> (str):
TOFILL</li>
<li><strong>ntCDR3</strong> (str):
TOFILL, default one</li>
<li><strong>clone_count</strong> (str):
TOFILL, default one</li>
<li><strong>nclus</strong> (float):
TOFILL</li>
<li><strong>colormap</strong> (str):
TOFILL</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>plot</strong>: TO DESCRIBE</li>
</ul>
</div>


                            </div>
                            <div id="longitudinal_analysis.plot_traj_clusters" class="classattr">
                                        <input id="longitudinal_analysis.plot_traj_clusters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_traj_clusters</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">n_top_clones</span>,</span><span class="param">	<span class="n">filename</span>,</span><span class="param">	<span class="n">ntCDR3</span><span class="o">=</span><span class="s1">&#39;N. Seq. CDR3&#39;</span>,</span><span class="param">	<span class="n">clone_count</span><span class="o">=</span><span class="s1">&#39;Clone count&#39;</span>,</span><span class="param">	<span class="n">nclus</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="longitudinal_analysis.plot_traj_clusters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#longitudinal_analysis.plot_traj_clusters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="longitudinal_analysis.plot_traj_clusters-1223"><a href="#longitudinal_analysis.plot_traj_clusters-1223"><span class="linenos">1223</span></a>    <span class="k">def</span> <span class="nf">plot_traj_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_top_clones</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1224"><a href="#longitudinal_analysis.plot_traj_clusters-1224"><span class="linenos">1224</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1225"><a href="#longitudinal_analysis.plot_traj_clusters-1225"><span class="linenos">1225</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1226"><a href="#longitudinal_analysis.plot_traj_clusters-1226"><span class="linenos">1226</span></a><span class="sd">        TOFILL</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1227"><a href="#longitudinal_analysis.plot_traj_clusters-1227"><span class="linenos">1227</span></a><span class="sd">        </span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1228"><a href="#longitudinal_analysis.plot_traj_clusters-1228"><span class="linenos">1228</span></a><span class="sd">        Parameters</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1229"><a href="#longitudinal_analysis.plot_traj_clusters-1229"><span class="linenos">1229</span></a><span class="sd">        ----------</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1230"><a href="#longitudinal_analysis.plot_traj_clusters-1230"><span class="linenos">1230</span></a><span class="sd">        n_top_clones : TOFILL</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1231"><a href="#longitudinal_analysis.plot_traj_clusters-1231"><span class="linenos">1231</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1232"><a href="#longitudinal_analysis.plot_traj_clusters-1232"><span class="linenos">1232</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1233"><a href="#longitudinal_analysis.plot_traj_clusters-1233"><span class="linenos">1233</span></a><span class="sd">        filename  : str</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1234"><a href="#longitudinal_analysis.plot_traj_clusters-1234"><span class="linenos">1234</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1235"><a href="#longitudinal_analysis.plot_traj_clusters-1235"><span class="linenos">1235</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1236"><a href="#longitudinal_analysis.plot_traj_clusters-1236"><span class="linenos">1236</span></a><span class="sd">        ntCDR3 : str</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1237"><a href="#longitudinal_analysis.plot_traj_clusters-1237"><span class="linenos">1237</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1238"><a href="#longitudinal_analysis.plot_traj_clusters-1238"><span class="linenos">1238</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1239"><a href="#longitudinal_analysis.plot_traj_clusters-1239"><span class="linenos">1239</span></a><span class="sd">        clone_count : str</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1240"><a href="#longitudinal_analysis.plot_traj_clusters-1240"><span class="linenos">1240</span></a><span class="sd">            TOFILL, default one</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1241"><a href="#longitudinal_analysis.plot_traj_clusters-1241"><span class="linenos">1241</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1242"><a href="#longitudinal_analysis.plot_traj_clusters-1242"><span class="linenos">1242</span></a><span class="sd">        nclus : float</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1243"><a href="#longitudinal_analysis.plot_traj_clusters-1243"><span class="linenos">1243</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1244"><a href="#longitudinal_analysis.plot_traj_clusters-1244"><span class="linenos">1244</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1245"><a href="#longitudinal_analysis.plot_traj_clusters-1245"><span class="linenos">1245</span></a><span class="sd">        colormap : str</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1246"><a href="#longitudinal_analysis.plot_traj_clusters-1246"><span class="linenos">1246</span></a><span class="sd">            TOFILL</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1247"><a href="#longitudinal_analysis.plot_traj_clusters-1247"><span class="linenos">1247</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1248"><a href="#longitudinal_analysis.plot_traj_clusters-1248"><span class="linenos">1248</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1249"><a href="#longitudinal_analysis.plot_traj_clusters-1249"><span class="linenos">1249</span></a><span class="sd">        Returns</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1250"><a href="#longitudinal_analysis.plot_traj_clusters-1250"><span class="linenos">1250</span></a><span class="sd">        -------</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1251"><a href="#longitudinal_analysis.plot_traj_clusters-1251"><span class="linenos">1251</span></a><span class="sd">        plot </span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1252"><a href="#longitudinal_analysis.plot_traj_clusters-1252"><span class="linenos">1252</span></a><span class="sd">            TO DESCRIBE</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1253"><a href="#longitudinal_analysis.plot_traj_clusters-1253"><span class="linenos">1253</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1254"><a href="#longitudinal_analysis.plot_traj_clusters-1254"><span class="linenos">1254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1255"><a href="#longitudinal_analysis.plot_traj_clusters-1255"><span class="linenos">1255</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1256"><a href="#longitudinal_analysis.plot_traj_clusters-1256"><span class="linenos">1256</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1257"><a href="#longitudinal_analysis.plot_traj_clusters-1257"><span class="linenos">1257</span></a>        <span class="n">pca</span><span class="p">,</span> <span class="n">clustering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PCA_traj</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span> <span class="o">=</span> <span class="s1">&#39;N. Seq. CDR3&#39;</span><span class="p">,</span> <span class="n">clone_count</span> <span class="o">=</span> <span class="s1">&#39;Clone count&#39;</span><span class="p">,</span> <span class="n">nclus</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1258"><a href="#longitudinal_analysis.plot_traj_clusters-1258"><span class="linenos">1258</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1259"><a href="#longitudinal_analysis.plot_traj_clusters-1259"><span class="linenos">1259</span></a>        <span class="n">n_cl</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">n_clusters</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1260"><a href="#longitudinal_analysis.plot_traj_clusters-1260"><span class="linenos">1260</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1261"><a href="#longitudinal_analysis.plot_traj_clusters-1261"><span class="linenos">1261</span></a>        <span class="c1">#Getting the top n_top_clones clonotypes at each time point</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1262"><a href="#longitudinal_analysis.plot_traj_clusters-1262"><span class="linenos">1262</span></a>        <span class="n">top_clones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_clones_set</span><span class="p">(</span><span class="n">n_top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span>  <span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1263"><a href="#longitudinal_analysis.plot_traj_clusters-1263"><span class="linenos">1263</span></a>        <span class="c1">#Building a trajectory dataframe</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1264"><a href="#longitudinal_analysis.plot_traj_clusters-1264"><span class="linenos">1264</span></a>        <span class="n">traj_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_traj_frame</span><span class="p">(</span><span class="n">top_clones</span><span class="p">,</span> <span class="n">ntCDR3</span><span class="p">,</span> <span class="n">clone_count</span> <span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1265"><a href="#longitudinal_analysis.plot_traj_clusters-1265"><span class="linenos">1265</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1266"><a href="#longitudinal_analysis.plot_traj_clusters-1266"><span class="linenos">1266</span></a>        <span class="c1">#Converting it in a numpy matrix</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1267"><a href="#longitudinal_analysis.plot_traj_clusters-1267"><span class="linenos">1267</span></a>        <span class="n">traj_matrix</span> <span class="o">=</span> <span class="n">traj_frame</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Clone cumul count&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1268"><a href="#longitudinal_analysis.plot_traj_clusters-1268"><span class="linenos">1268</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1269"><a href="#longitudinal_analysis.plot_traj_clusters-1269"><span class="linenos">1269</span></a>        <span class="c1"># Normalize each trajectory by its maximum</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1270"><a href="#longitudinal_analysis.plot_traj_clusters-1270"><span class="linenos">1270</span></a>        <span class="n">norm_traj_matrix</span> <span class="o">=</span> <span class="n">traj_matrix</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1271"><a href="#longitudinal_analysis.plot_traj_clusters-1271"><span class="linenos">1271</span></a>        <span class="n">clones</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_clones</span><span class="p">()</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1272"><a href="#longitudinal_analysis.plot_traj_clusters-1272"><span class="linenos">1272</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1273"><a href="#longitudinal_analysis.plot_traj_clusters-1273"><span class="linenos">1273</span></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_cl</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">n_cl</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1274"><a href="#longitudinal_analysis.plot_traj_clusters-1274"><span class="linenos">1274</span></a>        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cl</span><span class="p">):</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1275"><a href="#longitudinal_analysis.plot_traj_clusters-1275"><span class="linenos">1275</span></a>            <span class="n">trajs</span> <span class="o">=</span> <span class="n">norm_traj_matrix</span><span class="p">[</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">==</span> <span class="n">cl</span><span class="p">]</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1276"><a href="#longitudinal_analysis.plot_traj_clusters-1276"><span class="linenos">1276</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1277"><a href="#longitudinal_analysis.plot_traj_clusters-1277"><span class="linenos">1277</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1278"><a href="#longitudinal_analysis.plot_traj_clusters-1278"><span class="linenos">1278</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1279"><a href="#longitudinal_analysis.plot_traj_clusters-1279"><span class="linenos">1279</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1280"><a href="#longitudinal_analysis.plot_traj_clusters-1280"><span class="linenos">1280</span></a>            <span class="k">for</span> <span class="n">traj</span> <span class="ow">in</span> <span class="n">trajs</span><span class="p">:</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1281"><a href="#longitudinal_analysis.plot_traj_clusters-1281"><span class="linenos">1281</span></a>                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">cl</span><span class="o">/</span><span class="n">n_cl</span><span class="p">))</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1282"><a href="#longitudinal_analysis.plot_traj_clusters-1282"><span class="linenos">1282</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1283"><a href="#longitudinal_analysis.plot_traj_clusters-1283"><span class="linenos">1283</span></a>            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
</span><span id="longitudinal_analysis.plot_traj_clusters-1284"><a href="#longitudinal_analysis.plot_traj_clusters-1284"><span class="linenos">1284</span></a>                                <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">trajs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">cl</span><span class="o">/</span><span class="n">n_cl</span><span class="p">))</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1285"><a href="#longitudinal_analysis.plot_traj_clusters-1285"><span class="linenos">1285</span></a>            <span class="c1">#axs[1][cl].fill_between(times, np.quantile(trajs, 0.75, axis=0), np.quantile(trajs, 0.25, axis=0), color=colors[cl])</span>
</span><span id="longitudinal_analysis.plot_traj_clusters-1286"><a href="#longitudinal_analysis.plot_traj_clusters-1286"><span class="linenos">1286</span></a>               
</span><span id="longitudinal_analysis.plot_traj_clusters-1287"><a href="#longitudinal_analysis.plot_traj_clusters-1287"><span class="linenos">1287</span></a>
</span><span id="longitudinal_analysis.plot_traj_clusters-1288"><a href="#longitudinal_analysis.plot_traj_clusters-1288"><span class="linenos">1288</span></a>        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span> 
</span><span id="longitudinal_analysis.plot_traj_clusters-1289"><a href="#longitudinal_analysis.plot_traj_clusters-1289"><span class="linenos">1289</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>TOFILL</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>n_top_clones</strong> (TOFILL):
TOFILL</li>
<li><strong>filename</strong> (str):
TOFILL</li>
<li><strong>ntCDR3</strong> (str):
TOFILL, default one</li>
<li><strong>clone_count</strong> (str):
TOFILL, default one</li>
<li><strong>nclus</strong> (float):
TOFILL</li>
<li><strong>colormap</strong> (str):
TOFILL</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>plot</strong>: TO DESCRIBE</li>
</ul>
</div>


                            </div>
                </section>
                <section id="Data_Process">
                            <input id="Data_Process-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Data_Process</span>:

                <label class="view-source-button" for="Data_Process-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Data_Process"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Data_Process-1293"><a href="#Data_Process-1293"><span class="linenos">1293</span></a><span class="k">class</span> <span class="nc">Data_Process</span><span class="p">():</span>
</span><span id="Data_Process-1294"><a href="#Data_Process-1294"><span class="linenos">1294</span></a>
</span><span id="Data_Process-1295"><a href="#Data_Process-1295"><span class="linenos">1295</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Data_Process-1296"><a href="#Data_Process-1296"><span class="linenos">1296</span></a><span class="sd">    ## TODO in the future, merge this class with other classes.</span>
</span><span id="Data_Process-1297"><a href="#Data_Process-1297"><span class="linenos">1297</span></a>
</span><span id="Data_Process-1298"><a href="#Data_Process-1298"><span class="linenos">1298</span></a><span class="sd">    A class used to represent longitudinal RepSeq data and pre-analysis of the longitudinal data associated with</span>
</span><span id="Data_Process-1299"><a href="#Data_Process-1299"><span class="linenos">1299</span></a><span class="sd">    one individual.</span>
</span><span id="Data_Process-1300"><a href="#Data_Process-1300"><span class="linenos">1300</span></a>
</span><span id="Data_Process-1301"><a href="#Data_Process-1301"><span class="linenos">1301</span></a><span class="sd">    ...</span>
</span><span id="Data_Process-1302"><a href="#Data_Process-1302"><span class="linenos">1302</span></a>
</span><span id="Data_Process-1303"><a href="#Data_Process-1303"><span class="linenos">1303</span></a><span class="sd">    Attributes</span>
</span><span id="Data_Process-1304"><a href="#Data_Process-1304"><span class="linenos">1304</span></a><span class="sd">    ----------</span>
</span><span id="Data_Process-1305"><a href="#Data_Process-1305"><span class="linenos">1305</span></a><span class="sd">    path : str</span>
</span><span id="Data_Process-1306"><a href="#Data_Process-1306"><span class="linenos">1306</span></a><span class="sd">        the name of the path to get access to the data files to use for our analysis</span>
</span><span id="Data_Process-1307"><a href="#Data_Process-1307"><span class="linenos">1307</span></a><span class="sd">    filename1 : str</span>
</span><span id="Data_Process-1308"><a href="#Data_Process-1308"><span class="linenos">1308</span></a><span class="sd">        the name of the file of the RepSeq sample which can be the first replicate when deciphering the experimental noise </span>
</span><span id="Data_Process-1309"><a href="#Data_Process-1309"><span class="linenos">1309</span></a><span class="sd">        or the first time point RepSeq sample when analysing responding clones to a stimulus between two time points.</span>
</span><span id="Data_Process-1310"><a href="#Data_Process-1310"><span class="linenos">1310</span></a><span class="sd">    filename2 : str</span>
</span><span id="Data_Process-1311"><a href="#Data_Process-1311"><span class="linenos">1311</span></a><span class="sd">        the name of the file of the RepSeq sample which can be the second replicate when deciphering the experimental noise </span>
</span><span id="Data_Process-1312"><a href="#Data_Process-1312"><span class="linenos">1312</span></a><span class="sd">        or the second time point RepSeq sample when analysing responding clones to a stimulus between two time points.</span>
</span><span id="Data_Process-1313"><a href="#Data_Process-1313"><span class="linenos">1313</span></a><span class="sd">    colnames1 : str</span>
</span><span id="Data_Process-1314"><a href="#Data_Process-1314"><span class="linenos">1314</span></a><span class="sd">        list of columns names of data-set - first sample</span>
</span><span id="Data_Process-1315"><a href="#Data_Process-1315"><span class="linenos">1315</span></a><span class="sd">    colnames2 : str</span>
</span><span id="Data_Process-1316"><a href="#Data_Process-1316"><span class="linenos">1316</span></a><span class="sd">        list of columns names of data-set - second sample </span>
</span><span id="Data_Process-1317"><a href="#Data_Process-1317"><span class="linenos">1317</span></a>
</span><span id="Data_Process-1318"><a href="#Data_Process-1318"><span class="linenos">1318</span></a>
</span><span id="Data_Process-1319"><a href="#Data_Process-1319"><span class="linenos">1319</span></a><span class="sd">    Methods</span>
</span><span id="Data_Process-1320"><a href="#Data_Process-1320"><span class="linenos">1320</span></a><span class="sd">    -------</span>
</span><span id="Data_Process-1321"><a href="#Data_Process-1321"><span class="linenos">1321</span></a>
</span><span id="Data_Process-1322"><a href="#Data_Process-1322"><span class="linenos">1322</span></a><span class="sd">    import_data() : </span>
</span><span id="Data_Process-1323"><a href="#Data_Process-1323"><span class="linenos">1323</span></a><span class="sd">        to import and merged two RepSeq samples and build a unique data-frame with frequencies and abundances of all TCR clones present in the </span>
</span><span id="Data_Process-1324"><a href="#Data_Process-1324"><span class="linenos">1324</span></a><span class="sd">        union of both samples.</span>
</span><span id="Data_Process-1325"><a href="#Data_Process-1325"><span class="linenos">1325</span></a><span class="sd">    </span>
</span><span id="Data_Process-1326"><a href="#Data_Process-1326"><span class="linenos">1326</span></a>
</span><span id="Data_Process-1327"><a href="#Data_Process-1327"><span class="linenos">1327</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Data_Process-1328"><a href="#Data_Process-1328"><span class="linenos">1328</span></a>
</span><span id="Data_Process-1329"><a href="#Data_Process-1329"><span class="linenos">1329</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename1</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="n">colnames1</span><span class="p">,</span>  <span class="n">colnames2</span><span class="p">):</span>
</span><span id="Data_Process-1330"><a href="#Data_Process-1330"><span class="linenos">1330</span></a>
</span><span id="Data_Process-1331"><a href="#Data_Process-1331"><span class="linenos">1331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="Data_Process-1332"><a href="#Data_Process-1332"><span class="linenos">1332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span> <span class="o">=</span> <span class="n">filename1</span>
</span><span id="Data_Process-1333"><a href="#Data_Process-1333"><span class="linenos">1333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span> <span class="o">=</span> <span class="n">filename2</span>
</span><span id="Data_Process-1334"><a href="#Data_Process-1334"><span class="linenos">1334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span> <span class="o">=</span> <span class="n">colnames1</span>
</span><span id="Data_Process-1335"><a href="#Data_Process-1335"><span class="linenos">1335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span> <span class="o">=</span> <span class="n">colnames2</span>
</span><span id="Data_Process-1336"><a href="#Data_Process-1336"><span class="linenos">1336</span></a>    
</span><span id="Data_Process-1337"><a href="#Data_Process-1337"><span class="linenos">1337</span></a>
</span><span id="Data_Process-1338"><a href="#Data_Process-1338"><span class="linenos">1338</span></a>    <span class="k">def</span> <span class="nf">import_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Data_Process-1339"><a href="#Data_Process-1339"><span class="linenos">1339</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Data_Process-1340"><a href="#Data_Process-1340"><span class="linenos">1340</span></a><span class="sd">        TOFILL</span>
</span><span id="Data_Process-1341"><a href="#Data_Process-1341"><span class="linenos">1341</span></a><span class="sd">        </span>
</span><span id="Data_Process-1342"><a href="#Data_Process-1342"><span class="linenos">1342</span></a><span class="sd">        Parameters</span>
</span><span id="Data_Process-1343"><a href="#Data_Process-1343"><span class="linenos">1343</span></a><span class="sd">        ----------</span>
</span><span id="Data_Process-1344"><a href="#Data_Process-1344"><span class="linenos">1344</span></a><span class="sd">        NONE</span>
</span><span id="Data_Process-1345"><a href="#Data_Process-1345"><span class="linenos">1345</span></a>
</span><span id="Data_Process-1346"><a href="#Data_Process-1346"><span class="linenos">1346</span></a>
</span><span id="Data_Process-1347"><a href="#Data_Process-1347"><span class="linenos">1347</span></a><span class="sd">        Returns</span>
</span><span id="Data_Process-1348"><a href="#Data_Process-1348"><span class="linenos">1348</span></a><span class="sd">        -------</span>
</span><span id="Data_Process-1349"><a href="#Data_Process-1349"><span class="linenos">1349</span></a><span class="sd">        number_clones</span>
</span><span id="Data_Process-1350"><a href="#Data_Process-1350"><span class="linenos">1350</span></a><span class="sd">            numpy array, number of clones in the data frame which is the union of the two RepSeq used as entries of the function</span>
</span><span id="Data_Process-1351"><a href="#Data_Process-1351"><span class="linenos">1351</span></a>
</span><span id="Data_Process-1352"><a href="#Data_Process-1352"><span class="linenos">1352</span></a><span class="sd">        df</span>
</span><span id="Data_Process-1353"><a href="#Data_Process-1353"><span class="linenos">1353</span></a><span class="sd">            pandas data-frame which is the data-frame containing the informations labeled in colnames vector string</span>
</span><span id="Data_Process-1354"><a href="#Data_Process-1354"><span class="linenos">1354</span></a><span class="sd">            for both RepSeq samples taken as input.</span>
</span><span id="Data_Process-1355"><a href="#Data_Process-1355"><span class="linenos">1355</span></a>
</span><span id="Data_Process-1356"><a href="#Data_Process-1356"><span class="linenos">1356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Data_Process-1357"><a href="#Data_Process-1357"><span class="linenos">1357</span></a>
</span><span id="Data_Process-1358"><a href="#Data_Process-1358"><span class="linenos">1358</span></a>        <span class="n">mincount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Data_Process-1359"><a href="#Data_Process-1359"><span class="linenos">1359</span></a>        <span class="n">maxcount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="Data_Process-1360"><a href="#Data_Process-1360"><span class="linenos">1360</span></a>        
</span><span id="Data_Process-1361"><a href="#Data_Process-1361"><span class="linenos">1361</span></a>        <span class="n">headerline</span><span class="o">=</span><span class="mi">0</span> <span class="c1">#line number of headerline</span>
</span><span id="Data_Process-1362"><a href="#Data_Process-1362"><span class="linenos">1362</span></a>        <span class="n">newnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Clone_fraction&#39;</span><span class="p">,</span><span class="s1">&#39;Clone_count&#39;</span><span class="p">,</span><span class="s1">&#39;ntCDR3&#39;</span><span class="p">,</span><span class="s1">&#39;AACDR3&#39;</span><span class="p">]</span>   
</span><span id="Data_Process-1363"><a href="#Data_Process-1363"><span class="linenos">1363</span></a>
</span><span id="Data_Process-1364"><a href="#Data_Process-1364"><span class="linenos">1364</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span><span class="p">:</span>
</span><span id="Data_Process-1365"><a href="#Data_Process-1365"><span class="linenos">1365</span></a>            <span class="n">F1Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">]</span>
</span><span id="Data_Process-1366"><a href="#Data_Process-1366"><span class="linenos">1366</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Data_Process-1367"><a href="#Data_Process-1367"><span class="linenos">1367</span></a>            <span class="n">F1Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">]</span>
</span><span id="Data_Process-1368"><a href="#Data_Process-1368"><span class="linenos">1368</span></a>
</span><span id="Data_Process-1369"><a href="#Data_Process-1369"><span class="linenos">1369</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span><span class="p">:</span>
</span><span id="Data_Process-1370"><a href="#Data_Process-1370"><span class="linenos">1370</span></a>            <span class="n">F2Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">]</span>
</span><span id="Data_Process-1371"><a href="#Data_Process-1371"><span class="linenos">1371</span></a>
</span><span id="Data_Process-1372"><a href="#Data_Process-1372"><span class="linenos">1372</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Data_Process-1373"><a href="#Data_Process-1373"><span class="linenos">1373</span></a>            <span class="n">F2Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">]</span>
</span><span id="Data_Process-1374"><a href="#Data_Process-1374"><span class="linenos">1374</span></a>
</span><span id="Data_Process-1375"><a href="#Data_Process-1375"><span class="linenos">1375</span></a>        <span class="n">F1Frame_chunk</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">newnames</span>
</span><span id="Data_Process-1376"><a href="#Data_Process-1376"><span class="linenos">1376</span></a>        <span class="n">F2Frame_chunk</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">newnames</span>
</span><span id="Data_Process-1377"><a href="#Data_Process-1377"><span class="linenos">1377</span></a>        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span><span class="s1">&#39;_2&#39;</span><span class="p">)</span>
</span><span id="Data_Process-1378"><a href="#Data_Process-1378"><span class="linenos">1378</span></a>        <span class="n">mergedFrame</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">F1Frame_chunk</span><span class="p">,</span><span class="n">F2Frame_chunk</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="n">newnames</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="n">suffixes</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</span><span id="Data_Process-1379"><a href="#Data_Process-1379"><span class="linenos">1379</span></a>        <span class="k">for</span> <span class="n">nameit</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Data_Process-1380"><a href="#Data_Process-1380"><span class="linenos">1380</span></a>            <span class="k">for</span> <span class="n">labelit</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
</span><span id="Data_Process-1381"><a href="#Data_Process-1381"><span class="linenos">1381</span></a>                <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="n">nameit</span><span class="p">]</span><span class="o">+</span><span class="n">labelit</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Data_Process-1382"><a href="#Data_Process-1382"><span class="linenos">1382</span></a>                <span class="k">if</span> <span class="n">nameit</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Data_Process-1383"><a href="#Data_Process-1383"><span class="linenos">1383</span></a>                    <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="n">nameit</span><span class="p">]</span><span class="o">+</span><span class="n">labelit</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Data_Process-1384"><a href="#Data_Process-1384"><span class="linenos">1384</span></a>        <span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="Data_Process-1385"><a href="#Data_Process-1385"><span class="linenos">1385</span></a>            <span class="n">val</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Data_Process-1386"><a href="#Data_Process-1386"><span class="linenos">1386</span></a>            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span><span id="Data_Process-1387"><a href="#Data_Process-1387"><span class="linenos">1387</span></a>                <span class="n">val</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    
</span><span id="Data_Process-1388"><a href="#Data_Process-1388"><span class="linenos">1388</span></a>            <span class="k">return</span> <span class="n">val</span>
</span><span id="Data_Process-1389"><a href="#Data_Process-1389"><span class="linenos">1389</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#assigns AA sequence to clones, creates duplicates</span>
</span><span id="Data_Process-1390"><a href="#Data_Process-1390"><span class="linenos">1390</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#removes duplicates</span>
</span><span id="Data_Process-1391"><a href="#Data_Process-1391"><span class="linenos">1391</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Data_Process-1392"><a href="#Data_Process-1392"><span class="linenos">1392</span></a>        <span class="n">mergedFrame</span><span class="o">=</span><span class="n">mergedFrame</span><span class="p">[[</span><span class="n">newname</span><span class="o">+</span><span class="n">suffix</span> <span class="k">for</span> <span class="n">newname</span> <span class="ow">in</span> <span class="n">newnames</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">newnames</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
</span><span id="Data_Process-1393"><a href="#Data_Process-1393"><span class="linenos">1393</span></a>        <span class="n">filterout</span><span class="o">=</span><span class="p">((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">&lt;</span><span class="n">mincount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">&lt;</span><span class="n">mincount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="c1">#has effect only if mincount&gt;0</span>
</span><span id="Data_Process-1394"><a href="#Data_Process-1394"><span class="linenos">1394</span></a>        <span class="n">number_clones</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mergedFrame</span><span class="p">)</span>
</span><span id="Data_Process-1395"><a href="#Data_Process-1395"><span class="linenos">1395</span></a>        <span class="k">return</span> <span class="n">number_clones</span><span class="p">,</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">&lt;=</span><span class="n">maxcount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">&lt;=</span><span class="n">maxcount</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filterout</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><h2 id="todo-in-the-future-merge-this-class-with-other-classes">TODO in the future, merge this class with other classes.</h2>

<p>A class used to represent longitudinal RepSeq data and pre-analysis of the longitudinal data associated with
one individual.</p>

<p>...</p>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>path</strong> (str):
the name of the path to get access to the data files to use for our analysis</li>
<li><strong>filename1</strong> (str):
the name of the file of the RepSeq sample which can be the first replicate when deciphering the experimental noise 
or the first time point RepSeq sample when analysing responding clones to a stimulus between two time points.</li>
<li><strong>filename2</strong> (str):
the name of the file of the RepSeq sample which can be the second replicate when deciphering the experimental noise 
or the second time point RepSeq sample when analysing responding clones to a stimulus between two time points.</li>
<li><strong>colnames1</strong> (str):
list of columns names of data-set - first sample</li>
<li><strong>colnames2</strong> (str):
list of columns names of data-set - second sample</li>
</ul>

<h6 id="methods">Methods</h6>

<p>import_data() : 
    to import and merged two RepSeq samples and build a unique data-frame with frequencies and abundances of all TCR clones present in the 
    union of both samples.</p>
</div>


                            <div id="Data_Process.__init__" class="classattr">
                                        <input id="Data_Process.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Data_Process</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">path</span>, </span><span class="param"><span class="n">filename1</span>, </span><span class="param"><span class="n">filename2</span>, </span><span class="param"><span class="n">colnames1</span>, </span><span class="param"><span class="n">colnames2</span></span>)</span>

                <label class="view-source-button" for="Data_Process.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Data_Process.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Data_Process.__init__-1329"><a href="#Data_Process.__init__-1329"><span class="linenos">1329</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename1</span><span class="p">,</span> <span class="n">filename2</span><span class="p">,</span> <span class="n">colnames1</span><span class="p">,</span>  <span class="n">colnames2</span><span class="p">):</span>
</span><span id="Data_Process.__init__-1330"><a href="#Data_Process.__init__-1330"><span class="linenos">1330</span></a>
</span><span id="Data_Process.__init__-1331"><a href="#Data_Process.__init__-1331"><span class="linenos">1331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="Data_Process.__init__-1332"><a href="#Data_Process.__init__-1332"><span class="linenos">1332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span> <span class="o">=</span> <span class="n">filename1</span>
</span><span id="Data_Process.__init__-1333"><a href="#Data_Process.__init__-1333"><span class="linenos">1333</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span> <span class="o">=</span> <span class="n">filename2</span>
</span><span id="Data_Process.__init__-1334"><a href="#Data_Process.__init__-1334"><span class="linenos">1334</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span> <span class="o">=</span> <span class="n">colnames1</span>
</span><span id="Data_Process.__init__-1335"><a href="#Data_Process.__init__-1335"><span class="linenos">1335</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span> <span class="o">=</span> <span class="n">colnames2</span>
</span></pre></div>


    

                            </div>
                            <div id="Data_Process.import_data" class="classattr">
                                        <input id="Data_Process.import_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Data_Process.import_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Data_Process.import_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Data_Process.import_data-1338"><a href="#Data_Process.import_data-1338"><span class="linenos">1338</span></a>    <span class="k">def</span> <span class="nf">import_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Data_Process.import_data-1339"><a href="#Data_Process.import_data-1339"><span class="linenos">1339</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Data_Process.import_data-1340"><a href="#Data_Process.import_data-1340"><span class="linenos">1340</span></a><span class="sd">        TOFILL</span>
</span><span id="Data_Process.import_data-1341"><a href="#Data_Process.import_data-1341"><span class="linenos">1341</span></a><span class="sd">        </span>
</span><span id="Data_Process.import_data-1342"><a href="#Data_Process.import_data-1342"><span class="linenos">1342</span></a><span class="sd">        Parameters</span>
</span><span id="Data_Process.import_data-1343"><a href="#Data_Process.import_data-1343"><span class="linenos">1343</span></a><span class="sd">        ----------</span>
</span><span id="Data_Process.import_data-1344"><a href="#Data_Process.import_data-1344"><span class="linenos">1344</span></a><span class="sd">        NONE</span>
</span><span id="Data_Process.import_data-1345"><a href="#Data_Process.import_data-1345"><span class="linenos">1345</span></a>
</span><span id="Data_Process.import_data-1346"><a href="#Data_Process.import_data-1346"><span class="linenos">1346</span></a>
</span><span id="Data_Process.import_data-1347"><a href="#Data_Process.import_data-1347"><span class="linenos">1347</span></a><span class="sd">        Returns</span>
</span><span id="Data_Process.import_data-1348"><a href="#Data_Process.import_data-1348"><span class="linenos">1348</span></a><span class="sd">        -------</span>
</span><span id="Data_Process.import_data-1349"><a href="#Data_Process.import_data-1349"><span class="linenos">1349</span></a><span class="sd">        number_clones</span>
</span><span id="Data_Process.import_data-1350"><a href="#Data_Process.import_data-1350"><span class="linenos">1350</span></a><span class="sd">            numpy array, number of clones in the data frame which is the union of the two RepSeq used as entries of the function</span>
</span><span id="Data_Process.import_data-1351"><a href="#Data_Process.import_data-1351"><span class="linenos">1351</span></a>
</span><span id="Data_Process.import_data-1352"><a href="#Data_Process.import_data-1352"><span class="linenos">1352</span></a><span class="sd">        df</span>
</span><span id="Data_Process.import_data-1353"><a href="#Data_Process.import_data-1353"><span class="linenos">1353</span></a><span class="sd">            pandas data-frame which is the data-frame containing the informations labeled in colnames vector string</span>
</span><span id="Data_Process.import_data-1354"><a href="#Data_Process.import_data-1354"><span class="linenos">1354</span></a><span class="sd">            for both RepSeq samples taken as input.</span>
</span><span id="Data_Process.import_data-1355"><a href="#Data_Process.import_data-1355"><span class="linenos">1355</span></a>
</span><span id="Data_Process.import_data-1356"><a href="#Data_Process.import_data-1356"><span class="linenos">1356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Data_Process.import_data-1357"><a href="#Data_Process.import_data-1357"><span class="linenos">1357</span></a>
</span><span id="Data_Process.import_data-1358"><a href="#Data_Process.import_data-1358"><span class="linenos">1358</span></a>        <span class="n">mincount</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Data_Process.import_data-1359"><a href="#Data_Process.import_data-1359"><span class="linenos">1359</span></a>        <span class="n">maxcount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="Data_Process.import_data-1360"><a href="#Data_Process.import_data-1360"><span class="linenos">1360</span></a>        
</span><span id="Data_Process.import_data-1361"><a href="#Data_Process.import_data-1361"><span class="linenos">1361</span></a>        <span class="n">headerline</span><span class="o">=</span><span class="mi">0</span> <span class="c1">#line number of headerline</span>
</span><span id="Data_Process.import_data-1362"><a href="#Data_Process.import_data-1362"><span class="linenos">1362</span></a>        <span class="n">newnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Clone_fraction&#39;</span><span class="p">,</span><span class="s1">&#39;Clone_count&#39;</span><span class="p">,</span><span class="s1">&#39;ntCDR3&#39;</span><span class="p">,</span><span class="s1">&#39;AACDR3&#39;</span><span class="p">]</span>   
</span><span id="Data_Process.import_data-1363"><a href="#Data_Process.import_data-1363"><span class="linenos">1363</span></a>
</span><span id="Data_Process.import_data-1364"><a href="#Data_Process.import_data-1364"><span class="linenos">1364</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span><span class="p">:</span>
</span><span id="Data_Process.import_data-1365"><a href="#Data_Process.import_data-1365"><span class="linenos">1365</span></a>            <span class="n">F1Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">]</span>
</span><span id="Data_Process.import_data-1366"><a href="#Data_Process.import_data-1366"><span class="linenos">1366</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Data_Process.import_data-1367"><a href="#Data_Process.import_data-1367"><span class="linenos">1367</span></a>            <span class="n">F1Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename1</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames1</span><span class="p">]</span>
</span><span id="Data_Process.import_data-1368"><a href="#Data_Process.import_data-1368"><span class="linenos">1368</span></a>
</span><span id="Data_Process.import_data-1369"><a href="#Data_Process.import_data-1369"><span class="linenos">1369</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;gz&#39;</span><span class="p">:</span>
</span><span id="Data_Process.import_data-1370"><a href="#Data_Process.import_data-1370"><span class="linenos">1370</span></a>            <span class="n">F2Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">,</span> <span class="n">compression</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">]</span>
</span><span id="Data_Process.import_data-1371"><a href="#Data_Process.import_data-1371"><span class="linenos">1371</span></a>
</span><span id="Data_Process.import_data-1372"><a href="#Data_Process.import_data-1372"><span class="linenos">1372</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Data_Process.import_data-1373"><a href="#Data_Process.import_data-1373"><span class="linenos">1373</span></a>            <span class="n">F2Frame_chunk</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename2</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">headerline</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">colnames2</span><span class="p">]</span>
</span><span id="Data_Process.import_data-1374"><a href="#Data_Process.import_data-1374"><span class="linenos">1374</span></a>
</span><span id="Data_Process.import_data-1375"><a href="#Data_Process.import_data-1375"><span class="linenos">1375</span></a>        <span class="n">F1Frame_chunk</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">newnames</span>
</span><span id="Data_Process.import_data-1376"><a href="#Data_Process.import_data-1376"><span class="linenos">1376</span></a>        <span class="n">F2Frame_chunk</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">newnames</span>
</span><span id="Data_Process.import_data-1377"><a href="#Data_Process.import_data-1377"><span class="linenos">1377</span></a>        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span><span class="s1">&#39;_2&#39;</span><span class="p">)</span>
</span><span id="Data_Process.import_data-1378"><a href="#Data_Process.import_data-1378"><span class="linenos">1378</span></a>        <span class="n">mergedFrame</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">F1Frame_chunk</span><span class="p">,</span><span class="n">F2Frame_chunk</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="n">newnames</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="n">suffixes</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
</span><span id="Data_Process.import_data-1379"><a href="#Data_Process.import_data-1379"><span class="linenos">1379</span></a>        <span class="k">for</span> <span class="n">nameit</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="Data_Process.import_data-1380"><a href="#Data_Process.import_data-1380"><span class="linenos">1380</span></a>            <span class="k">for</span> <span class="n">labelit</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
</span><span id="Data_Process.import_data-1381"><a href="#Data_Process.import_data-1381"><span class="linenos">1381</span></a>                <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="n">nameit</span><span class="p">]</span><span class="o">+</span><span class="n">labelit</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Data_Process.import_data-1382"><a href="#Data_Process.import_data-1382"><span class="linenos">1382</span></a>                <span class="k">if</span> <span class="n">nameit</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Data_Process.import_data-1383"><a href="#Data_Process.import_data-1383"><span class="linenos">1383</span></a>                    <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="n">nameit</span><span class="p">]</span><span class="o">+</span><span class="n">labelit</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Data_Process.import_data-1384"><a href="#Data_Process.import_data-1384"><span class="linenos">1384</span></a>        <span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="Data_Process.import_data-1385"><a href="#Data_Process.import_data-1385"><span class="linenos">1385</span></a>            <span class="n">val</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Data_Process.import_data-1386"><a href="#Data_Process.import_data-1386"><span class="linenos">1386</span></a>            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
</span><span id="Data_Process.import_data-1387"><a href="#Data_Process.import_data-1387"><span class="linenos">1387</span></a>                <span class="n">val</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    
</span><span id="Data_Process.import_data-1388"><a href="#Data_Process.import_data-1388"><span class="linenos">1388</span></a>            <span class="k">return</span> <span class="n">val</span>
</span><span id="Data_Process.import_data-1389"><a href="#Data_Process.import_data-1389"><span class="linenos">1389</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#assigns AA sequence to clones, creates duplicates</span>
</span><span id="Data_Process.import_data-1390"><a href="#Data_Process.import_data-1390"><span class="linenos">1390</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#removes duplicates</span>
</span><span id="Data_Process.import_data-1391"><a href="#Data_Process.import_data-1391"><span class="linenos">1391</span></a>        <span class="n">mergedFrame</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]},</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Data_Process.import_data-1392"><a href="#Data_Process.import_data-1392"><span class="linenos">1392</span></a>        <span class="n">mergedFrame</span><span class="o">=</span><span class="n">mergedFrame</span><span class="p">[[</span><span class="n">newname</span><span class="o">+</span><span class="n">suffix</span> <span class="k">for</span> <span class="n">newname</span> <span class="ow">in</span> <span class="n">newnames</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">newnames</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">newnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
</span><span id="Data_Process.import_data-1393"><a href="#Data_Process.import_data-1393"><span class="linenos">1393</span></a>        <span class="n">filterout</span><span class="o">=</span><span class="p">((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">&lt;</span><span class="n">mincount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">&lt;</span><span class="n">mincount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="c1">#has effect only if mincount&gt;0</span>
</span><span id="Data_Process.import_data-1394"><a href="#Data_Process.import_data-1394"><span class="linenos">1394</span></a>        <span class="n">number_clones</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mergedFrame</span><span class="p">)</span>
</span><span id="Data_Process.import_data-1395"><a href="#Data_Process.import_data-1395"><span class="linenos">1395</span></a>        <span class="k">return</span> <span class="n">number_clones</span><span class="p">,</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="o">&lt;=</span><span class="n">maxcount</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mergedFrame</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="o">&lt;=</span><span class="n">maxcount</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">filterout</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>TOFILL</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>NONE</strong></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>number_clones</strong>: numpy array, number of clones in the data frame which is the union of the two RepSeq used as entries of the function</li>
<li><strong>df</strong>: pandas data-frame which is the data-frame containing the informations labeled in colnames vector string
for both RepSeq samples taken as input.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="Noise_Model">
                            <input id="Noise_Model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Noise_Model</span>:

                <label class="view-source-button" for="Noise_Model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Noise_Model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Noise_Model-1403"><a href="#Noise_Model-1403"><span class="linenos">1403</span></a><span class="k">class</span> <span class="nc">Noise_Model</span><span class="p">():</span>
</span><span id="Noise_Model-1404"><a href="#Noise_Model-1404"><span class="linenos">1404</span></a>
</span><span id="Noise_Model-1405"><a href="#Noise_Model-1405"><span class="linenos">1405</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model-1406"><a href="#Noise_Model-1406"><span class="linenos">1406</span></a><span class="sd">    A class used to build an object associated to methods in order to learn the experimental noise from same day </span>
</span><span id="Noise_Model-1407"><a href="#Noise_Model-1407"><span class="linenos">1407</span></a><span class="sd">    biological RepSeq samples.</span>
</span><span id="Noise_Model-1408"><a href="#Noise_Model-1408"><span class="linenos">1408</span></a>
</span><span id="Noise_Model-1409"><a href="#Noise_Model-1409"><span class="linenos">1409</span></a><span class="sd">    ...</span>
</span><span id="Noise_Model-1410"><a href="#Noise_Model-1410"><span class="linenos">1410</span></a>
</span><span id="Noise_Model-1411"><a href="#Noise_Model-1411"><span class="linenos">1411</span></a><span class="sd">    Methods</span>
</span><span id="Noise_Model-1412"><a href="#Noise_Model-1412"><span class="linenos">1412</span></a><span class="sd">    -------</span>
</span><span id="Noise_Model-1413"><a href="#Noise_Model-1413"><span class="linenos">1413</span></a>
</span><span id="Noise_Model-1414"><a href="#Noise_Model-1414"><span class="linenos">1414</span></a><span class="sd">    get_sparserep(df) :</span>
</span><span id="Noise_Model-1415"><a href="#Noise_Model-1415"><span class="linenos">1415</span></a><span class="sd">        get sparse representation of the abundances / frequencies of the TCR clones present in both RepSeq samples of interest.</span>
</span><span id="Noise_Model-1416"><a href="#Noise_Model-1416"><span class="linenos">1416</span></a><span class="sd">        this changes the data input to fasten the algorithm</span>
</span><span id="Noise_Model-1417"><a href="#Noise_Model-1417"><span class="linenos">1417</span></a>
</span><span id="Noise_Model-1418"><a href="#Noise_Model-1418"><span class="linenos">1418</span></a><span class="sd">    learn_null_model(df, noise_model, init_paras,  output_dir = None, filename = None, display_loss_function = False) :</span>
</span><span id="Noise_Model-1419"><a href="#Noise_Model-1419"><span class="linenos">1419</span></a><span class="sd">        function to optimize the likelihood associated to the experimental noise model and get the associated parameters.</span>
</span><span id="Noise_Model-1420"><a href="#Noise_Model-1420"><span class="linenos">1420</span></a>
</span><span id="Noise_Model-1421"><a href="#Noise_Model-1421"><span class="linenos">1421</span></a><span class="sd">    diversity_estimate(df, paras, noise_model) :</span>
</span><span id="Noise_Model-1422"><a href="#Noise_Model-1422"><span class="linenos">1422</span></a><span class="sd">        function to get the estimation of diversity from the noise model information.</span>
</span><span id="Noise_Model-1423"><a href="#Noise_Model-1423"><span class="linenos">1423</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Noise_Model-1424"><a href="#Noise_Model-1424"><span class="linenos">1424</span></a>
</span><span id="Noise_Model-1425"><a href="#Noise_Model-1425"><span class="linenos">1425</span></a>
</span><span id="Noise_Model-1426"><a href="#Noise_Model-1426"><span class="linenos">1426</span></a>    <span class="k">def</span> <span class="nf">get_sparserep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span> 
</span><span id="Noise_Model-1427"><a href="#Noise_Model-1427"><span class="linenos">1427</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model-1428"><a href="#Noise_Model-1428"><span class="linenos">1428</span></a><span class="sd">        Tranforms {(n1,n2)} data stored in pandas dataframe to a sparse 1D representation.</span>
</span><span id="Noise_Model-1429"><a href="#Noise_Model-1429"><span class="linenos">1429</span></a><span class="sd">        unicountvals_1(2) are the unique values of n1(2).</span>
</span><span id="Noise_Model-1430"><a href="#Noise_Model-1430"><span class="linenos">1430</span></a><span class="sd">        sparse_rep_counts gives the counts of unique pairs.</span>
</span><span id="Noise_Model-1431"><a href="#Noise_Model-1431"><span class="linenos">1431</span></a><span class="sd">        ndn1(2) is the index of unicountvals_1(2) giving the value of n1(2) in that unique pair.</span>
</span><span id="Noise_Model-1432"><a href="#Noise_Model-1432"><span class="linenos">1432</span></a><span class="sd">        len(indn1)=len(indn2)=len(sparse_rep_counts)</span>
</span><span id="Noise_Model-1433"><a href="#Noise_Model-1433"><span class="linenos">1433</span></a>
</span><span id="Noise_Model-1434"><a href="#Noise_Model-1434"><span class="linenos">1434</span></a>
</span><span id="Noise_Model-1435"><a href="#Noise_Model-1435"><span class="linenos">1435</span></a><span class="sd">        Parameters</span>
</span><span id="Noise_Model-1436"><a href="#Noise_Model-1436"><span class="linenos">1436</span></a><span class="sd">        ----------</span>
</span><span id="Noise_Model-1437"><a href="#Noise_Model-1437"><span class="linenos">1437</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="Noise_Model-1438"><a href="#Noise_Model-1438"><span class="linenos">1438</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="Noise_Model-1439"><a href="#Noise_Model-1439"><span class="linenos">1439</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two replicates RepSeq samples</span>
</span><span id="Noise_Model-1440"><a href="#Noise_Model-1440"><span class="linenos">1440</span></a><span class="sd">            associated to their clone frequencies and clone abundances in the first and second replicate.</span>
</span><span id="Noise_Model-1441"><a href="#Noise_Model-1441"><span class="linenos">1441</span></a>
</span><span id="Noise_Model-1442"><a href="#Noise_Model-1442"><span class="linenos">1442</span></a>
</span><span id="Noise_Model-1443"><a href="#Noise_Model-1443"><span class="linenos">1443</span></a><span class="sd">        Returns</span>
</span><span id="Noise_Model-1444"><a href="#Noise_Model-1444"><span class="linenos">1444</span></a><span class="sd">        -------</span>
</span><span id="Noise_Model-1445"><a href="#Noise_Model-1445"><span class="linenos">1445</span></a><span class="sd">        indn1</span>
</span><span id="Noise_Model-1446"><a href="#Noise_Model-1446"><span class="linenos">1446</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_1</span>
</span><span id="Noise_Model-1447"><a href="#Noise_Model-1447"><span class="linenos">1447</span></a>
</span><span id="Noise_Model-1448"><a href="#Noise_Model-1448"><span class="linenos">1448</span></a><span class="sd">        indn2</span>
</span><span id="Noise_Model-1449"><a href="#Noise_Model-1449"><span class="linenos">1449</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_2</span>
</span><span id="Noise_Model-1450"><a href="#Noise_Model-1450"><span class="linenos">1450</span></a>
</span><span id="Noise_Model-1451"><a href="#Noise_Model-1451"><span class="linenos">1451</span></a><span class="sd">        sparse_rep_counts</span>
</span><span id="Noise_Model-1452"><a href="#Noise_Model-1452"><span class="linenos">1452</span></a><span class="sd">            numpy array, # of clones having the read counts pair {(n1,n2)} </span>
</span><span id="Noise_Model-1453"><a href="#Noise_Model-1453"><span class="linenos">1453</span></a>
</span><span id="Noise_Model-1454"><a href="#Noise_Model-1454"><span class="linenos">1454</span></a><span class="sd">        unicountvals_1</span>
</span><span id="Noise_Model-1455"><a href="#Noise_Model-1455"><span class="linenos">1455</span></a><span class="sd">            numpy array list of unique counts values present in the first sample in df[clone_count_1]</span>
</span><span id="Noise_Model-1456"><a href="#Noise_Model-1456"><span class="linenos">1456</span></a>
</span><span id="Noise_Model-1457"><a href="#Noise_Model-1457"><span class="linenos">1457</span></a><span class="sd">        unicountvals_2</span>
</span><span id="Noise_Model-1458"><a href="#Noise_Model-1458"><span class="linenos">1458</span></a><span class="sd">            numpy array list of unique counts values present in the second sample in df[clone_count_2]</span>
</span><span id="Noise_Model-1459"><a href="#Noise_Model-1459"><span class="linenos">1459</span></a>
</span><span id="Noise_Model-1460"><a href="#Noise_Model-1460"><span class="linenos">1460</span></a><span class="sd">        Nreads1</span>
</span><span id="Noise_Model-1461"><a href="#Noise_Model-1461"><span class="linenos">1461</span></a><span class="sd">            float, total number of counts/reads in the first sample referred in df by &quot;_1&quot;</span>
</span><span id="Noise_Model-1462"><a href="#Noise_Model-1462"><span class="linenos">1462</span></a>
</span><span id="Noise_Model-1463"><a href="#Noise_Model-1463"><span class="linenos">1463</span></a><span class="sd">        Nreads2</span>
</span><span id="Noise_Model-1464"><a href="#Noise_Model-1464"><span class="linenos">1464</span></a><span class="sd">            float, total number of counts/reads in the second sample referred in df by &quot;_2&quot;</span>
</span><span id="Noise_Model-1465"><a href="#Noise_Model-1465"><span class="linenos">1465</span></a>
</span><span id="Noise_Model-1466"><a href="#Noise_Model-1466"><span class="linenos">1466</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Noise_Model-1467"><a href="#Noise_Model-1467"><span class="linenos">1467</span></a>        
</span><span id="Noise_Model-1468"><a href="#Noise_Model-1468"><span class="linenos">1468</span></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]]</span>
</span><span id="Noise_Model-1469"><a href="#Noise_Model-1469"><span class="linenos">1469</span></a>        <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;paircount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># gives a weight of 1 to each observed clone</span>
</span><span id="Noise_Model-1470"><a href="#Noise_Model-1470"><span class="linenos">1470</span></a>
</span><span id="Noise_Model-1471"><a href="#Noise_Model-1471"><span class="linenos">1471</span></a>        <span class="n">clone_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Noise_Model-1472"><a href="#Noise_Model-1472"><span class="linenos">1472</span></a>        <span class="n">sparse_rep_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clone_counts</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Noise_Model-1473"><a href="#Noise_Model-1473"><span class="linenos">1473</span></a>        <span class="n">clonecountpair_vals</span> <span class="o">=</span> <span class="n">clone_counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="Noise_Model-1474"><a href="#Noise_Model-1474"><span class="linenos">1474</span></a>        <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Noise_Model-1475"><a href="#Noise_Model-1475"><span class="linenos">1475</span></a>        <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Noise_Model-1476"><a href="#Noise_Model-1476"><span class="linenos">1476</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="Noise_Model-1477"><a href="#Noise_Model-1477"><span class="linenos">1477</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="Noise_Model-1478"><a href="#Noise_Model-1478"><span class="linenos">1478</span></a>
</span><span id="Noise_Model-1479"><a href="#Noise_Model-1479"><span class="linenos">1479</span></a>        <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Noise_Model-1480"><a href="#Noise_Model-1480"><span class="linenos">1480</span></a>        <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn2</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Noise_Model-1481"><a href="#Noise_Model-1481"><span class="linenos">1481</span></a>
</span><span id="Noise_Model-1482"><a href="#Noise_Model-1482"><span class="linenos">1482</span></a>        <span class="k">return</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span>
</span><span id="Noise_Model-1483"><a href="#Noise_Model-1483"><span class="linenos">1483</span></a>
</span><span id="Noise_Model-1484"><a href="#Noise_Model-1484"><span class="linenos">1484</span></a>
</span><span id="Noise_Model-1485"><a href="#Noise_Model-1485"><span class="linenos">1485</span></a>
</span><span id="Noise_Model-1486"><a href="#Noise_Model-1486"><span class="linenos">1486</span></a>    <span class="k">def</span> <span class="nf">_NegBinPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">mvec</span><span class="p">):</span> 
</span><span id="Noise_Model-1487"><a href="#Noise_Model-1487"><span class="linenos">1487</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Noise_Model-1488"><a href="#Noise_Model-1488"><span class="linenos">1488</span></a><span class="sd">        Same as NegBinParMtr, but for m and v being scalars.</span>
</span><span id="Noise_Model-1489"><a href="#Noise_Model-1489"><span class="linenos">1489</span></a><span class="sd">        Assumes m&gt;0.</span>
</span><span id="Noise_Model-1490"><a href="#Noise_Model-1490"><span class="linenos">1490</span></a><span class="sd">        Output is (len(mvec),) array</span>
</span><span id="Noise_Model-1491"><a href="#Noise_Model-1491"><span class="linenos">1491</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Noise_Model-1492"><a href="#Noise_Model-1492"><span class="linenos">1492</span></a>        <span class="n">mmax</span><span class="o">=</span><span class="n">mvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Noise_Model-1493"><a href="#Noise_Model-1493"><span class="linenos">1493</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="Noise_Model-1494"><a href="#Noise_Model-1494"><span class="linenos">1494</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">p</span>
</span><span id="Noise_Model-1495"><a href="#Noise_Model-1495"><span class="linenos">1495</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>   
</span><span id="Noise_Model-1496"><a href="#Noise_Model-1496"><span class="linenos">1496</span></a>        <span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="c1">#vectorization won&#39;t help unfortuneately here since log needs to be over array</span>
</span><span id="Noise_Model-1497"><a href="#Noise_Model-1497"><span class="linenos">1497</span></a>        <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="p">)</span>
</span><span id="Noise_Model-1498"><a href="#Noise_Model-1498"><span class="linenos">1498</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">NBvec</span><span class="p">)[</span><span class="n">mvec</span><span class="p">])</span> <span class="c1">#save a bit here</span>
</span><span id="Noise_Model-1499"><a href="#Noise_Model-1499"><span class="linenos">1499</span></a>        <span class="k">return</span> <span class="n">NBvec</span>
</span><span id="Noise_Model-1500"><a href="#Noise_Model-1500"><span class="linenos">1500</span></a>
</span><span id="Noise_Model-1501"><a href="#Noise_Model-1501"><span class="linenos">1501</span></a>    <span class="k">def</span> <span class="nf">_NegBinParMtr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">nvec</span><span class="p">):</span> <span class="c1">#speed up only insofar as the log and exp are called once on array instead of multiple times on rows</span>
</span><span id="Noise_Model-1502"><a href="#Noise_Model-1502"><span class="linenos">1502</span></a>        <span class="sd">&#39;&#39;&#39; </span>
</span><span id="Noise_Model-1503"><a href="#Noise_Model-1503"><span class="linenos">1503</span></a><span class="sd">        computes NegBin probabilities over the ordered (but possibly discontiguous) vector (nvec) </span>
</span><span id="Noise_Model-1504"><a href="#Noise_Model-1504"><span class="linenos">1504</span></a><span class="sd">        for mean/variance combinations given by the mean (m) and variance (v) vectors. </span>
</span><span id="Noise_Model-1505"><a href="#Noise_Model-1505"><span class="linenos">1505</span></a><span class="sd">        Note that m&lt;v for negative binomial.</span>
</span><span id="Noise_Model-1506"><a href="#Noise_Model-1506"><span class="linenos">1506</span></a><span class="sd">        Output is (len(m),len(nvec)) array</span>
</span><span id="Noise_Model-1507"><a href="#Noise_Model-1507"><span class="linenos">1507</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Noise_Model-1508"><a href="#Noise_Model-1508"><span class="linenos">1508</span></a>        <span class="n">nmax</span><span class="o">=</span><span class="n">nvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Noise_Model-1509"><a href="#Noise_Model-1509"><span class="linenos">1509</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="Noise_Model-1510"><a href="#Noise_Model-1510"><span class="linenos">1510</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">p</span>
</span><span id="Noise_Model-1511"><a href="#Noise_Model-1511"><span class="linenos">1511</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Noise_Model-1512"><a href="#Noise_Model-1512"><span class="linenos">1512</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">NBvec</span><span class="o">+</span><span class="n">r</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">/</span><span class="n">NBvec</span><span class="p">))</span>
</span><span id="Noise_Model-1513"><a href="#Noise_Model-1513"><span class="linenos">1513</span></a>        <span class="n">NBvec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="p">)</span> <span class="c1">#handle NBvec[0]=0, treated specially when m[0]=0, see below</span>
</span><span id="Noise_Model-1514"><a href="#Noise_Model-1514"><span class="linenos">1514</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">NBvec</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#save a bit here</span>
</span><span id="Noise_Model-1515"><a href="#Noise_Model-1515"><span class="linenos">1515</span></a>        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Noise_Model-1516"><a href="#Noise_Model-1516"><span class="linenos">1516</span></a>            <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">0.</span>
</span><span id="Noise_Model-1517"><a href="#Noise_Model-1517"><span class="linenos">1517</span></a>            <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span>
</span><span id="Noise_Model-1518"><a href="#Noise_Model-1518"><span class="linenos">1518</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">NBvec</span><span class="p">[:,</span><span class="n">nvec</span><span class="p">]</span>
</span><span id="Noise_Model-1519"><a href="#Noise_Model-1519"><span class="linenos">1519</span></a>        <span class="k">return</span> <span class="n">NBvec</span>
</span><span id="Noise_Model-1520"><a href="#Noise_Model-1520"><span class="linenos">1520</span></a>
</span><span id="Noise_Model-1521"><a href="#Noise_Model-1521"><span class="linenos">1521</span></a>    <span class="k">def</span> <span class="nf">_PoisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Mvec</span><span class="p">,</span><span class="n">unicountvals</span><span class="p">):</span>
</span><span id="Noise_Model-1522"><a href="#Noise_Model-1522"><span class="linenos">1522</span></a>        <span class="c1">#assert Mvec[0]==0, &quot;first element needs to be zero&quot;</span>
</span><span id="Noise_Model-1523"><a href="#Noise_Model-1523"><span class="linenos">1523</span></a>        <span class="n">nmax</span><span class="o">=</span><span class="n">unicountvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Noise_Model-1524"><a href="#Noise_Model-1524"><span class="linenos">1524</span></a>        <span class="n">nlen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unicountvals</span><span class="p">)</span>
</span><span id="Noise_Model-1525"><a href="#Noise_Model-1525"><span class="linenos">1525</span></a>        <span class="n">mlen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">Mvec</span><span class="p">)</span>
</span><span id="Noise_Model-1526"><a href="#Noise_Model-1526"><span class="linenos">1526</span></a>        <span class="n">Nvec</span><span class="o">=</span><span class="n">unicountvals</span>
</span><span id="Noise_Model-1527"><a href="#Noise_Model-1527"><span class="linenos">1527</span></a>        <span class="n">logNvec</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">))),</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.</span><span class="p">)[</span><span class="n">unicountvals</span><span class="p">]</span> <span class="c1">#avoid n=0 nans  </span>
</span><span id="Noise_Model-1528"><a href="#Noise_Model-1528"><span class="linenos">1528</span></a>        <span class="n">Nmtr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Nvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Mvec</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">+</span><span class="n">logNvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">-</span><span class="n">Mvec</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="c1"># np.log(Mvec) throws warning: since log(0)=-inf</span>
</span><span id="Noise_Model-1529"><a href="#Noise_Model-1529"><span class="linenos">1529</span></a>        <span class="k">if</span> <span class="n">Mvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Noise_Model-1530"><a href="#Noise_Model-1530"><span class="linenos">1530</span></a>            <span class="n">Nmtr</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlen</span><span class="p">,))</span> <span class="c1">#when m=0, n=0, and so get rid of nans from log(0)</span>
</span><span id="Noise_Model-1531"><a href="#Noise_Model-1531"><span class="linenos">1531</span></a>            <span class="n">Nmtr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span> <span class="c1">#handled belowacq_model_type</span>
</span><span id="Noise_Model-1532"><a href="#Noise_Model-1532"><span class="linenos">1532</span></a>        <span class="k">if</span> <span class="n">unicountvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#if n=0 included get rid of nans from log(0)</span>
</span><span id="Noise_Model-1533"><a href="#Noise_Model-1533"><span class="linenos">1533</span></a>            <span class="n">Nmtr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Mvec</span><span class="p">)</span>
</span><span id="Noise_Model-1534"><a href="#Noise_Model-1534"><span class="linenos">1534</span></a>        <span class="k">return</span> <span class="n">Nmtr</span>
</span><span id="Noise_Model-1535"><a href="#Noise_Model-1535"><span class="linenos">1535</span></a>
</span><span id="Noise_Model-1536"><a href="#Noise_Model-1536"><span class="linenos">1536</span></a>    <span class="k">def</span> <span class="nf">_get_rhof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alpha_rho</span><span class="p">,</span> <span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">):</span>
</span><span id="Noise_Model-1537"><a href="#Noise_Model-1537"><span class="linenos">1537</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Noise_Model-1538"><a href="#Noise_Model-1538"><span class="linenos">1538</span></a><span class="sd">        generates power law (power is alpha_rho) clone frequency distribution over </span>
</span><span id="Noise_Model-1539"><a href="#Noise_Model-1539"><span class="linenos">1539</span></a><span class="sd">        freq_nbins discrete logarithmically spaced frequences between fmin and 1 of dtype freq_dtype</span>
</span><span id="Noise_Model-1540"><a href="#Noise_Model-1540"><span class="linenos">1540</span></a><span class="sd">        Outputs log probabilities obtained at log frequencies&#39;&#39;&#39;</span>
</span><span id="Noise_Model-1541"><a href="#Noise_Model-1541"><span class="linenos">1541</span></a>        <span class="n">fmax</span><span class="o">=</span><span class="mf">1e0</span>
</span><span id="Noise_Model-1542"><a href="#Noise_Model-1542"><span class="linenos">1542</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span> <span class="n">nfbins</span><span class="p">)</span>
</span><span id="Noise_Model-1543"><a href="#Noise_Model-1543"><span class="linenos">1543</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">logfvec</span><span class="p">))</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  
</span><span id="Noise_Model-1544"><a href="#Noise_Model-1544"><span class="linenos">1544</span></a>        <span class="n">logrhovec</span><span class="o">=</span><span class="n">logfvec</span><span class="o">*</span><span class="n">alpha_rho</span>
</span><span id="Noise_Model-1545"><a href="#Noise_Model-1545"><span class="linenos">1545</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhovec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Noise_Model-1546"><a href="#Noise_Model-1546"><span class="linenos">1546</span></a>        <span class="n">normconst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="Noise_Model-1547"><a href="#Noise_Model-1547"><span class="linenos">1547</span></a>        <span class="n">logrhovec</span><span class="o">-=</span><span class="n">normconst</span> 
</span><span id="Noise_Model-1548"><a href="#Noise_Model-1548"><span class="linenos">1548</span></a>        <span class="k">return</span> <span class="n">logrhovec</span><span class="p">,</span><span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span>
</span><span id="Noise_Model-1549"><a href="#Noise_Model-1549"><span class="linenos">1549</span></a>
</span><span id="Noise_Model-1550"><a href="#Noise_Model-1550"><span class="linenos">1550</span></a>
</span><span id="Noise_Model-1551"><a href="#Noise_Model-1551"><span class="linenos">1551</span></a>    <span class="k">def</span> <span class="nf">_get_logPn_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unicounts</span><span class="p">,</span><span class="n">Nreads</span><span class="p">,</span><span class="n">logfvec</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">):</span>
</span><span id="Noise_Model-1552"><a href="#Noise_Model-1552"><span class="linenos">1552</span></a>
</span><span id="Noise_Model-1553"><a href="#Noise_Model-1553"><span class="linenos">1553</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model-1554"><a href="#Noise_Model-1554"><span class="linenos">1554</span></a><span class="sd">        tools to compute the likelihood of the noise model. It is not useful for the user.</span>
</span><span id="Noise_Model-1555"><a href="#Noise_Model-1555"><span class="linenos">1555</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Noise_Model-1556"><a href="#Noise_Model-1556"><span class="linenos">1556</span></a>
</span><span id="Noise_Model-1557"><a href="#Noise_Model-1557"><span class="linenos">1557</span></a>        <span class="c1"># Choice of the model:</span>
</span><span id="Noise_Model-1558"><a href="#Noise_Model-1558"><span class="linenos">1558</span></a>        
</span><span id="Noise_Model-1559"><a href="#Noise_Model-1559"><span class="linenos">1559</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model-1560"><a href="#Noise_Model-1560"><span class="linenos">1560</span></a>
</span><span id="Noise_Model-1561"><a href="#Noise_Model-1561"><span class="linenos">1561</span></a>            <span class="n">m_total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> 
</span><span id="Noise_Model-1562"><a href="#Noise_Model-1562"><span class="linenos">1562</span></a>            <span class="n">r_c</span><span class="o">=</span><span class="n">Nreads</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="Noise_Model-1563"><a href="#Noise_Model-1563"><span class="linenos">1563</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="Noise_Model-1564"><a href="#Noise_Model-1564"><span class="linenos">1564</span></a>
</span><span id="Noise_Model-1565"><a href="#Noise_Model-1565"><span class="linenos">1565</span></a>            <span class="n">beta_mv</span><span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Noise_Model-1566"><a href="#Noise_Model-1566"><span class="linenos">1566</span></a>            <span class="n">alpha_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Noise_Model-1567"><a href="#Noise_Model-1567"><span class="linenos">1567</span></a>            
</span><span id="Noise_Model-1568"><a href="#Noise_Model-1568"><span class="linenos">1568</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#for models that include cell counts</span>
</span><span id="Noise_Model-1569"><a href="#Noise_Model-1569"><span class="linenos">1569</span></a>            <span class="c1">#compute parametrized range (mean-sigma,mean+5*sigma) of m values (number of cells) conditioned on n values (reads) appearing in the data only </span>
</span><span id="Noise_Model-1570"><a href="#Noise_Model-1570"><span class="linenos">1570</span></a>            <span class="n">nsigma</span><span class="o">=</span><span class="mf">5.</span>
</span><span id="Noise_Model-1571"><a href="#Noise_Model-1571"><span class="linenos">1571</span></a>            <span class="n">nmin</span><span class="o">=</span><span class="mf">300.</span>
</span><span id="Noise_Model-1572"><a href="#Noise_Model-1572"><span class="linenos">1572</span></a>            <span class="c1">#for each n, get actual range of m to compute around n-dependent mean m</span>
</span><span id="Noise_Model-1573"><a href="#Noise_Model-1573"><span class="linenos">1573</span></a>            <span class="n">m_low</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Noise_Model-1574"><a href="#Noise_Model-1574"><span class="linenos">1574</span></a>            <span class="n">m_high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Noise_Model-1575"><a href="#Noise_Model-1575"><span class="linenos">1575</span></a>            <span class="k">for</span> <span class="n">nit</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unicounts</span><span class="p">):</span>
</span><span id="Noise_Model-1576"><a href="#Noise_Model-1576"><span class="linenos">1576</span></a>                <span class="n">mean_m</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">r_c</span>
</span><span id="Noise_Model-1577"><a href="#Noise_Model-1577"><span class="linenos">1577</span></a>                <span class="n">dev</span><span class="o">=</span><span class="n">nsigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_m</span><span class="p">)</span>
</span><span id="Noise_Model-1578"><a href="#Noise_Model-1578"><span class="linenos">1578</span></a>                <span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span> <span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mean_m</span><span class="o">-</span>  <span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">mean_m</span><span class="o">&gt;</span><span class="n">dev</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>                         
</span><span id="Noise_Model-1579"><a href="#Noise_Model-1579"><span class="linenos">1579</span></a>                <span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mean_m</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span>      <span class="n">n</span><span class="o">&gt;</span><span class="n">nmin</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">nmin</span><span class="o">/</span><span class="n">r_c</span><span class="p">)</span>
</span><span id="Noise_Model-1580"><a href="#Noise_Model-1580"><span class="linenos">1580</span></a>            <span class="n">m_cellmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">m_high</span><span class="p">)</span>
</span><span id="Noise_Model-1581"><a href="#Noise_Model-1581"><span class="linenos">1581</span></a>            <span class="c1">#across n, collect all in-range m</span>
</span><span id="Noise_Model-1582"><a href="#Noise_Model-1582"><span class="linenos">1582</span></a>            <span class="n">mvec_bool</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m_cellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1">#cheap bool</span>
</span><span id="Noise_Model-1583"><a href="#Noise_Model-1583"><span class="linenos">1583</span></a>            <span class="n">nvec</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">))</span>
</span><span id="Noise_Model-1584"><a href="#Noise_Model-1584"><span class="linenos">1584</span></a>            <span class="k">for</span> <span class="n">nit</span> <span class="ow">in</span> <span class="n">nvec</span><span class="p">:</span>
</span><span id="Noise_Model-1585"><a href="#Noise_Model-1585"><span class="linenos">1585</span></a>                <span class="n">mvec_bool</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>  <span class="c1">#mask vector</span>
</span><span id="Noise_Model-1586"><a href="#Noise_Model-1586"><span class="linenos">1586</span></a>            <span class="n">mvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_cellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">mvec_bool</span><span class="p">]</span>                
</span><span id="Noise_Model-1587"><a href="#Noise_Model-1587"><span class="linenos">1587</span></a>            <span class="c1">#transform to in-range index</span>
</span><span id="Noise_Model-1588"><a href="#Noise_Model-1588"><span class="linenos">1588</span></a>            <span class="k">for</span> <span class="n">nit</span> <span class="ow">in</span> <span class="n">nvec</span><span class="p">:</span>
</span><span id="Noise_Model-1589"><a href="#Noise_Model-1589"><span class="linenos">1589</span></a>                <span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">==</span><span class="n">mvec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Noise_Model-1590"><a href="#Noise_Model-1590"><span class="linenos">1590</span></a>                <span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">==</span><span class="n">mvec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Noise_Model-1591"><a href="#Noise_Model-1591"><span class="linenos">1591</span></a>
</span><span id="Noise_Model-1592"><a href="#Noise_Model-1592"><span class="linenos">1592</span></a>        <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">)))</span>
</span><span id="Noise_Model-1593"><a href="#Noise_Model-1593"><span class="linenos">1593</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Noise_Model-1594"><a href="#Noise_Model-1594"><span class="linenos">1594</span></a>
</span><span id="Noise_Model-1595"><a href="#Noise_Model-1595"><span class="linenos">1595</span></a>            <span class="n">mean_m</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1596"><a href="#Noise_Model-1596"><span class="linenos">1596</span></a>            <span class="n">var_m</span><span class="o">=</span><span class="n">mean_m</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_m</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Noise_Model-1597"><a href="#Noise_Model-1597"><span class="linenos">1597</span></a>            <span class="n">Poisvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PoisPar</span><span class="p">(</span><span class="n">mvec</span><span class="o">*</span><span class="n">r_c</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="Noise_Model-1598"><a href="#Noise_Model-1598"><span class="linenos">1598</span></a>            <span class="k">for</span> <span class="n">f_it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)):</span>
</span><span id="Noise_Model-1599"><a href="#Noise_Model-1599"><span class="linenos">1599</span></a>                <span class="n">NBvec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_NegBinPar</span><span class="p">(</span><span class="n">mean_m</span><span class="p">[</span><span class="n">f_it</span><span class="p">],</span><span class="n">var_m</span><span class="p">[</span><span class="n">f_it</span><span class="p">],</span><span class="n">mvec</span><span class="p">)</span>
</span><span id="Noise_Model-1600"><a href="#Noise_Model-1600"><span class="linenos">1600</span></a>                <span class="k">for</span> <span class="n">n_it</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unicounts</span><span class="p">):</span>
</span><span id="Noise_Model-1601"><a href="#Noise_Model-1601"><span class="linenos">1601</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">f_it</span><span class="p">,</span><span class="n">n_it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">NBvec</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">n_it</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">n_it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Poisvec</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">n_it</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">n_it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n_it</span><span class="p">])</span> 
</span><span id="Noise_Model-1602"><a href="#Noise_Model-1602"><span class="linenos">1602</span></a>        
</span><span id="Noise_Model-1603"><a href="#Noise_Model-1603"><span class="linenos">1603</span></a>        <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model-1604"><a href="#Noise_Model-1604"><span class="linenos">1604</span></a>
</span><span id="Noise_Model-1605"><a href="#Noise_Model-1605"><span class="linenos">1605</span></a>            <span class="n">mean_n</span><span class="o">=</span><span class="n">Nreads</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1606"><a href="#Noise_Model-1606"><span class="linenos">1606</span></a>            <span class="n">var_n</span><span class="o">=</span><span class="n">mean_n</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Noise_Model-1607"><a href="#Noise_Model-1607"><span class="linenos">1607</span></a>            <span class="n">Pn_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NegBinParMtr</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">var_n</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="Noise_Model-1608"><a href="#Noise_Model-1608"><span class="linenos">1608</span></a>        <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="Noise_Model-1609"><a href="#Noise_Model-1609"><span class="linenos">1609</span></a>
</span><span id="Noise_Model-1610"><a href="#Noise_Model-1610"><span class="linenos">1610</span></a>            <span class="n">mean_n</span><span class="o">=</span><span class="n">Nreads</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1611"><a href="#Noise_Model-1611"><span class="linenos">1611</span></a>            <span class="n">Pn_f</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PoisPar</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="Noise_Model-1612"><a href="#Noise_Model-1612"><span class="linenos">1612</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Noise_Model-1613"><a href="#Noise_Model-1613"><span class="linenos">1613</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1, or 2 only&#39;</span><span class="p">)</span>
</span><span id="Noise_Model-1614"><a href="#Noise_Model-1614"><span class="linenos">1614</span></a>
</span><span id="Noise_Model-1615"><a href="#Noise_Model-1615"><span class="linenos">1615</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn_f</span><span class="p">)</span>
</span><span id="Noise_Model-1616"><a href="#Noise_Model-1616"><span class="linenos">1616</span></a>
</span><span id="Noise_Model-1617"><a href="#Noise_Model-1617"><span class="linenos">1617</span></a>    <span class="c1">#-----------------------------Null-Model-optimization--------------------------</span>
</span><span id="Noise_Model-1618"><a href="#Noise_Model-1618"><span class="linenos">1618</span></a>        
</span><span id="Noise_Model-1619"><a href="#Noise_Model-1619"><span class="linenos">1619</span></a>    <span class="k">def</span> <span class="nf">_get_Pn1n2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">):</span>
</span><span id="Noise_Model-1620"><a href="#Noise_Model-1620"><span class="linenos">1620</span></a>
</span><span id="Noise_Model-1621"><a href="#Noise_Model-1621"><span class="linenos">1621</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model-1622"><a href="#Noise_Model-1622"><span class="linenos">1622</span></a><span class="sd">        Tool to compute likelihood of the noise model. It is not useful for the user.</span>
</span><span id="Noise_Model-1623"><a href="#Noise_Model-1623"><span class="linenos">1623</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Noise_Model-1624"><a href="#Noise_Model-1624"><span class="linenos">1624</span></a>
</span><span id="Noise_Model-1625"><a href="#Noise_Model-1625"><span class="linenos">1625</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="Noise_Model-1626"><a href="#Noise_Model-1626"><span class="linenos">1626</span></a>            
</span><span id="Noise_Model-1627"><a href="#Noise_Model-1627"><span class="linenos">1627</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span>
</span><span id="Noise_Model-1628"><a href="#Noise_Model-1628"><span class="linenos">1628</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="Noise_Model-1629"><a href="#Noise_Model-1629"><span class="linenos">1629</span></a>
</span><span id="Noise_Model-1630"><a href="#Noise_Model-1630"><span class="linenos">1630</span></a>        <span class="c1"># Parameters</span>
</span><span id="Noise_Model-1631"><a href="#Noise_Model-1631"><span class="linenos">1631</span></a>
</span><span id="Noise_Model-1632"><a href="#Noise_Model-1632"><span class="linenos">1632</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Noise_Model-1633"><a href="#Noise_Model-1633"><span class="linenos">1633</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Noise_Model-1634"><a href="#Noise_Model-1634"><span class="linenos">1634</span></a>
</span><span id="Noise_Model-1635"><a href="#Noise_Model-1635"><span class="linenos">1635</span></a>        <span class="c1"># </span>
</span><span id="Noise_Model-1636"><a href="#Noise_Model-1636"><span class="linenos">1636</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Noise_Model-1637"><a href="#Noise_Model-1637"><span class="linenos">1637</span></a>
</span><span id="Noise_Model-1638"><a href="#Noise_Model-1638"><span class="linenos">1638</span></a>        <span class="c1"># </span>
</span><span id="Noise_Model-1639"><a href="#Noise_Model-1639"><span class="linenos">1639</span></a>
</span><span id="Noise_Model-1640"><a href="#Noise_Model-1640"><span class="linenos">1640</span></a>        <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1641"><a href="#Noise_Model-1641"><span class="linenos">1641</span></a>
</span><span id="Noise_Model-1642"><a href="#Noise_Model-1642"><span class="linenos">1642</span></a>        <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Noise_Model-1643"><a href="#Noise_Model-1643"><span class="linenos">1643</span></a>        <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Noise_Model-1644"><a href="#Noise_Model-1644"><span class="linenos">1644</span></a>
</span><span id="Noise_Model-1645"><a href="#Noise_Model-1645"><span class="linenos">1645</span></a>        <span class="c1"># for the trapezoid integral methods</span>
</span><span id="Noise_Model-1646"><a href="#Noise_Model-1646"><span class="linenos">1646</span></a>
</span><span id="Noise_Model-1647"><a href="#Noise_Model-1647"><span class="linenos">1647</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="Noise_Model-1648"><a href="#Noise_Model-1648"><span class="linenos">1648</span></a>
</span><span id="Noise_Model-1649"><a href="#Noise_Model-1649"><span class="linenos">1649</span></a>        <span class="c1"># Compute P(0,0) for the normalization constraint</span>
</span><span id="Noise_Model-1650"><a href="#Noise_Model-1650"><span class="linenos">1650</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1651"><a href="#Noise_Model-1651"><span class="linenos">1651</span></a>        <span class="n">Pn0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Noise_Model-1652"><a href="#Noise_Model-1652"><span class="linenos">1652</span></a>
</span><span id="Noise_Model-1653"><a href="#Noise_Model-1653"><span class="linenos">1653</span></a>        <span class="c1">#print(&quot;computing P(n1,n2)&quot;)</span>
</span><span id="Noise_Model-1654"><a href="#Noise_Model-1654"><span class="linenos">1654</span></a>        <span class="n">Pn1n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))</span>  <span class="c1"># 1D representation</span>
</span><span id="Noise_Model-1655"><a href="#Noise_Model-1655"><span class="linenos">1655</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">)):</span>
</span><span id="Noise_Model-1656"><a href="#Noise_Model-1656"><span class="linenos">1656</span></a>            <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span> <span class="n">ind1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="n">ind2</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1657"><a href="#Noise_Model-1657"><span class="linenos">1657</span></a>            <span class="n">Pn1n2</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Noise_Model-1658"><a href="#Noise_Model-1658"><span class="linenos">1658</span></a>        <span class="n">Pn1n2</span> <span class="o">/=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">Pn0n0</span>  <span class="c1"># renormalize</span>
</span><span id="Noise_Model-1659"><a href="#Noise_Model-1659"><span class="linenos">1659</span></a>        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pn1n2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn1n2</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))</span>
</span><span id="Noise_Model-1660"><a href="#Noise_Model-1660"><span class="linenos">1660</span></a>
</span><span id="Noise_Model-1661"><a href="#Noise_Model-1661"><span class="linenos">1661</span></a>    
</span><span id="Noise_Model-1662"><a href="#Noise_Model-1662"><span class="linenos">1662</span></a>
</span><span id="Noise_Model-1663"><a href="#Noise_Model-1663"><span class="linenos">1663</span></a>
</span><span id="Noise_Model-1664"><a href="#Noise_Model-1664"><span class="linenos">1664</span></a>    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">nparas</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">):</span>
</span><span id="Noise_Model-1665"><a href="#Noise_Model-1665"><span class="linenos">1665</span></a>        <span class="sd">&#39;&#39;&#39;prints iteration info. called by scipy.minimize. Not useful for the user.&#39;&#39;&#39;</span>
</span><span id="Noise_Model-1666"><a href="#Noise_Model-1666"><span class="linenos">1666</span></a>
</span><span id="Noise_Model-1667"><a href="#Noise_Model-1667"><span class="linenos">1667</span></a>        <span class="k">global</span> <span class="n">curr_iter</span>
</span><span id="Noise_Model-1668"><a href="#Noise_Model-1668"><span class="linenos">1668</span></a>        <span class="c1">#curr_iter = 0</span>
</span><span id="Noise_Model-1669"><a href="#Noise_Model-1669"><span class="linenos">1669</span></a>        <span class="k">global</span> <span class="n">Loss_function</span> 
</span><span id="Noise_Model-1670"><a href="#Noise_Model-1670"><span class="linenos">1670</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0:d}</span><span class="s1"> &#39;</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;{&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:3.6f} &#39;</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">paras</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">curr_iter</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">paras</span><span class="p">))))</span>
</span><span id="Noise_Model-1671"><a href="#Noise_Model-1671"><span class="linenos">1671</span></a>        <span class="c1">#print (&#39;{&#39; + str(len(paras)+1) + &#39;:3.6f}&#39;.format( [self.get_Pn1n2(paras, sparse_rep, acq_model_type)]))</span>
</span><span id="Noise_Model-1672"><a href="#Noise_Model-1672"><span class="linenos">1672</span></a>        <span class="n">Loss_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pn1n2</span><span class="p">(</span><span class="n">paras</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">)</span>
</span><span id="Noise_Model-1673"><a href="#Noise_Model-1673"><span class="linenos">1673</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">Loss_function</span><span class="p">)</span>
</span><span id="Noise_Model-1674"><a href="#Noise_Model-1674"><span class="linenos">1674</span></a>        <span class="n">curr_iter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Noise_Model-1675"><a href="#Noise_Model-1675"><span class="linenos">1675</span></a>        
</span><span id="Noise_Model-1676"><a href="#Noise_Model-1676"><span class="linenos">1676</span></a>
</span><span id="Noise_Model-1677"><a href="#Noise_Model-1677"><span class="linenos">1677</span></a>
</span><span id="Noise_Model-1678"><a href="#Noise_Model-1678"><span class="linenos">1678</span></a>    <span class="c1"># Constraints for the Null-Model, no filtered </span>
</span><span id="Noise_Model-1679"><a href="#Noise_Model-1679"><span class="linenos">1679</span></a>    <span class="k">def</span> <span class="nf">_nullmodel_constr_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">constr_type</span><span class="p">):</span>
</span><span id="Noise_Model-1680"><a href="#Noise_Model-1680"><span class="linenos">1680</span></a>            
</span><span id="Noise_Model-1681"><a href="#Noise_Model-1681"><span class="linenos">1681</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Noise_Model-1682"><a href="#Noise_Model-1682"><span class="linenos">1682</span></a><span class="sd">        returns either or both of the two level-set functions: log&lt;f&gt;-log(1/N), with N=Nclones/(1-P(0,0)) and log(Z_f), with Z_f=N&lt;f&gt;_{n+n&#39;=0} + sum_i^Nclones &lt;f&gt;_{f|n,n&#39;}</span>
</span><span id="Noise_Model-1683"><a href="#Noise_Model-1683"><span class="linenos">1683</span></a><span class="sd">        not useful for the user</span>
</span><span id="Noise_Model-1684"><a href="#Noise_Model-1684"><span class="linenos">1684</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Noise_Model-1685"><a href="#Noise_Model-1685"><span class="linenos">1685</span></a>
</span><span id="Noise_Model-1686"><a href="#Noise_Model-1686"><span class="linenos">1686</span></a>        <span class="c1"># Choice of the model: </span>
</span><span id="Noise_Model-1687"><a href="#Noise_Model-1687"><span class="linenos">1687</span></a>
</span><span id="Noise_Model-1688"><a href="#Noise_Model-1688"><span class="linenos">1688</span></a>        <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="Noise_Model-1689"><a href="#Noise_Model-1689"><span class="linenos">1689</span></a>
</span><span id="Noise_Model-1690"><a href="#Noise_Model-1690"><span class="linenos">1690</span></a>        <span class="c1">#Variables that would be chosen in the future by the user </span>
</span><span id="Noise_Model-1691"><a href="#Noise_Model-1691"><span class="linenos">1691</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span>
</span><span id="Noise_Model-1692"><a href="#Noise_Model-1692"><span class="linenos">1692</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="Noise_Model-1693"><a href="#Noise_Model-1693"><span class="linenos">1693</span></a>
</span><span id="Noise_Model-1694"><a href="#Noise_Model-1694"><span class="linenos">1694</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># power law exponent</span>
</span><span id="Noise_Model-1695"><a href="#Noise_Model-1695"><span class="linenos">1695</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># true minimal frequency </span>
</span><span id="Noise_Model-1696"><a href="#Noise_Model-1696"><span class="linenos">1696</span></a>
</span><span id="Noise_Model-1697"><a href="#Noise_Model-1697"><span class="linenos">1697</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Noise_Model-1698"><a href="#Noise_Model-1698"><span class="linenos">1698</span></a>        <span class="n">dlogfby2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>  <span class="c1"># 1/2 comes from trapezoid integration below</span>
</span><span id="Noise_Model-1699"><a href="#Noise_Model-1699"><span class="linenos">1699</span></a>
</span><span id="Noise_Model-1700"><a href="#Noise_Model-1700"><span class="linenos">1700</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1701"><a href="#Noise_Model-1701"><span class="linenos">1701</span></a>        <span class="n">avgf_ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="Noise_Model-1702"><a href="#Noise_Model-1702"><span class="linenos">1702</span></a>
</span><span id="Noise_Model-1703"><a href="#Noise_Model-1703"><span class="linenos">1703</span></a>        <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Noise_Model-1704"><a href="#Noise_Model-1704"><span class="linenos">1704</span></a>        <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Noise_Model-1705"><a href="#Noise_Model-1705"><span class="linenos">1705</span></a>
</span><span id="Noise_Model-1706"><a href="#Noise_Model-1706"><span class="linenos">1706</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1707"><a href="#Noise_Model-1707"><span class="linenos">1707</span></a>        <span class="n">Pn0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Noise_Model-1708"><a href="#Noise_Model-1708"><span class="linenos">1708</span></a>        <span class="n">logPnng0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">Pn0n0</span><span class="p">)</span>
</span><span id="Noise_Model-1709"><a href="#Noise_Model-1709"><span class="linenos">1709</span></a>        <span class="n">avgf_null_pair</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPnng0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)))</span>
</span><span id="Noise_Model-1710"><a href="#Noise_Model-1710"><span class="linenos">1710</span></a>
</span><span id="Noise_Model-1711"><a href="#Noise_Model-1711"><span class="linenos">1711</span></a>        <span class="n">C1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgf_ps</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgf_null_pair</span><span class="p">)</span>
</span><span id="Noise_Model-1712"><a href="#Noise_Model-1712"><span class="linenos">1712</span></a>
</span><span id="Noise_Model-1713"><a href="#Noise_Model-1713"><span class="linenos">1713</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logrhofvec</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1714"><a href="#Noise_Model-1714"><span class="linenos">1714</span></a>        <span class="n">log_avgf_n0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="Noise_Model-1715"><a href="#Noise_Model-1715"><span class="linenos">1715</span></a>
</span><span id="Noise_Model-1716"><a href="#Noise_Model-1716"><span class="linenos">1716</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span> <span class="n">indn1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="n">indn2</span><span class="p">]</span> <span class="o">+</span> <span class="n">logrhofvec</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="Noise_Model-1717"><a href="#Noise_Model-1717"><span class="linenos">1717</span></a>        <span class="n">log_Pn1n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</span><span id="Noise_Model-1718"><a href="#Noise_Model-1718"><span class="linenos">1718</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">integ</span><span class="p">)</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
</span><span id="Noise_Model-1719"><a href="#Noise_Model-1719"><span class="linenos">1719</span></a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">log_Pn1n2</span><span class="p">)</span>
</span><span id="Noise_Model-1720"><a href="#Noise_Model-1720"><span class="linenos">1720</span></a>        <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>  <span class="c1"># since subtracted in next line</span>
</span><span id="Noise_Model-1721"><a href="#Noise_Model-1721"><span class="linenos">1721</span></a>        <span class="n">avgf_n1n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">)</span>
</span><span id="Noise_Model-1722"><a href="#Noise_Model-1722"><span class="linenos">1722</span></a>        <span class="n">log_sumavgf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">avgf_n1n2</span><span class="p">))</span>
</span><span id="Noise_Model-1723"><a href="#Noise_Model-1723"><span class="linenos">1723</span></a>
</span><span id="Noise_Model-1724"><a href="#Noise_Model-1724"><span class="linenos">1724</span></a>        <span class="n">logNclones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))</span> <span class="o">-</span> <span class="n">logPnng0</span>
</span><span id="Noise_Model-1725"><a href="#Noise_Model-1725"><span class="linenos">1725</span></a>        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logNclones</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn0n0</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_avgf_n0n0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_sumavgf</span><span class="p">)</span>
</span><span id="Noise_Model-1726"><a href="#Noise_Model-1726"><span class="linenos">1726</span></a>
</span><span id="Noise_Model-1727"><a href="#Noise_Model-1727"><span class="linenos">1727</span></a>        <span class="n">C2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
</span><span id="Noise_Model-1728"><a href="#Noise_Model-1728"><span class="linenos">1728</span></a>
</span><span id="Noise_Model-1729"><a href="#Noise_Model-1729"><span class="linenos">1729</span></a>        
</span><span id="Noise_Model-1730"><a href="#Noise_Model-1730"><span class="linenos">1730</span></a>        <span class="c1"># print(&#39;C1:&#39;+str(C1)+&#39; C2:&#39;+str(C2))</span>
</span><span id="Noise_Model-1731"><a href="#Noise_Model-1731"><span class="linenos">1731</span></a>        <span class="k">if</span> <span class="n">constr_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Noise_Model-1732"><a href="#Noise_Model-1732"><span class="linenos">1732</span></a>            <span class="k">return</span> <span class="n">C1</span>
</span><span id="Noise_Model-1733"><a href="#Noise_Model-1733"><span class="linenos">1733</span></a>        <span class="k">elif</span> <span class="n">constr_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model-1734"><a href="#Noise_Model-1734"><span class="linenos">1734</span></a>            <span class="k">return</span> <span class="n">C2</span>
</span><span id="Noise_Model-1735"><a href="#Noise_Model-1735"><span class="linenos">1735</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Noise_Model-1736"><a href="#Noise_Model-1736"><span class="linenos">1736</span></a>            <span class="k">return</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span>
</span><span id="Noise_Model-1737"><a href="#Noise_Model-1737"><span class="linenos">1737</span></a>
</span><span id="Noise_Model-1738"><a href="#Noise_Model-1738"><span class="linenos">1738</span></a>
</span><span id="Noise_Model-1739"><a href="#Noise_Model-1739"><span class="linenos">1739</span></a>        
</span><span id="Noise_Model-1740"><a href="#Noise_Model-1740"><span class="linenos">1740</span></a>    <span class="c1"># Null-Model optimization learning </span>
</span><span id="Noise_Model-1741"><a href="#Noise_Model-1741"><span class="linenos">1741</span></a>
</span><span id="Noise_Model-1742"><a href="#Noise_Model-1742"><span class="linenos">1742</span></a>    <span class="k">def</span> <span class="nf">learn_null_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">init_paras</span><span class="p">,</span>  <span class="n">output_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">display_loss_function</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>  <span class="c1"># constraint type 1 gives only low error modes, see paper for details.</span>
</span><span id="Noise_Model-1743"><a href="#Noise_Model-1743"><span class="linenos">1743</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model-1744"><a href="#Noise_Model-1744"><span class="linenos">1744</span></a><span class="sd">        Parameters</span>
</span><span id="Noise_Model-1745"><a href="#Noise_Model-1745"><span class="linenos">1745</span></a><span class="sd">        ----------</span>
</span><span id="Noise_Model-1746"><a href="#Noise_Model-1746"><span class="linenos">1746</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="Noise_Model-1747"><a href="#Noise_Model-1747"><span class="linenos">1747</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="Noise_Model-1748"><a href="#Noise_Model-1748"><span class="linenos">1748</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two replicates RepSeq samples</span>
</span><span id="Noise_Model-1749"><a href="#Noise_Model-1749"><span class="linenos">1749</span></a><span class="sd">            associated to their clone frequencies and clone abundances in the first and second replicate.</span>
</span><span id="Noise_Model-1750"><a href="#Noise_Model-1750"><span class="linenos">1750</span></a><span class="sd">        noise_model: numpy array</span>
</span><span id="Noise_Model-1751"><a href="#Noise_Model-1751"><span class="linenos">1751</span></a><span class="sd">            choice of noise model </span>
</span><span id="Noise_Model-1752"><a href="#Noise_Model-1752"><span class="linenos">1752</span></a><span class="sd">        init_paras: numpy array</span>
</span><span id="Noise_Model-1753"><a href="#Noise_Model-1753"><span class="linenos">1753</span></a><span class="sd">            initial vector of parameters to start the optimization of the model from data (df)</span>
</span><span id="Noise_Model-1754"><a href="#Noise_Model-1754"><span class="linenos">1754</span></a><span class="sd">        output_dir : str</span>
</span><span id="Noise_Model-1755"><a href="#Noise_Model-1755"><span class="linenos">1755</span></a><span class="sd">            default value is None, it is the output directory name i which we want to save the values of the parameters</span>
</span><span id="Noise_Model-1756"><a href="#Noise_Model-1756"><span class="linenos">1756</span></a><span class="sd">        display_loss_function : bool</span>
</span><span id="Noise_Model-1757"><a href="#Noise_Model-1757"><span class="linenos">1757</span></a><span class="sd">            boolean variable to chose if we want to print the loss function during the experimental noise learning, default value is </span>
</span><span id="Noise_Model-1758"><a href="#Noise_Model-1758"><span class="linenos">1758</span></a><span class="sd">            None.</span>
</span><span id="Noise_Model-1759"><a href="#Noise_Model-1759"><span class="linenos">1759</span></a><span class="sd">        </span>
</span><span id="Noise_Model-1760"><a href="#Noise_Model-1760"><span class="linenos">1760</span></a>
</span><span id="Noise_Model-1761"><a href="#Noise_Model-1761"><span class="linenos">1761</span></a><span class="sd">        Returns</span>
</span><span id="Noise_Model-1762"><a href="#Noise_Model-1762"><span class="linenos">1762</span></a><span class="sd">        -------</span>
</span><span id="Noise_Model-1763"><a href="#Noise_Model-1763"><span class="linenos">1763</span></a><span class="sd">        outstruct</span>
</span><span id="Noise_Model-1764"><a href="#Noise_Model-1764"><span class="linenos">1764</span></a><span class="sd">            numpy array parameters of the noise model</span>
</span><span id="Noise_Model-1765"><a href="#Noise_Model-1765"><span class="linenos">1765</span></a>
</span><span id="Noise_Model-1766"><a href="#Noise_Model-1766"><span class="linenos">1766</span></a><span class="sd">        constr_value</span>
</span><span id="Noise_Model-1767"><a href="#Noise_Model-1767"><span class="linenos">1767</span></a><span class="sd">            float, value of the constraint </span>
</span><span id="Noise_Model-1768"><a href="#Noise_Model-1768"><span class="linenos">1768</span></a><span class="sd">    </span>
</span><span id="Noise_Model-1769"><a href="#Noise_Model-1769"><span class="linenos">1769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Noise_Model-1770"><a href="#Noise_Model-1770"><span class="linenos">1770</span></a>            
</span><span id="Noise_Model-1771"><a href="#Noise_Model-1771"><span class="linenos">1771</span></a>        <span class="c1"># Data introduction</span>
</span><span id="Noise_Model-1772"><a href="#Noise_Model-1772"><span class="linenos">1772</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="Noise_Model-1773"><a href="#Noise_Model-1773"><span class="linenos">1773</span></a>        <span class="n">constr_type</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Noise_Model-1774"><a href="#Noise_Model-1774"><span class="linenos">1774</span></a>
</span><span id="Noise_Model-1775"><a href="#Noise_Model-1775"><span class="linenos">1775</span></a>        <span class="c1"># Choice of the model:</span>
</span><span id="Noise_Model-1776"><a href="#Noise_Model-1776"><span class="linenos">1776</span></a>        <span class="c1"># Parameters initialization depending on the model </span>
</span><span id="Noise_Model-1777"><a href="#Noise_Model-1777"><span class="linenos">1777</span></a>        <span class="k">if</span> <span class="n">noise_model</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model-1778"><a href="#Noise_Model-1778"><span class="linenos">1778</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;m_total&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model-1779"><a href="#Noise_Model-1779"><span class="linenos">1779</span></a>        <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model-1780"><a href="#Noise_Model-1780"><span class="linenos">1780</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model-1781"><a href="#Noise_Model-1781"><span class="linenos">1781</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Noise_Model-1782"><a href="#Noise_Model-1782"><span class="linenos">1782</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model-1783"><a href="#Noise_Model-1783"><span class="linenos">1783</span></a>
</span><span id="Noise_Model-1784"><a href="#Noise_Model-1784"><span class="linenos">1784</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">),</span> <span class="s2">&quot;number of model and initial paras differ!&quot;</span>
</span><span id="Noise_Model-1785"><a href="#Noise_Model-1785"><span class="linenos">1785</span></a>
</span><span id="Noise_Model-1786"><a href="#Noise_Model-1786"><span class="linenos">1786</span></a>        <span class="n">condict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nullmodel_constr_fn</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">constr_type</span><span class="p">)}</span>
</span><span id="Noise_Model-1787"><a href="#Noise_Model-1787"><span class="linenos">1787</span></a>
</span><span id="Noise_Model-1788"><a href="#Noise_Model-1788"><span class="linenos">1788</span></a>
</span><span id="Noise_Model-1789"><a href="#Noise_Model-1789"><span class="linenos">1789</span></a>        <span class="n">partialobjfunc</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_Pn1n2</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="o">=</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="o">=</span><span class="n">noise_model</span><span class="p">)</span>
</span><span id="Noise_Model-1790"><a href="#Noise_Model-1790"><span class="linenos">1790</span></a>        <span class="n">nullfunctol</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="Noise_Model-1791"><a href="#Noise_Model-1791"><span class="linenos">1791</span></a>        <span class="n">nullmaxiter</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="Noise_Model-1792"><a href="#Noise_Model-1792"><span class="linenos">1792</span></a>        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Iter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameter_labels</span>
</span><span id="Noise_Model-1793"><a href="#Noise_Model-1793"><span class="linenos">1793</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:9s} &#39;</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">))</span>
</span><span id="Noise_Model-1794"><a href="#Noise_Model-1794"><span class="linenos">1794</span></a>            
</span><span id="Noise_Model-1795"><a href="#Noise_Model-1795"><span class="linenos">1795</span></a>        <span class="k">global</span> <span class="n">curr_iter</span>
</span><span id="Noise_Model-1796"><a href="#Noise_Model-1796"><span class="linenos">1796</span></a>        <span class="n">curr_iter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Noise_Model-1797"><a href="#Noise_Model-1797"><span class="linenos">1797</span></a>        <span class="n">callbackp</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">,</span> <span class="n">nparas</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">),</span> <span class="n">sparse_rep</span> <span class="o">=</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="o">=</span> <span class="n">noise_model</span><span class="p">)</span>
</span><span id="Noise_Model-1798"><a href="#Noise_Model-1798"><span class="linenos">1798</span></a>        <span class="n">outstruct</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">partialobjfunc</span><span class="p">,</span> <span class="n">init_paras</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callbackp</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">condict</span><span class="p">,</span>
</span><span id="Noise_Model-1799"><a href="#Noise_Model-1799"><span class="linenos">1799</span></a>                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="n">nullfunctol</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">nullmaxiter</span><span class="p">})</span>
</span><span id="Noise_Model-1800"><a href="#Noise_Model-1800"><span class="linenos">1800</span></a>            
</span><span id="Noise_Model-1801"><a href="#Noise_Model-1801"><span class="linenos">1801</span></a>        <span class="n">constr_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nullmodel_constr_fn</span><span class="p">(</span><span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">constr_type</span><span class="p">)</span>
</span><span id="Noise_Model-1802"><a href="#Noise_Model-1802"><span class="linenos">1802</span></a>
</span><span id="Noise_Model-1803"><a href="#Noise_Model-1803"><span class="linenos">1803</span></a>        <span class="k">if</span> <span class="n">noise_model</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model-1804"><a href="#Noise_Model-1804"><span class="linenos">1804</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;m_total&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model-1805"><a href="#Noise_Model-1805"><span class="linenos">1805</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="Noise_Model-1806"><a href="#Noise_Model-1806"><span class="linenos">1806</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="Noise_Model-1807"><a href="#Noise_Model-1807"><span class="linenos">1807</span></a>        <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model-1808"><a href="#Noise_Model-1808"><span class="linenos">1808</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model-1809"><a href="#Noise_Model-1809"><span class="linenos">1809</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="Noise_Model-1810"><a href="#Noise_Model-1810"><span class="linenos">1810</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="Noise_Model-1811"><a href="#Noise_Model-1811"><span class="linenos">1811</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Noise_Model-1812"><a href="#Noise_Model-1812"><span class="linenos">1812</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model-1813"><a href="#Noise_Model-1813"><span class="linenos">1813</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="Noise_Model-1814"><a href="#Noise_Model-1814"><span class="linenos">1814</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="Noise_Model-1815"><a href="#Noise_Model-1815"><span class="linenos">1815</span></a>
</span><span id="Noise_Model-1816"><a href="#Noise_Model-1816"><span class="linenos">1816</span></a>
</span><span id="Noise_Model-1817"><a href="#Noise_Model-1817"><span class="linenos">1817</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">output_dir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Noise_Model-1818"><a href="#Noise_Model-1818"><span class="linenos">1818</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;nullpara&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">noise_model</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Noise_Model-1819"><a href="#Noise_Model-1819"><span class="linenos">1819</span></a>
</span><span id="Noise_Model-1820"><a href="#Noise_Model-1820"><span class="linenos">1820</span></a>        <span class="k">elif</span> <span class="p">(</span><span class="n">output_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Noise_Model-1821"><a href="#Noise_Model-1821"><span class="linenos">1821</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;/nullpara&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">noise_model</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Noise_Model-1822"><a href="#Noise_Model-1822"><span class="linenos">1822</span></a>
</span><span id="Noise_Model-1823"><a href="#Noise_Model-1823"><span class="linenos">1823</span></a>        <span class="k">else</span> <span class="p">:</span>
</span><span id="Noise_Model-1824"><a href="#Noise_Model-1824"><span class="linenos">1824</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Noise_Model-1825"><a href="#Noise_Model-1825"><span class="linenos">1825</span></a>
</span><span id="Noise_Model-1826"><a href="#Noise_Model-1826"><span class="linenos">1826</span></a>        <span class="k">return</span> <span class="n">outstruct</span><span class="p">,</span> <span class="n">constr_value</span>
</span><span id="Noise_Model-1827"><a href="#Noise_Model-1827"><span class="linenos">1827</span></a>
</span><span id="Noise_Model-1828"><a href="#Noise_Model-1828"><span class="linenos">1828</span></a>    <span class="k">def</span> <span class="nf">diversity_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">):</span>
</span><span id="Noise_Model-1829"><a href="#Noise_Model-1829"><span class="linenos">1829</span></a>
</span><span id="Noise_Model-1830"><a href="#Noise_Model-1830"><span class="linenos">1830</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model-1831"><a href="#Noise_Model-1831"><span class="linenos">1831</span></a><span class="sd">        Estimate diversity of the individual repertoire from the experimental noise learning step. </span>
</span><span id="Noise_Model-1832"><a href="#Noise_Model-1832"><span class="linenos">1832</span></a>
</span><span id="Noise_Model-1833"><a href="#Noise_Model-1833"><span class="linenos">1833</span></a><span class="sd">        Parameters</span>
</span><span id="Noise_Model-1834"><a href="#Noise_Model-1834"><span class="linenos">1834</span></a><span class="sd">        ----------</span>
</span><span id="Noise_Model-1835"><a href="#Noise_Model-1835"><span class="linenos">1835</span></a><span class="sd">        df : data-frame </span>
</span><span id="Noise_Model-1836"><a href="#Noise_Model-1836"><span class="linenos">1836</span></a><span class="sd">            The data-frame which has been used to learn the noise model</span>
</span><span id="Noise_Model-1837"><a href="#Noise_Model-1837"><span class="linenos">1837</span></a><span class="sd">        paras : numpy array</span>
</span><span id="Noise_Model-1838"><a href="#Noise_Model-1838"><span class="linenos">1838</span></a><span class="sd">            vector containing the noise parameters</span>
</span><span id="Noise_Model-1839"><a href="#Noise_Model-1839"><span class="linenos">1839</span></a><span class="sd">        noise_model : int</span>
</span><span id="Noise_Model-1840"><a href="#Noise_Model-1840"><span class="linenos">1840</span></a><span class="sd">            choice of noise model </span>
</span><span id="Noise_Model-1841"><a href="#Noise_Model-1841"><span class="linenos">1841</span></a>
</span><span id="Noise_Model-1842"><a href="#Noise_Model-1842"><span class="linenos">1842</span></a><span class="sd">        Returns</span>
</span><span id="Noise_Model-1843"><a href="#Noise_Model-1843"><span class="linenos">1843</span></a><span class="sd">        -------</span>
</span><span id="Noise_Model-1844"><a href="#Noise_Model-1844"><span class="linenos">1844</span></a><span class="sd">        diversity_estimate</span>
</span><span id="Noise_Model-1845"><a href="#Noise_Model-1845"><span class="linenos">1845</span></a><span class="sd">            float, diversity estimate from the noise model inference.</span>
</span><span id="Noise_Model-1846"><a href="#Noise_Model-1846"><span class="linenos">1846</span></a><span class="sd">    </span>
</span><span id="Noise_Model-1847"><a href="#Noise_Model-1847"><span class="linenos">1847</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Noise_Model-1848"><a href="#Noise_Model-1848"><span class="linenos">1848</span></a>
</span><span id="Noise_Model-1849"><a href="#Noise_Model-1849"><span class="linenos">1849</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="Noise_Model-1850"><a href="#Noise_Model-1850"><span class="linenos">1850</span></a>
</span><span id="Noise_Model-1851"><a href="#Noise_Model-1851"><span class="linenos">1851</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="Noise_Model-1852"><a href="#Noise_Model-1852"><span class="linenos">1852</span></a>            
</span><span id="Noise_Model-1853"><a href="#Noise_Model-1853"><span class="linenos">1853</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span>
</span><span id="Noise_Model-1854"><a href="#Noise_Model-1854"><span class="linenos">1854</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="Noise_Model-1855"><a href="#Noise_Model-1855"><span class="linenos">1855</span></a>
</span><span id="Noise_Model-1856"><a href="#Noise_Model-1856"><span class="linenos">1856</span></a>        <span class="c1"># Parameters</span>
</span><span id="Noise_Model-1857"><a href="#Noise_Model-1857"><span class="linenos">1857</span></a>
</span><span id="Noise_Model-1858"><a href="#Noise_Model-1858"><span class="linenos">1858</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Noise_Model-1859"><a href="#Noise_Model-1859"><span class="linenos">1859</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Noise_Model-1860"><a href="#Noise_Model-1860"><span class="linenos">1860</span></a>
</span><span id="Noise_Model-1861"><a href="#Noise_Model-1861"><span class="linenos">1861</span></a>        <span class="c1"># </span>
</span><span id="Noise_Model-1862"><a href="#Noise_Model-1862"><span class="linenos">1862</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Noise_Model-1863"><a href="#Noise_Model-1863"><span class="linenos">1863</span></a>
</span><span id="Noise_Model-1864"><a href="#Noise_Model-1864"><span class="linenos">1864</span></a>        <span class="c1"># </span>
</span><span id="Noise_Model-1865"><a href="#Noise_Model-1865"><span class="linenos">1865</span></a>
</span><span id="Noise_Model-1866"><a href="#Noise_Model-1866"><span class="linenos">1866</span></a>        <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1867"><a href="#Noise_Model-1867"><span class="linenos">1867</span></a>
</span><span id="Noise_Model-1868"><a href="#Noise_Model-1868"><span class="linenos">1868</span></a>        <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Noise_Model-1869"><a href="#Noise_Model-1869"><span class="linenos">1869</span></a>        <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Noise_Model-1870"><a href="#Noise_Model-1870"><span class="linenos">1870</span></a>
</span><span id="Noise_Model-1871"><a href="#Noise_Model-1871"><span class="linenos">1871</span></a>        <span class="c1"># for the trapezoid integral methods</span>
</span><span id="Noise_Model-1872"><a href="#Noise_Model-1872"><span class="linenos">1872</span></a>
</span><span id="Noise_Model-1873"><a href="#Noise_Model-1873"><span class="linenos">1873</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="Noise_Model-1874"><a href="#Noise_Model-1874"><span class="linenos">1874</span></a>
</span><span id="Noise_Model-1875"><a href="#Noise_Model-1875"><span class="linenos">1875</span></a>        <span class="c1"># Compute P(0,0) for the normalization constraint</span>
</span><span id="Noise_Model-1876"><a href="#Noise_Model-1876"><span class="linenos">1876</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model-1877"><a href="#Noise_Model-1877"><span class="linenos">1877</span></a>        <span class="n">Pn0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Noise_Model-1878"><a href="#Noise_Model-1878"><span class="linenos">1878</span></a>
</span><span id="Noise_Model-1879"><a href="#Noise_Model-1879"><span class="linenos">1879</span></a>        <span class="c1">#print(np.sum(sparse_rep_counts))</span>
</span><span id="Noise_Model-1880"><a href="#Noise_Model-1880"><span class="linenos">1880</span></a>        <span class="n">N_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)</span>
</span><span id="Noise_Model-1881"><a href="#Noise_Model-1881"><span class="linenos">1881</span></a>
</span><span id="Noise_Model-1882"><a href="#Noise_Model-1882"><span class="linenos">1882</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_obs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn0n0</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>A class used to build an object associated to methods in order to learn the experimental noise from same day 
biological RepSeq samples.</p>

<p>...</p>

<h6 id="methods">Methods</h6>

<p>get_sparserep(df) :
    get sparse representation of the abundances / frequencies of the TCR clones present in both RepSeq samples of interest.
    this changes the data input to fasten the algorithm</p>

<p>learn_null_model(df, noise_model, init_paras,  output_dir = None, filename = None, display_loss_function = False) :
    function to optimize the likelihood associated to the experimental noise model and get the associated parameters.</p>

<p>diversity_estimate(df, paras, noise_model) :
    function to get the estimation of diversity from the noise model information.</p>
</div>


                            <div id="Noise_Model.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Noise_Model</span><span class="signature pdoc-code condensed">()</span>

        
    </div>
    <a class="headerlink" href="#Noise_Model.__init__"></a>
    
    

                            </div>
                            <div id="Noise_Model.get_sparserep" class="classattr">
                                        <input id="Noise_Model.get_sparserep-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_sparserep</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">df</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Noise_Model.get_sparserep-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Noise_Model.get_sparserep"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Noise_Model.get_sparserep-1426"><a href="#Noise_Model.get_sparserep-1426"><span class="linenos">1426</span></a>    <span class="k">def</span> <span class="nf">get_sparserep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span> 
</span><span id="Noise_Model.get_sparserep-1427"><a href="#Noise_Model.get_sparserep-1427"><span class="linenos">1427</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model.get_sparserep-1428"><a href="#Noise_Model.get_sparserep-1428"><span class="linenos">1428</span></a><span class="sd">        Tranforms {(n1,n2)} data stored in pandas dataframe to a sparse 1D representation.</span>
</span><span id="Noise_Model.get_sparserep-1429"><a href="#Noise_Model.get_sparserep-1429"><span class="linenos">1429</span></a><span class="sd">        unicountvals_1(2) are the unique values of n1(2).</span>
</span><span id="Noise_Model.get_sparserep-1430"><a href="#Noise_Model.get_sparserep-1430"><span class="linenos">1430</span></a><span class="sd">        sparse_rep_counts gives the counts of unique pairs.</span>
</span><span id="Noise_Model.get_sparserep-1431"><a href="#Noise_Model.get_sparserep-1431"><span class="linenos">1431</span></a><span class="sd">        ndn1(2) is the index of unicountvals_1(2) giving the value of n1(2) in that unique pair.</span>
</span><span id="Noise_Model.get_sparserep-1432"><a href="#Noise_Model.get_sparserep-1432"><span class="linenos">1432</span></a><span class="sd">        len(indn1)=len(indn2)=len(sparse_rep_counts)</span>
</span><span id="Noise_Model.get_sparserep-1433"><a href="#Noise_Model.get_sparserep-1433"><span class="linenos">1433</span></a>
</span><span id="Noise_Model.get_sparserep-1434"><a href="#Noise_Model.get_sparserep-1434"><span class="linenos">1434</span></a>
</span><span id="Noise_Model.get_sparserep-1435"><a href="#Noise_Model.get_sparserep-1435"><span class="linenos">1435</span></a><span class="sd">        Parameters</span>
</span><span id="Noise_Model.get_sparserep-1436"><a href="#Noise_Model.get_sparserep-1436"><span class="linenos">1436</span></a><span class="sd">        ----------</span>
</span><span id="Noise_Model.get_sparserep-1437"><a href="#Noise_Model.get_sparserep-1437"><span class="linenos">1437</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="Noise_Model.get_sparserep-1438"><a href="#Noise_Model.get_sparserep-1438"><span class="linenos">1438</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="Noise_Model.get_sparserep-1439"><a href="#Noise_Model.get_sparserep-1439"><span class="linenos">1439</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two replicates RepSeq samples</span>
</span><span id="Noise_Model.get_sparserep-1440"><a href="#Noise_Model.get_sparserep-1440"><span class="linenos">1440</span></a><span class="sd">            associated to their clone frequencies and clone abundances in the first and second replicate.</span>
</span><span id="Noise_Model.get_sparserep-1441"><a href="#Noise_Model.get_sparserep-1441"><span class="linenos">1441</span></a>
</span><span id="Noise_Model.get_sparserep-1442"><a href="#Noise_Model.get_sparserep-1442"><span class="linenos">1442</span></a>
</span><span id="Noise_Model.get_sparserep-1443"><a href="#Noise_Model.get_sparserep-1443"><span class="linenos">1443</span></a><span class="sd">        Returns</span>
</span><span id="Noise_Model.get_sparserep-1444"><a href="#Noise_Model.get_sparserep-1444"><span class="linenos">1444</span></a><span class="sd">        -------</span>
</span><span id="Noise_Model.get_sparserep-1445"><a href="#Noise_Model.get_sparserep-1445"><span class="linenos">1445</span></a><span class="sd">        indn1</span>
</span><span id="Noise_Model.get_sparserep-1446"><a href="#Noise_Model.get_sparserep-1446"><span class="linenos">1446</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_1</span>
</span><span id="Noise_Model.get_sparserep-1447"><a href="#Noise_Model.get_sparserep-1447"><span class="linenos">1447</span></a>
</span><span id="Noise_Model.get_sparserep-1448"><a href="#Noise_Model.get_sparserep-1448"><span class="linenos">1448</span></a><span class="sd">        indn2</span>
</span><span id="Noise_Model.get_sparserep-1449"><a href="#Noise_Model.get_sparserep-1449"><span class="linenos">1449</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_2</span>
</span><span id="Noise_Model.get_sparserep-1450"><a href="#Noise_Model.get_sparserep-1450"><span class="linenos">1450</span></a>
</span><span id="Noise_Model.get_sparserep-1451"><a href="#Noise_Model.get_sparserep-1451"><span class="linenos">1451</span></a><span class="sd">        sparse_rep_counts</span>
</span><span id="Noise_Model.get_sparserep-1452"><a href="#Noise_Model.get_sparserep-1452"><span class="linenos">1452</span></a><span class="sd">            numpy array, # of clones having the read counts pair {(n1,n2)} </span>
</span><span id="Noise_Model.get_sparserep-1453"><a href="#Noise_Model.get_sparserep-1453"><span class="linenos">1453</span></a>
</span><span id="Noise_Model.get_sparserep-1454"><a href="#Noise_Model.get_sparserep-1454"><span class="linenos">1454</span></a><span class="sd">        unicountvals_1</span>
</span><span id="Noise_Model.get_sparserep-1455"><a href="#Noise_Model.get_sparserep-1455"><span class="linenos">1455</span></a><span class="sd">            numpy array list of unique counts values present in the first sample in df[clone_count_1]</span>
</span><span id="Noise_Model.get_sparserep-1456"><a href="#Noise_Model.get_sparserep-1456"><span class="linenos">1456</span></a>
</span><span id="Noise_Model.get_sparserep-1457"><a href="#Noise_Model.get_sparserep-1457"><span class="linenos">1457</span></a><span class="sd">        unicountvals_2</span>
</span><span id="Noise_Model.get_sparserep-1458"><a href="#Noise_Model.get_sparserep-1458"><span class="linenos">1458</span></a><span class="sd">            numpy array list of unique counts values present in the second sample in df[clone_count_2]</span>
</span><span id="Noise_Model.get_sparserep-1459"><a href="#Noise_Model.get_sparserep-1459"><span class="linenos">1459</span></a>
</span><span id="Noise_Model.get_sparserep-1460"><a href="#Noise_Model.get_sparserep-1460"><span class="linenos">1460</span></a><span class="sd">        Nreads1</span>
</span><span id="Noise_Model.get_sparserep-1461"><a href="#Noise_Model.get_sparserep-1461"><span class="linenos">1461</span></a><span class="sd">            float, total number of counts/reads in the first sample referred in df by &quot;_1&quot;</span>
</span><span id="Noise_Model.get_sparserep-1462"><a href="#Noise_Model.get_sparserep-1462"><span class="linenos">1462</span></a>
</span><span id="Noise_Model.get_sparserep-1463"><a href="#Noise_Model.get_sparserep-1463"><span class="linenos">1463</span></a><span class="sd">        Nreads2</span>
</span><span id="Noise_Model.get_sparserep-1464"><a href="#Noise_Model.get_sparserep-1464"><span class="linenos">1464</span></a><span class="sd">            float, total number of counts/reads in the second sample referred in df by &quot;_2&quot;</span>
</span><span id="Noise_Model.get_sparserep-1465"><a href="#Noise_Model.get_sparserep-1465"><span class="linenos">1465</span></a>
</span><span id="Noise_Model.get_sparserep-1466"><a href="#Noise_Model.get_sparserep-1466"><span class="linenos">1466</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Noise_Model.get_sparserep-1467"><a href="#Noise_Model.get_sparserep-1467"><span class="linenos">1467</span></a>        
</span><span id="Noise_Model.get_sparserep-1468"><a href="#Noise_Model.get_sparserep-1468"><span class="linenos">1468</span></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]]</span>
</span><span id="Noise_Model.get_sparserep-1469"><a href="#Noise_Model.get_sparserep-1469"><span class="linenos">1469</span></a>        <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;paircount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># gives a weight of 1 to each observed clone</span>
</span><span id="Noise_Model.get_sparserep-1470"><a href="#Noise_Model.get_sparserep-1470"><span class="linenos">1470</span></a>
</span><span id="Noise_Model.get_sparserep-1471"><a href="#Noise_Model.get_sparserep-1471"><span class="linenos">1471</span></a>        <span class="n">clone_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Noise_Model.get_sparserep-1472"><a href="#Noise_Model.get_sparserep-1472"><span class="linenos">1472</span></a>        <span class="n">sparse_rep_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clone_counts</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Noise_Model.get_sparserep-1473"><a href="#Noise_Model.get_sparserep-1473"><span class="linenos">1473</span></a>        <span class="n">clonecountpair_vals</span> <span class="o">=</span> <span class="n">clone_counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="Noise_Model.get_sparserep-1474"><a href="#Noise_Model.get_sparserep-1474"><span class="linenos">1474</span></a>        <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Noise_Model.get_sparserep-1475"><a href="#Noise_Model.get_sparserep-1475"><span class="linenos">1475</span></a>        <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Noise_Model.get_sparserep-1476"><a href="#Noise_Model.get_sparserep-1476"><span class="linenos">1476</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="Noise_Model.get_sparserep-1477"><a href="#Noise_Model.get_sparserep-1477"><span class="linenos">1477</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="Noise_Model.get_sparserep-1478"><a href="#Noise_Model.get_sparserep-1478"><span class="linenos">1478</span></a>
</span><span id="Noise_Model.get_sparserep-1479"><a href="#Noise_Model.get_sparserep-1479"><span class="linenos">1479</span></a>        <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Noise_Model.get_sparserep-1480"><a href="#Noise_Model.get_sparserep-1480"><span class="linenos">1480</span></a>        <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn2</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Noise_Model.get_sparserep-1481"><a href="#Noise_Model.get_sparserep-1481"><span class="linenos">1481</span></a>
</span><span id="Noise_Model.get_sparserep-1482"><a href="#Noise_Model.get_sparserep-1482"><span class="linenos">1482</span></a>        <span class="k">return</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span>
</span></pre></div>


            <div class="docstring"><p>Tranforms {(n1,n2)} data stored in pandas dataframe to a sparse 1D representation.
unicountvals_1(2) are the unique values of n1(2).
sparse_rep_counts gives the counts of unique pairs.
ndn1(2) is the index of unicountvals_1(2) giving the value of n1(2) in that unique pair.
len(indn1)=len(indn2)=len(sparse_rep_counts)</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>df</strong> (pandas data frame):
data-frame which is the output of the method .import_data() for one Data_Process instance.
these data-frame should give the list of TCR clones present in two replicates RepSeq samples
associated to their clone frequencies and clone abundances in the first and second replicate.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>indn1</strong>: numpy array list of indexes of all values of unicountvals_1</li>
<li><strong>indn2</strong>: numpy array list of indexes of all values of unicountvals_2</li>
<li><strong>sparse_rep_counts</strong>: numpy array, # of clones having the read counts pair {(n1,n2)}</li>
<li><strong>unicountvals_1</strong>: numpy array list of unique counts values present in the first sample in df[clone_count_1]</li>
<li><strong>unicountvals_2</strong>: numpy array list of unique counts values present in the second sample in df[clone_count_2]</li>
<li><strong>Nreads1</strong>: float, total number of counts/reads in the first sample referred in df by "_1"</li>
<li><strong>Nreads2</strong>: float, total number of counts/reads in the second sample referred in df by "_2"</li>
</ul>
</div>


                            </div>
                            <div id="Noise_Model.learn_null_model" class="classattr">
                                        <input id="Noise_Model.learn_null_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">learn_null_model</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">noise_model</span>,</span><span class="param">	<span class="n">init_paras</span>,</span><span class="param">	<span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">filename</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">display_loss_function</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Noise_Model.learn_null_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Noise_Model.learn_null_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Noise_Model.learn_null_model-1742"><a href="#Noise_Model.learn_null_model-1742"><span class="linenos">1742</span></a>    <span class="k">def</span> <span class="nf">learn_null_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">init_paras</span><span class="p">,</span>  <span class="n">output_dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">display_loss_function</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>  <span class="c1"># constraint type 1 gives only low error modes, see paper for details.</span>
</span><span id="Noise_Model.learn_null_model-1743"><a href="#Noise_Model.learn_null_model-1743"><span class="linenos">1743</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model.learn_null_model-1744"><a href="#Noise_Model.learn_null_model-1744"><span class="linenos">1744</span></a><span class="sd">        Parameters</span>
</span><span id="Noise_Model.learn_null_model-1745"><a href="#Noise_Model.learn_null_model-1745"><span class="linenos">1745</span></a><span class="sd">        ----------</span>
</span><span id="Noise_Model.learn_null_model-1746"><a href="#Noise_Model.learn_null_model-1746"><span class="linenos">1746</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="Noise_Model.learn_null_model-1747"><a href="#Noise_Model.learn_null_model-1747"><span class="linenos">1747</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="Noise_Model.learn_null_model-1748"><a href="#Noise_Model.learn_null_model-1748"><span class="linenos">1748</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two replicates RepSeq samples</span>
</span><span id="Noise_Model.learn_null_model-1749"><a href="#Noise_Model.learn_null_model-1749"><span class="linenos">1749</span></a><span class="sd">            associated to their clone frequencies and clone abundances in the first and second replicate.</span>
</span><span id="Noise_Model.learn_null_model-1750"><a href="#Noise_Model.learn_null_model-1750"><span class="linenos">1750</span></a><span class="sd">        noise_model: numpy array</span>
</span><span id="Noise_Model.learn_null_model-1751"><a href="#Noise_Model.learn_null_model-1751"><span class="linenos">1751</span></a><span class="sd">            choice of noise model </span>
</span><span id="Noise_Model.learn_null_model-1752"><a href="#Noise_Model.learn_null_model-1752"><span class="linenos">1752</span></a><span class="sd">        init_paras: numpy array</span>
</span><span id="Noise_Model.learn_null_model-1753"><a href="#Noise_Model.learn_null_model-1753"><span class="linenos">1753</span></a><span class="sd">            initial vector of parameters to start the optimization of the model from data (df)</span>
</span><span id="Noise_Model.learn_null_model-1754"><a href="#Noise_Model.learn_null_model-1754"><span class="linenos">1754</span></a><span class="sd">        output_dir : str</span>
</span><span id="Noise_Model.learn_null_model-1755"><a href="#Noise_Model.learn_null_model-1755"><span class="linenos">1755</span></a><span class="sd">            default value is None, it is the output directory name i which we want to save the values of the parameters</span>
</span><span id="Noise_Model.learn_null_model-1756"><a href="#Noise_Model.learn_null_model-1756"><span class="linenos">1756</span></a><span class="sd">        display_loss_function : bool</span>
</span><span id="Noise_Model.learn_null_model-1757"><a href="#Noise_Model.learn_null_model-1757"><span class="linenos">1757</span></a><span class="sd">            boolean variable to chose if we want to print the loss function during the experimental noise learning, default value is </span>
</span><span id="Noise_Model.learn_null_model-1758"><a href="#Noise_Model.learn_null_model-1758"><span class="linenos">1758</span></a><span class="sd">            None.</span>
</span><span id="Noise_Model.learn_null_model-1759"><a href="#Noise_Model.learn_null_model-1759"><span class="linenos">1759</span></a><span class="sd">        </span>
</span><span id="Noise_Model.learn_null_model-1760"><a href="#Noise_Model.learn_null_model-1760"><span class="linenos">1760</span></a>
</span><span id="Noise_Model.learn_null_model-1761"><a href="#Noise_Model.learn_null_model-1761"><span class="linenos">1761</span></a><span class="sd">        Returns</span>
</span><span id="Noise_Model.learn_null_model-1762"><a href="#Noise_Model.learn_null_model-1762"><span class="linenos">1762</span></a><span class="sd">        -------</span>
</span><span id="Noise_Model.learn_null_model-1763"><a href="#Noise_Model.learn_null_model-1763"><span class="linenos">1763</span></a><span class="sd">        outstruct</span>
</span><span id="Noise_Model.learn_null_model-1764"><a href="#Noise_Model.learn_null_model-1764"><span class="linenos">1764</span></a><span class="sd">            numpy array parameters of the noise model</span>
</span><span id="Noise_Model.learn_null_model-1765"><a href="#Noise_Model.learn_null_model-1765"><span class="linenos">1765</span></a>
</span><span id="Noise_Model.learn_null_model-1766"><a href="#Noise_Model.learn_null_model-1766"><span class="linenos">1766</span></a><span class="sd">        constr_value</span>
</span><span id="Noise_Model.learn_null_model-1767"><a href="#Noise_Model.learn_null_model-1767"><span class="linenos">1767</span></a><span class="sd">            float, value of the constraint </span>
</span><span id="Noise_Model.learn_null_model-1768"><a href="#Noise_Model.learn_null_model-1768"><span class="linenos">1768</span></a><span class="sd">    </span>
</span><span id="Noise_Model.learn_null_model-1769"><a href="#Noise_Model.learn_null_model-1769"><span class="linenos">1769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Noise_Model.learn_null_model-1770"><a href="#Noise_Model.learn_null_model-1770"><span class="linenos">1770</span></a>            
</span><span id="Noise_Model.learn_null_model-1771"><a href="#Noise_Model.learn_null_model-1771"><span class="linenos">1771</span></a>        <span class="c1"># Data introduction</span>
</span><span id="Noise_Model.learn_null_model-1772"><a href="#Noise_Model.learn_null_model-1772"><span class="linenos">1772</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1773"><a href="#Noise_Model.learn_null_model-1773"><span class="linenos">1773</span></a>        <span class="n">constr_type</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Noise_Model.learn_null_model-1774"><a href="#Noise_Model.learn_null_model-1774"><span class="linenos">1774</span></a>
</span><span id="Noise_Model.learn_null_model-1775"><a href="#Noise_Model.learn_null_model-1775"><span class="linenos">1775</span></a>        <span class="c1"># Choice of the model:</span>
</span><span id="Noise_Model.learn_null_model-1776"><a href="#Noise_Model.learn_null_model-1776"><span class="linenos">1776</span></a>        <span class="c1"># Parameters initialization depending on the model </span>
</span><span id="Noise_Model.learn_null_model-1777"><a href="#Noise_Model.learn_null_model-1777"><span class="linenos">1777</span></a>        <span class="k">if</span> <span class="n">noise_model</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model.learn_null_model-1778"><a href="#Noise_Model.learn_null_model-1778"><span class="linenos">1778</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;m_total&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model.learn_null_model-1779"><a href="#Noise_Model.learn_null_model-1779"><span class="linenos">1779</span></a>        <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model.learn_null_model-1780"><a href="#Noise_Model.learn_null_model-1780"><span class="linenos">1780</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model.learn_null_model-1781"><a href="#Noise_Model.learn_null_model-1781"><span class="linenos">1781</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Noise_Model.learn_null_model-1782"><a href="#Noise_Model.learn_null_model-1782"><span class="linenos">1782</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model.learn_null_model-1783"><a href="#Noise_Model.learn_null_model-1783"><span class="linenos">1783</span></a>
</span><span id="Noise_Model.learn_null_model-1784"><a href="#Noise_Model.learn_null_model-1784"><span class="linenos">1784</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter_labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">),</span> <span class="s2">&quot;number of model and initial paras differ!&quot;</span>
</span><span id="Noise_Model.learn_null_model-1785"><a href="#Noise_Model.learn_null_model-1785"><span class="linenos">1785</span></a>
</span><span id="Noise_Model.learn_null_model-1786"><a href="#Noise_Model.learn_null_model-1786"><span class="linenos">1786</span></a>        <span class="n">condict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nullmodel_constr_fn</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">constr_type</span><span class="p">)}</span>
</span><span id="Noise_Model.learn_null_model-1787"><a href="#Noise_Model.learn_null_model-1787"><span class="linenos">1787</span></a>
</span><span id="Noise_Model.learn_null_model-1788"><a href="#Noise_Model.learn_null_model-1788"><span class="linenos">1788</span></a>
</span><span id="Noise_Model.learn_null_model-1789"><a href="#Noise_Model.learn_null_model-1789"><span class="linenos">1789</span></a>        <span class="n">partialobjfunc</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_Pn1n2</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="o">=</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="o">=</span><span class="n">noise_model</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1790"><a href="#Noise_Model.learn_null_model-1790"><span class="linenos">1790</span></a>        <span class="n">nullfunctol</span> <span class="o">=</span> <span class="mf">1e-6</span>
</span><span id="Noise_Model.learn_null_model-1791"><a href="#Noise_Model.learn_null_model-1791"><span class="linenos">1791</span></a>        <span class="n">nullmaxiter</span> <span class="o">=</span> <span class="mi">200</span>
</span><span id="Noise_Model.learn_null_model-1792"><a href="#Noise_Model.learn_null_model-1792"><span class="linenos">1792</span></a>        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Iter&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">parameter_labels</span>
</span><span id="Noise_Model.learn_null_model-1793"><a href="#Noise_Model.learn_null_model-1793"><span class="linenos">1793</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:9s} &#39;</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">))</span>
</span><span id="Noise_Model.learn_null_model-1794"><a href="#Noise_Model.learn_null_model-1794"><span class="linenos">1794</span></a>            
</span><span id="Noise_Model.learn_null_model-1795"><a href="#Noise_Model.learn_null_model-1795"><span class="linenos">1795</span></a>        <span class="k">global</span> <span class="n">curr_iter</span>
</span><span id="Noise_Model.learn_null_model-1796"><a href="#Noise_Model.learn_null_model-1796"><span class="linenos">1796</span></a>        <span class="n">curr_iter</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Noise_Model.learn_null_model-1797"><a href="#Noise_Model.learn_null_model-1797"><span class="linenos">1797</span></a>        <span class="n">callbackp</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">,</span> <span class="n">nparas</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">init_paras</span><span class="p">),</span> <span class="n">sparse_rep</span> <span class="o">=</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="o">=</span> <span class="n">noise_model</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1798"><a href="#Noise_Model.learn_null_model-1798"><span class="linenos">1798</span></a>        <span class="n">outstruct</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">partialobjfunc</span><span class="p">,</span> <span class="n">init_paras</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callbackp</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">condict</span><span class="p">,</span>
</span><span id="Noise_Model.learn_null_model-1799"><a href="#Noise_Model.learn_null_model-1799"><span class="linenos">1799</span></a>                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="n">nullfunctol</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">nullmaxiter</span><span class="p">})</span>
</span><span id="Noise_Model.learn_null_model-1800"><a href="#Noise_Model.learn_null_model-1800"><span class="linenos">1800</span></a>            
</span><span id="Noise_Model.learn_null_model-1801"><a href="#Noise_Model.learn_null_model-1801"><span class="linenos">1801</span></a>        <span class="n">constr_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nullmodel_constr_fn</span><span class="p">(</span><span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">constr_type</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1802"><a href="#Noise_Model.learn_null_model-1802"><span class="linenos">1802</span></a>
</span><span id="Noise_Model.learn_null_model-1803"><a href="#Noise_Model.learn_null_model-1803"><span class="linenos">1803</span></a>        <span class="k">if</span> <span class="n">noise_model</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model.learn_null_model-1804"><a href="#Noise_Model.learn_null_model-1804"><span class="linenos">1804</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;m_total&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model.learn_null_model-1805"><a href="#Noise_Model.learn_null_model-1805"><span class="linenos">1805</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="Noise_Model.learn_null_model-1806"><a href="#Noise_Model.learn_null_model-1806"><span class="linenos">1806</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1807"><a href="#Noise_Model.learn_null_model-1807"><span class="linenos">1807</span></a>        <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Noise_Model.learn_null_model-1808"><a href="#Noise_Model.learn_null_model-1808"><span class="linenos">1808</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model.learn_null_model-1809"><a href="#Noise_Model.learn_null_model-1809"><span class="linenos">1809</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="Noise_Model.learn_null_model-1810"><a href="#Noise_Model.learn_null_model-1810"><span class="linenos">1810</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1811"><a href="#Noise_Model.learn_null_model-1811"><span class="linenos">1811</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Noise_Model.learn_null_model-1812"><a href="#Noise_Model.learn_null_model-1812"><span class="linenos">1812</span></a>            <span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alph_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;fmin&#39;</span><span class="p">]</span>
</span><span id="Noise_Model.learn_null_model-1813"><a href="#Noise_Model.learn_null_model-1813"><span class="linenos">1813</span></a>            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span> <span class="p">:</span> <span class="n">parameter_labels</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">}</span>
</span><span id="Noise_Model.learn_null_model-1814"><a href="#Noise_Model.learn_null_model-1814"><span class="linenos">1814</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1815"><a href="#Noise_Model.learn_null_model-1815"><span class="linenos">1815</span></a>
</span><span id="Noise_Model.learn_null_model-1816"><a href="#Noise_Model.learn_null_model-1816"><span class="linenos">1816</span></a>
</span><span id="Noise_Model.learn_null_model-1817"><a href="#Noise_Model.learn_null_model-1817"><span class="linenos">1817</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">output_dir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Noise_Model.learn_null_model-1818"><a href="#Noise_Model.learn_null_model-1818"><span class="linenos">1818</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;nullpara&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">noise_model</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1819"><a href="#Noise_Model.learn_null_model-1819"><span class="linenos">1819</span></a>
</span><span id="Noise_Model.learn_null_model-1820"><a href="#Noise_Model.learn_null_model-1820"><span class="linenos">1820</span></a>        <span class="k">elif</span> <span class="p">(</span><span class="n">output_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Noise_Model.learn_null_model-1821"><a href="#Noise_Model.learn_null_model-1821"><span class="linenos">1821</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;/nullpara&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">noise_model</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1822"><a href="#Noise_Model.learn_null_model-1822"><span class="linenos">1822</span></a>
</span><span id="Noise_Model.learn_null_model-1823"><a href="#Noise_Model.learn_null_model-1823"><span class="linenos">1823</span></a>        <span class="k">else</span> <span class="p">:</span>
</span><span id="Noise_Model.learn_null_model-1824"><a href="#Noise_Model.learn_null_model-1824"><span class="linenos">1824</span></a>            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Noise_Model.learn_null_model-1825"><a href="#Noise_Model.learn_null_model-1825"><span class="linenos">1825</span></a>
</span><span id="Noise_Model.learn_null_model-1826"><a href="#Noise_Model.learn_null_model-1826"><span class="linenos">1826</span></a>        <span class="k">return</span> <span class="n">outstruct</span><span class="p">,</span> <span class="n">constr_value</span>
</span></pre></div>


            <div class="docstring"><h6 id="parameters">Parameters</h6>

<ul>
<li><strong>df</strong> (pandas data frame):
data-frame which is the output of the method .import_data() for one Data_Process instance.
these data-frame should give the list of TCR clones present in two replicates RepSeq samples
associated to their clone frequencies and clone abundances in the first and second replicate.</li>
<li><strong>noise_model</strong> (numpy array):
choice of noise model</li>
<li><strong>init_paras</strong> (numpy array):
initial vector of parameters to start the optimization of the model from data (df)</li>
<li><strong>output_dir</strong> (str):
default value is None, it is the output directory name i which we want to save the values of the parameters</li>
<li><strong>display_loss_function</strong> (bool):
boolean variable to chose if we want to print the loss function during the experimental noise learning, default value is 
None.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>outstruct</strong>: numpy array parameters of the noise model</li>
<li><strong>constr_value</strong>: float, value of the constraint</li>
</ul>
</div>


                            </div>
                            <div id="Noise_Model.diversity_estimate" class="classattr">
                                        <input id="Noise_Model.diversity_estimate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">diversity_estimate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">df</span>, </span><span class="param"><span class="n">paras</span>, </span><span class="param"><span class="n">noise_model</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Noise_Model.diversity_estimate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Noise_Model.diversity_estimate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Noise_Model.diversity_estimate-1828"><a href="#Noise_Model.diversity_estimate-1828"><span class="linenos">1828</span></a>    <span class="k">def</span> <span class="nf">diversity_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">):</span>
</span><span id="Noise_Model.diversity_estimate-1829"><a href="#Noise_Model.diversity_estimate-1829"><span class="linenos">1829</span></a>
</span><span id="Noise_Model.diversity_estimate-1830"><a href="#Noise_Model.diversity_estimate-1830"><span class="linenos">1830</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Noise_Model.diversity_estimate-1831"><a href="#Noise_Model.diversity_estimate-1831"><span class="linenos">1831</span></a><span class="sd">        Estimate diversity of the individual repertoire from the experimental noise learning step. </span>
</span><span id="Noise_Model.diversity_estimate-1832"><a href="#Noise_Model.diversity_estimate-1832"><span class="linenos">1832</span></a>
</span><span id="Noise_Model.diversity_estimate-1833"><a href="#Noise_Model.diversity_estimate-1833"><span class="linenos">1833</span></a><span class="sd">        Parameters</span>
</span><span id="Noise_Model.diversity_estimate-1834"><a href="#Noise_Model.diversity_estimate-1834"><span class="linenos">1834</span></a><span class="sd">        ----------</span>
</span><span id="Noise_Model.diversity_estimate-1835"><a href="#Noise_Model.diversity_estimate-1835"><span class="linenos">1835</span></a><span class="sd">        df : data-frame </span>
</span><span id="Noise_Model.diversity_estimate-1836"><a href="#Noise_Model.diversity_estimate-1836"><span class="linenos">1836</span></a><span class="sd">            The data-frame which has been used to learn the noise model</span>
</span><span id="Noise_Model.diversity_estimate-1837"><a href="#Noise_Model.diversity_estimate-1837"><span class="linenos">1837</span></a><span class="sd">        paras : numpy array</span>
</span><span id="Noise_Model.diversity_estimate-1838"><a href="#Noise_Model.diversity_estimate-1838"><span class="linenos">1838</span></a><span class="sd">            vector containing the noise parameters</span>
</span><span id="Noise_Model.diversity_estimate-1839"><a href="#Noise_Model.diversity_estimate-1839"><span class="linenos">1839</span></a><span class="sd">        noise_model : int</span>
</span><span id="Noise_Model.diversity_estimate-1840"><a href="#Noise_Model.diversity_estimate-1840"><span class="linenos">1840</span></a><span class="sd">            choice of noise model </span>
</span><span id="Noise_Model.diversity_estimate-1841"><a href="#Noise_Model.diversity_estimate-1841"><span class="linenos">1841</span></a>
</span><span id="Noise_Model.diversity_estimate-1842"><a href="#Noise_Model.diversity_estimate-1842"><span class="linenos">1842</span></a><span class="sd">        Returns</span>
</span><span id="Noise_Model.diversity_estimate-1843"><a href="#Noise_Model.diversity_estimate-1843"><span class="linenos">1843</span></a><span class="sd">        -------</span>
</span><span id="Noise_Model.diversity_estimate-1844"><a href="#Noise_Model.diversity_estimate-1844"><span class="linenos">1844</span></a><span class="sd">        diversity_estimate</span>
</span><span id="Noise_Model.diversity_estimate-1845"><a href="#Noise_Model.diversity_estimate-1845"><span class="linenos">1845</span></a><span class="sd">            float, diversity estimate from the noise model inference.</span>
</span><span id="Noise_Model.diversity_estimate-1846"><a href="#Noise_Model.diversity_estimate-1846"><span class="linenos">1846</span></a><span class="sd">    </span>
</span><span id="Noise_Model.diversity_estimate-1847"><a href="#Noise_Model.diversity_estimate-1847"><span class="linenos">1847</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Noise_Model.diversity_estimate-1848"><a href="#Noise_Model.diversity_estimate-1848"><span class="linenos">1848</span></a>
</span><span id="Noise_Model.diversity_estimate-1849"><a href="#Noise_Model.diversity_estimate-1849"><span class="linenos">1849</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="Noise_Model.diversity_estimate-1850"><a href="#Noise_Model.diversity_estimate-1850"><span class="linenos">1850</span></a>
</span><span id="Noise_Model.diversity_estimate-1851"><a href="#Noise_Model.diversity_estimate-1851"><span class="linenos">1851</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="Noise_Model.diversity_estimate-1852"><a href="#Noise_Model.diversity_estimate-1852"><span class="linenos">1852</span></a>            
</span><span id="Noise_Model.diversity_estimate-1853"><a href="#Noise_Model.diversity_estimate-1853"><span class="linenos">1853</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span>
</span><span id="Noise_Model.diversity_estimate-1854"><a href="#Noise_Model.diversity_estimate-1854"><span class="linenos">1854</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="nb">float</span>
</span><span id="Noise_Model.diversity_estimate-1855"><a href="#Noise_Model.diversity_estimate-1855"><span class="linenos">1855</span></a>
</span><span id="Noise_Model.diversity_estimate-1856"><a href="#Noise_Model.diversity_estimate-1856"><span class="linenos">1856</span></a>        <span class="c1"># Parameters</span>
</span><span id="Noise_Model.diversity_estimate-1857"><a href="#Noise_Model.diversity_estimate-1857"><span class="linenos">1857</span></a>
</span><span id="Noise_Model.diversity_estimate-1858"><a href="#Noise_Model.diversity_estimate-1858"><span class="linenos">1858</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Noise_Model.diversity_estimate-1859"><a href="#Noise_Model.diversity_estimate-1859"><span class="linenos">1859</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Noise_Model.diversity_estimate-1860"><a href="#Noise_Model.diversity_estimate-1860"><span class="linenos">1860</span></a>
</span><span id="Noise_Model.diversity_estimate-1861"><a href="#Noise_Model.diversity_estimate-1861"><span class="linenos">1861</span></a>        <span class="c1"># </span>
</span><span id="Noise_Model.diversity_estimate-1862"><a href="#Noise_Model.diversity_estimate-1862"><span class="linenos">1862</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span><span class="p">,</span> <span class="n">normconst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Noise_Model.diversity_estimate-1863"><a href="#Noise_Model.diversity_estimate-1863"><span class="linenos">1863</span></a>
</span><span id="Noise_Model.diversity_estimate-1864"><a href="#Noise_Model.diversity_estimate-1864"><span class="linenos">1864</span></a>        <span class="c1"># </span>
</span><span id="Noise_Model.diversity_estimate-1865"><a href="#Noise_Model.diversity_estimate-1865"><span class="linenos">1865</span></a>
</span><span id="Noise_Model.diversity_estimate-1866"><a href="#Noise_Model.diversity_estimate-1866"><span class="linenos">1866</span></a>        <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model.diversity_estimate-1867"><a href="#Noise_Model.diversity_estimate-1867"><span class="linenos">1867</span></a>
</span><span id="Noise_Model.diversity_estimate-1868"><a href="#Noise_Model.diversity_estimate-1868"><span class="linenos">1868</span></a>        <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Noise_Model.diversity_estimate-1869"><a href="#Noise_Model.diversity_estimate-1869"><span class="linenos">1869</span></a>        <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span><span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Noise_Model.diversity_estimate-1870"><a href="#Noise_Model.diversity_estimate-1870"><span class="linenos">1870</span></a>
</span><span id="Noise_Model.diversity_estimate-1871"><a href="#Noise_Model.diversity_estimate-1871"><span class="linenos">1871</span></a>        <span class="c1"># for the trapezoid integral methods</span>
</span><span id="Noise_Model.diversity_estimate-1872"><a href="#Noise_Model.diversity_estimate-1872"><span class="linenos">1872</span></a>
</span><span id="Noise_Model.diversity_estimate-1873"><a href="#Noise_Model.diversity_estimate-1873"><span class="linenos">1873</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="Noise_Model.diversity_estimate-1874"><a href="#Noise_Model.diversity_estimate-1874"><span class="linenos">1874</span></a>
</span><span id="Noise_Model.diversity_estimate-1875"><a href="#Noise_Model.diversity_estimate-1875"><span class="linenos">1875</span></a>        <span class="c1"># Compute P(0,0) for the normalization constraint</span>
</span><span id="Noise_Model.diversity_estimate-1876"><a href="#Noise_Model.diversity_estimate-1876"><span class="linenos">1876</span></a>        <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span> <span class="o">+</span> <span class="n">logPn2_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logPn1_f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">logfvec</span><span class="p">)</span>
</span><span id="Noise_Model.diversity_estimate-1877"><a href="#Noise_Model.diversity_estimate-1877"><span class="linenos">1877</span></a>        <span class="n">Pn0n0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span> <span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Noise_Model.diversity_estimate-1878"><a href="#Noise_Model.diversity_estimate-1878"><span class="linenos">1878</span></a>
</span><span id="Noise_Model.diversity_estimate-1879"><a href="#Noise_Model.diversity_estimate-1879"><span class="linenos">1879</span></a>        <span class="c1">#print(np.sum(sparse_rep_counts))</span>
</span><span id="Noise_Model.diversity_estimate-1880"><a href="#Noise_Model.diversity_estimate-1880"><span class="linenos">1880</span></a>        <span class="n">N_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)</span>
</span><span id="Noise_Model.diversity_estimate-1881"><a href="#Noise_Model.diversity_estimate-1881"><span class="linenos">1881</span></a>
</span><span id="Noise_Model.diversity_estimate-1882"><a href="#Noise_Model.diversity_estimate-1882"><span class="linenos">1882</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_obs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn0n0</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Estimate diversity of the individual repertoire from the experimental noise learning step. </p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>df</strong> (data-frame):
The data-frame which has been used to learn the noise model</li>
<li><strong>paras</strong> (numpy array):
vector containing the noise parameters</li>
<li><strong>noise_model</strong> (int):
choice of noise model</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>diversity_estimate</strong>: float, diversity estimate from the noise model inference.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="Expansion_Model">
                            <input id="Expansion_Model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Expansion_Model</span>:

                <label class="view-source-button" for="Expansion_Model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Expansion_Model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Expansion_Model-1887"><a href="#Expansion_Model-1887"><span class="linenos">1887</span></a><span class="k">class</span> <span class="nc">Expansion_Model</span><span class="p">():</span>
</span><span id="Expansion_Model-1888"><a href="#Expansion_Model-1888"><span class="linenos">1888</span></a>    
</span><span id="Expansion_Model-1889"><a href="#Expansion_Model-1889"><span class="linenos">1889</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Expansion_Model-1890"><a href="#Expansion_Model-1890"><span class="linenos">1890</span></a><span class="sd">    A class used to build an object associated to methods in order to select significant expanding or </span>
</span><span id="Expansion_Model-1891"><a href="#Expansion_Model-1891"><span class="linenos">1891</span></a><span class="sd">    contracting clones from RepSeq samples taken at two different time points.</span>
</span><span id="Expansion_Model-1892"><a href="#Expansion_Model-1892"><span class="linenos">1892</span></a>
</span><span id="Expansion_Model-1893"><a href="#Expansion_Model-1893"><span class="linenos">1893</span></a><span class="sd">    ...</span>
</span><span id="Expansion_Model-1894"><a href="#Expansion_Model-1894"><span class="linenos">1894</span></a>
</span><span id="Expansion_Model-1895"><a href="#Expansion_Model-1895"><span class="linenos">1895</span></a><span class="sd">    Methods</span>
</span><span id="Expansion_Model-1896"><a href="#Expansion_Model-1896"><span class="linenos">1896</span></a><span class="sd">    -------</span>
</span><span id="Expansion_Model-1897"><a href="#Expansion_Model-1897"><span class="linenos">1897</span></a>
</span><span id="Expansion_Model-1898"><a href="#Expansion_Model-1898"><span class="linenos">1898</span></a><span class="sd">    get_sparserep(df) :</span>
</span><span id="Expansion_Model-1899"><a href="#Expansion_Model-1899"><span class="linenos">1899</span></a><span class="sd">        get sparse representation of the abundances / frequencies of the TCR clones present in RepSeq samples of both time points.</span>
</span><span id="Expansion_Model-1900"><a href="#Expansion_Model-1900"><span class="linenos">1900</span></a><span class="sd">        This changes the data input to fasten the algorithm</span>
</span><span id="Expansion_Model-1901"><a href="#Expansion_Model-1901"><span class="linenos">1901</span></a>
</span><span id="Expansion_Model-1902"><a href="#Expansion_Model-1902"><span class="linenos">1902</span></a><span class="sd">    expansion_table(outpath, paras_1, paras_2, df, noise_model, pval_threshold, smed_threshold):</span>
</span><span id="Expansion_Model-1903"><a href="#Expansion_Model-1903"><span class="linenos">1903</span></a><span class="sd">        generate the table of clones that have been significantly detected to be responsive to an acute stimuli.</span>
</span><span id="Expansion_Model-1904"><a href="#Expansion_Model-1904"><span class="linenos">1904</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Expansion_Model-1905"><a href="#Expansion_Model-1905"><span class="linenos">1905</span></a>
</span><span id="Expansion_Model-1906"><a href="#Expansion_Model-1906"><span class="linenos">1906</span></a>
</span><span id="Expansion_Model-1907"><a href="#Expansion_Model-1907"><span class="linenos">1907</span></a>    <span class="k">def</span> <span class="nf">get_sparserep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span> 
</span><span id="Expansion_Model-1908"><a href="#Expansion_Model-1908"><span class="linenos">1908</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Expansion_Model-1909"><a href="#Expansion_Model-1909"><span class="linenos">1909</span></a><span class="sd">        Tranforms {(n1,n2)} data stored in pandas dataframe to a sparse 1D representation.</span>
</span><span id="Expansion_Model-1910"><a href="#Expansion_Model-1910"><span class="linenos">1910</span></a><span class="sd">        unicountvals_1(2) are the unique values of n1(2).</span>
</span><span id="Expansion_Model-1911"><a href="#Expansion_Model-1911"><span class="linenos">1911</span></a><span class="sd">        sparse_rep_counts gives the counts of unique pairs.</span>
</span><span id="Expansion_Model-1912"><a href="#Expansion_Model-1912"><span class="linenos">1912</span></a><span class="sd">        ndn1(2) is the index of unicountvals_1(2) giving the value of n1(2) in that unique pair.</span>
</span><span id="Expansion_Model-1913"><a href="#Expansion_Model-1913"><span class="linenos">1913</span></a><span class="sd">        len(indn1)=len(indn2)=len(sparse_rep_counts)</span>
</span><span id="Expansion_Model-1914"><a href="#Expansion_Model-1914"><span class="linenos">1914</span></a>
</span><span id="Expansion_Model-1915"><a href="#Expansion_Model-1915"><span class="linenos">1915</span></a>
</span><span id="Expansion_Model-1916"><a href="#Expansion_Model-1916"><span class="linenos">1916</span></a><span class="sd">        Parameters</span>
</span><span id="Expansion_Model-1917"><a href="#Expansion_Model-1917"><span class="linenos">1917</span></a><span class="sd">        ----------</span>
</span><span id="Expansion_Model-1918"><a href="#Expansion_Model-1918"><span class="linenos">1918</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="Expansion_Model-1919"><a href="#Expansion_Model-1919"><span class="linenos">1919</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="Expansion_Model-1920"><a href="#Expansion_Model-1920"><span class="linenos">1920</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two RepSeq samples, talen at two </span>
</span><span id="Expansion_Model-1921"><a href="#Expansion_Model-1921"><span class="linenos">1921</span></a><span class="sd">            different time points, associated to their clone frequencies and clone abundances in the first and second replicate?</span>
</span><span id="Expansion_Model-1922"><a href="#Expansion_Model-1922"><span class="linenos">1922</span></a>
</span><span id="Expansion_Model-1923"><a href="#Expansion_Model-1923"><span class="linenos">1923</span></a>
</span><span id="Expansion_Model-1924"><a href="#Expansion_Model-1924"><span class="linenos">1924</span></a><span class="sd">        Returns</span>
</span><span id="Expansion_Model-1925"><a href="#Expansion_Model-1925"><span class="linenos">1925</span></a><span class="sd">        -------</span>
</span><span id="Expansion_Model-1926"><a href="#Expansion_Model-1926"><span class="linenos">1926</span></a><span class="sd">        indn1</span>
</span><span id="Expansion_Model-1927"><a href="#Expansion_Model-1927"><span class="linenos">1927</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_1</span>
</span><span id="Expansion_Model-1928"><a href="#Expansion_Model-1928"><span class="linenos">1928</span></a>
</span><span id="Expansion_Model-1929"><a href="#Expansion_Model-1929"><span class="linenos">1929</span></a><span class="sd">        indn2</span>
</span><span id="Expansion_Model-1930"><a href="#Expansion_Model-1930"><span class="linenos">1930</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_2</span>
</span><span id="Expansion_Model-1931"><a href="#Expansion_Model-1931"><span class="linenos">1931</span></a>
</span><span id="Expansion_Model-1932"><a href="#Expansion_Model-1932"><span class="linenos">1932</span></a><span class="sd">        sparse_rep_counts</span>
</span><span id="Expansion_Model-1933"><a href="#Expansion_Model-1933"><span class="linenos">1933</span></a><span class="sd">            numpy array, # of clones having the read counts pair {(n1,n2)} </span>
</span><span id="Expansion_Model-1934"><a href="#Expansion_Model-1934"><span class="linenos">1934</span></a>
</span><span id="Expansion_Model-1935"><a href="#Expansion_Model-1935"><span class="linenos">1935</span></a><span class="sd">        unicountvals_1</span>
</span><span id="Expansion_Model-1936"><a href="#Expansion_Model-1936"><span class="linenos">1936</span></a><span class="sd">            numpy array list of unique counts values present in the first sample in df[clone_count_1]</span>
</span><span id="Expansion_Model-1937"><a href="#Expansion_Model-1937"><span class="linenos">1937</span></a>
</span><span id="Expansion_Model-1938"><a href="#Expansion_Model-1938"><span class="linenos">1938</span></a><span class="sd">        unicountvals_2</span>
</span><span id="Expansion_Model-1939"><a href="#Expansion_Model-1939"><span class="linenos">1939</span></a><span class="sd">            numpy array list of unique counts values present in the second sample in df[clone_count_2]</span>
</span><span id="Expansion_Model-1940"><a href="#Expansion_Model-1940"><span class="linenos">1940</span></a>
</span><span id="Expansion_Model-1941"><a href="#Expansion_Model-1941"><span class="linenos">1941</span></a><span class="sd">        Nreads1</span>
</span><span id="Expansion_Model-1942"><a href="#Expansion_Model-1942"><span class="linenos">1942</span></a><span class="sd">            float, total number of counts/reads in the first sample referred in df by &quot;_1&quot; for first time point</span>
</span><span id="Expansion_Model-1943"><a href="#Expansion_Model-1943"><span class="linenos">1943</span></a>
</span><span id="Expansion_Model-1944"><a href="#Expansion_Model-1944"><span class="linenos">1944</span></a><span class="sd">        Nreads2</span>
</span><span id="Expansion_Model-1945"><a href="#Expansion_Model-1945"><span class="linenos">1945</span></a><span class="sd">            float, total number of counts/reads in the second sample referred in df by &quot;_2&quot; for second time point</span>
</span><span id="Expansion_Model-1946"><a href="#Expansion_Model-1946"><span class="linenos">1946</span></a>
</span><span id="Expansion_Model-1947"><a href="#Expansion_Model-1947"><span class="linenos">1947</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Expansion_Model-1948"><a href="#Expansion_Model-1948"><span class="linenos">1948</span></a>        
</span><span id="Expansion_Model-1949"><a href="#Expansion_Model-1949"><span class="linenos">1949</span></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]]</span>
</span><span id="Expansion_Model-1950"><a href="#Expansion_Model-1950"><span class="linenos">1950</span></a>        <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;paircount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># gives a weight of 1 to each observed clone</span>
</span><span id="Expansion_Model-1951"><a href="#Expansion_Model-1951"><span class="linenos">1951</span></a>
</span><span id="Expansion_Model-1952"><a href="#Expansion_Model-1952"><span class="linenos">1952</span></a>        <span class="n">clone_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Expansion_Model-1953"><a href="#Expansion_Model-1953"><span class="linenos">1953</span></a>        <span class="n">sparse_rep_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clone_counts</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model-1954"><a href="#Expansion_Model-1954"><span class="linenos">1954</span></a>        <span class="n">clonecountpair_vals</span> <span class="o">=</span> <span class="n">clone_counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="Expansion_Model-1955"><a href="#Expansion_Model-1955"><span class="linenos">1955</span></a>        <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model-1956"><a href="#Expansion_Model-1956"><span class="linenos">1956</span></a>        <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model-1957"><a href="#Expansion_Model-1957"><span class="linenos">1957</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="Expansion_Model-1958"><a href="#Expansion_Model-1958"><span class="linenos">1958</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="Expansion_Model-1959"><a href="#Expansion_Model-1959"><span class="linenos">1959</span></a>
</span><span id="Expansion_Model-1960"><a href="#Expansion_Model-1960"><span class="linenos">1960</span></a>        <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Expansion_Model-1961"><a href="#Expansion_Model-1961"><span class="linenos">1961</span></a>        <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn2</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Expansion_Model-1962"><a href="#Expansion_Model-1962"><span class="linenos">1962</span></a>
</span><span id="Expansion_Model-1963"><a href="#Expansion_Model-1963"><span class="linenos">1963</span></a>        <span class="k">return</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span>
</span><span id="Expansion_Model-1964"><a href="#Expansion_Model-1964"><span class="linenos">1964</span></a>
</span><span id="Expansion_Model-1965"><a href="#Expansion_Model-1965"><span class="linenos">1965</span></a>    
</span><span id="Expansion_Model-1966"><a href="#Expansion_Model-1966"><span class="linenos">1966</span></a>
</span><span id="Expansion_Model-1967"><a href="#Expansion_Model-1967"><span class="linenos">1967</span></a>    <span class="k">def</span> <span class="nf">_NegBinPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">mvec</span><span class="p">):</span> 
</span><span id="Expansion_Model-1968"><a href="#Expansion_Model-1968"><span class="linenos">1968</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Expansion_Model-1969"><a href="#Expansion_Model-1969"><span class="linenos">1969</span></a><span class="sd">        Same as NegBinParMtr, but for m and v being scalars.</span>
</span><span id="Expansion_Model-1970"><a href="#Expansion_Model-1970"><span class="linenos">1970</span></a><span class="sd">        Assumes m&gt;0.</span>
</span><span id="Expansion_Model-1971"><a href="#Expansion_Model-1971"><span class="linenos">1971</span></a><span class="sd">        Output is (len(mvec),) array</span>
</span><span id="Expansion_Model-1972"><a href="#Expansion_Model-1972"><span class="linenos">1972</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Expansion_Model-1973"><a href="#Expansion_Model-1973"><span class="linenos">1973</span></a>        <span class="n">mmax</span><span class="o">=</span><span class="n">mvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Expansion_Model-1974"><a href="#Expansion_Model-1974"><span class="linenos">1974</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="Expansion_Model-1975"><a href="#Expansion_Model-1975"><span class="linenos">1975</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">p</span>
</span><span id="Expansion_Model-1976"><a href="#Expansion_Model-1976"><span class="linenos">1976</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>   
</span><span id="Expansion_Model-1977"><a href="#Expansion_Model-1977"><span class="linenos">1977</span></a>        <span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">NBvec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="c1">#vectorization won&#39;t help unfortuneately here since log needs to be over array</span>
</span><span id="Expansion_Model-1978"><a href="#Expansion_Model-1978"><span class="linenos">1978</span></a>        <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="p">)</span>
</span><span id="Expansion_Model-1979"><a href="#Expansion_Model-1979"><span class="linenos">1979</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">NBvec</span><span class="p">)[</span><span class="n">mvec</span><span class="p">])</span> <span class="c1">#save a bit here</span>
</span><span id="Expansion_Model-1980"><a href="#Expansion_Model-1980"><span class="linenos">1980</span></a>        <span class="k">return</span> <span class="n">NBvec</span>
</span><span id="Expansion_Model-1981"><a href="#Expansion_Model-1981"><span class="linenos">1981</span></a>
</span><span id="Expansion_Model-1982"><a href="#Expansion_Model-1982"><span class="linenos">1982</span></a>
</span><span id="Expansion_Model-1983"><a href="#Expansion_Model-1983"><span class="linenos">1983</span></a>    <span class="k">def</span> <span class="nf">_NegBinParMtr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">nvec</span><span class="p">):</span> <span class="c1">#speed up only insofar as the log and exp are called once on array instead of multiple times on rows</span>
</span><span id="Expansion_Model-1984"><a href="#Expansion_Model-1984"><span class="linenos">1984</span></a>        <span class="sd">&#39;&#39;&#39; </span>
</span><span id="Expansion_Model-1985"><a href="#Expansion_Model-1985"><span class="linenos">1985</span></a><span class="sd">        computes NegBin probabilities over the ordered (but possibly discontiguous) vector (nvec) </span>
</span><span id="Expansion_Model-1986"><a href="#Expansion_Model-1986"><span class="linenos">1986</span></a><span class="sd">        for mean/variance combinations given by the mean (m) and variance (v) vectors. </span>
</span><span id="Expansion_Model-1987"><a href="#Expansion_Model-1987"><span class="linenos">1987</span></a><span class="sd">        Note that m&lt;v for negative binomial.</span>
</span><span id="Expansion_Model-1988"><a href="#Expansion_Model-1988"><span class="linenos">1988</span></a><span class="sd">        Output is (len(m),len(nvec)) array</span>
</span><span id="Expansion_Model-1989"><a href="#Expansion_Model-1989"><span class="linenos">1989</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Expansion_Model-1990"><a href="#Expansion_Model-1990"><span class="linenos">1990</span></a>        <span class="n">nmax</span><span class="o">=</span><span class="n">nvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Expansion_Model-1991"><a href="#Expansion_Model-1991"><span class="linenos">1991</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="o">/</span><span class="n">v</span>
</span><span id="Expansion_Model-1992"><a href="#Expansion_Model-1992"><span class="linenos">1992</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">p</span>
</span><span id="Expansion_Model-1993"><a href="#Expansion_Model-1993"><span class="linenos">1993</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</span><span id="Expansion_Model-1994"><a href="#Expansion_Model-1994"><span class="linenos">1994</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">NBvec</span><span class="o">+</span><span class="n">r</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">/</span><span class="n">NBvec</span><span class="p">))</span>
</span><span id="Expansion_Model-1995"><a href="#Expansion_Model-1995"><span class="linenos">1995</span></a>        <span class="n">NBvec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="p">)</span> <span class="c1">#handle NBvec[0]=0, treated specially when m[0]=0, see below</span>
</span><span id="Expansion_Model-1996"><a href="#Expansion_Model-1996"><span class="linenos">1996</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">NBvec</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c1">#save a bit here</span>
</span><span id="Expansion_Model-1997"><a href="#Expansion_Model-1997"><span class="linenos">1997</span></a>        <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Expansion_Model-1998"><a href="#Expansion_Model-1998"><span class="linenos">1998</span></a>            <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="mf">0.</span>
</span><span id="Expansion_Model-1999"><a href="#Expansion_Model-1999"><span class="linenos">1999</span></a>            <span class="n">NBvec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span>
</span><span id="Expansion_Model-2000"><a href="#Expansion_Model-2000"><span class="linenos">2000</span></a>        <span class="n">NBvec</span><span class="o">=</span><span class="n">NBvec</span><span class="p">[:,</span><span class="n">nvec</span><span class="p">]</span>
</span><span id="Expansion_Model-2001"><a href="#Expansion_Model-2001"><span class="linenos">2001</span></a>        <span class="k">return</span> <span class="n">NBvec</span>
</span><span id="Expansion_Model-2002"><a href="#Expansion_Model-2002"><span class="linenos">2002</span></a>
</span><span id="Expansion_Model-2003"><a href="#Expansion_Model-2003"><span class="linenos">2003</span></a>    <span class="k">def</span> <span class="nf">_PoisPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Mvec</span><span class="p">,</span><span class="n">unicountvals</span><span class="p">):</span>
</span><span id="Expansion_Model-2004"><a href="#Expansion_Model-2004"><span class="linenos">2004</span></a>        <span class="c1">#assert Mvec[0]==0, &quot;first element needs to be zero&quot;</span>
</span><span id="Expansion_Model-2005"><a href="#Expansion_Model-2005"><span class="linenos">2005</span></a>        <span class="n">nmax</span><span class="o">=</span><span class="n">unicountvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Expansion_Model-2006"><a href="#Expansion_Model-2006"><span class="linenos">2006</span></a>        <span class="n">nlen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unicountvals</span><span class="p">)</span>
</span><span id="Expansion_Model-2007"><a href="#Expansion_Model-2007"><span class="linenos">2007</span></a>        <span class="n">mlen</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">Mvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2008"><a href="#Expansion_Model-2008"><span class="linenos">2008</span></a>        <span class="n">Nvec</span><span class="o">=</span><span class="n">unicountvals</span>
</span><span id="Expansion_Model-2009"><a href="#Expansion_Model-2009"><span class="linenos">2009</span></a>        <span class="n">logNvec</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">))),</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.</span><span class="p">)[</span><span class="n">unicountvals</span><span class="p">]</span> <span class="c1">#avoid n=0 nans  </span>
</span><span id="Expansion_Model-2010"><a href="#Expansion_Model-2010"><span class="linenos">2010</span></a>        <span class="n">Nmtr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Nvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Mvec</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">+</span><span class="n">logNvec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">-</span><span class="n">Mvec</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="c1"># np.log(Mvec) throws warning: since log(0)=-inf</span>
</span><span id="Expansion_Model-2011"><a href="#Expansion_Model-2011"><span class="linenos">2011</span></a>        <span class="k">if</span> <span class="n">Mvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Expansion_Model-2012"><a href="#Expansion_Model-2012"><span class="linenos">2012</span></a>            <span class="n">Nmtr</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlen</span><span class="p">,))</span> <span class="c1">#when m=0, n=0, and so get rid of nans from log(0)</span>
</span><span id="Expansion_Model-2013"><a href="#Expansion_Model-2013"><span class="linenos">2013</span></a>            <span class="n">Nmtr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span> <span class="c1">#handled belowacq_model_type</span>
</span><span id="Expansion_Model-2014"><a href="#Expansion_Model-2014"><span class="linenos">2014</span></a>        <span class="k">if</span> <span class="n">unicountvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#if n=0 included get rid of nans from log(0)</span>
</span><span id="Expansion_Model-2015"><a href="#Expansion_Model-2015"><span class="linenos">2015</span></a>            <span class="n">Nmtr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Mvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2016"><a href="#Expansion_Model-2016"><span class="linenos">2016</span></a>        <span class="k">return</span> <span class="n">Nmtr</span>
</span><span id="Expansion_Model-2017"><a href="#Expansion_Model-2017"><span class="linenos">2017</span></a>
</span><span id="Expansion_Model-2018"><a href="#Expansion_Model-2018"><span class="linenos">2018</span></a>    <span class="k">def</span> <span class="nf">_get_rhof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alpha_rho</span><span class="p">,</span> <span class="n">nfbins</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">freq_dtype</span><span class="p">):</span>
</span><span id="Expansion_Model-2019"><a href="#Expansion_Model-2019"><span class="linenos">2019</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2020"><a href="#Expansion_Model-2020"><span class="linenos">2020</span></a><span class="sd">        generates power law (power is alpha_rho) clone frequency distribution over </span>
</span><span id="Expansion_Model-2021"><a href="#Expansion_Model-2021"><span class="linenos">2021</span></a><span class="sd">        freq_nbins discrete logarithmically spaced frequences between fmin and 1 of dtype freq_dtype</span>
</span><span id="Expansion_Model-2022"><a href="#Expansion_Model-2022"><span class="linenos">2022</span></a><span class="sd">        Outputs log probabilities obtained at log frequencies&#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2023"><a href="#Expansion_Model-2023"><span class="linenos">2023</span></a>        <span class="n">fmax</span><span class="o">=</span><span class="mf">1e0</span>
</span><span id="Expansion_Model-2024"><a href="#Expansion_Model-2024"><span class="linenos">2024</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span> <span class="n">nfbins</span><span class="p">)</span>
</span><span id="Expansion_Model-2025"><a href="#Expansion_Model-2025"><span class="linenos">2025</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">logfvec</span><span class="p">))</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  
</span><span id="Expansion_Model-2026"><a href="#Expansion_Model-2026"><span class="linenos">2026</span></a>        <span class="n">logrhovec</span><span class="o">=</span><span class="n">logfvec</span><span class="o">*</span><span class="n">alpha_rho</span>
</span><span id="Expansion_Model-2027"><a href="#Expansion_Model-2027"><span class="linenos">2027</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhovec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Expansion_Model-2028"><a href="#Expansion_Model-2028"><span class="linenos">2028</span></a>        <span class="n">normconst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="Expansion_Model-2029"><a href="#Expansion_Model-2029"><span class="linenos">2029</span></a>        <span class="n">logrhovec</span><span class="o">-=</span><span class="n">normconst</span> 
</span><span id="Expansion_Model-2030"><a href="#Expansion_Model-2030"><span class="linenos">2030</span></a>        <span class="k">return</span> <span class="n">logrhovec</span><span class="p">,</span><span class="n">logfvec</span>
</span><span id="Expansion_Model-2031"><a href="#Expansion_Model-2031"><span class="linenos">2031</span></a>
</span><span id="Expansion_Model-2032"><a href="#Expansion_Model-2032"><span class="linenos">2032</span></a>    
</span><span id="Expansion_Model-2033"><a href="#Expansion_Model-2033"><span class="linenos">2033</span></a>    <span class="k">def</span> <span class="nf">_get_logPn_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unicounts</span><span class="p">,</span><span class="n">Nreads</span><span class="p">,</span><span class="n">logfvec</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">):</span>
</span><span id="Expansion_Model-2034"><a href="#Expansion_Model-2034"><span class="linenos">2034</span></a>
</span><span id="Expansion_Model-2035"><a href="#Expansion_Model-2035"><span class="linenos">2035</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Expansion_Model-2036"><a href="#Expansion_Model-2036"><span class="linenos">2036</span></a><span class="sd">        tools to compute the likelihood of the noise model. It is not useful for the user.</span>
</span><span id="Expansion_Model-2037"><a href="#Expansion_Model-2037"><span class="linenos">2037</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Expansion_Model-2038"><a href="#Expansion_Model-2038"><span class="linenos">2038</span></a>        
</span><span id="Expansion_Model-2039"><a href="#Expansion_Model-2039"><span class="linenos">2039</span></a>        <span class="c1"># Choice of the model:</span>
</span><span id="Expansion_Model-2040"><a href="#Expansion_Model-2040"><span class="linenos">2040</span></a>        
</span><span id="Expansion_Model-2041"><a href="#Expansion_Model-2041"><span class="linenos">2041</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Expansion_Model-2042"><a href="#Expansion_Model-2042"><span class="linenos">2042</span></a>
</span><span id="Expansion_Model-2043"><a href="#Expansion_Model-2043"><span class="linenos">2043</span></a>            <span class="n">m_total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> 
</span><span id="Expansion_Model-2044"><a href="#Expansion_Model-2044"><span class="linenos">2044</span></a>            <span class="n">r_c</span><span class="o">=</span><span class="n">Nreads</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="Expansion_Model-2045"><a href="#Expansion_Model-2045"><span class="linenos">2045</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="Expansion_Model-2046"><a href="#Expansion_Model-2046"><span class="linenos">2046</span></a>
</span><span id="Expansion_Model-2047"><a href="#Expansion_Model-2047"><span class="linenos">2047</span></a>            <span class="n">beta_mv</span><span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Expansion_Model-2048"><a href="#Expansion_Model-2048"><span class="linenos">2048</span></a>            <span class="n">alpha_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Expansion_Model-2049"><a href="#Expansion_Model-2049"><span class="linenos">2049</span></a>            
</span><span id="Expansion_Model-2050"><a href="#Expansion_Model-2050"><span class="linenos">2050</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#for models that include cell counts</span>
</span><span id="Expansion_Model-2051"><a href="#Expansion_Model-2051"><span class="linenos">2051</span></a>            <span class="c1">#compute parametrized range (mean-sigma,mean+5*sigma) of m values (number of cells) conditioned on n values (reads) appearing in the data only </span>
</span><span id="Expansion_Model-2052"><a href="#Expansion_Model-2052"><span class="linenos">2052</span></a>            <span class="n">nsigma</span><span class="o">=</span><span class="mf">5.</span>
</span><span id="Expansion_Model-2053"><a href="#Expansion_Model-2053"><span class="linenos">2053</span></a>            <span class="n">nmin</span><span class="o">=</span><span class="mf">300.</span>
</span><span id="Expansion_Model-2054"><a href="#Expansion_Model-2054"><span class="linenos">2054</span></a>            <span class="c1">#for each n, get actual range of m to compute around n-dependent mean m</span>
</span><span id="Expansion_Model-2055"><a href="#Expansion_Model-2055"><span class="linenos">2055</span></a>            <span class="n">m_low</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model-2056"><a href="#Expansion_Model-2056"><span class="linenos">2056</span></a>            <span class="n">m_high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model-2057"><a href="#Expansion_Model-2057"><span class="linenos">2057</span></a>            <span class="k">for</span> <span class="n">nit</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unicounts</span><span class="p">):</span>
</span><span id="Expansion_Model-2058"><a href="#Expansion_Model-2058"><span class="linenos">2058</span></a>                <span class="n">mean_m</span><span class="o">=</span><span class="n">n</span><span class="o">/</span><span class="n">r_c</span>
</span><span id="Expansion_Model-2059"><a href="#Expansion_Model-2059"><span class="linenos">2059</span></a>                <span class="n">dev</span><span class="o">=</span><span class="n">nsigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_m</span><span class="p">)</span>
</span><span id="Expansion_Model-2060"><a href="#Expansion_Model-2060"><span class="linenos">2060</span></a>                <span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span> <span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mean_m</span><span class="o">-</span>  <span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">mean_m</span><span class="o">&gt;</span><span class="n">dev</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>                         
</span><span id="Expansion_Model-2061"><a href="#Expansion_Model-2061"><span class="linenos">2061</span></a>                <span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">mean_m</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span>      <span class="n">n</span><span class="o">&gt;</span><span class="n">nmin</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">nmin</span><span class="o">/</span><span class="n">r_c</span><span class="p">)</span>
</span><span id="Expansion_Model-2062"><a href="#Expansion_Model-2062"><span class="linenos">2062</span></a>            <span class="n">m_cellmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">m_high</span><span class="p">)</span>
</span><span id="Expansion_Model-2063"><a href="#Expansion_Model-2063"><span class="linenos">2063</span></a>            <span class="c1">#across n, collect all in-range m</span>
</span><span id="Expansion_Model-2064"><a href="#Expansion_Model-2064"><span class="linenos">2064</span></a>            <span class="n">mvec_bool</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m_cellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1">#cheap bool</span>
</span><span id="Expansion_Model-2065"><a href="#Expansion_Model-2065"><span class="linenos">2065</span></a>            <span class="n">nvec</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">))</span>
</span><span id="Expansion_Model-2066"><a href="#Expansion_Model-2066"><span class="linenos">2066</span></a>            <span class="k">for</span> <span class="n">nit</span> <span class="ow">in</span> <span class="n">nvec</span><span class="p">:</span>
</span><span id="Expansion_Model-2067"><a href="#Expansion_Model-2067"><span class="linenos">2067</span></a>                <span class="n">mvec_bool</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>  <span class="c1">#mask vector</span>
</span><span id="Expansion_Model-2068"><a href="#Expansion_Model-2068"><span class="linenos">2068</span></a>            <span class="n">mvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_cellmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">mvec_bool</span><span class="p">]</span>                
</span><span id="Expansion_Model-2069"><a href="#Expansion_Model-2069"><span class="linenos">2069</span></a>            <span class="c1">#transform to in-range index</span>
</span><span id="Expansion_Model-2070"><a href="#Expansion_Model-2070"><span class="linenos">2070</span></a>            <span class="k">for</span> <span class="n">nit</span> <span class="ow">in</span> <span class="n">nvec</span><span class="p">:</span>
</span><span id="Expansion_Model-2071"><a href="#Expansion_Model-2071"><span class="linenos">2071</span></a>                <span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_low</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">==</span><span class="n">mvec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2072"><a href="#Expansion_Model-2072"><span class="linenos">2072</span></a>                <span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_high</span><span class="p">[</span><span class="n">nit</span><span class="p">]</span><span class="o">==</span><span class="n">mvec</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2073"><a href="#Expansion_Model-2073"><span class="linenos">2073</span></a>
</span><span id="Expansion_Model-2074"><a href="#Expansion_Model-2074"><span class="linenos">2074</span></a>        <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">unicounts</span><span class="p">)))</span>
</span><span id="Expansion_Model-2075"><a href="#Expansion_Model-2075"><span class="linenos">2075</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Expansion_Model-2076"><a href="#Expansion_Model-2076"><span class="linenos">2076</span></a>
</span><span id="Expansion_Model-2077"><a href="#Expansion_Model-2077"><span class="linenos">2077</span></a>            <span class="n">mean_m</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2078"><a href="#Expansion_Model-2078"><span class="linenos">2078</span></a>            <span class="n">var_m</span><span class="o">=</span><span class="n">mean_m</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_m</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Expansion_Model-2079"><a href="#Expansion_Model-2079"><span class="linenos">2079</span></a>            <span class="n">Poisvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PoisPar</span><span class="p">(</span><span class="n">mvec</span><span class="o">*</span><span class="n">r_c</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="Expansion_Model-2080"><a href="#Expansion_Model-2080"><span class="linenos">2080</span></a>            <span class="k">for</span> <span class="n">f_it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)):</span>
</span><span id="Expansion_Model-2081"><a href="#Expansion_Model-2081"><span class="linenos">2081</span></a>                <span class="n">NBvec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_NegBinPar</span><span class="p">(</span><span class="n">mean_m</span><span class="p">[</span><span class="n">f_it</span><span class="p">],</span><span class="n">var_m</span><span class="p">[</span><span class="n">f_it</span><span class="p">],</span><span class="n">mvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2082"><a href="#Expansion_Model-2082"><span class="linenos">2082</span></a>                <span class="k">for</span> <span class="n">n_it</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unicounts</span><span class="p">):</span>
</span><span id="Expansion_Model-2083"><a href="#Expansion_Model-2083"><span class="linenos">2083</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">f_it</span><span class="p">,</span><span class="n">n_it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">NBvec</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">n_it</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">n_it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Poisvec</span><span class="p">[</span><span class="n">m_low</span><span class="p">[</span><span class="n">n_it</span><span class="p">]:</span><span class="n">m_high</span><span class="p">[</span><span class="n">n_it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n_it</span><span class="p">])</span> 
</span><span id="Expansion_Model-2084"><a href="#Expansion_Model-2084"><span class="linenos">2084</span></a>        
</span><span id="Expansion_Model-2085"><a href="#Expansion_Model-2085"><span class="linenos">2085</span></a>        <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Expansion_Model-2086"><a href="#Expansion_Model-2086"><span class="linenos">2086</span></a>
</span><span id="Expansion_Model-2087"><a href="#Expansion_Model-2087"><span class="linenos">2087</span></a>            <span class="n">mean_n</span><span class="o">=</span><span class="n">Nreads</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2088"><a href="#Expansion_Model-2088"><span class="linenos">2088</span></a>            <span class="n">var_n</span><span class="o">=</span><span class="n">mean_n</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Expansion_Model-2089"><a href="#Expansion_Model-2089"><span class="linenos">2089</span></a>            <span class="n">Pn_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NegBinParMtr</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">var_n</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="Expansion_Model-2090"><a href="#Expansion_Model-2090"><span class="linenos">2090</span></a>        <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="Expansion_Model-2091"><a href="#Expansion_Model-2091"><span class="linenos">2091</span></a>
</span><span id="Expansion_Model-2092"><a href="#Expansion_Model-2092"><span class="linenos">2092</span></a>            <span class="n">mean_n</span><span class="o">=</span><span class="n">Nreads</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2093"><a href="#Expansion_Model-2093"><span class="linenos">2093</span></a>            <span class="n">Pn_f</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PoisPar</span><span class="p">(</span><span class="n">mean_n</span><span class="p">,</span><span class="n">unicounts</span><span class="p">)</span>
</span><span id="Expansion_Model-2094"><a href="#Expansion_Model-2094"><span class="linenos">2094</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Expansion_Model-2095"><a href="#Expansion_Model-2095"><span class="linenos">2095</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1,or 2 only&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2096"><a href="#Expansion_Model-2096"><span class="linenos">2096</span></a>
</span><span id="Expansion_Model-2097"><a href="#Expansion_Model-2097"><span class="linenos">2097</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn_f</span><span class="p">)</span>
</span><span id="Expansion_Model-2098"><a href="#Expansion_Model-2098"><span class="linenos">2098</span></a>
</span><span id="Expansion_Model-2099"><a href="#Expansion_Model-2099"><span class="linenos">2099</span></a>    <span class="k">def</span> <span class="nf">_get_Ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alp</span><span class="p">,</span><span class="n">sbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">stp</span><span class="p">):</span>
</span><span id="Expansion_Model-2100"><a href="#Expansion_Model-2100"><span class="linenos">2100</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2101"><a href="#Expansion_Model-2101"><span class="linenos">2101</span></a><span class="sd">        generates symmetric exponential distribution over log fold change</span>
</span><span id="Expansion_Model-2102"><a href="#Expansion_Model-2102"><span class="linenos">2102</span></a><span class="sd">        with effect size sbar and nonresponding fraction 1-alp at s=0.</span>
</span><span id="Expansion_Model-2103"><a href="#Expansion_Model-2103"><span class="linenos">2103</span></a><span class="sd">        computed over discrete range of s from -smax to smax in steps of size stp</span>
</span><span id="Expansion_Model-2104"><a href="#Expansion_Model-2104"><span class="linenos">2104</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2105"><a href="#Expansion_Model-2105"><span class="linenos">2105</span></a>        <span class="n">lamb</span><span class="o">=-</span><span class="n">stp</span><span class="o">/</span><span class="n">sbar</span>
</span><span id="Expansion_Model-2106"><a href="#Expansion_Model-2106"><span class="linenos">2106</span></a>        <span class="n">smaxt</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">stp</span><span class="p">)</span>
</span><span id="Expansion_Model-2107"><a href="#Expansion_Model-2107"><span class="linenos">2107</span></a>        <span class="n">s_zeroind</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">smaxt</span><span class="p">)</span>
</span><span id="Expansion_Model-2108"><a href="#Expansion_Model-2108"><span class="linenos">2108</span></a>        <span class="n">Z</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">smaxt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">lamb</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
</span><span id="Expansion_Model-2109"><a href="#Expansion_Model-2109"><span class="linenos">2109</span></a>        <span class="n">Ps</span><span class="o">=</span><span class="n">alp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lamb</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">smaxt</span><span class="p">,</span><span class="n">smaxt</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="n">Z</span>
</span><span id="Expansion_Model-2110"><a href="#Expansion_Model-2110"><span class="linenos">2110</span></a>        <span class="n">Ps</span><span class="p">[</span><span class="n">s_zeroind</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alp</span><span class="p">)</span>
</span><span id="Expansion_Model-2111"><a href="#Expansion_Model-2111"><span class="linenos">2111</span></a>        <span class="k">return</span> <span class="n">Ps</span>
</span><span id="Expansion_Model-2112"><a href="#Expansion_Model-2112"><span class="linenos">2112</span></a>
</span><span id="Expansion_Model-2113"><a href="#Expansion_Model-2113"><span class="linenos">2113</span></a>    <span class="k">def</span> <span class="nf">_callbackFdiffexpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Xi</span><span class="p">):</span> <span class="c1">#case dependent</span>
</span><span id="Expansion_Model-2114"><a href="#Expansion_Model-2114"><span class="linenos">2114</span></a>        <span class="sd">&#39;&#39;&#39;prints iteration info. called scipy.minimize&#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2115"><a href="#Expansion_Model-2115"><span class="linenos">2115</span></a>               
</span><span id="Expansion_Model-2116"><a href="#Expansion_Model-2116"><span class="linenos">2116</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0: 3.6f}</span><span class="s1">   </span><span class="si">{1: 3.6f}</span><span class="s1">   &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Xi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Xi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>   
</span><span id="Expansion_Model-2117"><a href="#Expansion_Model-2117"><span class="linenos">2117</span></a>    
</span><span id="Expansion_Model-2118"><a href="#Expansion_Model-2118"><span class="linenos">2118</span></a>
</span><span id="Expansion_Model-2119"><a href="#Expansion_Model-2119"><span class="linenos">2119</span></a>    <span class="k">def</span> <span class="nf">_learning_dynamics_expansion_polished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span>  <span class="n">noise_model</span><span class="p">):</span>
</span><span id="Expansion_Model-2120"><a href="#Expansion_Model-2120"><span class="linenos">2120</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Expansion_Model-2121"><a href="#Expansion_Model-2121"><span class="linenos">2121</span></a><span class="sd">        function to infer the expansion mode parameters - not usable by the user.</span>
</span><span id="Expansion_Model-2122"><a href="#Expansion_Model-2122"><span class="linenos">2122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Expansion_Model-2123"><a href="#Expansion_Model-2123"><span class="linenos">2123</span></a>
</span><span id="Expansion_Model-2124"><a href="#Expansion_Model-2124"><span class="linenos">2124</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="Expansion_Model-2125"><a href="#Expansion_Model-2125"><span class="linenos">2125</span></a>
</span><span id="Expansion_Model-2126"><a href="#Expansion_Model-2126"><span class="linenos">2126</span></a>        <span class="n">alpha_rho</span> <span class="o">=</span> <span class="n">paras_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2127"><a href="#Expansion_Model-2127"><span class="linenos">2127</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Expansion_Model-2128"><a href="#Expansion_Model-2128"><span class="linenos">2128</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>
</span><span id="Expansion_Model-2129"><a href="#Expansion_Model-2129"><span class="linenos">2129</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span> <span class="c1">#Accuracy of the integration</span>
</span><span id="Expansion_Model-2130"><a href="#Expansion_Model-2130"><span class="linenos">2130</span></a>
</span><span id="Expansion_Model-2131"><a href="#Expansion_Model-2131"><span class="linenos">2131</span></a>
</span><span id="Expansion_Model-2132"><a href="#Expansion_Model-2132"><span class="linenos">2132</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span> <span class="o">=</span> <span class="n">get_rhof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha_rho</span><span class="p">,</span> <span class="n">nfbins</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Expansion_Model-2133"><a href="#Expansion_Model-2133"><span class="linenos">2133</span></a>
</span><span id="Expansion_Model-2134"><a href="#Expansion_Model-2134"><span class="linenos">2134</span></a>        <span class="c1">#Definition of svec</span>
</span><span id="Expansion_Model-2135"><a href="#Expansion_Model-2135"><span class="linenos">2135</span></a>        <span class="n">smax</span> <span class="o">=</span> <span class="mf">25.0</span>     <span class="c1">#maximum absolute logfold change value</span>
</span><span id="Expansion_Model-2136"><a href="#Expansion_Model-2136"><span class="linenos">2136</span></a>        <span class="n">s_step</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="Expansion_Model-2137"><a href="#Expansion_Model-2137"><span class="linenos">2137</span></a>        <span class="n">s_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Expansion_Model-2138"><a href="#Expansion_Model-2138"><span class="linenos">2138</span></a>        
</span><span id="Expansion_Model-2139"><a href="#Expansion_Model-2139"><span class="linenos">2139</span></a>        <span class="n">s_step_old</span><span class="o">=</span> <span class="n">s_step</span>
</span><span id="Expansion_Model-2140"><a href="#Expansion_Model-2140"><span class="linenos">2140</span></a>        <span class="n">logf_step</span><span class="o">=</span> <span class="n">logfvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">logfvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#use natural log here since f2 increments in increments in exp().  </span>
</span><span id="Expansion_Model-2141"><a href="#Expansion_Model-2141"><span class="linenos">2141</span></a>        <span class="n">f2s_step</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_step</span><span class="o">/</span><span class="n">logf_step</span><span class="p">))</span> <span class="c1">#rounded number of f-steps in one s-step</span>
</span><span id="Expansion_Model-2142"><a href="#Expansion_Model-2142"><span class="linenos">2142</span></a>        <span class="n">s_step</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f2s_step</span><span class="p">)</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="Expansion_Model-2143"><a href="#Expansion_Model-2143"><span class="linenos">2143</span></a>        <span class="n">smax</span><span class="o">=</span> <span class="n">s_step</span><span class="o">*</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">s_step_old</span><span class="p">)</span>
</span><span id="Expansion_Model-2144"><a href="#Expansion_Model-2144"><span class="linenos">2144</span></a>        <span class="n">svec</span><span class="o">=</span> <span class="n">s_step</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">s_step</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>   
</span><span id="Expansion_Model-2145"><a href="#Expansion_Model-2145"><span class="linenos">2145</span></a>        <span class="n">svec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">svec</span><span class="p">[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">svec</span><span class="p">)</span>
</span><span id="Expansion_Model-2146"><a href="#Expansion_Model-2146"><span class="linenos">2146</span></a>
</span><span id="Expansion_Model-2147"><a href="#Expansion_Model-2147"><span class="linenos">2147</span></a>        <span class="n">smaxind</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">svec</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="Expansion_Model-2148"><a href="#Expansion_Model-2148"><span class="linenos">2148</span></a>        <span class="n">f2s_step</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_step</span><span class="o">/</span><span class="n">logf_step</span><span class="p">))</span> <span class="c1">#rounded number of f-steps in one s-step</span>
</span><span id="Expansion_Model-2149"><a href="#Expansion_Model-2149"><span class="linenos">2149</span></a>        <span class="n">logfmin</span><span class="o">=</span><span class="n">logfvec</span><span class="p">[</span><span class="mi">0</span> <span class="p">]</span><span class="o">-</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="Expansion_Model-2150"><a href="#Expansion_Model-2150"><span class="linenos">2150</span></a>        <span class="n">logfmax</span><span class="o">=</span><span class="n">logfvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="Expansion_Model-2151"><a href="#Expansion_Model-2151"><span class="linenos">2151</span></a>        
</span><span id="Expansion_Model-2152"><a href="#Expansion_Model-2152"><span class="linenos">2152</span></a>        <span class="n">logfvecwide</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">logfmin</span><span class="p">,</span><span class="n">logfmax</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">f2s_step</span><span class="p">)</span> <span class="c1">#a wider domain for the second frequency f2=f1*exp(s)</span>
</span><span id="Expansion_Model-2153"><a href="#Expansion_Model-2153"><span class="linenos">2153</span></a>            
</span><span id="Expansion_Model-2154"><a href="#Expansion_Model-2154"><span class="linenos">2154</span></a>        <span class="c1"># Compute P(n1|f) and P(n2|f), each in an iteration of the following loop</span>
</span><span id="Expansion_Model-2155"><a href="#Expansion_Model-2155"><span class="linenos">2155</span></a>
</span><span id="Expansion_Model-2156"><a href="#Expansion_Model-2156"><span class="linenos">2156</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="Expansion_Model-2157"><a href="#Expansion_Model-2157"><span class="linenos">2157</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Expansion_Model-2158"><a href="#Expansion_Model-2158"><span class="linenos">2158</span></a>                <span class="n">unicounts</span><span class="o">=</span><span class="n">unicountvals_1</span>
</span><span id="Expansion_Model-2159"><a href="#Expansion_Model-2159"><span class="linenos">2159</span></a>                <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2160"><a href="#Expansion_Model-2160"><span class="linenos">2160</span></a>                <span class="n">Nreads</span> <span class="o">=</span> <span class="n">NreadsI</span>
</span><span id="Expansion_Model-2161"><a href="#Expansion_Model-2161"><span class="linenos">2161</span></a>                <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_1</span>
</span><span id="Expansion_Model-2162"><a href="#Expansion_Model-2162"><span class="linenos">2162</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Expansion_Model-2163"><a href="#Expansion_Model-2163"><span class="linenos">2163</span></a>                <span class="n">unicounts</span><span class="o">=</span><span class="n">unicountvals_2</span>
</span><span id="Expansion_Model-2164"><a href="#Expansion_Model-2164"><span class="linenos">2164</span></a>                <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvecwide</span><span class="p">)</span> <span class="c1">#contains s-shift for sampled data method</span>
</span><span id="Expansion_Model-2165"><a href="#Expansion_Model-2165"><span class="linenos">2165</span></a>                <span class="n">Nreads</span> <span class="o">=</span> <span class="n">NreadsII</span>
</span><span id="Expansion_Model-2166"><a href="#Expansion_Model-2166"><span class="linenos">2166</span></a>                <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_2</span>
</span><span id="Expansion_Model-2167"><a href="#Expansion_Model-2167"><span class="linenos">2167</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Expansion_Model-2168"><a href="#Expansion_Model-2168"><span class="linenos">2168</span></a>                <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span> <span class="n">unicounts</span><span class="p">,</span> <span class="n">Nreads</span><span class="p">,</span> <span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Expansion_Model-2169"><a href="#Expansion_Model-2169"><span class="linenos">2169</span></a>
</span><span id="Expansion_Model-2170"><a href="#Expansion_Model-2170"><span class="linenos">2170</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Expansion_Model-2171"><a href="#Expansion_Model-2171"><span class="linenos">2171</span></a>                <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicounts</span><span class="p">,</span> <span class="n">Nreads</span><span class="p">,</span> <span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Expansion_Model-2172"><a href="#Expansion_Model-2172"><span class="linenos">2172</span></a>
</span><span id="Expansion_Model-2173"><a href="#Expansion_Model-2173"><span class="linenos">2173</span></a>        <span class="c1">#for the trapezoid method</span>
</span><span id="Expansion_Model-2174"><a href="#Expansion_Model-2174"><span class="linenos">2174</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> 
</span><span id="Expansion_Model-2175"><a href="#Expansion_Model-2175"><span class="linenos">2175</span></a>
</span><span id="Expansion_Model-2176"><a href="#Expansion_Model-2176"><span class="linenos">2176</span></a>        <span class="c1"># Computing P(n1,n2|f,s)</span>
</span><span id="Expansion_Model-2177"><a href="#Expansion_Model-2177"><span class="linenos">2177</span></a>        <span class="n">Pn1n2_s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">svec</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">)))</span> 
</span><span id="Expansion_Model-2178"><a href="#Expansion_Model-2178"><span class="linenos">2178</span></a>
</span><span id="Expansion_Model-2179"><a href="#Expansion_Model-2179"><span class="linenos">2179</span></a>        <span class="k">for</span> <span class="n">s_it</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svec</span><span class="p">):</span>
</span><span id="Expansion_Model-2180"><a href="#Expansion_Model-2180"><span class="linenos">2180</span></a>            <span class="k">for</span> <span class="n">it</span><span class="p">,(</span><span class="n">n1_it</span><span class="p">,</span> <span class="n">n2_it</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">)):</span>
</span><span id="Expansion_Model-2181"><a href="#Expansion_Model-2181"><span class="linenos">2181</span></a>                <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span><span class="o">+</span><span class="n">logPn2_f</span><span class="p">[</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="p">:(</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)),</span><span class="n">n2_it</span><span class="p">]</span><span class="o">+</span><span class="n">logPn1_f</span><span class="p">[:,</span><span class="n">n1_it</span><span class="p">]</span><span class="o">+</span> <span class="n">logfvec</span> <span class="p">)</span>
</span><span id="Expansion_Model-2182"><a href="#Expansion_Model-2182"><span class="linenos">2182</span></a>                <span class="n">Pn1n2_s</span><span class="p">[</span><span class="n">s_it</span><span class="p">,</span> <span class="n">n1_it</span><span class="p">,</span> <span class="n">n2_it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Expansion_Model-2183"><a href="#Expansion_Model-2183"><span class="linenos">2183</span></a>            
</span><span id="Expansion_Model-2184"><a href="#Expansion_Model-2184"><span class="linenos">2184</span></a>    
</span><span id="Expansion_Model-2185"><a href="#Expansion_Model-2185"><span class="linenos">2185</span></a>        <span class="n">Pn0n0_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">svec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Expansion_Model-2186"><a href="#Expansion_Model-2186"><span class="linenos">2186</span></a>        <span class="k">for</span> <span class="n">s_it</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svec</span><span class="p">):</span>    
</span><span id="Expansion_Model-2187"><a href="#Expansion_Model-2187"><span class="linenos">2187</span></a>            <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logPn2_f</span><span class="p">[</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="p">:(</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)),</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logrhofvec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2188"><a href="#Expansion_Model-2188"><span class="linenos">2188</span></a>            <span class="n">Pn0n0_s</span><span class="p">[</span><span class="n">s_it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Expansion_Model-2189"><a href="#Expansion_Model-2189"><span class="linenos">2189</span></a>            
</span><span id="Expansion_Model-2190"><a href="#Expansion_Model-2190"><span class="linenos">2190</span></a>    
</span><span id="Expansion_Model-2191"><a href="#Expansion_Model-2191"><span class="linenos">2191</span></a>        <span class="n">N_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)</span>
</span><span id="Expansion_Model-2192"><a href="#Expansion_Model-2192"><span class="linenos">2192</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;N_obs: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_obs</span><span class="p">))</span>
</span><span id="Expansion_Model-2193"><a href="#Expansion_Model-2193"><span class="linenos">2193</span></a>    
</span><span id="Expansion_Model-2194"><a href="#Expansion_Model-2194"><span class="linenos">2194</span></a>            
</span><span id="Expansion_Model-2195"><a href="#Expansion_Model-2195"><span class="linenos">2195</span></a>        <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">PARAS</span><span class="p">):</span>
</span><span id="Expansion_Model-2196"><a href="#Expansion_Model-2196"><span class="linenos">2196</span></a>
</span><span id="Expansion_Model-2197"><a href="#Expansion_Model-2197"><span class="linenos">2197</span></a>            <span class="n">alp</span> <span class="o">=</span> <span class="n">PARAS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2198"><a href="#Expansion_Model-2198"><span class="linenos">2198</span></a>            <span class="n">sbar</span> <span class="o">=</span> <span class="n">PARAS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Expansion_Model-2199"><a href="#Expansion_Model-2199"><span class="linenos">2199</span></a>
</span><span id="Expansion_Model-2200"><a href="#Expansion_Model-2200"><span class="linenos">2200</span></a>            <span class="n">Ps</span> <span class="o">=</span> <span class="n">_get_Ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">alp</span><span class="p">,</span><span class="n">sbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">s_step</span><span class="p">)</span>
</span><span id="Expansion_Model-2201"><a href="#Expansion_Model-2201"><span class="linenos">2201</span></a>            <span class="n">Pn0n0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Pn0n0_s</span><span class="p">,</span><span class="n">Ps</span><span class="p">)</span>
</span><span id="Expansion_Model-2202"><a href="#Expansion_Model-2202"><span class="linenos">2202</span></a>            <span class="n">Pn1n2_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pn1n2_s</span><span class="o">*</span><span class="n">Ps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Expansion_Model-2203"><a href="#Expansion_Model-2203"><span class="linenos">2203</span></a>            <span class="n">Pn1n2_ps</span><span class="o">/=</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn0n0</span>
</span><span id="Expansion_Model-2204"><a href="#Expansion_Model-2204"><span class="linenos">2204</span></a>            <span class="nb">print</span><span class="p">(</span><span class="n">Pn0n0</span><span class="p">)</span>
</span><span id="Expansion_Model-2205"><a href="#Expansion_Model-2205"><span class="linenos">2205</span></a>
</span><span id="Expansion_Model-2206"><a href="#Expansion_Model-2206"><span class="linenos">2206</span></a>       
</span><span id="Expansion_Model-2207"><a href="#Expansion_Model-2207"><span class="linenos">2207</span></a>
</span><span id="Expansion_Model-2208"><a href="#Expansion_Model-2208"><span class="linenos">2208</span></a>            <span class="n">Energy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">N_obs</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">]),</span><span class="mi">0</span><span class="p">))</span> 
</span><span id="Expansion_Model-2209"><a href="#Expansion_Model-2209"><span class="linenos">2209</span></a>                
</span><span id="Expansion_Model-2210"><a href="#Expansion_Model-2210"><span class="linenos">2210</span></a>            <span class="k">return</span> <span class="n">Energy</span>
</span><span id="Expansion_Model-2211"><a href="#Expansion_Model-2211"><span class="linenos">2211</span></a>
</span><span id="Expansion_Model-2212"><a href="#Expansion_Model-2212"><span class="linenos">2212</span></a>    <span class="c1">#--------------------------Compute-the-grid-----------------------------------------</span>
</span><span id="Expansion_Model-2213"><a href="#Expansion_Model-2213"><span class="linenos">2213</span></a>        
</span><span id="Expansion_Model-2214"><a href="#Expansion_Model-2214"><span class="linenos">2214</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculation Surface : </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2215"><a href="#Expansion_Model-2215"><span class="linenos">2215</span></a>        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Expansion_Model-2216"><a href="#Expansion_Model-2216"><span class="linenos">2216</span></a>
</span><span id="Expansion_Model-2217"><a href="#Expansion_Model-2217"><span class="linenos">2217</span></a>        <span class="n">npoints</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#to be chosen by the user </span>
</span><span id="Expansion_Model-2218"><a href="#Expansion_Model-2218"><span class="linenos">2218</span></a>        <span class="n">alpvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.99</span><span class="p">),</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="Expansion_Model-2219"><a href="#Expansion_Model-2219"><span class="linenos">2219</span></a>        <span class="n">sbarvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="Expansion_Model-2220"><a href="#Expansion_Model-2220"><span class="linenos">2220</span></a>
</span><span id="Expansion_Model-2221"><a href="#Expansion_Model-2221"><span class="linenos">2221</span></a>        <span class="n">LSurface</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sbarvec</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">alpvec</span><span class="p">)))</span>
</span><span id="Expansion_Model-2222"><a href="#Expansion_Model-2222"><span class="linenos">2222</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sbarvec</span><span class="p">)):</span>
</span><span id="Expansion_Model-2223"><a href="#Expansion_Model-2223"><span class="linenos">2223</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpvec</span><span class="p">)):</span>
</span><span id="Expansion_Model-2224"><a href="#Expansion_Model-2224"><span class="linenos">2224</span></a>                <span class="n">LSurface</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">=</span>  <span class="o">-</span> <span class="n">cost</span><span class="p">([</span><span class="n">alpvec</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sbarvec</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="Expansion_Model-2225"><a href="#Expansion_Model-2225"><span class="linenos">2225</span></a>        
</span><span id="Expansion_Model-2226"><a href="#Expansion_Model-2226"><span class="linenos">2226</span></a>        <span class="n">alpmesh</span><span class="p">,</span> <span class="n">sbarmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">alpvec</span><span class="p">,</span> <span class="n">sbarvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2227"><a href="#Expansion_Model-2227"><span class="linenos">2227</span></a>        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LSurface</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LSurface</span><span class="p">))</span>
</span><span id="Expansion_Model-2228"><a href="#Expansion_Model-2228"><span class="linenos">2228</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
</span><span id="Expansion_Model-2229"><a href="#Expansion_Model-2229"><span class="linenos">2229</span></a>    
</span><span id="Expansion_Model-2230"><a href="#Expansion_Model-2230"><span class="linenos">2230</span></a>    
</span><span id="Expansion_Model-2231"><a href="#Expansion_Model-2231"><span class="linenos">2231</span></a>    <span class="c1">#------------------------------Optimization----------------------------------------------</span>
</span><span id="Expansion_Model-2232"><a href="#Expansion_Model-2232"><span class="linenos">2232</span></a>        
</span><span id="Expansion_Model-2233"><a href="#Expansion_Model-2233"><span class="linenos">2233</span></a>        <span class="n">optA</span> <span class="o">=</span> <span class="n">alpmesh</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="Expansion_Model-2234"><a href="#Expansion_Model-2234"><span class="linenos">2234</span></a>        <span class="n">optB</span> <span class="o">=</span> <span class="n">sbarmesh</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="Expansion_Model-2235"><a href="#Expansion_Model-2235"><span class="linenos">2235</span></a>                  
</span><span id="Expansion_Model-2236"><a href="#Expansion_Model-2236"><span class="linenos">2236</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;polish parameter estimate from &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">optA</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">optB</span><span class="p">))</span>
</span><span id="Expansion_Model-2237"><a href="#Expansion_Model-2237"><span class="linenos">2237</span></a>        <span class="n">initparas</span><span class="o">=</span><span class="p">(</span><span class="n">optA</span><span class="p">,</span><span class="n">optB</span><span class="p">)</span>  
</span><span id="Expansion_Model-2238"><a href="#Expansion_Model-2238"><span class="linenos">2238</span></a>    
</span><span id="Expansion_Model-2239"><a href="#Expansion_Model-2239"><span class="linenos">2239</span></a>
</span><span id="Expansion_Model-2240"><a href="#Expansion_Model-2240"><span class="linenos">2240</span></a>        <span class="n">outstruct</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span> <span class="n">initparas</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">_callbackFdiffexpr</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ftol&#39;</span><span class="p">:</span><span class="mf">1e-8</span> <span class="p">,</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mi">300</span><span class="p">})</span>
</span><span id="Expansion_Model-2241"><a href="#Expansion_Model-2241"><span class="linenos">2241</span></a>
</span><span id="Expansion_Model-2242"><a href="#Expansion_Model-2242"><span class="linenos">2242</span></a>        <span class="k">return</span> <span class="n">outstruct</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">Pn1n2_s</span><span class="p">,</span> <span class="n">Pn0n0_s</span><span class="p">,</span> <span class="n">svec</span>
</span><span id="Expansion_Model-2243"><a href="#Expansion_Model-2243"><span class="linenos">2243</span></a>
</span><span id="Expansion_Model-2244"><a href="#Expansion_Model-2244"><span class="linenos">2244</span></a>    <span class="k">def</span> <span class="nf">_learning_dynamics_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sparse_rep</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">display_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Expansion_Model-2245"><a href="#Expansion_Model-2245"><span class="linenos">2245</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Expansion_Model-2246"><a href="#Expansion_Model-2246"><span class="linenos">2246</span></a><span class="sd">        function to infer the expansion mode parameters - not usable by the user.</span>
</span><span id="Expansion_Model-2247"><a href="#Expansion_Model-2247"><span class="linenos">2247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Expansion_Model-2248"><a href="#Expansion_Model-2248"><span class="linenos">2248</span></a>
</span><span id="Expansion_Model-2249"><a href="#Expansion_Model-2249"><span class="linenos">2249</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span><span class="n">unicountvals_1</span><span class="p">,</span><span class="n">unicountvals_2</span><span class="p">,</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="Expansion_Model-2250"><a href="#Expansion_Model-2250"><span class="linenos">2250</span></a>
</span><span id="Expansion_Model-2251"><a href="#Expansion_Model-2251"><span class="linenos">2251</span></a>        <span class="n">alpha_rho</span> <span class="o">=</span> <span class="n">paras_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2252"><a href="#Expansion_Model-2252"><span class="linenos">2252</span></a>        <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Expansion_Model-2253"><a href="#Expansion_Model-2253"><span class="linenos">2253</span></a>        <span class="n">freq_dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>
</span><span id="Expansion_Model-2254"><a href="#Expansion_Model-2254"><span class="linenos">2254</span></a>        <span class="n">nfbins</span> <span class="o">=</span> <span class="mi">1200</span> <span class="c1">#Accuracy of the integration</span>
</span><span id="Expansion_Model-2255"><a href="#Expansion_Model-2255"><span class="linenos">2255</span></a>
</span><span id="Expansion_Model-2256"><a href="#Expansion_Model-2256"><span class="linenos">2256</span></a>
</span><span id="Expansion_Model-2257"><a href="#Expansion_Model-2257"><span class="linenos">2257</span></a>        <span class="n">logrhofvec</span><span class="p">,</span> <span class="n">logfvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rhof</span><span class="p">(</span><span class="n">alpha_rho</span><span class="p">,</span> <span class="n">nfbins</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Expansion_Model-2258"><a href="#Expansion_Model-2258"><span class="linenos">2258</span></a>
</span><span id="Expansion_Model-2259"><a href="#Expansion_Model-2259"><span class="linenos">2259</span></a>        <span class="c1">#Definition of svec</span>
</span><span id="Expansion_Model-2260"><a href="#Expansion_Model-2260"><span class="linenos">2260</span></a>        <span class="n">smax</span> <span class="o">=</span> <span class="mf">25.0</span>     <span class="c1">#maximum absolute logfold change value</span>
</span><span id="Expansion_Model-2261"><a href="#Expansion_Model-2261"><span class="linenos">2261</span></a>        <span class="n">s_step</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="Expansion_Model-2262"><a href="#Expansion_Model-2262"><span class="linenos">2262</span></a>        <span class="n">s_0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Expansion_Model-2263"><a href="#Expansion_Model-2263"><span class="linenos">2263</span></a>        
</span><span id="Expansion_Model-2264"><a href="#Expansion_Model-2264"><span class="linenos">2264</span></a>        <span class="n">s_step_old</span><span class="o">=</span> <span class="n">s_step</span>
</span><span id="Expansion_Model-2265"><a href="#Expansion_Model-2265"><span class="linenos">2265</span></a>        <span class="n">logf_step</span><span class="o">=</span> <span class="n">logfvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">logfvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#use natural log here since f2 increments in increments in exp().  </span>
</span><span id="Expansion_Model-2266"><a href="#Expansion_Model-2266"><span class="linenos">2266</span></a>        <span class="n">f2s_step</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_step</span><span class="o">/</span><span class="n">logf_step</span><span class="p">))</span> <span class="c1">#rounded number of f-steps in one s-step</span>
</span><span id="Expansion_Model-2267"><a href="#Expansion_Model-2267"><span class="linenos">2267</span></a>        <span class="n">s_step</span><span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f2s_step</span><span class="p">)</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="Expansion_Model-2268"><a href="#Expansion_Model-2268"><span class="linenos">2268</span></a>        <span class="n">smax</span><span class="o">=</span> <span class="n">s_step</span><span class="o">*</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">s_step_old</span><span class="p">)</span>
</span><span id="Expansion_Model-2269"><a href="#Expansion_Model-2269"><span class="linenos">2269</span></a>        <span class="n">svec</span><span class="o">=</span> <span class="n">s_step</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">smax</span><span class="o">/</span><span class="n">s_step</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>   
</span><span id="Expansion_Model-2270"><a href="#Expansion_Model-2270"><span class="linenos">2270</span></a>        <span class="n">svec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">svec</span><span class="p">[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">svec</span><span class="p">)</span>
</span><span id="Expansion_Model-2271"><a href="#Expansion_Model-2271"><span class="linenos">2271</span></a>
</span><span id="Expansion_Model-2272"><a href="#Expansion_Model-2272"><span class="linenos">2272</span></a>        <span class="n">smaxind</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">svec</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="Expansion_Model-2273"><a href="#Expansion_Model-2273"><span class="linenos">2273</span></a>        <span class="n">f2s_step</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">s_step</span><span class="o">/</span><span class="n">logf_step</span><span class="p">))</span> <span class="c1">#rounded number of f-steps in one s-step</span>
</span><span id="Expansion_Model-2274"><a href="#Expansion_Model-2274"><span class="linenos">2274</span></a>        <span class="n">logfmin</span><span class="o">=</span><span class="n">logfvec</span><span class="p">[</span><span class="mi">0</span> <span class="p">]</span><span class="o">-</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="Expansion_Model-2275"><a href="#Expansion_Model-2275"><span class="linenos">2275</span></a>        <span class="n">logfmax</span><span class="o">=</span><span class="n">logfvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">logf_step</span>
</span><span id="Expansion_Model-2276"><a href="#Expansion_Model-2276"><span class="linenos">2276</span></a>        
</span><span id="Expansion_Model-2277"><a href="#Expansion_Model-2277"><span class="linenos">2277</span></a>        <span class="n">logfvecwide</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">logfmin</span><span class="p">,</span><span class="n">logfmax</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">smaxind</span><span class="o">*</span><span class="n">f2s_step</span><span class="p">))</span> <span class="c1">#a wider domain for the second frequency f2=f1*exp(s)</span>
</span><span id="Expansion_Model-2278"><a href="#Expansion_Model-2278"><span class="linenos">2278</span></a>            
</span><span id="Expansion_Model-2279"><a href="#Expansion_Model-2279"><span class="linenos">2279</span></a>        <span class="c1"># Compute P(n1|f) and P(n2|f), each in an iteration of the following loop</span>
</span><span id="Expansion_Model-2280"><a href="#Expansion_Model-2280"><span class="linenos">2280</span></a>
</span><span id="Expansion_Model-2281"><a href="#Expansion_Model-2281"><span class="linenos">2281</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="Expansion_Model-2282"><a href="#Expansion_Model-2282"><span class="linenos">2282</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Expansion_Model-2283"><a href="#Expansion_Model-2283"><span class="linenos">2283</span></a>                <span class="n">unicounts</span><span class="o">=</span><span class="n">unicountvals_1</span>
</span><span id="Expansion_Model-2284"><a href="#Expansion_Model-2284"><span class="linenos">2284</span></a>                <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2285"><a href="#Expansion_Model-2285"><span class="linenos">2285</span></a>                <span class="n">Nreads</span> <span class="o">=</span> <span class="n">NreadsI</span>
</span><span id="Expansion_Model-2286"><a href="#Expansion_Model-2286"><span class="linenos">2286</span></a>                <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_1</span>
</span><span id="Expansion_Model-2287"><a href="#Expansion_Model-2287"><span class="linenos">2287</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Expansion_Model-2288"><a href="#Expansion_Model-2288"><span class="linenos">2288</span></a>                <span class="n">unicounts</span><span class="o">=</span><span class="n">unicountvals_2</span>
</span><span id="Expansion_Model-2289"><a href="#Expansion_Model-2289"><span class="linenos">2289</span></a>                <span class="n">logfvec_tmp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logfvecwide</span><span class="p">)</span> <span class="c1">#contains s-shift for sampled data method</span>
</span><span id="Expansion_Model-2290"><a href="#Expansion_Model-2290"><span class="linenos">2290</span></a>                <span class="n">Nreads</span> <span class="o">=</span> <span class="n">NreadsII</span>
</span><span id="Expansion_Model-2291"><a href="#Expansion_Model-2291"><span class="linenos">2291</span></a>                <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_2</span>
</span><span id="Expansion_Model-2292"><a href="#Expansion_Model-2292"><span class="linenos">2292</span></a>            <span class="k">if</span> <span class="n">it</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Expansion_Model-2293"><a href="#Expansion_Model-2293"><span class="linenos">2293</span></a>                <span class="n">logPn1_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicounts</span><span class="p">,</span> <span class="n">Nreads</span><span class="p">,</span> <span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Expansion_Model-2294"><a href="#Expansion_Model-2294"><span class="linenos">2294</span></a>
</span><span id="Expansion_Model-2295"><a href="#Expansion_Model-2295"><span class="linenos">2295</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Expansion_Model-2296"><a href="#Expansion_Model-2296"><span class="linenos">2296</span></a>                <span class="n">logPn2_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_logPn_f</span><span class="p">(</span><span class="n">unicounts</span><span class="p">,</span> <span class="n">Nreads</span><span class="p">,</span> <span class="n">logfvec_tmp</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">paras</span><span class="p">)</span>
</span><span id="Expansion_Model-2297"><a href="#Expansion_Model-2297"><span class="linenos">2297</span></a>
</span><span id="Expansion_Model-2298"><a href="#Expansion_Model-2298"><span class="linenos">2298</span></a>        <span class="c1">#for the trapezoid method</span>
</span><span id="Expansion_Model-2299"><a href="#Expansion_Model-2299"><span class="linenos">2299</span></a>        <span class="n">dlogfby2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> 
</span><span id="Expansion_Model-2300"><a href="#Expansion_Model-2300"><span class="linenos">2300</span></a>
</span><span id="Expansion_Model-2301"><a href="#Expansion_Model-2301"><span class="linenos">2301</span></a>        <span class="c1"># Computing P(n1,n2|f,s)</span>
</span><span id="Expansion_Model-2302"><a href="#Expansion_Model-2302"><span class="linenos">2302</span></a>        <span class="n">Pn1n2_s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">svec</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unicountvals_1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">unicountvals_2</span><span class="p">)))</span> 
</span><span id="Expansion_Model-2303"><a href="#Expansion_Model-2303"><span class="linenos">2303</span></a>
</span><span id="Expansion_Model-2304"><a href="#Expansion_Model-2304"><span class="linenos">2304</span></a>        <span class="k">for</span> <span class="n">s_it</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svec</span><span class="p">):</span>
</span><span id="Expansion_Model-2305"><a href="#Expansion_Model-2305"><span class="linenos">2305</span></a>            <span class="k">for</span> <span class="n">it</span><span class="p">,(</span><span class="n">n1_it</span><span class="p">,</span> <span class="n">n2_it</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">)):</span>
</span><span id="Expansion_Model-2306"><a href="#Expansion_Model-2306"><span class="linenos">2306</span></a>                <span class="n">integ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhofvec</span><span class="o">+</span><span class="n">logPn2_f</span><span class="p">[</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="p">:(</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)),</span><span class="n">n2_it</span><span class="p">]</span><span class="o">+</span><span class="n">logPn1_f</span><span class="p">[:,</span><span class="n">n1_it</span><span class="p">]</span><span class="o">+</span> <span class="n">logfvec</span> <span class="p">)</span>
</span><span id="Expansion_Model-2307"><a href="#Expansion_Model-2307"><span class="linenos">2307</span></a>                <span class="n">Pn1n2_s</span><span class="p">[</span><span class="n">s_it</span><span class="p">,</span> <span class="n">n1_it</span><span class="p">,</span> <span class="n">n2_it</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Expansion_Model-2308"><a href="#Expansion_Model-2308"><span class="linenos">2308</span></a>            
</span><span id="Expansion_Model-2309"><a href="#Expansion_Model-2309"><span class="linenos">2309</span></a>    
</span><span id="Expansion_Model-2310"><a href="#Expansion_Model-2310"><span class="linenos">2310</span></a>        <span class="n">Pn0n0_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">svec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Expansion_Model-2311"><a href="#Expansion_Model-2311"><span class="linenos">2311</span></a>        <span class="k">for</span> <span class="n">s_it</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svec</span><span class="p">):</span>    
</span><span id="Expansion_Model-2312"><a href="#Expansion_Model-2312"><span class="linenos">2312</span></a>            <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn1_f</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logPn2_f</span><span class="p">[</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="p">:(</span><span class="n">f2s_step</span><span class="o">*</span><span class="n">s_it</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)),</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">logrhofvec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2313"><a href="#Expansion_Model-2313"><span class="linenos">2313</span></a>            <span class="n">Pn0n0_s</span><span class="p">[</span><span class="n">s_it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dlogfby2</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Expansion_Model-2314"><a href="#Expansion_Model-2314"><span class="linenos">2314</span></a>            
</span><span id="Expansion_Model-2315"><a href="#Expansion_Model-2315"><span class="linenos">2315</span></a>   
</span><span id="Expansion_Model-2316"><a href="#Expansion_Model-2316"><span class="linenos">2316</span></a>        <span class="n">N_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">)</span>
</span><span id="Expansion_Model-2317"><a href="#Expansion_Model-2317"><span class="linenos">2317</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;N_obs: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_obs</span><span class="p">))</span>
</span><span id="Expansion_Model-2318"><a href="#Expansion_Model-2318"><span class="linenos">2318</span></a>    
</span><span id="Expansion_Model-2319"><a href="#Expansion_Model-2319"><span class="linenos">2319</span></a>            
</span><span id="Expansion_Model-2320"><a href="#Expansion_Model-2320"><span class="linenos">2320</span></a>        <span class="k">def</span> <span class="nf">cost</span><span class="p">(</span><span class="n">PARAS</span><span class="p">):</span>
</span><span id="Expansion_Model-2321"><a href="#Expansion_Model-2321"><span class="linenos">2321</span></a>
</span><span id="Expansion_Model-2322"><a href="#Expansion_Model-2322"><span class="linenos">2322</span></a>            <span class="n">alp</span> <span class="o">=</span> <span class="n">PARAS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2323"><a href="#Expansion_Model-2323"><span class="linenos">2323</span></a>            <span class="n">sbar</span> <span class="o">=</span> <span class="n">PARAS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Expansion_Model-2324"><a href="#Expansion_Model-2324"><span class="linenos">2324</span></a>
</span><span id="Expansion_Model-2325"><a href="#Expansion_Model-2325"><span class="linenos">2325</span></a>            <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Ps</span><span class="p">(</span><span class="n">alp</span><span class="p">,</span><span class="n">sbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">s_step</span><span class="p">)</span>
</span><span id="Expansion_Model-2326"><a href="#Expansion_Model-2326"><span class="linenos">2326</span></a>            <span class="n">Pn0n0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Pn0n0_s</span><span class="p">,</span><span class="n">Ps</span><span class="p">)</span>
</span><span id="Expansion_Model-2327"><a href="#Expansion_Model-2327"><span class="linenos">2327</span></a>            <span class="n">Pn1n2_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pn1n2_s</span><span class="o">*</span><span class="n">Ps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Expansion_Model-2328"><a href="#Expansion_Model-2328"><span class="linenos">2328</span></a>            <span class="n">Pn1n2_ps</span><span class="o">/=</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn0n0</span>
</span><span id="Expansion_Model-2329"><a href="#Expansion_Model-2329"><span class="linenos">2329</span></a>            <span class="c1">#print(Pn0n0)</span>
</span><span id="Expansion_Model-2330"><a href="#Expansion_Model-2330"><span class="linenos">2330</span></a>
</span><span id="Expansion_Model-2331"><a href="#Expansion_Model-2331"><span class="linenos">2331</span></a>       
</span><span id="Expansion_Model-2332"><a href="#Expansion_Model-2332"><span class="linenos">2332</span></a>
</span><span id="Expansion_Model-2333"><a href="#Expansion_Model-2333"><span class="linenos">2333</span></a>            <span class="n">Energy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">N_obs</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">]),</span><span class="mi">0</span><span class="p">))</span> 
</span><span id="Expansion_Model-2334"><a href="#Expansion_Model-2334"><span class="linenos">2334</span></a>                
</span><span id="Expansion_Model-2335"><a href="#Expansion_Model-2335"><span class="linenos">2335</span></a>            <span class="k">return</span> <span class="n">Energy</span>
</span><span id="Expansion_Model-2336"><a href="#Expansion_Model-2336"><span class="linenos">2336</span></a>
</span><span id="Expansion_Model-2337"><a href="#Expansion_Model-2337"><span class="linenos">2337</span></a>    <span class="c1">#--------------------------Compute-the-grid-----------------------------------------</span>
</span><span id="Expansion_Model-2338"><a href="#Expansion_Model-2338"><span class="linenos">2338</span></a>        
</span><span id="Expansion_Model-2339"><a href="#Expansion_Model-2339"><span class="linenos">2339</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculation Surface : </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2340"><a href="#Expansion_Model-2340"><span class="linenos">2340</span></a>        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Expansion_Model-2341"><a href="#Expansion_Model-2341"><span class="linenos">2341</span></a>
</span><span id="Expansion_Model-2342"><a href="#Expansion_Model-2342"><span class="linenos">2342</span></a>        <span class="n">npoints</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1">#to be chosen by the user </span>
</span><span id="Expansion_Model-2343"><a href="#Expansion_Model-2343"><span class="linenos">2343</span></a>        <span class="n">alpvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.99</span><span class="p">),</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="Expansion_Model-2344"><a href="#Expansion_Model-2344"><span class="linenos">2344</span></a>        <span class="n">sbarvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="Expansion_Model-2345"><a href="#Expansion_Model-2345"><span class="linenos">2345</span></a>
</span><span id="Expansion_Model-2346"><a href="#Expansion_Model-2346"><span class="linenos">2346</span></a>        <span class="n">LSurface</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sbarvec</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">alpvec</span><span class="p">)))</span>
</span><span id="Expansion_Model-2347"><a href="#Expansion_Model-2347"><span class="linenos">2347</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sbarvec</span><span class="p">)):</span>
</span><span id="Expansion_Model-2348"><a href="#Expansion_Model-2348"><span class="linenos">2348</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpvec</span><span class="p">)):</span>
</span><span id="Expansion_Model-2349"><a href="#Expansion_Model-2349"><span class="linenos">2349</span></a>                <span class="n">LSurface</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">=</span>  <span class="o">-</span> <span class="n">cost</span><span class="p">([</span><span class="n">alpvec</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sbarvec</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</span><span id="Expansion_Model-2350"><a href="#Expansion_Model-2350"><span class="linenos">2350</span></a>        
</span><span id="Expansion_Model-2351"><a href="#Expansion_Model-2351"><span class="linenos">2351</span></a>        <span class="n">alpmesh</span><span class="p">,</span> <span class="n">sbarmesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">alpvec</span><span class="p">,</span> <span class="n">sbarvec</span><span class="p">)</span>
</span><span id="Expansion_Model-2352"><a href="#Expansion_Model-2352"><span class="linenos">2352</span></a>        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LSurface</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LSurface</span><span class="p">))</span>
</span><span id="Expansion_Model-2353"><a href="#Expansion_Model-2353"><span class="linenos">2353</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">))</span>
</span><span id="Expansion_Model-2354"><a href="#Expansion_Model-2354"><span class="linenos">2354</span></a>    
</span><span id="Expansion_Model-2355"><a href="#Expansion_Model-2355"><span class="linenos">2355</span></a>    <span class="c1">#---------------------------Plot-the-grid-------------------------------------------</span>
</span><span id="Expansion_Model-2356"><a href="#Expansion_Model-2356"><span class="linenos">2356</span></a>        <span class="k">if</span> <span class="n">display_plot</span><span class="p">:</span>
</span><span id="Expansion_Model-2357"><a href="#Expansion_Model-2357"><span class="linenos">2357</span></a>
</span><span id="Expansion_Model-2358"><a href="#Expansion_Model-2358"><span class="linenos">2358</span></a>            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span><span id="Expansion_Model-2359"><a href="#Expansion_Model-2359"><span class="linenos">2359</span></a>
</span><span id="Expansion_Model-2360"><a href="#Expansion_Model-2360"><span class="linenos">2360</span></a>         
</span><span id="Expansion_Model-2361"><a href="#Expansion_Model-2361"><span class="linenos">2361</span></a>            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LSurface</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LSurface</span><span class="p">))</span>
</span><span id="Expansion_Model-2362"><a href="#Expansion_Model-2362"><span class="linenos">2362</span></a>
</span><span id="Expansion_Model-2363"><a href="#Expansion_Model-2363"><span class="linenos">2363</span></a>            <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">alpmesh</span><span class="p">,</span> <span class="n">sbarmesh</span><span class="p">,</span> <span class="n">LSurface</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span> <span class="o">=</span> <span class="s1">&#39;solid&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2364"><a href="#Expansion_Model-2364"><span class="linenos">2364</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">alpmesh</span><span class="p">,</span> <span class="n">sbarmesh</span><span class="p">,</span> <span class="n">LSurface</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="mf">0.8</span><span class="p">)</span>
</span><span id="Expansion_Model-2365"><a href="#Expansion_Model-2365"><span class="linenos">2365</span></a>
</span><span id="Expansion_Model-2366"><a href="#Expansion_Model-2366"><span class="linenos">2366</span></a>            <span class="n">xmax</span> <span class="o">=</span> <span class="n">alpmesh</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="Expansion_Model-2367"><a href="#Expansion_Model-2367"><span class="linenos">2367</span></a>            <span class="n">ymax</span> <span class="o">=</span> <span class="n">sbarmesh</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="Expansion_Model-2368"><a href="#Expansion_Model-2368"><span class="linenos">2368</span></a>            <span class="n">text</span><span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$ alpha=</span><span class="si">{:.3f}</span><span class="s2">, s=</span><span class="si">{:.3f}</span><span class="s2"> $&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
</span><span id="Expansion_Model-2369"><a href="#Expansion_Model-2369"><span class="linenos">2369</span></a>            <span class="n">bbox_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;square,pad=0.3&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.72</span><span class="p">)</span>
</span><span id="Expansion_Model-2370"><a href="#Expansion_Model-2370"><span class="linenos">2370</span></a>            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span><span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle,angleA=0,angleB=80&quot;</span><span class="p">)</span>
</span><span id="Expansion_Model-2371"><a href="#Expansion_Model-2371"><span class="linenos">2371</span></a>            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;axes fraction&quot;</span><span class="p">,</span>
</span><span id="Expansion_Model-2372"><a href="#Expansion_Model-2372"><span class="linenos">2372</span></a>                <span class="n">arrowprops</span><span class="o">=</span><span class="n">arrowprops</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox_props</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
</span><span id="Expansion_Model-2373"><a href="#Expansion_Model-2373"><span class="linenos">2373</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.94</span><span class="p">,</span><span class="mf">0.96</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="Expansion_Model-2374"><a href="#Expansion_Model-2374"><span class="linenos">2374</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ \alpha, \ size \ of \ the \ repertoire \ that \ answers \ to \ the \ vaccine $&#39;</span><span class="p">)</span> 
</span><span id="Expansion_Model-2375"><a href="#Expansion_Model-2375"><span class="linenos">2375</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$ s_</span><span class="si">{bar}</span><span class="s1">, \ characteristic \ expansion \ decrease $&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2376"><a href="#Expansion_Model-2376"><span class="linenos">2376</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2377"><a href="#Expansion_Model-2377"><span class="linenos">2377</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2378"><a href="#Expansion_Model-2378"><span class="linenos">2378</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="Expansion_Model-2379"><a href="#Expansion_Model-2379"><span class="linenos">2379</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$Grid \ Search \ graph \ for \ \alpha \ and \ s_</span><span class="si">{bar}</span><span class="s1"> \ parameters. $&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2380"><a href="#Expansion_Model-2380"><span class="linenos">2380</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</span><span id="Expansion_Model-2381"><a href="#Expansion_Model-2381"><span class="linenos">2381</span></a>
</span><span id="Expansion_Model-2382"><a href="#Expansion_Model-2382"><span class="linenos">2382</span></a>        <span class="k">return</span> <span class="n">LSurface</span><span class="p">,</span> <span class="n">Pn1n2_s</span><span class="p">,</span> <span class="n">Pn0n0_s</span><span class="p">,</span> <span class="n">svec</span>
</span><span id="Expansion_Model-2383"><a href="#Expansion_Model-2383"><span class="linenos">2383</span></a> 
</span><span id="Expansion_Model-2384"><a href="#Expansion_Model-2384"><span class="linenos">2384</span></a>
</span><span id="Expansion_Model-2385"><a href="#Expansion_Model-2385"><span class="linenos">2385</span></a>    <span class="k">def</span> <span class="nf">_save_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">svec</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span><span class="n">Pn1n2_s</span><span class="p">,</span> <span class="n">Pn0n0_s</span><span class="p">,</span>  <span class="n">subset</span><span class="p">,</span> <span class="n">unicountvals_1_d</span><span class="p">,</span> <span class="n">unicountvals_2_d</span><span class="p">,</span> <span class="n">indn1_d</span><span class="p">,</span> <span class="n">indn2_d</span><span class="p">,</span> <span class="n">print_expanded</span><span class="p">,</span> <span class="n">pthresh</span><span class="p">,</span> <span class="n">smedthresh</span><span class="p">):</span>
</span><span id="Expansion_Model-2386"><a href="#Expansion_Model-2386"><span class="linenos">2386</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2387"><a href="#Expansion_Model-2387"><span class="linenos">2387</span></a><span class="sd">        takes learned diffexpr model, Pn1n2_s*Ps, computes posteriors over (n1,n2) pairs, and writes to file a table of data with clones as rows and columns as measures of thier posteriors </span>
</span><span id="Expansion_Model-2388"><a href="#Expansion_Model-2388"><span class="linenos">2388</span></a><span class="sd">        print_expanded=True orders table as ascending by , else descending</span>
</span><span id="Expansion_Model-2389"><a href="#Expansion_Model-2389"><span class="linenos">2389</span></a><span class="sd">        pthresh is the threshold in &#39;p-value&#39;-like (null hypo) probability, 1-P(s&gt;0|n1_i,n2_i), where i is the row (i.e. the clone) n.b. lower null prob implies larger probability of expansion</span>
</span><span id="Expansion_Model-2390"><a href="#Expansion_Model-2390"><span class="linenos">2390</span></a><span class="sd">        smedthresh is the threshold on the posterior median, below which clones are discarded</span>
</span><span id="Expansion_Model-2391"><a href="#Expansion_Model-2391"><span class="linenos">2391</span></a>
</span><span id="Expansion_Model-2392"><a href="#Expansion_Model-2392"><span class="linenos">2392</span></a><span class="sd">        not usable by the user. </span>
</span><span id="Expansion_Model-2393"><a href="#Expansion_Model-2393"><span class="linenos">2393</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2394"><a href="#Expansion_Model-2394"><span class="linenos">2394</span></a>
</span><span id="Expansion_Model-2395"><a href="#Expansion_Model-2395"><span class="linenos">2395</span></a>        <span class="n">Psn1n2_ps</span><span class="o">=</span><span class="n">Pn1n2_s</span><span class="o">*</span><span class="n">Ps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> 
</span><span id="Expansion_Model-2396"><a href="#Expansion_Model-2396"><span class="linenos">2396</span></a>    
</span><span id="Expansion_Model-2397"><a href="#Expansion_Model-2397"><span class="linenos">2397</span></a>        <span class="c1">#compute marginal likelihood (neglect renormalization , since it cancels in conditional below) </span>
</span><span id="Expansion_Model-2398"><a href="#Expansion_Model-2398"><span class="linenos">2398</span></a>        <span class="n">Pn1n2_ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Psn1n2_ps</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Expansion_Model-2399"><a href="#Expansion_Model-2399"><span class="linenos">2399</span></a>
</span><span id="Expansion_Model-2400"><a href="#Expansion_Model-2400"><span class="linenos">2400</span></a>        <span class="n">Ps_n1n2ps</span><span class="o">=</span><span class="n">Pn1n2_s</span><span class="o">*</span><span class="n">Ps</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">/</span><span class="n">Pn1n2_ps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>
</span><span id="Expansion_Model-2401"><a href="#Expansion_Model-2401"><span class="linenos">2401</span></a>        <span class="c1">#compute cdf to get p-value to threshold on to reduce output size</span>
</span><span id="Expansion_Model-2402"><a href="#Expansion_Model-2402"><span class="linenos">2402</span></a>        <span class="n">cdfPs_n1n2ps</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">Ps_n1n2ps</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Expansion_Model-2403"><a href="#Expansion_Model-2403"><span class="linenos">2403</span></a>    
</span><span id="Expansion_Model-2404"><a href="#Expansion_Model-2404"><span class="linenos">2404</span></a>
</span><span id="Expansion_Model-2405"><a href="#Expansion_Model-2405"><span class="linenos">2405</span></a>        <span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">cdfPs_n1n2ps</span><span class="p">,</span><span class="n">unicountvals_1_d</span><span class="p">,</span><span class="n">unicountvals_2_d</span><span class="p">):</span>
</span><span id="Expansion_Model-2406"><a href="#Expansion_Model-2406"><span class="linenos">2406</span></a>            <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2407"><a href="#Expansion_Model-2407"><span class="linenos">2407</span></a><span class="sd">            when applied to dataframe, generates &#39;p-value&#39;-like (null hypo) probability, 1-P(s&gt;0|n1_i,n2_i), where i is the row (i.e. the clone)</span>
</span><span id="Expansion_Model-2408"><a href="#Expansion_Model-2408"><span class="linenos">2408</span></a><span class="sd">            &#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2409"><a href="#Expansion_Model-2409"><span class="linenos">2409</span></a>            <span class="k">return</span> <span class="n">cdfPs_n1n2ps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">svec</span><span class="p">)),</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">unicountvals_1_d</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">unicountvals_2_d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2410"><a href="#Expansion_Model-2410"><span class="linenos">2410</span></a>        <span class="n">dummy_part</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="n">cdfPs_n1n2ps</span><span class="o">=</span><span class="n">cdfPs_n1n2ps</span><span class="p">,</span><span class="n">unicountvals_1_d</span><span class="o">=</span><span class="n">unicountvals_1_d</span><span class="p">,</span><span class="n">unicountvals_2_d</span><span class="o">=</span><span class="n">unicountvals_2_d</span><span class="p">)</span>
</span><span id="Expansion_Model-2411"><a href="#Expansion_Model-2411"><span class="linenos">2411</span></a>    
</span><span id="Expansion_Model-2412"><a href="#Expansion_Model-2412"><span class="linenos">2412</span></a>        <span class="n">cdflabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$1-P(s&gt;0)$&#39;</span>
</span><span id="Expansion_Model-2413"><a href="#Expansion_Model-2413"><span class="linenos">2413</span></a>        <span class="n">subset</span><span class="p">[</span><span class="n">cdflabel</span><span class="p">]</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">dummy_part</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Expansion_Model-2414"><a href="#Expansion_Model-2414"><span class="linenos">2414</span></a>        <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="n">cdflabel</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pthresh</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Expansion_Model-2415"><a href="#Expansion_Model-2415"><span class="linenos">2415</span></a>
</span><span id="Expansion_Model-2416"><a href="#Expansion_Model-2416"><span class="linenos">2416</span></a>        <span class="c1">#go from clone count pair (n1,n2) to index in unicountvals_1_d and unicountvals_2_d</span>
</span><span id="Expansion_Model-2417"><a href="#Expansion_Model-2417"><span class="linenos">2417</span></a>        <span class="n">data_pairs_ind_1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model-2418"><a href="#Expansion_Model-2418"><span class="linenos">2418</span></a>        <span class="n">data_pairs_ind_2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model-2419"><a href="#Expansion_Model-2419"><span class="linenos">2419</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)):</span>
</span><span id="Expansion_Model-2420"><a href="#Expansion_Model-2420"><span class="linenos">2420</span></a>            <span class="n">data_pairs_ind_1</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">Clone_count_1</span><span class="p">)</span><span class="o">==</span><span class="n">unicountvals_1_d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2421"><a href="#Expansion_Model-2421"><span class="linenos">2421</span></a>            <span class="n">data_pairs_ind_2</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">Clone_count_2</span><span class="p">)</span><span class="o">==</span><span class="n">unicountvals_2_d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>   
</span><span id="Expansion_Model-2422"><a href="#Expansion_Model-2422"><span class="linenos">2422</span></a>        <span class="c1">#posteriors over data clones</span>
</span><span id="Expansion_Model-2423"><a href="#Expansion_Model-2423"><span class="linenos">2423</span></a>        <span class="n">Ps_n1n2ps_datpairs</span><span class="o">=</span><span class="n">Ps_n1n2ps</span><span class="p">[:,</span><span class="n">data_pairs_ind_1</span><span class="p">,</span><span class="n">data_pairs_ind_2</span><span class="p">]</span>
</span><span id="Expansion_Model-2424"><a href="#Expansion_Model-2424"><span class="linenos">2424</span></a>    
</span><span id="Expansion_Model-2425"><a href="#Expansion_Model-2425"><span class="linenos">2425</span></a>        <span class="c1">#compute posterior metrics</span>
</span><span id="Expansion_Model-2426"><a href="#Expansion_Model-2426"><span class="linenos">2426</span></a>        <span class="n">mean_est</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="Expansion_Model-2427"><a href="#Expansion_Model-2427"><span class="linenos">2427</span></a>        <span class="n">max_est</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="Expansion_Model-2428"><a href="#Expansion_Model-2428"><span class="linenos">2428</span></a>        <span class="n">slowvec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="Expansion_Model-2429"><a href="#Expansion_Model-2429"><span class="linenos">2429</span></a>        <span class="n">smedvec</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="Expansion_Model-2430"><a href="#Expansion_Model-2430"><span class="linenos">2430</span></a>        <span class="n">shighvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),))</span>
</span><span id="Expansion_Model-2431"><a href="#Expansion_Model-2431"><span class="linenos">2431</span></a>        <span class="n">pval</span><span class="o">=</span><span class="mf">0.025</span> <span class="c1">#double-sided comparison statistical test</span>
</span><span id="Expansion_Model-2432"><a href="#Expansion_Model-2432"><span class="linenos">2432</span></a>        <span class="n">pvalvec</span><span class="o">=</span><span class="p">[</span><span class="n">pval</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">pval</span><span class="p">]</span> <span class="c1">#bound criteria defining slow, smed, and shigh, respectively</span>
</span><span id="Expansion_Model-2433"><a href="#Expansion_Model-2433"><span class="linenos">2433</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Ps_n1n2ps_datpairs</span><span class="p">)):</span>
</span><span id="Expansion_Model-2434"><a href="#Expansion_Model-2434"><span class="linenos">2434</span></a>            <span class="n">mean_est</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">svec</span><span class="o">*</span><span class="n">column</span><span class="p">)</span>
</span><span id="Expansion_Model-2435"><a href="#Expansion_Model-2435"><span class="linenos">2435</span></a>            <span class="n">max_est</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">svec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">column</span><span class="p">)]</span>
</span><span id="Expansion_Model-2436"><a href="#Expansion_Model-2436"><span class="linenos">2436</span></a>            <span class="n">forwardcmf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
</span><span id="Expansion_Model-2437"><a href="#Expansion_Model-2437"><span class="linenos">2437</span></a>            <span class="n">backwardcmf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">column</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Expansion_Model-2438"><a href="#Expansion_Model-2438"><span class="linenos">2438</span></a>            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">forwardcmf</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">forwardcmf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">&gt;=</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2439"><a href="#Expansion_Model-2439"><span class="linenos">2439</span></a>            <span class="n">slowvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">svec</span><span class="p">[</span><span class="n">inds</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)])</span>  <span class="c1">#use mean in case there are two values</span>
</span><span id="Expansion_Model-2440"><a href="#Expansion_Model-2440"><span class="linenos">2440</span></a>            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">forwardcmf</span><span class="o">&gt;=</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">backwardcmf</span><span class="o">&gt;=</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2441"><a href="#Expansion_Model-2441"><span class="linenos">2441</span></a>            <span class="n">smedvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">svec</span><span class="p">[</span><span class="n">inds</span><span class="p">])</span>
</span><span id="Expansion_Model-2442"><a href="#Expansion_Model-2442"><span class="linenos">2442</span></a>            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">forwardcmf</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">forwardcmf</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">&gt;=</span><span class="n">pvalvec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Expansion_Model-2443"><a href="#Expansion_Model-2443"><span class="linenos">2443</span></a>            <span class="n">shighvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">svec</span><span class="p">[</span><span class="n">inds</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)])</span>
</span><span id="Expansion_Model-2444"><a href="#Expansion_Model-2444"><span class="linenos">2444</span></a>    
</span><span id="Expansion_Model-2445"><a href="#Expansion_Model-2445"><span class="linenos">2445</span></a>        <span class="n">colnames</span><span class="o">=</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\bar</span><span class="si">{s}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$s_</span><span class="si">{max}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$s_{3,high}$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$s_{2,med}$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$s_{1,low}$&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2446"><a href="#Expansion_Model-2446"><span class="linenos">2446</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">coldata</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="n">mean_est</span><span class="p">,</span><span class="n">max_est</span><span class="p">,</span><span class="n">shighvec</span><span class="p">,</span><span class="n">smedvec</span><span class="p">,</span><span class="n">slowvec</span><span class="p">)):</span>
</span><span id="Expansion_Model-2447"><a href="#Expansion_Model-2447"><span class="linenos">2447</span></a>            <span class="n">subset</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colnames</span><span class="p">[</span><span class="n">it</span><span class="p">],</span><span class="n">coldata</span><span class="p">)</span>
</span><span id="Expansion_Model-2448"><a href="#Expansion_Model-2448"><span class="linenos">2448</span></a>        <span class="n">oldcolnames</span><span class="o">=</span><span class="p">(</span> <span class="s1">&#39;AACDR3&#39;</span><span class="p">,</span>  <span class="s1">&#39;ntCDR3&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_fraction_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_fraction_2&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2449"><a href="#Expansion_Model-2449"><span class="linenos">2449</span></a>        <span class="n">newcolnames</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;CDR3_AA&#39;</span><span class="p">,</span> <span class="s1">&#39;CDR3_nt&#39;</span><span class="p">,</span>        <span class="sa">r</span><span class="s1">&#39;$n_1$&#39;</span><span class="p">,</span>        <span class="sa">r</span><span class="s1">&#39;$n_2$&#39;</span><span class="p">,</span>           <span class="sa">r</span><span class="s1">&#39;$f_1$&#39;</span><span class="p">,</span>           <span class="sa">r</span><span class="s1">&#39;$f_2$&#39;</span><span class="p">)</span>
</span><span id="Expansion_Model-2450"><a href="#Expansion_Model-2450"><span class="linenos">2450</span></a>        <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">oldcolnames</span><span class="p">,</span> <span class="n">newcolnames</span><span class="p">)))</span>
</span><span id="Expansion_Model-2451"><a href="#Expansion_Model-2451"><span class="linenos">2451</span></a>    
</span><span id="Expansion_Model-2452"><a href="#Expansion_Model-2452"><span class="linenos">2452</span></a>        <span class="c1">#select only clones whose posterior median pass the given threshold</span>
</span><span id="Expansion_Model-2453"><a href="#Expansion_Model-2453"><span class="linenos">2453</span></a>        <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$s_{2,med}$&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">smedthresh</span><span class="p">]</span>
</span><span id="Expansion_Model-2454"><a href="#Expansion_Model-2454"><span class="linenos">2454</span></a>    
</span><span id="Expansion_Model-2455"><a href="#Expansion_Model-2455"><span class="linenos">2455</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing to: &quot;</span><span class="o">+</span><span class="n">outpath</span><span class="p">)</span>
</span><span id="Expansion_Model-2456"><a href="#Expansion_Model-2456"><span class="linenos">2456</span></a>        <span class="k">if</span> <span class="n">print_expanded</span><span class="p">:</span>
</span><span id="Expansion_Model-2457"><a href="#Expansion_Model-2457"><span class="linenos">2457</span></a>            <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">cdflabel</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Expansion_Model-2458"><a href="#Expansion_Model-2458"><span class="linenos">2458</span></a>            <span class="n">strout</span><span class="o">=</span><span class="s1">&#39;expanded&#39;</span>
</span><span id="Expansion_Model-2459"><a href="#Expansion_Model-2459"><span class="linenos">2459</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Expansion_Model-2460"><a href="#Expansion_Model-2460"><span class="linenos">2460</span></a>            <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">cdflabel</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Expansion_Model-2461"><a href="#Expansion_Model-2461"><span class="linenos">2461</span></a>            <span class="n">strout</span><span class="o">=</span><span class="s1">&#39;contracted&#39;</span>
</span><span id="Expansion_Model-2462"><a href="#Expansion_Model-2462"><span class="linenos">2462</span></a>        <span class="n">subset</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outpath</span><span class="o">+</span><span class="s1">&#39;top_&#39;</span><span class="o">+</span><span class="n">strout</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Expansion_Model-2463"><a href="#Expansion_Model-2463"><span class="linenos">2463</span></a>
</span><span id="Expansion_Model-2464"><a href="#Expansion_Model-2464"><span class="linenos">2464</span></a>
</span><span id="Expansion_Model-2465"><a href="#Expansion_Model-2465"><span class="linenos">2465</span></a>
</span><span id="Expansion_Model-2466"><a href="#Expansion_Model-2466"><span class="linenos">2466</span></a>    <span class="k">def</span> <span class="nf">expansion_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">pval_threshold</span><span class="p">,</span> <span class="n">smed_threshold</span><span class="p">):</span>
</span><span id="Expansion_Model-2467"><a href="#Expansion_Model-2467"><span class="linenos">2467</span></a>
</span><span id="Expansion_Model-2468"><a href="#Expansion_Model-2468"><span class="linenos">2468</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2469"><a href="#Expansion_Model-2469"><span class="linenos">2469</span></a><span class="sd">        generate the table of clones that have been significantly detected to be responsive to an acute stimuli.    </span>
</span><span id="Expansion_Model-2470"><a href="#Expansion_Model-2470"><span class="linenos">2470</span></a><span class="sd">    </span>
</span><span id="Expansion_Model-2471"><a href="#Expansion_Model-2471"><span class="linenos">2471</span></a><span class="sd">        Parameters</span>
</span><span id="Expansion_Model-2472"><a href="#Expansion_Model-2472"><span class="linenos">2472</span></a><span class="sd">        ----------</span>
</span><span id="Expansion_Model-2473"><a href="#Expansion_Model-2473"><span class="linenos">2473</span></a><span class="sd">        outpath  : str</span>
</span><span id="Expansion_Model-2474"><a href="#Expansion_Model-2474"><span class="linenos">2474</span></a><span class="sd">            Name of the directory where to store the output table</span>
</span><span id="Expansion_Model-2475"><a href="#Expansion_Model-2475"><span class="linenos">2475</span></a><span class="sd">        paras_1  : numpy array</span>
</span><span id="Expansion_Model-2476"><a href="#Expansion_Model-2476"><span class="linenos">2476</span></a><span class="sd">            parameters of the noise model that has been learned at time_1</span>
</span><span id="Expansion_Model-2477"><a href="#Expansion_Model-2477"><span class="linenos">2477</span></a><span class="sd">        paras_2  : numpy array</span>
</span><span id="Expansion_Model-2478"><a href="#Expansion_Model-2478"><span class="linenos">2478</span></a><span class="sd">            parameters of the noise model that has been learned at time_2</span>
</span><span id="Expansion_Model-2479"><a href="#Expansion_Model-2479"><span class="linenos">2479</span></a><span class="sd">        df       : pandas dataframe </span>
</span><span id="Expansion_Model-2480"><a href="#Expansion_Model-2480"><span class="linenos">2480</span></a><span class="sd">            pandas dataframe merging the two RepSeq data at time_1 and time_2</span>
</span><span id="Expansion_Model-2481"><a href="#Expansion_Model-2481"><span class="linenos">2481</span></a>
</span><span id="Expansion_Model-2482"><a href="#Expansion_Model-2482"><span class="linenos">2482</span></a><span class="sd">        noise_model : int</span>
</span><span id="Expansion_Model-2483"><a href="#Expansion_Model-2483"><span class="linenos">2483</span></a><span class="sd">            choice of noise model 0: Poisson, 1: negative Binomial, 2: negative Binomial + Poisson  </span>
</span><span id="Expansion_Model-2484"><a href="#Expansion_Model-2484"><span class="linenos">2484</span></a>
</span><span id="Expansion_Model-2485"><a href="#Expansion_Model-2485"><span class="linenos">2485</span></a><span class="sd">        pval_threshold : float</span>
</span><span id="Expansion_Model-2486"><a href="#Expansion_Model-2486"><span class="linenos">2486</span></a><span class="sd">            P-value threshold to detect and discriminate if a TCR clone has expanded </span>
</span><span id="Expansion_Model-2487"><a href="#Expansion_Model-2487"><span class="linenos">2487</span></a>
</span><span id="Expansion_Model-2488"><a href="#Expansion_Model-2488"><span class="linenos">2488</span></a><span class="sd">        smed_threshold : float</span>
</span><span id="Expansion_Model-2489"><a href="#Expansion_Model-2489"><span class="linenos">2489</span></a><span class="sd">            median of the log-fold change threshold to detect if a TCR clone has expanded </span>
</span><span id="Expansion_Model-2490"><a href="#Expansion_Model-2490"><span class="linenos">2490</span></a>
</span><span id="Expansion_Model-2491"><a href="#Expansion_Model-2491"><span class="linenos">2491</span></a><span class="sd">        Returns</span>
</span><span id="Expansion_Model-2492"><a href="#Expansion_Model-2492"><span class="linenos">2492</span></a><span class="sd">        -------</span>
</span><span id="Expansion_Model-2493"><a href="#Expansion_Model-2493"><span class="linenos">2493</span></a><span class="sd">        data-frame - csv file</span>
</span><span id="Expansion_Model-2494"><a href="#Expansion_Model-2494"><span class="linenos">2494</span></a><span class="sd">            the output is a csv file of columns : $s_{1-low}$, $s_{2-med}$, $s_{3-high}$, $s_{max}$, $\bar{s}$, $f_1$, $f_2$, $n_1$, $n_2$, &#39;CDR3_nt&#39;, &#39;CDR3_AA&#39; and &#39;$p$-value&#39;</span>
</span><span id="Expansion_Model-2495"><a href="#Expansion_Model-2495"><span class="linenos">2495</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Expansion_Model-2496"><a href="#Expansion_Model-2496"><span class="linenos">2496</span></a>
</span><span id="Expansion_Model-2497"><a href="#Expansion_Model-2497"><span class="linenos">2497</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="Expansion_Model-2498"><a href="#Expansion_Model-2498"><span class="linenos">2498</span></a>        <span class="n">L_surface</span><span class="p">,</span> <span class="n">Pn1n2_s_d</span><span class="p">,</span> <span class="n">Pn0n0_s_d</span><span class="p">,</span> <span class="n">svec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_dynamics_expansion</span><span class="p">(</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">)</span>
</span><span id="Expansion_Model-2499"><a href="#Expansion_Model-2499"><span class="linenos">2499</span></a>        <span class="n">npoints</span><span class="o">=</span> <span class="mi">50</span> <span class="c1"># same as in learning_dynamics_expansion</span>
</span><span id="Expansion_Model-2500"><a href="#Expansion_Model-2500"><span class="linenos">2500</span></a>        <span class="n">smax</span> <span class="o">=</span> <span class="mf">25.0</span>     
</span><span id="Expansion_Model-2501"><a href="#Expansion_Model-2501"><span class="linenos">2501</span></a>        <span class="n">s_step</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="Expansion_Model-2502"><a href="#Expansion_Model-2502"><span class="linenos">2502</span></a>        <span class="n">alpvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.99</span><span class="p">),</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="Expansion_Model-2503"><a href="#Expansion_Model-2503"><span class="linenos">2503</span></a>        <span class="n">sbarvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="Expansion_Model-2504"><a href="#Expansion_Model-2504"><span class="linenos">2504</span></a>        <span class="n">maxinds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">L_surface</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">L_surface</span><span class="p">))</span>
</span><span id="Expansion_Model-2505"><a href="#Expansion_Model-2505"><span class="linenos">2505</span></a>        <span class="n">optsbar</span><span class="o">=</span><span class="n">sbarvec</span><span class="p">[</span><span class="n">maxinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="Expansion_Model-2506"><a href="#Expansion_Model-2506"><span class="linenos">2506</span></a>        <span class="n">optalp</span><span class="o">=</span><span class="n">alpvec</span><span class="p">[</span><span class="n">maxinds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="Expansion_Model-2507"><a href="#Expansion_Model-2507"><span class="linenos">2507</span></a>        <span class="n">optPs</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Ps</span><span class="p">(</span><span class="n">optalp</span><span class="p">,</span><span class="n">optsbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">s_step</span><span class="p">)</span>
</span><span id="Expansion_Model-2508"><a href="#Expansion_Model-2508"><span class="linenos">2508</span></a>        <span class="n">pval_expanded</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Expansion_Model-2509"><a href="#Expansion_Model-2509"><span class="linenos">2509</span></a>
</span><span id="Expansion_Model-2510"><a href="#Expansion_Model-2510"><span class="linenos">2510</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="Expansion_Model-2511"><a href="#Expansion_Model-2511"><span class="linenos">2511</span></a>
</span><span id="Expansion_Model-2512"><a href="#Expansion_Model-2512"><span class="linenos">2512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_table</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">svec</span><span class="p">,</span> <span class="n">optPs</span><span class="p">,</span> <span class="n">Pn1n2_s_d</span><span class="p">,</span> <span class="n">Pn0n0_s_d</span><span class="p">,</span>  <span class="n">df</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">pval_expanded</span><span class="p">,</span> <span class="n">pval_threshold</span><span class="p">,</span> <span class="n">smed_threshold</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A class used to build an object associated to methods in order to select significant expanding or 
contracting clones from RepSeq samples taken at two different time points.</p>

<p>...</p>

<h6 id="methods">Methods</h6>

<p>get_sparserep(df) :
    get sparse representation of the abundances / frequencies of the TCR clones present in RepSeq samples of both time points.
    This changes the data input to fasten the algorithm</p>

<p>expansion_table(outpath, paras_1, paras_2, df, noise_model, pval_threshold, smed_threshold):
    generate the table of clones that have been significantly detected to be responsive to an acute stimuli.</p>
</div>


                            <div id="Expansion_Model.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Expansion_Model</span><span class="signature pdoc-code condensed">()</span>

        
    </div>
    <a class="headerlink" href="#Expansion_Model.__init__"></a>
    
    

                            </div>
                            <div id="Expansion_Model.get_sparserep" class="classattr">
                                        <input id="Expansion_Model.get_sparserep-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_sparserep</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">df</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Expansion_Model.get_sparserep-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Expansion_Model.get_sparserep"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Expansion_Model.get_sparserep-1907"><a href="#Expansion_Model.get_sparserep-1907"><span class="linenos">1907</span></a>    <span class="k">def</span> <span class="nf">get_sparserep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span> 
</span><span id="Expansion_Model.get_sparserep-1908"><a href="#Expansion_Model.get_sparserep-1908"><span class="linenos">1908</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Expansion_Model.get_sparserep-1909"><a href="#Expansion_Model.get_sparserep-1909"><span class="linenos">1909</span></a><span class="sd">        Tranforms {(n1,n2)} data stored in pandas dataframe to a sparse 1D representation.</span>
</span><span id="Expansion_Model.get_sparserep-1910"><a href="#Expansion_Model.get_sparserep-1910"><span class="linenos">1910</span></a><span class="sd">        unicountvals_1(2) are the unique values of n1(2).</span>
</span><span id="Expansion_Model.get_sparserep-1911"><a href="#Expansion_Model.get_sparserep-1911"><span class="linenos">1911</span></a><span class="sd">        sparse_rep_counts gives the counts of unique pairs.</span>
</span><span id="Expansion_Model.get_sparserep-1912"><a href="#Expansion_Model.get_sparserep-1912"><span class="linenos">1912</span></a><span class="sd">        ndn1(2) is the index of unicountvals_1(2) giving the value of n1(2) in that unique pair.</span>
</span><span id="Expansion_Model.get_sparserep-1913"><a href="#Expansion_Model.get_sparserep-1913"><span class="linenos">1913</span></a><span class="sd">        len(indn1)=len(indn2)=len(sparse_rep_counts)</span>
</span><span id="Expansion_Model.get_sparserep-1914"><a href="#Expansion_Model.get_sparserep-1914"><span class="linenos">1914</span></a>
</span><span id="Expansion_Model.get_sparserep-1915"><a href="#Expansion_Model.get_sparserep-1915"><span class="linenos">1915</span></a>
</span><span id="Expansion_Model.get_sparserep-1916"><a href="#Expansion_Model.get_sparserep-1916"><span class="linenos">1916</span></a><span class="sd">        Parameters</span>
</span><span id="Expansion_Model.get_sparserep-1917"><a href="#Expansion_Model.get_sparserep-1917"><span class="linenos">1917</span></a><span class="sd">        ----------</span>
</span><span id="Expansion_Model.get_sparserep-1918"><a href="#Expansion_Model.get_sparserep-1918"><span class="linenos">1918</span></a><span class="sd">        df : pandas data frame</span>
</span><span id="Expansion_Model.get_sparserep-1919"><a href="#Expansion_Model.get_sparserep-1919"><span class="linenos">1919</span></a><span class="sd">            data-frame which is the output of the method .import_data() for one Data_Process instance.</span>
</span><span id="Expansion_Model.get_sparserep-1920"><a href="#Expansion_Model.get_sparserep-1920"><span class="linenos">1920</span></a><span class="sd">            these data-frame should give the list of TCR clones present in two RepSeq samples, talen at two </span>
</span><span id="Expansion_Model.get_sparserep-1921"><a href="#Expansion_Model.get_sparserep-1921"><span class="linenos">1921</span></a><span class="sd">            different time points, associated to their clone frequencies and clone abundances in the first and second replicate?</span>
</span><span id="Expansion_Model.get_sparserep-1922"><a href="#Expansion_Model.get_sparserep-1922"><span class="linenos">1922</span></a>
</span><span id="Expansion_Model.get_sparserep-1923"><a href="#Expansion_Model.get_sparserep-1923"><span class="linenos">1923</span></a>
</span><span id="Expansion_Model.get_sparserep-1924"><a href="#Expansion_Model.get_sparserep-1924"><span class="linenos">1924</span></a><span class="sd">        Returns</span>
</span><span id="Expansion_Model.get_sparserep-1925"><a href="#Expansion_Model.get_sparserep-1925"><span class="linenos">1925</span></a><span class="sd">        -------</span>
</span><span id="Expansion_Model.get_sparserep-1926"><a href="#Expansion_Model.get_sparserep-1926"><span class="linenos">1926</span></a><span class="sd">        indn1</span>
</span><span id="Expansion_Model.get_sparserep-1927"><a href="#Expansion_Model.get_sparserep-1927"><span class="linenos">1927</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_1</span>
</span><span id="Expansion_Model.get_sparserep-1928"><a href="#Expansion_Model.get_sparserep-1928"><span class="linenos">1928</span></a>
</span><span id="Expansion_Model.get_sparserep-1929"><a href="#Expansion_Model.get_sparserep-1929"><span class="linenos">1929</span></a><span class="sd">        indn2</span>
</span><span id="Expansion_Model.get_sparserep-1930"><a href="#Expansion_Model.get_sparserep-1930"><span class="linenos">1930</span></a><span class="sd">            numpy array list of indexes of all values of unicountvals_2</span>
</span><span id="Expansion_Model.get_sparserep-1931"><a href="#Expansion_Model.get_sparserep-1931"><span class="linenos">1931</span></a>
</span><span id="Expansion_Model.get_sparserep-1932"><a href="#Expansion_Model.get_sparserep-1932"><span class="linenos">1932</span></a><span class="sd">        sparse_rep_counts</span>
</span><span id="Expansion_Model.get_sparserep-1933"><a href="#Expansion_Model.get_sparserep-1933"><span class="linenos">1933</span></a><span class="sd">            numpy array, # of clones having the read counts pair {(n1,n2)} </span>
</span><span id="Expansion_Model.get_sparserep-1934"><a href="#Expansion_Model.get_sparserep-1934"><span class="linenos">1934</span></a>
</span><span id="Expansion_Model.get_sparserep-1935"><a href="#Expansion_Model.get_sparserep-1935"><span class="linenos">1935</span></a><span class="sd">        unicountvals_1</span>
</span><span id="Expansion_Model.get_sparserep-1936"><a href="#Expansion_Model.get_sparserep-1936"><span class="linenos">1936</span></a><span class="sd">            numpy array list of unique counts values present in the first sample in df[clone_count_1]</span>
</span><span id="Expansion_Model.get_sparserep-1937"><a href="#Expansion_Model.get_sparserep-1937"><span class="linenos">1937</span></a>
</span><span id="Expansion_Model.get_sparserep-1938"><a href="#Expansion_Model.get_sparserep-1938"><span class="linenos">1938</span></a><span class="sd">        unicountvals_2</span>
</span><span id="Expansion_Model.get_sparserep-1939"><a href="#Expansion_Model.get_sparserep-1939"><span class="linenos">1939</span></a><span class="sd">            numpy array list of unique counts values present in the second sample in df[clone_count_2]</span>
</span><span id="Expansion_Model.get_sparserep-1940"><a href="#Expansion_Model.get_sparserep-1940"><span class="linenos">1940</span></a>
</span><span id="Expansion_Model.get_sparserep-1941"><a href="#Expansion_Model.get_sparserep-1941"><span class="linenos">1941</span></a><span class="sd">        Nreads1</span>
</span><span id="Expansion_Model.get_sparserep-1942"><a href="#Expansion_Model.get_sparserep-1942"><span class="linenos">1942</span></a><span class="sd">            float, total number of counts/reads in the first sample referred in df by &quot;_1&quot; for first time point</span>
</span><span id="Expansion_Model.get_sparserep-1943"><a href="#Expansion_Model.get_sparserep-1943"><span class="linenos">1943</span></a>
</span><span id="Expansion_Model.get_sparserep-1944"><a href="#Expansion_Model.get_sparserep-1944"><span class="linenos">1944</span></a><span class="sd">        Nreads2</span>
</span><span id="Expansion_Model.get_sparserep-1945"><a href="#Expansion_Model.get_sparserep-1945"><span class="linenos">1945</span></a><span class="sd">            float, total number of counts/reads in the second sample referred in df by &quot;_2&quot; for second time point</span>
</span><span id="Expansion_Model.get_sparserep-1946"><a href="#Expansion_Model.get_sparserep-1946"><span class="linenos">1946</span></a>
</span><span id="Expansion_Model.get_sparserep-1947"><a href="#Expansion_Model.get_sparserep-1947"><span class="linenos">1947</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Expansion_Model.get_sparserep-1948"><a href="#Expansion_Model.get_sparserep-1948"><span class="linenos">1948</span></a>        
</span><span id="Expansion_Model.get_sparserep-1949"><a href="#Expansion_Model.get_sparserep-1949"><span class="linenos">1949</span></a>        <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]]</span>
</span><span id="Expansion_Model.get_sparserep-1950"><a href="#Expansion_Model.get_sparserep-1950"><span class="linenos">1950</span></a>        <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;paircount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># gives a weight of 1 to each observed clone</span>
</span><span id="Expansion_Model.get_sparserep-1951"><a href="#Expansion_Model.get_sparserep-1951"><span class="linenos">1951</span></a>
</span><span id="Expansion_Model.get_sparserep-1952"><a href="#Expansion_Model.get_sparserep-1952"><span class="linenos">1952</span></a>        <span class="n">clone_counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Expansion_Model.get_sparserep-1953"><a href="#Expansion_Model.get_sparserep-1953"><span class="linenos">1953</span></a>        <span class="n">sparse_rep_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">clone_counts</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model.get_sparserep-1954"><a href="#Expansion_Model.get_sparserep-1954"><span class="linenos">1954</span></a>        <span class="n">clonecountpair_vals</span> <span class="o">=</span> <span class="n">clone_counts</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="Expansion_Model.get_sparserep-1955"><a href="#Expansion_Model.get_sparserep-1955"><span class="linenos">1955</span></a>        <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model.get_sparserep-1956"><a href="#Expansion_Model.get_sparserep-1956"><span class="linenos">1956</span></a>        <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">clonecountpair_vals</span><span class="p">[</span><span class="n">it</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sparse_rep_counts</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</span><span id="Expansion_Model.get_sparserep-1957"><a href="#Expansion_Model.get_sparserep-1957"><span class="linenos">1957</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="Expansion_Model.get_sparserep-1958"><a href="#Expansion_Model.get_sparserep-1958"><span class="linenos">1958</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="Expansion_Model.get_sparserep-1959"><a href="#Expansion_Model.get_sparserep-1959"><span class="linenos">1959</span></a>
</span><span id="Expansion_Model.get_sparserep-1960"><a href="#Expansion_Model.get_sparserep-1960"><span class="linenos">1960</span></a>        <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">indn1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn1</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Expansion_Model.get_sparserep-1961"><a href="#Expansion_Model.get_sparserep-1961"><span class="linenos">1961</span></a>        <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indn2</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Expansion_Model.get_sparserep-1962"><a href="#Expansion_Model.get_sparserep-1962"><span class="linenos">1962</span></a>
</span><span id="Expansion_Model.get_sparserep-1963"><a href="#Expansion_Model.get_sparserep-1963"><span class="linenos">1963</span></a>        <span class="k">return</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span>
</span></pre></div>


            <div class="docstring"><p>Tranforms {(n1,n2)} data stored in pandas dataframe to a sparse 1D representation.
unicountvals_1(2) are the unique values of n1(2).
sparse_rep_counts gives the counts of unique pairs.
ndn1(2) is the index of unicountvals_1(2) giving the value of n1(2) in that unique pair.
len(indn1)=len(indn2)=len(sparse_rep_counts)</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>df</strong> (pandas data frame):
data-frame which is the output of the method .import_data() for one Data_Process instance.
these data-frame should give the list of TCR clones present in two RepSeq samples, talen at two 
different time points, associated to their clone frequencies and clone abundances in the first and second replicate?</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>indn1</strong>: numpy array list of indexes of all values of unicountvals_1</li>
<li><strong>indn2</strong>: numpy array list of indexes of all values of unicountvals_2</li>
<li><strong>sparse_rep_counts</strong>: numpy array, # of clones having the read counts pair {(n1,n2)}</li>
<li><strong>unicountvals_1</strong>: numpy array list of unique counts values present in the first sample in df[clone_count_1]</li>
<li><strong>unicountvals_2</strong>: numpy array list of unique counts values present in the second sample in df[clone_count_2]</li>
<li><strong>Nreads1</strong>: float, total number of counts/reads in the first sample referred in df by "_1" for first time point</li>
<li><strong>Nreads2</strong>: float, total number of counts/reads in the second sample referred in df by "_2" for second time point</li>
</ul>
</div>


                            </div>
                            <div id="Expansion_Model.expansion_table" class="classattr">
                                        <input id="Expansion_Model.expansion_table-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">expansion_table</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">outpath</span>,</span><span class="param">	<span class="n">paras_1</span>,</span><span class="param">	<span class="n">paras_2</span>,</span><span class="param">	<span class="n">df</span>,</span><span class="param">	<span class="n">noise_model</span>,</span><span class="param">	<span class="n">pval_threshold</span>,</span><span class="param">	<span class="n">smed_threshold</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Expansion_Model.expansion_table-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Expansion_Model.expansion_table"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Expansion_Model.expansion_table-2466"><a href="#Expansion_Model.expansion_table-2466"><span class="linenos">2466</span></a>    <span class="k">def</span> <span class="nf">expansion_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">pval_threshold</span><span class="p">,</span> <span class="n">smed_threshold</span><span class="p">):</span>
</span><span id="Expansion_Model.expansion_table-2467"><a href="#Expansion_Model.expansion_table-2467"><span class="linenos">2467</span></a>
</span><span id="Expansion_Model.expansion_table-2468"><a href="#Expansion_Model.expansion_table-2468"><span class="linenos">2468</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Expansion_Model.expansion_table-2469"><a href="#Expansion_Model.expansion_table-2469"><span class="linenos">2469</span></a><span class="sd">        generate the table of clones that have been significantly detected to be responsive to an acute stimuli.    </span>
</span><span id="Expansion_Model.expansion_table-2470"><a href="#Expansion_Model.expansion_table-2470"><span class="linenos">2470</span></a><span class="sd">    </span>
</span><span id="Expansion_Model.expansion_table-2471"><a href="#Expansion_Model.expansion_table-2471"><span class="linenos">2471</span></a><span class="sd">        Parameters</span>
</span><span id="Expansion_Model.expansion_table-2472"><a href="#Expansion_Model.expansion_table-2472"><span class="linenos">2472</span></a><span class="sd">        ----------</span>
</span><span id="Expansion_Model.expansion_table-2473"><a href="#Expansion_Model.expansion_table-2473"><span class="linenos">2473</span></a><span class="sd">        outpath  : str</span>
</span><span id="Expansion_Model.expansion_table-2474"><a href="#Expansion_Model.expansion_table-2474"><span class="linenos">2474</span></a><span class="sd">            Name of the directory where to store the output table</span>
</span><span id="Expansion_Model.expansion_table-2475"><a href="#Expansion_Model.expansion_table-2475"><span class="linenos">2475</span></a><span class="sd">        paras_1  : numpy array</span>
</span><span id="Expansion_Model.expansion_table-2476"><a href="#Expansion_Model.expansion_table-2476"><span class="linenos">2476</span></a><span class="sd">            parameters of the noise model that has been learned at time_1</span>
</span><span id="Expansion_Model.expansion_table-2477"><a href="#Expansion_Model.expansion_table-2477"><span class="linenos">2477</span></a><span class="sd">        paras_2  : numpy array</span>
</span><span id="Expansion_Model.expansion_table-2478"><a href="#Expansion_Model.expansion_table-2478"><span class="linenos">2478</span></a><span class="sd">            parameters of the noise model that has been learned at time_2</span>
</span><span id="Expansion_Model.expansion_table-2479"><a href="#Expansion_Model.expansion_table-2479"><span class="linenos">2479</span></a><span class="sd">        df       : pandas dataframe </span>
</span><span id="Expansion_Model.expansion_table-2480"><a href="#Expansion_Model.expansion_table-2480"><span class="linenos">2480</span></a><span class="sd">            pandas dataframe merging the two RepSeq data at time_1 and time_2</span>
</span><span id="Expansion_Model.expansion_table-2481"><a href="#Expansion_Model.expansion_table-2481"><span class="linenos">2481</span></a>
</span><span id="Expansion_Model.expansion_table-2482"><a href="#Expansion_Model.expansion_table-2482"><span class="linenos">2482</span></a><span class="sd">        noise_model : int</span>
</span><span id="Expansion_Model.expansion_table-2483"><a href="#Expansion_Model.expansion_table-2483"><span class="linenos">2483</span></a><span class="sd">            choice of noise model 0: Poisson, 1: negative Binomial, 2: negative Binomial + Poisson  </span>
</span><span id="Expansion_Model.expansion_table-2484"><a href="#Expansion_Model.expansion_table-2484"><span class="linenos">2484</span></a>
</span><span id="Expansion_Model.expansion_table-2485"><a href="#Expansion_Model.expansion_table-2485"><span class="linenos">2485</span></a><span class="sd">        pval_threshold : float</span>
</span><span id="Expansion_Model.expansion_table-2486"><a href="#Expansion_Model.expansion_table-2486"><span class="linenos">2486</span></a><span class="sd">            P-value threshold to detect and discriminate if a TCR clone has expanded </span>
</span><span id="Expansion_Model.expansion_table-2487"><a href="#Expansion_Model.expansion_table-2487"><span class="linenos">2487</span></a>
</span><span id="Expansion_Model.expansion_table-2488"><a href="#Expansion_Model.expansion_table-2488"><span class="linenos">2488</span></a><span class="sd">        smed_threshold : float</span>
</span><span id="Expansion_Model.expansion_table-2489"><a href="#Expansion_Model.expansion_table-2489"><span class="linenos">2489</span></a><span class="sd">            median of the log-fold change threshold to detect if a TCR clone has expanded </span>
</span><span id="Expansion_Model.expansion_table-2490"><a href="#Expansion_Model.expansion_table-2490"><span class="linenos">2490</span></a>
</span><span id="Expansion_Model.expansion_table-2491"><a href="#Expansion_Model.expansion_table-2491"><span class="linenos">2491</span></a><span class="sd">        Returns</span>
</span><span id="Expansion_Model.expansion_table-2492"><a href="#Expansion_Model.expansion_table-2492"><span class="linenos">2492</span></a><span class="sd">        -------</span>
</span><span id="Expansion_Model.expansion_table-2493"><a href="#Expansion_Model.expansion_table-2493"><span class="linenos">2493</span></a><span class="sd">        data-frame - csv file</span>
</span><span id="Expansion_Model.expansion_table-2494"><a href="#Expansion_Model.expansion_table-2494"><span class="linenos">2494</span></a><span class="sd">            the output is a csv file of columns : $s_{1-low}$, $s_{2-med}$, $s_{3-high}$, $s_{max}$, $\bar{s}$, $f_1$, $f_2$, $n_1$, $n_2$, &#39;CDR3_nt&#39;, &#39;CDR3_AA&#39; and &#39;$p$-value&#39;</span>
</span><span id="Expansion_Model.expansion_table-2495"><a href="#Expansion_Model.expansion_table-2495"><span class="linenos">2495</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Expansion_Model.expansion_table-2496"><a href="#Expansion_Model.expansion_table-2496"><span class="linenos">2496</span></a>
</span><span id="Expansion_Model.expansion_table-2497"><a href="#Expansion_Model.expansion_table-2497"><span class="linenos">2497</span></a>        <span class="n">sparse_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sparserep</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="Expansion_Model.expansion_table-2498"><a href="#Expansion_Model.expansion_table-2498"><span class="linenos">2498</span></a>        <span class="n">L_surface</span><span class="p">,</span> <span class="n">Pn1n2_s_d</span><span class="p">,</span> <span class="n">Pn0n0_s_d</span><span class="p">,</span> <span class="n">svec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learning_dynamics_expansion</span><span class="p">(</span><span class="n">sparse_rep</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">)</span>
</span><span id="Expansion_Model.expansion_table-2499"><a href="#Expansion_Model.expansion_table-2499"><span class="linenos">2499</span></a>        <span class="n">npoints</span><span class="o">=</span> <span class="mi">50</span> <span class="c1"># same as in learning_dynamics_expansion</span>
</span><span id="Expansion_Model.expansion_table-2500"><a href="#Expansion_Model.expansion_table-2500"><span class="linenos">2500</span></a>        <span class="n">smax</span> <span class="o">=</span> <span class="mf">25.0</span>     
</span><span id="Expansion_Model.expansion_table-2501"><a href="#Expansion_Model.expansion_table-2501"><span class="linenos">2501</span></a>        <span class="n">s_step</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="Expansion_Model.expansion_table-2502"><a href="#Expansion_Model.expansion_table-2502"><span class="linenos">2502</span></a>        <span class="n">alpvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.99</span><span class="p">),</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="Expansion_Model.expansion_table-2503"><a href="#Expansion_Model.expansion_table-2503"><span class="linenos">2503</span></a>        <span class="n">sbarvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span>
</span><span id="Expansion_Model.expansion_table-2504"><a href="#Expansion_Model.expansion_table-2504"><span class="linenos">2504</span></a>        <span class="n">maxinds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">L_surface</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">L_surface</span><span class="p">))</span>
</span><span id="Expansion_Model.expansion_table-2505"><a href="#Expansion_Model.expansion_table-2505"><span class="linenos">2505</span></a>        <span class="n">optsbar</span><span class="o">=</span><span class="n">sbarvec</span><span class="p">[</span><span class="n">maxinds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="Expansion_Model.expansion_table-2506"><a href="#Expansion_Model.expansion_table-2506"><span class="linenos">2506</span></a>        <span class="n">optalp</span><span class="o">=</span><span class="n">alpvec</span><span class="p">[</span><span class="n">maxinds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="Expansion_Model.expansion_table-2507"><a href="#Expansion_Model.expansion_table-2507"><span class="linenos">2507</span></a>        <span class="n">optPs</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Ps</span><span class="p">(</span><span class="n">optalp</span><span class="p">,</span><span class="n">optsbar</span><span class="p">,</span><span class="n">smax</span><span class="p">,</span><span class="n">s_step</span><span class="p">)</span>
</span><span id="Expansion_Model.expansion_table-2508"><a href="#Expansion_Model.expansion_table-2508"><span class="linenos">2508</span></a>        <span class="n">pval_expanded</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Expansion_Model.expansion_table-2509"><a href="#Expansion_Model.expansion_table-2509"><span class="linenos">2509</span></a>
</span><span id="Expansion_Model.expansion_table-2510"><a href="#Expansion_Model.expansion_table-2510"><span class="linenos">2510</span></a>        <span class="n">indn1</span><span class="p">,</span><span class="n">indn2</span><span class="p">,</span><span class="n">sparse_rep_counts</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="n">sparse_rep</span>
</span><span id="Expansion_Model.expansion_table-2511"><a href="#Expansion_Model.expansion_table-2511"><span class="linenos">2511</span></a>
</span><span id="Expansion_Model.expansion_table-2512"><a href="#Expansion_Model.expansion_table-2512"><span class="linenos">2512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_table</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">svec</span><span class="p">,</span> <span class="n">optPs</span><span class="p">,</span> <span class="n">Pn1n2_s_d</span><span class="p">,</span> <span class="n">Pn0n0_s_d</span><span class="p">,</span>  <span class="n">df</span><span class="p">,</span> <span class="n">unicountvals_1</span><span class="p">,</span> <span class="n">unicountvals_2</span><span class="p">,</span> <span class="n">indn1</span><span class="p">,</span> <span class="n">indn2</span><span class="p">,</span> <span class="n">pval_expanded</span><span class="p">,</span> <span class="n">pval_threshold</span><span class="p">,</span> <span class="n">smed_threshold</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>generate the table of clones that have been significantly detected to be responsive to an acute stimuli.    </p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>outpath</strong> (str):
Name of the directory where to store the output table</li>
<li><strong>paras_1</strong> (numpy array):
parameters of the noise model that has been learned at time_1</li>
<li><strong>paras_2</strong> (numpy array):
parameters of the noise model that has been learned at time_2</li>
<li><strong>df</strong> (pandas dataframe):
pandas dataframe merging the two RepSeq data at time_1 and time_2</li>
<li><strong>noise_model</strong> (int):
choice of noise model 0: Poisson, 1: negative Binomial, 2: negative Binomial + Poisson</li>
<li><strong>pval_threshold</strong> (float):
P-value threshold to detect and discriminate if a TCR clone has expanded</li>
<li><strong>smed_threshold</strong> (float):
median of the log-fold change threshold to detect if a TCR clone has expanded</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>data-frame - csv file</strong>: the output is a csv file of columns : $s_{1-low}$, $s_{2-med}$, $s_{3-high}$, $s_{max}$, $ar{s}$, $f_1$, $f_2$, $n_1$, $n_2$, 'CDR3_nt', 'CDR3_AA' and '$p$-value'</li>
</ul>
</div>


                            </div>
                </section>
                <section id="Generator">
                            <input id="Generator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Generator</span>:

                <label class="view-source-button" for="Generator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Generator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Generator-2517"><a href="#Generator-2517"><span class="linenos">2517</span></a><span class="k">class</span> <span class="nc">Generator</span><span class="p">:</span>
</span><span id="Generator-2518"><a href="#Generator-2518"><span class="linenos">2518</span></a>
</span><span id="Generator-2519"><a href="#Generator-2519"><span class="linenos">2519</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Generator-2520"><a href="#Generator-2520"><span class="linenos">2520</span></a><span class="sd">    A class used to build an object to generate in-Silico (synthetic) RepSeq samples, in the case of replicates at</span>
</span><span id="Generator-2521"><a href="#Generator-2521"><span class="linenos">2521</span></a><span class="sd">    the same day and in the case of having 2 samples generated at an initial time for the first one and some time after (months, years)</span>
</span><span id="Generator-2522"><a href="#Generator-2522"><span class="linenos">2522</span></a><span class="sd">    for the second one using the geometric Brownian motion model decribed in https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1.</span>
</span><span id="Generator-2523"><a href="#Generator-2523"><span class="linenos">2523</span></a>
</span><span id="Generator-2524"><a href="#Generator-2524"><span class="linenos">2524</span></a><span class="sd">    ...</span>
</span><span id="Generator-2525"><a href="#Generator-2525"><span class="linenos">2525</span></a>
</span><span id="Generator-2526"><a href="#Generator-2526"><span class="linenos">2526</span></a><span class="sd">    Methods</span>
</span><span id="Generator-2527"><a href="#Generator-2527"><span class="linenos">2527</span></a><span class="sd">    -------</span>
</span><span id="Generator-2528"><a href="#Generator-2528"><span class="linenos">2528</span></a>
</span><span id="Generator-2529"><a href="#Generator-2529"><span class="linenos">2529</span></a><span class="sd">    gen_synthetic_data_Null(paras, noise_model, NreadsI,NreadsII,Nsamp):</span>
</span><span id="Generator-2530"><a href="#Generator-2530"><span class="linenos">2530</span></a><span class="sd">        generate in-silico same day RepSeq replicates.</span>
</span><span id="Generator-2531"><a href="#Generator-2531"><span class="linenos">2531</span></a>
</span><span id="Generator-2532"><a href="#Generator-2532"><span class="linenos">2532</span></a><span class="sd">    generate_trajectories(tau, theta, method, paras_1, paras_2, t_ime, filename, NreadsI = &#39;1e6&#39;, NreadsII = &#39;1e6&#39;):</span>
</span><span id="Generator-2533"><a href="#Generator-2533"><span class="linenos">2533</span></a><span class="sd">        generate in-silico t_ime apart RepSeq samples.</span>
</span><span id="Generator-2534"><a href="#Generator-2534"><span class="linenos">2534</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Generator-2535"><a href="#Generator-2535"><span class="linenos">2535</span></a>
</span><span id="Generator-2536"><a href="#Generator-2536"><span class="linenos">2536</span></a>    <span class="k">def</span> <span class="nf">_get_rhof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha_rho</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">freq_nbins</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">freq_dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">):</span>
</span><span id="Generator-2537"><a href="#Generator-2537"><span class="linenos">2537</span></a>
</span><span id="Generator-2538"><a href="#Generator-2538"><span class="linenos">2538</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Generator-2539"><a href="#Generator-2539"><span class="linenos">2539</span></a><span class="sd">        generates power law (power is alpha_rho) clone frequency distribution over </span>
</span><span id="Generator-2540"><a href="#Generator-2540"><span class="linenos">2540</span></a><span class="sd">        freq_nbins discrete logarithmically spaced frequences between fmin and 1 of dtype freq_dtype</span>
</span><span id="Generator-2541"><a href="#Generator-2541"><span class="linenos">2541</span></a><span class="sd">        Outputs log probabilities obtained at log frequencies&#39;&#39;&#39;</span>
</span><span id="Generator-2542"><a href="#Generator-2542"><span class="linenos">2542</span></a>        <span class="n">fmax</span><span class="o">=</span><span class="mf">1e0</span>
</span><span id="Generator-2543"><a href="#Generator-2543"><span class="linenos">2543</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fmax</span><span class="p">),</span><span class="n">freq_nbins</span><span class="p">)</span>
</span><span id="Generator-2544"><a href="#Generator-2544"><span class="linenos">2544</span></a>        <span class="n">logfvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">logfvec</span><span class="p">))</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  
</span><span id="Generator-2545"><a href="#Generator-2545"><span class="linenos">2545</span></a>        <span class="n">logrhovec</span><span class="o">=</span><span class="n">logfvec</span><span class="o">*</span><span class="n">alpha_rho</span>
</span><span id="Generator-2546"><a href="#Generator-2546"><span class="linenos">2546</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logrhovec</span><span class="o">+</span><span class="n">logfvec</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">freq_dtype</span><span class="p">)</span>
</span><span id="Generator-2547"><a href="#Generator-2547"><span class="linenos">2547</span></a>        <span class="n">normconst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="Generator-2548"><a href="#Generator-2548"><span class="linenos">2548</span></a>        <span class="n">logrhovec</span><span class="o">-=</span><span class="n">normconst</span> 
</span><span id="Generator-2549"><a href="#Generator-2549"><span class="linenos">2549</span></a>        <span class="k">return</span> <span class="n">logrhovec</span><span class="p">,</span><span class="n">logfvec</span>
</span><span id="Generator-2550"><a href="#Generator-2550"><span class="linenos">2550</span></a>
</span><span id="Generator-2551"><a href="#Generator-2551"><span class="linenos">2551</span></a>    <span class="k">def</span> <span class="nf">_get_distsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pmf</span><span class="p">,</span><span class="n">Nsamp</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint32&#39;</span><span class="p">):</span>
</span><span id="Generator-2552"><a href="#Generator-2552"><span class="linenos">2552</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Generator-2553"><a href="#Generator-2553"><span class="linenos">2553</span></a><span class="sd">        generates Nsamp index samples of dtype (e.g. uint16 handles up to 65535 indices) from discrete probability mass function pmf.</span>
</span><span id="Generator-2554"><a href="#Generator-2554"><span class="linenos">2554</span></a><span class="sd">        Handles multi-dimensional domain. N.B. Output is sorted.</span>
</span><span id="Generator-2555"><a href="#Generator-2555"><span class="linenos">2555</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Generator-2556"><a href="#Generator-2556"><span class="linenos">2556</span></a>        <span class="c1">#assert np.sum(pmf)==1, &quot;cmf not normalized!&quot;</span>
</span><span id="Generator-2557"><a href="#Generator-2557"><span class="linenos">2557</span></a>    
</span><span id="Generator-2558"><a href="#Generator-2558"><span class="linenos">2558</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
</span><span id="Generator-2559"><a href="#Generator-2559"><span class="linenos">2559</span></a>        <span class="n">sortindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pmf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="c1">#uses flattened array</span>
</span><span id="Generator-2560"><a href="#Generator-2560"><span class="linenos">2560</span></a>        <span class="n">pmf</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="Generator-2561"><a href="#Generator-2561"><span class="linenos">2561</span></a>        <span class="n">pmf</span> <span class="o">=</span> <span class="n">pmf</span><span class="p">[</span><span class="n">sortindex</span><span class="p">]</span>
</span><span id="Generator-2562"><a href="#Generator-2562"><span class="linenos">2562</span></a>        <span class="n">cmf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
</span><span id="Generator-2563"><a href="#Generator-2563"><span class="linenos">2563</span></a>        <span class="n">choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">high</span> <span class="o">=</span> <span class="n">cmf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">Nsamp</span><span class="p">)))</span>
</span><span id="Generator-2564"><a href="#Generator-2564"><span class="linenos">2564</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">cmf</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
</span><span id="Generator-2565"><a href="#Generator-2565"><span class="linenos">2565</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">sortindex</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="Generator-2566"><a href="#Generator-2566"><span class="linenos">2566</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
</span><span id="Generator-2567"><a href="#Generator-2567"><span class="linenos">2567</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span><span id="Generator-2568"><a href="#Generator-2568"><span class="linenos">2568</span></a>        <span class="n">sampled_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">index</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])],</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="Generator-2569"><a href="#Generator-2569"><span class="linenos">2569</span></a>        <span class="k">return</span> <span class="n">sampled_inds</span>
</span><span id="Generator-2570"><a href="#Generator-2570"><span class="linenos">2570</span></a>
</span><span id="Generator-2571"><a href="#Generator-2571"><span class="linenos">2571</span></a>    
</span><span id="Generator-2572"><a href="#Generator-2572"><span class="linenos">2572</span></a>    <span class="k">def</span> <span class="nf">gen_synthetic_data_Null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span><span class="p">,</span><span class="n">Nsamp</span><span class="p">):</span>
</span><span id="Generator-2573"><a href="#Generator-2573"><span class="linenos">2573</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Generator-2574"><a href="#Generator-2574"><span class="linenos">2574</span></a><span class="sd">        outputs an array of observed clone frequencies and corresponding dataframe of pair counts</span>
</span><span id="Generator-2575"><a href="#Generator-2575"><span class="linenos">2575</span></a><span class="sd">        for a null model learned from a dataset pair with NreadsI and NreadsII number of reads, respectively.</span>
</span><span id="Generator-2576"><a href="#Generator-2576"><span class="linenos">2576</span></a><span class="sd">        Crucial for RAM efficiency, sampling is conditioned on being observed in each of the three (n,0), (0,n&#39;), and n,n&#39;&gt;0 conditions</span>
</span><span id="Generator-2577"><a href="#Generator-2577"><span class="linenos">2577</span></a><span class="sd">        so that only Nsamp clones need to be sampled, rather than the N clones in the repertoire.</span>
</span><span id="Generator-2578"><a href="#Generator-2578"><span class="linenos">2578</span></a><span class="sd">        Note that no explicit normalization is applied. It is assumed that the values in paras are consistent with N&lt;f&gt;=1 </span>
</span><span id="Generator-2579"><a href="#Generator-2579"><span class="linenos">2579</span></a><span class="sd">        (e.g. were obtained through the learning done in this package).</span>
</span><span id="Generator-2580"><a href="#Generator-2580"><span class="linenos">2580</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Generator-2581"><a href="#Generator-2581"><span class="linenos">2581</span></a>
</span><span id="Generator-2582"><a href="#Generator-2582"><span class="linenos">2582</span></a>    
</span><span id="Generator-2583"><a href="#Generator-2583"><span class="linenos">2583</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#power law exponent</span>
</span><span id="Generator-2584"><a href="#Generator-2584"><span class="linenos">2584</span></a>        <span class="n">fmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Generator-2585"><a href="#Generator-2585"><span class="linenos">2585</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator-2586"><a href="#Generator-2586"><span class="linenos">2586</span></a>            <span class="n">m_total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> 
</span><span id="Generator-2587"><a href="#Generator-2587"><span class="linenos">2587</span></a>            <span class="n">r_c1</span><span class="o">=</span><span class="n">NreadsI</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="Generator-2588"><a href="#Generator-2588"><span class="linenos">2588</span></a>            <span class="n">r_c2</span><span class="o">=</span><span class="n">NreadsII</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="Generator-2589"><a href="#Generator-2589"><span class="linenos">2589</span></a>            <span class="n">r_cvec</span><span class="o">=</span><span class="p">[</span><span class="n">r_c1</span><span class="p">,</span><span class="n">r_c2</span><span class="p">]</span>
</span><span id="Generator-2590"><a href="#Generator-2590"><span class="linenos">2590</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="Generator-2591"><a href="#Generator-2591"><span class="linenos">2591</span></a>            <span class="n">beta_mv</span><span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Generator-2592"><a href="#Generator-2592"><span class="linenos">2592</span></a>            <span class="n">alpha_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Generator-2593"><a href="#Generator-2593"><span class="linenos">2593</span></a>    
</span><span id="Generator-2594"><a href="#Generator-2594"><span class="linenos">2594</span></a>        <span class="n">logrhofvec</span><span class="p">,</span><span class="n">logfvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">fmin</span><span class="p">)</span>
</span><span id="Generator-2595"><a href="#Generator-2595"><span class="linenos">2595</span></a>        <span class="n">fvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator-2596"><a href="#Generator-2596"><span class="linenos">2596</span></a>        <span class="n">dlogf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
</span><span id="Generator-2597"><a href="#Generator-2597"><span class="linenos">2597</span></a>    
</span><span id="Generator-2598"><a href="#Generator-2598"><span class="linenos">2598</span></a>        <span class="c1">#generate measurement model distribution, Pn_f</span>
</span><span id="Generator-2599"><a href="#Generator-2599"><span class="linenos">2599</span></a>        <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span> <span class="c1">#len(logfvec) samplers</span>
</span><span id="Generator-2600"><a href="#Generator-2600"><span class="linenos">2600</span></a>    
</span><span id="Generator-2601"><a href="#Generator-2601"><span class="linenos">2601</span></a>        <span class="c1">#get value at n=0 to use for conditioning on n&gt;0 (and get full Pn_f here if noise_model=1,2)</span>
</span><span id="Generator-2602"><a href="#Generator-2602"><span class="linenos">2602</span></a>        <span class="n">m_max</span><span class="o">=</span><span class="mf">1e3</span> <span class="c1">#conditioned on n=0, so no edge effects</span>
</span><span id="Generator-2603"><a href="#Generator-2603"><span class="linenos">2603</span></a>    
</span><span id="Generator-2604"><a href="#Generator-2604"><span class="linenos">2604</span></a>        <span class="n">Nreadsvec</span><span class="o">=</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span><span class="p">)</span>
</span><span id="Generator-2605"><a href="#Generator-2605"><span class="linenos">2605</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="Generator-2606"><a href="#Generator-2606"><span class="linenos">2606</span></a>            <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fvec</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="Generator-2607"><a href="#Generator-2607"><span class="linenos">2607</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="Generator-2608"><a href="#Generator-2608"><span class="linenos">2608</span></a>                <span class="n">m1vec</span><span class="o">=</span><span class="n">Nreadsvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="Generator-2609"><a href="#Generator-2609"><span class="linenos">2609</span></a>                <span class="k">for</span> <span class="n">find</span><span class="p">,</span><span class="n">m1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m1vec</span><span class="p">):</span>
</span><span id="Generator-2610"><a href="#Generator-2610"><span class="linenos">2610</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
</span><span id="Generator-2611"><a href="#Generator-2611"><span class="linenos">2611</span></a>                <span class="n">logPn0_f</span><span class="o">=-</span><span class="n">m1vec</span>
</span><span id="Generator-2612"><a href="#Generator-2612"><span class="linenos">2612</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator-2613"><a href="#Generator-2613"><span class="linenos">2613</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">Nreadsvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="Generator-2614"><a href="#Generator-2614"><span class="linenos">2614</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator-2615"><a href="#Generator-2615"><span class="linenos">2615</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="Generator-2616"><a href="#Generator-2616"><span class="linenos">2616</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator-2617"><a href="#Generator-2617"><span class="linenos">2617</span></a>                <span class="k">for</span> <span class="n">find</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">)):</span>
</span><span id="Generator-2618"><a href="#Generator-2618"><span class="linenos">2618</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator-2619"><a href="#Generator-2619"><span class="linenos">2619</span></a>                <span class="n">Pn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">Pn_find</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">Pn_find</span> <span class="ow">in</span> <span class="n">Pn_f</span><span class="p">])</span>
</span><span id="Generator-2620"><a href="#Generator-2620"><span class="linenos">2620</span></a>                <span class="n">logPn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)</span>
</span><span id="Generator-2621"><a href="#Generator-2621"><span class="linenos">2621</span></a>            
</span><span id="Generator-2622"><a href="#Generator-2622"><span class="linenos">2622</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2623"><a href="#Generator-2623"><span class="linenos">2623</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="Generator-2624"><a href="#Generator-2624"><span class="linenos">2624</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator-2625"><a href="#Generator-2625"><span class="linenos">2625</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="Generator-2626"><a href="#Generator-2626"><span class="linenos">2626</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator-2627"><a href="#Generator-2627"><span class="linenos">2627</span></a>                <span class="n">Pn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fvec</span><span class="p">),))</span>
</span><span id="Generator-2628"><a href="#Generator-2628"><span class="linenos">2628</span></a>                <span class="k">for</span> <span class="n">find</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)):</span>
</span><span id="Generator-2629"><a href="#Generator-2629"><span class="linenos">2629</span></a>                    <span class="n">nbtmp</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">find</span><span class="p">],</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">find</span><span class="p">])</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="Generator-2630"><a href="#Generator-2630"><span class="linenos">2630</span></a>                    <span class="n">ptmp</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_cvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2631"><a href="#Generator-2631"><span class="linenos">2631</span></a>                    <span class="n">Pn0_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nbtmp</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ptmp</span><span class="p">)))</span>
</span><span id="Generator-2632"><a href="#Generator-2632"><span class="linenos">2632</span></a>                <span class="n">logPn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)</span>
</span><span id="Generator-2633"><a href="#Generator-2633"><span class="linenos">2633</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator-2634"><a href="#Generator-2634"><span class="linenos">2634</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1,or 2 only&#39;</span><span class="p">)</span>
</span><span id="Generator-2635"><a href="#Generator-2635"><span class="linenos">2635</span></a>            
</span><span id="Generator-2636"><a href="#Generator-2636"><span class="linenos">2636</span></a>            <span class="k">if</span> <span class="n">it</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2637"><a href="#Generator-2637"><span class="linenos">2637</span></a>                <span class="n">Pn1_f</span><span class="o">=</span><span class="n">Pn_f</span>
</span><span id="Generator-2638"><a href="#Generator-2638"><span class="linenos">2638</span></a>                <span class="n">logPn10_f</span><span class="o">=</span><span class="n">logPn0_f</span>
</span><span id="Generator-2639"><a href="#Generator-2639"><span class="linenos">2639</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator-2640"><a href="#Generator-2640"><span class="linenos">2640</span></a>                <span class="n">Pn2_f</span><span class="o">=</span><span class="n">Pn_f</span>
</span><span id="Generator-2641"><a href="#Generator-2641"><span class="linenos">2641</span></a>                <span class="n">logPn20_f</span><span class="o">=</span><span class="n">logPn0_f</span>
</span><span id="Generator-2642"><a href="#Generator-2642"><span class="linenos">2642</span></a>
</span><span id="Generator-2643"><a href="#Generator-2643"><span class="linenos">2643</span></a>        <span class="c1">#3-quadrant q|f conditional distribution (qx0:n1&gt;0,n2=0;q0x:n1=0,n2&gt;0;qxx:n1,n2&gt;0)</span>
</span><span id="Generator-2644"><a href="#Generator-2644"><span class="linenos">2644</span></a>        <span class="n">logPqx0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn10_f</span><span class="p">))</span><span class="o">+</span><span class="n">logPn20_f</span>
</span><span id="Generator-2645"><a href="#Generator-2645"><span class="linenos">2645</span></a>        <span class="n">logPq0x_f</span><span class="o">=</span><span class="n">logPn10_f</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn20_f</span><span class="p">))</span>
</span><span id="Generator-2646"><a href="#Generator-2646"><span class="linenos">2646</span></a>        <span class="n">logPqxx_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn10_f</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn20_f</span><span class="p">))</span>
</span><span id="Generator-2647"><a href="#Generator-2647"><span class="linenos">2647</span></a>        <span class="c1">#3-quadrant q,f joint distribution</span>
</span><span id="Generator-2648"><a href="#Generator-2648"><span class="linenos">2648</span></a>        <span class="n">logPfqx0</span><span class="o">=</span><span class="n">logPqx0_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="Generator-2649"><a href="#Generator-2649"><span class="linenos">2649</span></a>        <span class="n">logPfq0x</span><span class="o">=</span><span class="n">logPq0x_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="Generator-2650"><a href="#Generator-2650"><span class="linenos">2650</span></a>        <span class="n">logPfqxx</span><span class="o">=</span><span class="n">logPqxx_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="Generator-2651"><a href="#Generator-2651"><span class="linenos">2651</span></a>        <span class="c1">#3-quadrant q marginal distribution </span>
</span><span id="Generator-2652"><a href="#Generator-2652"><span class="linenos">2652</span></a>        <span class="n">Pqx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator-2653"><a href="#Generator-2653"><span class="linenos">2653</span></a>        <span class="n">Pq0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator-2654"><a href="#Generator-2654"><span class="linenos">2654</span></a>        <span class="n">Pqxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator-2655"><a href="#Generator-2655"><span class="linenos">2655</span></a>    
</span><span id="Generator-2656"><a href="#Generator-2656"><span class="linenos">2656</span></a>        <span class="c1">#3 quadrant conditional f|q distribution</span>
</span><span id="Generator-2657"><a href="#Generator-2657"><span class="linenos">2657</span></a>        <span class="n">Pf_qx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pqx0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2658"><a href="#Generator-2658"><span class="linenos">2658</span></a>        <span class="n">Pf_q0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pq0x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pq0x</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2659"><a href="#Generator-2659"><span class="linenos">2659</span></a>        <span class="n">Pf_qxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pqxx</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pqxx</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2660"><a href="#Generator-2660"><span class="linenos">2660</span></a>    
</span><span id="Generator-2661"><a href="#Generator-2661"><span class="linenos">2661</span></a>        <span class="c1">#3-quadrant q marginal distribution</span>
</span><span id="Generator-2662"><a href="#Generator-2662"><span class="linenos">2662</span></a>        <span class="n">newPqZ</span><span class="o">=</span><span class="n">Pqx0</span> <span class="o">+</span> <span class="n">Pq0x</span> <span class="o">+</span> <span class="n">Pqxx</span>
</span><span id="Generator-2663"><a href="#Generator-2663"><span class="linenos">2663</span></a>        <span class="n">Pqx0</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="Generator-2664"><a href="#Generator-2664"><span class="linenos">2664</span></a>        <span class="n">Pq0x</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="Generator-2665"><a href="#Generator-2665"><span class="linenos">2665</span></a>        <span class="n">Pqxx</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="Generator-2666"><a href="#Generator-2666"><span class="linenos">2666</span></a>
</span><span id="Generator-2667"><a href="#Generator-2667"><span class="linenos">2667</span></a>        <span class="n">Pfqx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="p">)</span>
</span><span id="Generator-2668"><a href="#Generator-2668"><span class="linenos">2668</span></a>        <span class="n">Pfq0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="p">)</span>
</span><span id="Generator-2669"><a href="#Generator-2669"><span class="linenos">2669</span></a>        <span class="n">Pfqxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="p">)</span>
</span><span id="Generator-2670"><a href="#Generator-2670"><span class="linenos">2670</span></a>    
</span><span id="Generator-2671"><a href="#Generator-2671"><span class="linenos">2671</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model probs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pq0x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pqxx</span><span class="p">))</span>
</span><span id="Generator-2672"><a href="#Generator-2672"><span class="linenos">2672</span></a>
</span><span id="Generator-2673"><a href="#Generator-2673"><span class="linenos">2673</span></a>        <span class="c1">#get samples </span>
</span><span id="Generator-2674"><a href="#Generator-2674"><span class="linenos">2674</span></a>        <span class="n">num_samples</span><span class="o">=</span><span class="n">Nsamp</span>
</span><span id="Generator-2675"><a href="#Generator-2675"><span class="linenos">2675</span></a>        <span class="n">q_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">,</span><span class="n">Pq0x</span><span class="p">,</span><span class="n">Pqxx</span><span class="p">))</span>
</span><span id="Generator-2676"><a href="#Generator-2676"><span class="linenos">2676</span></a>        <span class="n">vals</span><span class="p">,</span><span class="n">counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">q_samples</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator-2677"><a href="#Generator-2677"><span class="linenos">2677</span></a>        <span class="n">num_qx0</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Generator-2678"><a href="#Generator-2678"><span class="linenos">2678</span></a>        <span class="n">num_q0x</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Generator-2679"><a href="#Generator-2679"><span class="linenos">2679</span></a>        <span class="n">num_qxx</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Generator-2680"><a href="#Generator-2680"><span class="linenos">2680</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qx0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_q0x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qxx</span><span class="p">))</span>
</span><span id="Generator-2681"><a href="#Generator-2681"><span class="linenos">2681</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q sampled probs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qx0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_q0x</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qxx</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">))))</span>
</span><span id="Generator-2682"><a href="#Generator-2682"><span class="linenos">2682</span></a>    
</span><span id="Generator-2683"><a href="#Generator-2683"><span class="linenos">2683</span></a>        <span class="c1">#x0</span>
</span><span id="Generator-2684"><a href="#Generator-2684"><span class="linenos">2684</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_qx0</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator-2685"><a href="#Generator-2685"><span class="linenos">2685</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_qx0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="Generator-2686"><a href="#Generator-2686"><span class="linenos">2686</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="Generator-2687"><a href="#Generator-2687"><span class="linenos">2687</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="Generator-2688"><a href="#Generator-2688"><span class="linenos">2688</span></a>        <span class="n">qx0_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="Generator-2689"><a href="#Generator-2689"><span class="linenos">2689</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator-2690"><a href="#Generator-2690"><span class="linenos">2690</span></a>        <span class="n">qx0_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,))</span>
</span><span id="Generator-2691"><a href="#Generator-2691"><span class="linenos">2691</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator-2692"><a href="#Generator-2692"><span class="linenos">2692</span></a>            <span class="n">qx0_m_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,))</span>
</span><span id="Generator-2693"><a href="#Generator-2693"><span class="linenos">2693</span></a>            <span class="c1">#conditioning on n&gt;0 applies an m-dependent factor to Pm_f, which can&#39;t be incorporated into the ppf method used for noise_model 1 and 2. </span>
</span><span id="Generator-2694"><a href="#Generator-2694"><span class="linenos">2694</span></a>            <span class="c1">#We handle that here by using a custom finite range sampler, which has the drawback of having to define an upper limit. </span>
</span><span id="Generator-2695"><a href="#Generator-2695"><span class="linenos">2695</span></a>            <span class="c1">#This works so long as n_max/r_c&lt;&lt;m_max, so depends on highest counts in data (n_max). My data had max counts of 1e3-1e4.</span>
</span><span id="Generator-2696"><a href="#Generator-2696"><span class="linenos">2696</span></a>            <span class="c1">#Alternatively, could define a custom scipy RV class by defining it&#39;s PMF, but has to be array-compatible which requires care. </span>
</span><span id="Generator-2697"><a href="#Generator-2697"><span class="linenos">2697</span></a>            <span class="n">m_samp_max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">)</span> 
</span><span id="Generator-2698"><a href="#Generator-2698"><span class="linenos">2698</span></a>            <span class="n">mvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_samp_max</span><span class="p">)</span>   
</span><span id="Generator-2699"><a href="#Generator-2699"><span class="linenos">2699</span></a>    
</span><span id="Generator-2700"><a href="#Generator-2700"><span class="linenos">2700</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="Generator-2701"><a href="#Generator-2701"><span class="linenos">2701</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>      
</span><span id="Generator-2702"><a href="#Generator-2702"><span class="linenos">2702</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="Generator-2703"><a href="#Generator-2703"><span class="linenos">2703</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator-2704"><a href="#Generator-2704"><span class="linenos">2704</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="Generator-2705"><a href="#Generator-2705"><span class="linenos">2705</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator-2706"><a href="#Generator-2706"><span class="linenos">2706</span></a>                <span class="n">Pm1_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator-2707"><a href="#Generator-2707"><span class="linenos">2707</span></a>            
</span><span id="Generator-2708"><a href="#Generator-2708"><span class="linenos">2708</span></a>                <span class="n">Pm1_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c1</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm1_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="Generator-2709"><a href="#Generator-2709"><span class="linenos">2709</span></a>                <span class="n">Pm1_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm1_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)))</span>
</span><span id="Generator-2710"><a href="#Generator-2710"><span class="linenos">2710</span></a>                <span class="n">qx0_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm1_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="Generator-2711"><a href="#Generator-2711"><span class="linenos">2711</span></a>            
</span><span id="Generator-2712"><a href="#Generator-2712"><span class="linenos">2712</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qx0_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator-2713"><a href="#Generator-2713"><span class="linenos">2713</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="Generator-2714"><a href="#Generator-2714"><span class="linenos">2714</span></a>                    <span class="n">Pn1_m1</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c1</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="Generator-2715"><a href="#Generator-2715"><span class="linenos">2715</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2716"><a href="#Generator-2716"><span class="linenos">2716</span></a>                    <span class="n">qx0_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator-2717"><a href="#Generator-2717"><span class="linenos">2717</span></a> 
</span><span id="Generator-2718"><a href="#Generator-2718"><span class="linenos">2718</span></a>        
</span><span id="Generator-2719"><a href="#Generator-2719"><span class="linenos">2719</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2720"><a href="#Generator-2720"><span class="linenos">2720</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2721"><a href="#Generator-2721"><span class="linenos">2721</span></a>                <span class="n">qx0_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator-2722"><a href="#Generator-2722"><span class="linenos">2722</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator-2723"><a href="#Generator-2723"><span class="linenos">2723</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1, or 2 only&#39;</span><span class="p">)</span>
</span><span id="Generator-2724"><a href="#Generator-2724"><span class="linenos">2724</span></a>        <span class="n">qx0_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">qx0_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span> 
</span><span id="Generator-2725"><a href="#Generator-2725"><span class="linenos">2725</span></a>    
</span><span id="Generator-2726"><a href="#Generator-2726"><span class="linenos">2726</span></a>        <span class="c1">#0x</span>
</span><span id="Generator-2727"><a href="#Generator-2727"><span class="linenos">2727</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_q0x</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator-2728"><a href="#Generator-2728"><span class="linenos">2728</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_q0x</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="Generator-2729"><a href="#Generator-2729"><span class="linenos">2729</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="Generator-2730"><a href="#Generator-2730"><span class="linenos">2730</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="Generator-2731"><a href="#Generator-2731"><span class="linenos">2731</span></a>        <span class="n">q0x_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="Generator-2732"><a href="#Generator-2732"><span class="linenos">2732</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator-2733"><a href="#Generator-2733"><span class="linenos">2733</span></a>        <span class="n">q0x_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,))</span>
</span><span id="Generator-2734"><a href="#Generator-2734"><span class="linenos">2734</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator-2735"><a href="#Generator-2735"><span class="linenos">2735</span></a>            <span class="n">q0x_m_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,))</span>
</span><span id="Generator-2736"><a href="#Generator-2736"><span class="linenos">2736</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="Generator-2737"><a href="#Generator-2737"><span class="linenos">2737</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2738"><a href="#Generator-2738"><span class="linenos">2738</span></a>                <span class="n">m2</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="Generator-2739"><a href="#Generator-2739"><span class="linenos">2739</span></a>                <span class="n">v2</span><span class="o">=</span><span class="n">m2</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator-2740"><a href="#Generator-2740"><span class="linenos">2740</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span>
</span><span id="Generator-2741"><a href="#Generator-2741"><span class="linenos">2741</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m2</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator-2742"><a href="#Generator-2742"><span class="linenos">2742</span></a>                <span class="n">Pm2_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator-2743"><a href="#Generator-2743"><span class="linenos">2743</span></a>            
</span><span id="Generator-2744"><a href="#Generator-2744"><span class="linenos">2744</span></a>                <span class="n">Pm2_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c2</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm2_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="Generator-2745"><a href="#Generator-2745"><span class="linenos">2745</span></a>                <span class="n">Pm2_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm2_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm2_f_adj</span><span class="p">)))</span>
</span><span id="Generator-2746"><a href="#Generator-2746"><span class="linenos">2746</span></a>                <span class="n">q0x_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm2_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="Generator-2747"><a href="#Generator-2747"><span class="linenos">2747</span></a>
</span><span id="Generator-2748"><a href="#Generator-2748"><span class="linenos">2748</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">q0x_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator-2749"><a href="#Generator-2749"><span class="linenos">2749</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="Generator-2750"><a href="#Generator-2750"><span class="linenos">2750</span></a>                    <span class="n">Pn2_m2</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="Generator-2751"><a href="#Generator-2751"><span class="linenos">2751</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2752"><a href="#Generator-2752"><span class="linenos">2752</span></a>                    <span class="n">q0x_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator-2753"><a href="#Generator-2753"><span class="linenos">2753</span></a>        
</span><span id="Generator-2754"><a href="#Generator-2754"><span class="linenos">2754</span></a>                       
</span><span id="Generator-2755"><a href="#Generator-2755"><span class="linenos">2755</span></a>        
</span><span id="Generator-2756"><a href="#Generator-2756"><span class="linenos">2756</span></a>            <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2757"><a href="#Generator-2757"><span class="linenos">2757</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2758"><a href="#Generator-2758"><span class="linenos">2758</span></a>                <span class="n">q0x_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator-2759"><a href="#Generator-2759"><span class="linenos">2759</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator-2760"><a href="#Generator-2760"><span class="linenos">2760</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1,or 2 only&#39;</span><span class="p">)</span>
</span><span id="Generator-2761"><a href="#Generator-2761"><span class="linenos">2761</span></a>        <span class="n">q0x_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="n">q0x_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>
</span><span id="Generator-2762"><a href="#Generator-2762"><span class="linenos">2762</span></a>    
</span><span id="Generator-2763"><a href="#Generator-2763"><span class="linenos">2763</span></a>        <span class="c1">#qxx</span>
</span><span id="Generator-2764"><a href="#Generator-2764"><span class="linenos">2764</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_qxx</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator-2765"><a href="#Generator-2765"><span class="linenos">2765</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_qxx</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>        
</span><span id="Generator-2766"><a href="#Generator-2766"><span class="linenos">2766</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="Generator-2767"><a href="#Generator-2767"><span class="linenos">2767</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="Generator-2768"><a href="#Generator-2768"><span class="linenos">2768</span></a>        <span class="n">qxx_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="Generator-2769"><a href="#Generator-2769"><span class="linenos">2769</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator-2770"><a href="#Generator-2770"><span class="linenos">2770</span></a>        <span class="n">qxx_n1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="Generator-2771"><a href="#Generator-2771"><span class="linenos">2771</span></a>        <span class="n">qxx_n2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="Generator-2772"><a href="#Generator-2772"><span class="linenos">2772</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator-2773"><a href="#Generator-2773"><span class="linenos">2773</span></a>            <span class="n">qxx_m1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="Generator-2774"><a href="#Generator-2774"><span class="linenos">2774</span></a>            <span class="n">qxx_m2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="Generator-2775"><a href="#Generator-2775"><span class="linenos">2775</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="Generator-2776"><a href="#Generator-2776"><span class="linenos">2776</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2777"><a href="#Generator-2777"><span class="linenos">2777</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="Generator-2778"><a href="#Generator-2778"><span class="linenos">2778</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator-2779"><a href="#Generator-2779"><span class="linenos">2779</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="Generator-2780"><a href="#Generator-2780"><span class="linenos">2780</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator-2781"><a href="#Generator-2781"><span class="linenos">2781</span></a>                <span class="n">Pm1_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator-2782"><a href="#Generator-2782"><span class="linenos">2782</span></a>            
</span><span id="Generator-2783"><a href="#Generator-2783"><span class="linenos">2783</span></a>                <span class="n">Pm1_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c1</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm1_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="Generator-2784"><a href="#Generator-2784"><span class="linenos">2784</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2785"><a href="#Generator-2785"><span class="linenos">2785</span></a>                    <span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="Generator-2786"><a href="#Generator-2786"><span class="linenos">2786</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Generator-2787"><a href="#Generator-2787"><span class="linenos">2787</span></a>                    <span class="n">Pm1_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm1_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)))</span>
</span><span id="Generator-2788"><a href="#Generator-2788"><span class="linenos">2788</span></a>                    <span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm1_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="Generator-2789"><a href="#Generator-2789"><span class="linenos">2789</span></a>
</span><span id="Generator-2790"><a href="#Generator-2790"><span class="linenos">2790</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator-2791"><a href="#Generator-2791"><span class="linenos">2791</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="Generator-2792"><a href="#Generator-2792"><span class="linenos">2792</span></a>                    <span class="n">Pn1_m1</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c1</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="Generator-2793"><a href="#Generator-2793"><span class="linenos">2793</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2794"><a href="#Generator-2794"><span class="linenos">2794</span></a>                    <span class="n">qxx_n1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator-2795"><a href="#Generator-2795"><span class="linenos">2795</span></a>                
</span><span id="Generator-2796"><a href="#Generator-2796"><span class="linenos">2796</span></a>                <span class="n">m2</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="Generator-2797"><a href="#Generator-2797"><span class="linenos">2797</span></a>                <span class="n">v2</span><span class="o">=</span><span class="n">m2</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator-2798"><a href="#Generator-2798"><span class="linenos">2798</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span>
</span><span id="Generator-2799"><a href="#Generator-2799"><span class="linenos">2799</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m2</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator-2800"><a href="#Generator-2800"><span class="linenos">2800</span></a>                <span class="n">Pm2_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator-2801"><a href="#Generator-2801"><span class="linenos">2801</span></a>            
</span><span id="Generator-2802"><a href="#Generator-2802"><span class="linenos">2802</span></a>                <span class="n">Pm2_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c2</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm2_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="Generator-2803"><a href="#Generator-2803"><span class="linenos">2803</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2804"><a href="#Generator-2804"><span class="linenos">2804</span></a>                    <span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="Generator-2805"><a href="#Generator-2805"><span class="linenos">2805</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Generator-2806"><a href="#Generator-2806"><span class="linenos">2806</span></a>                    <span class="n">Pm2_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm2_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm2_f_adj</span><span class="p">)))</span>
</span><span id="Generator-2807"><a href="#Generator-2807"><span class="linenos">2807</span></a>                    <span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm2_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="Generator-2808"><a href="#Generator-2808"><span class="linenos">2808</span></a>
</span><span id="Generator-2809"><a href="#Generator-2809"><span class="linenos">2809</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator-2810"><a href="#Generator-2810"><span class="linenos">2810</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="Generator-2811"><a href="#Generator-2811"><span class="linenos">2811</span></a>                    <span class="n">Pn2_m2</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="Generator-2812"><a href="#Generator-2812"><span class="linenos">2812</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2813"><a href="#Generator-2813"><span class="linenos">2813</span></a>                    <span class="n">qxx_n2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>    
</span><span id="Generator-2814"><a href="#Generator-2814"><span class="linenos">2814</span></a>
</span><span id="Generator-2815"><a href="#Generator-2815"><span class="linenos">2815</span></a>                          
</span><span id="Generator-2816"><a href="#Generator-2816"><span class="linenos">2816</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator-2817"><a href="#Generator-2817"><span class="linenos">2817</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2818"><a href="#Generator-2818"><span class="linenos">2818</span></a>                <span class="n">qxx_n1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator-2819"><a href="#Generator-2819"><span class="linenos">2819</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator-2820"><a href="#Generator-2820"><span class="linenos">2820</span></a>                <span class="n">qxx_n2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator-2821"><a href="#Generator-2821"><span class="linenos">2821</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator-2822"><a href="#Generator-2822"><span class="linenos">2822</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1, or 2 only&#39;</span><span class="p">)</span>
</span><span id="Generator-2823"><a href="#Generator-2823"><span class="linenos">2823</span></a>            
</span><span id="Generator-2824"><a href="#Generator-2824"><span class="linenos">2824</span></a>        <span class="n">qxx_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">qxx_n1_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">qxx_n2_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>
</span><span id="Generator-2825"><a href="#Generator-2825"><span class="linenos">2825</span></a>    
</span><span id="Generator-2826"><a href="#Generator-2826"><span class="linenos">2826</span></a>        <span class="n">pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">q0x_pair_samples</span><span class="p">,</span><span class="n">qx0_pair_samples</span><span class="p">,</span><span class="n">qxx_pair_samples</span><span class="p">))</span>
</span><span id="Generator-2827"><a href="#Generator-2827"><span class="linenos">2827</span></a>        <span class="n">f_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_f_samples</span><span class="p">,</span><span class="n">qx0_f_samples</span><span class="p">,</span><span class="n">qxx_f_samples</span><span class="p">))</span>
</span><span id="Generator-2828"><a href="#Generator-2828"><span class="linenos">2828</span></a>        <span class="n">output_m_samples</span><span class="o">=</span><span class="kc">False</span>
</span><span id="Generator-2829"><a href="#Generator-2829"><span class="linenos">2829</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">output_m_samples</span><span class="p">:</span>                
</span><span id="Generator-2830"><a href="#Generator-2830"><span class="linenos">2830</span></a>            <span class="n">m1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_m1_samples</span><span class="p">,</span><span class="n">qx0_m1_samples</span><span class="p">,</span><span class="n">qxx_m1_samples</span><span class="p">))</span>
</span><span id="Generator-2831"><a href="#Generator-2831"><span class="linenos">2831</span></a>            <span class="n">m2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_m2_samples</span><span class="p">,</span><span class="n">qx0_m2_samples</span><span class="p">,</span><span class="n">qxx_m2_samples</span><span class="p">))</span>
</span><span id="Generator-2832"><a href="#Generator-2832"><span class="linenos">2832</span></a>    
</span><span id="Generator-2833"><a href="#Generator-2833"><span class="linenos">2833</span></a>        <span class="n">pair_samples_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">:</span><span class="n">pair_samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">:</span><span class="n">pair_samples</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]})</span>
</span><span id="Generator-2834"><a href="#Generator-2834"><span class="linenos">2834</span></a>
</span><span id="Generator-2835"><a href="#Generator-2835"><span class="linenos">2835</span></a>        <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_fraction_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="Generator-2836"><a href="#Generator-2836"><span class="linenos">2836</span></a>        <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_fraction_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="Generator-2837"><a href="#Generator-2837"><span class="linenos">2837</span></a>    
</span><span id="Generator-2838"><a href="#Generator-2838"><span class="linenos">2838</span></a>        <span class="k">return</span> <span class="n">f_samples</span><span class="p">,</span><span class="n">pair_samples_df</span>
</span><span id="Generator-2839"><a href="#Generator-2839"><span class="linenos">2839</span></a>
</span><span id="Generator-2840"><a href="#Generator-2840"><span class="linenos">2840</span></a>
</span><span id="Generator-2841"><a href="#Generator-2841"><span class="linenos">2841</span></a>    <span class="k">def</span> <span class="nf">generate_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">t_ime</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">NreadsI</span> <span class="o">=</span> <span class="s1">&#39;1e6&#39;</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="s1">&#39;1e6&#39;</span><span class="p">):</span>
</span><span id="Generator-2842"><a href="#Generator-2842"><span class="linenos">2842</span></a>
</span><span id="Generator-2843"><a href="#Generator-2843"><span class="linenos">2843</span></a>
</span><span id="Generator-2844"><a href="#Generator-2844"><span class="linenos">2844</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Generator-2845"><a href="#Generator-2845"><span class="linenos">2845</span></a><span class="sd">        generate in-silico t_ime apart RepSeq samples.</span>
</span><span id="Generator-2846"><a href="#Generator-2846"><span class="linenos">2846</span></a><span class="sd">        </span>
</span><span id="Generator-2847"><a href="#Generator-2847"><span class="linenos">2847</span></a><span class="sd">        Parameters</span>
</span><span id="Generator-2848"><a href="#Generator-2848"><span class="linenos">2848</span></a><span class="sd">        ----------</span>
</span><span id="Generator-2849"><a href="#Generator-2849"><span class="linenos">2849</span></a><span class="sd">        paras_1  : numpy array</span>
</span><span id="Generator-2850"><a href="#Generator-2850"><span class="linenos">2850</span></a><span class="sd">            parameters of the noise model that has been learnt at time_1</span>
</span><span id="Generator-2851"><a href="#Generator-2851"><span class="linenos">2851</span></a><span class="sd">        paras_2  : numpy array</span>
</span><span id="Generator-2852"><a href="#Generator-2852"><span class="linenos">2852</span></a><span class="sd">            parameters of the noise model that has been learnt at time_2</span>
</span><span id="Generator-2853"><a href="#Generator-2853"><span class="linenos">2853</span></a><span class="sd">        method   : str</span>
</span><span id="Generator-2854"><a href="#Generator-2854"><span class="linenos">2854</span></a><span class="sd">            &#39;negative_binomial&#39; or &#39;poisson&#39;</span>
</span><span id="Generator-2855"><a href="#Generator-2855"><span class="linenos">2855</span></a><span class="sd">        tau      : float</span>
</span><span id="Generator-2856"><a href="#Generator-2856"><span class="linenos">2856</span></a><span class="sd">            first time-scale parameter of the dynamics</span>
</span><span id="Generator-2857"><a href="#Generator-2857"><span class="linenos">2857</span></a><span class="sd">        theta    : float</span>
</span><span id="Generator-2858"><a href="#Generator-2858"><span class="linenos">2858</span></a><span class="sd">            second time-scale parameter of the dynamics</span>
</span><span id="Generator-2859"><a href="#Generator-2859"><span class="linenos">2859</span></a><span class="sd">        t_ime    : float</span>
</span><span id="Generator-2860"><a href="#Generator-2860"><span class="linenos">2860</span></a><span class="sd">            number of years between both synthetic sampling (between time_1 and time_2)</span>
</span><span id="Generator-2861"><a href="#Generator-2861"><span class="linenos">2861</span></a><span class="sd">        filename : str</span>
</span><span id="Generator-2862"><a href="#Generator-2862"><span class="linenos">2862</span></a><span class="sd">            name of the file in which the dataframe is stored  </span>
</span><span id="Generator-2863"><a href="#Generator-2863"><span class="linenos">2863</span></a>
</span><span id="Generator-2864"><a href="#Generator-2864"><span class="linenos">2864</span></a><span class="sd">        Returns</span>
</span><span id="Generator-2865"><a href="#Generator-2865"><span class="linenos">2865</span></a><span class="sd">        -------</span>
</span><span id="Generator-2866"><a href="#Generator-2866"><span class="linenos">2866</span></a><span class="sd">        data-frame - csv file</span>
</span><span id="Generator-2867"><a href="#Generator-2867"><span class="linenos">2867</span></a><span class="sd">            the output is a csv file of columns : &#39;Clone_count_1&#39; (at time_1) &#39;Clone_count_2&#39; (at time_2) and the frequency counterparts &#39;Clone_frequency_1&#39; and &#39;Clone_frequency_2&#39;</span>
</span><span id="Generator-2868"><a href="#Generator-2868"><span class="linenos">2868</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Generator-2869"><a href="#Generator-2869"><span class="linenos">2869</span></a>
</span><span id="Generator-2870"><a href="#Generator-2870"><span class="linenos">2870</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span> 
</span><span id="Generator-2871"><a href="#Generator-2871"><span class="linenos">2871</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span><span id="Generator-2872"><a href="#Generator-2872"><span class="linenos">2872</span></a>
</span><span id="Generator-2873"><a href="#Generator-2873"><span class="linenos">2873</span></a>        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;negative_binomial&#39;</span>
</span><span id="Generator-2874"><a href="#Generator-2874"><span class="linenos">2874</span></a>
</span><span id="Generator-2875"><a href="#Generator-2875"><span class="linenos">2875</span></a>
</span><span id="Generator-2876"><a href="#Generator-2876"><span class="linenos">2876</span></a>        <span class="c1"># Synthetic data generation</span>
</span><span id="Generator-2877"><a href="#Generator-2877"><span class="linenos">2877</span></a>
</span><span id="Generator-2878"><a href="#Generator-2878"><span class="linenos">2878</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;execution starting...&#39;</span><span class="p">)</span>
</span><span id="Generator-2879"><a href="#Generator-2879"><span class="linenos">2879</span></a>
</span><span id="Generator-2880"><a href="#Generator-2880"><span class="linenos">2880</span></a>        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Generator-2881"><a href="#Generator-2881"><span class="linenos">2881</span></a>
</span><span id="Generator-2882"><a href="#Generator-2882"><span class="linenos">2882</span></a>        <span class="c1">#Values of the parameters</span>
</span><span id="Generator-2883"><a href="#Generator-2883"><span class="linenos">2883</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau</span>
</span><span id="Generator-2884"><a href="#Generator-2884"><span class="linenos">2884</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">theta</span>
</span><span id="Generator-2885"><a href="#Generator-2885"><span class="linenos">2885</span></a>        <span class="n">N_0</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="Generator-2886"><a href="#Generator-2886"><span class="linenos">2886</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">)</span>
</span><span id="Generator-2887"><a href="#Generator-2887"><span class="linenos">2887</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NreadsII</span><span class="p">)</span>
</span><span id="Generator-2888"><a href="#Generator-2888"><span class="linenos">2888</span></a>
</span><span id="Generator-2889"><a href="#Generator-2889"><span class="linenos">2889</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_ime</span><span class="p">)</span>
</span><span id="Generator-2890"><a href="#Generator-2890"><span class="linenos">2890</span></a>
</span><span id="Generator-2891"><a href="#Generator-2891"><span class="linenos">2891</span></a>        <span class="k">if</span> <span class="n">NreadsI</span> <span class="o">==</span> <span class="n">NreadsII</span><span class="p">:</span>
</span><span id="Generator-2892"><a href="#Generator-2892"><span class="linenos">2892</span></a>            <span class="n">key_sym</span> <span class="o">=</span> <span class="s1">&#39;_sym_&#39;</span>
</span><span id="Generator-2893"><a href="#Generator-2893"><span class="linenos">2893</span></a>
</span><span id="Generator-2894"><a href="#Generator-2894"><span class="linenos">2894</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Generator-2895"><a href="#Generator-2895"><span class="linenos">2895</span></a>            <span class="n">key_sym</span> <span class="o">=</span> <span class="s1">&#39;_asym_&#39;</span>
</span><span id="Generator-2896"><a href="#Generator-2896"><span class="linenos">2896</span></a>
</span><span id="Generator-2897"><a href="#Generator-2897"><span class="linenos">2897</span></a>        <span class="c1"># Name of the directory</span>
</span><span id="Generator-2898"><a href="#Generator-2898"><span class="linenos">2898</span></a>
</span><span id="Generator-2899"><a href="#Generator-2899"><span class="linenos">2899</span></a>
</span><span id="Generator-2900"><a href="#Generator-2900"><span class="linenos">2900</span></a>        <span class="n">dirName</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span>    
</span><span id="Generator-2901"><a href="#Generator-2901"><span class="linenos">2901</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirName</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span><span id="Generator-2902"><a href="#Generator-2902"><span class="linenos">2902</span></a>
</span><span id="Generator-2903"><a href="#Generator-2903"><span class="linenos">2903</span></a>        <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_1</span> <span class="c1">#Just put a and b of the negative binomiale distribution [0.7, 1.1]</span>
</span><span id="Generator-2904"><a href="#Generator-2904"><span class="linenos">2904</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">/</span><span class="n">B</span>
</span><span id="Generator-2905"><a href="#Generator-2905"><span class="linenos">2905</span></a>        <span class="c1">#print(&#39;alpha : &#39; + str(alpha))</span>
</span><span id="Generator-2906"><a href="#Generator-2906"><span class="linenos">2906</span></a>
</span><span id="Generator-2907"><a href="#Generator-2907"><span class="linenos">2907</span></a>        <span class="c1">#1/ Generate log-population at initial time from steady-state distribution + GBM diffusion trajectories for 2 years</span>
</span><span id="Generator-2908"><a href="#Generator-2908"><span class="linenos">2908</span></a>        <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">Prop_Matrix_LB</span><span class="p">,</span> <span class="n">p_ext_LB</span><span class="p">,</span> <span class="n">results_extinction_LB</span><span class="p">,</span> <span class="n">time_vec_LB</span><span class="p">,</span> <span class="n">results_extinction_source_LB</span><span class="p">,</span> <span class="n">x_source_LB</span> <span class="o">=</span> <span class="n">_generator_diffusion_LB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">N_0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="Generator-2909"><a href="#Generator-2909"><span class="linenos">2909</span></a>        
</span><span id="Generator-2910"><a href="#Generator-2910"><span class="linenos">2910</span></a>        <span class="c1">#x_i_LB, x_f_LB, Prop_Matrix, p_ext, results_extinction  = generator_diffusion_LB(B, A, N_0, t)</span>
</span><span id="Generator-2911"><a href="#Generator-2911"><span class="linenos">2911</span></a>        <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_i_LB</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_f_LB</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_source_LB</span><span class="p">))</span>  <span class="c1">#N_cells_final_LB</span>
</span><span id="Generator-2912"><a href="#Generator-2912"><span class="linenos">2912</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NUMBER OF CELLS AT INITIAL TIME&#39;</span><span class="p">)</span>
</span><span id="Generator-2913"><a href="#Generator-2913"><span class="linenos">2913</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">N_cells_day_0_LB</span><span class="p">)</span>
</span><span id="Generator-2914"><a href="#Generator-2914"><span class="linenos">2914</span></a>
</span><span id="Generator-2915"><a href="#Generator-2915"><span class="linenos">2915</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NUMBER OF CELLS AT FINAL TIME&#39;</span><span class="p">)</span>
</span><span id="Generator-2916"><a href="#Generator-2916"><span class="linenos">2916</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="Generator-2917"><a href="#Generator-2917"><span class="linenos">2917</span></a>
</span><span id="Generator-2918"><a href="#Generator-2918"><span class="linenos">2918</span></a>        <span class="c1">#print(&#39;SHAPE_X_I &#39; +  str(np.shape(x_i_LB)))</span>
</span><span id="Generator-2919"><a href="#Generator-2919"><span class="linenos">2919</span></a>        <span class="c1">#print(&#39;SHAPE_X_F &#39; +  str(np.shape(x_f_LB)))</span>
</span><span id="Generator-2920"><a href="#Generator-2920"><span class="linenos">2920</span></a>
</span><span id="Generator-2921"><a href="#Generator-2921"><span class="linenos">2921</span></a>
</span><span id="Generator-2922"><a href="#Generator-2922"><span class="linenos">2922</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;negative_binomial&#39;</span><span class="p">:</span>
</span><span id="Generator-2923"><a href="#Generator-2923"><span class="linenos">2923</span></a>
</span><span id="Generator-2924"><a href="#Generator-2924"><span class="linenos">2924</span></a>            <span class="n">df_diffusion_LB</span>  <span class="o">=</span> <span class="n">_experimental_sampling_diffusion_NegBin</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="Generator-2925"><a href="#Generator-2925"><span class="linenos">2925</span></a>            <span class="n">df_diffusion_LB</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span> <span class="p">,</span> <span class="n">sep</span><span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Generator-2926"><a href="#Generator-2926"><span class="linenos">2926</span></a>
</span><span id="Generator-2927"><a href="#Generator-2927"><span class="linenos">2927</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;poisson&#39;</span><span class="p">:</span> 
</span><span id="Generator-2928"><a href="#Generator-2928"><span class="linenos">2928</span></a>
</span><span id="Generator-2929"><a href="#Generator-2929"><span class="linenos">2929</span></a>            <span class="n">df_diffusion_LB</span>  <span class="o">=</span> <span class="n">_experimental_sampling_diffusion_Poisson</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="Generator-2930"><a href="#Generator-2930"><span class="linenos">2930</span></a>            <span class="n">df_diffusion_LB</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span> <span class="p">,</span> <span class="n">sep</span><span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A class used to build an object to generate in-Silico (synthetic) RepSeq samples, in the case of replicates at
the same day and in the case of having 2 samples generated at an initial time for the first one and some time after (months, years)
for the second one using the geometric Brownian motion model decribed in <a href="https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1">https://www.biorxiv.org/content/10.1101/2022.05.01.490247v1</a>.</p>

<p>...</p>

<h6 id="methods">Methods</h6>

<p>gen_synthetic_data_Null(paras, noise_model, NreadsI,NreadsII,Nsamp):
    generate in-silico same day RepSeq replicates.</p>

<p>generate_trajectories(tau, theta, method, paras_1, paras_2, t_ime, filename, NreadsI = '1e6', NreadsII = '1e6'):
    generate in-silico t_ime apart RepSeq samples.</p>
</div>


                            <div id="Generator.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Generator</span><span class="signature pdoc-code condensed">()</span>

        
    </div>
    <a class="headerlink" href="#Generator.__init__"></a>
    
    

                            </div>
                            <div id="Generator.gen_synthetic_data_Null" class="classattr">
                                        <input id="Generator.gen_synthetic_data_Null-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gen_synthetic_data_Null</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">paras</span>, </span><span class="param"><span class="n">noise_model</span>, </span><span class="param"><span class="n">NreadsI</span>, </span><span class="param"><span class="n">NreadsII</span>, </span><span class="param"><span class="n">Nsamp</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Generator.gen_synthetic_data_Null-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Generator.gen_synthetic_data_Null"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Generator.gen_synthetic_data_Null-2572"><a href="#Generator.gen_synthetic_data_Null-2572"><span class="linenos">2572</span></a>    <span class="k">def</span> <span class="nf">gen_synthetic_data_Null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">noise_model</span><span class="p">,</span> <span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span><span class="p">,</span><span class="n">Nsamp</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2573"><a href="#Generator.gen_synthetic_data_Null-2573"><span class="linenos">2573</span></a>        <span class="sd">&#39;&#39;&#39;</span>
</span><span id="Generator.gen_synthetic_data_Null-2574"><a href="#Generator.gen_synthetic_data_Null-2574"><span class="linenos">2574</span></a><span class="sd">        outputs an array of observed clone frequencies and corresponding dataframe of pair counts</span>
</span><span id="Generator.gen_synthetic_data_Null-2575"><a href="#Generator.gen_synthetic_data_Null-2575"><span class="linenos">2575</span></a><span class="sd">        for a null model learned from a dataset pair with NreadsI and NreadsII number of reads, respectively.</span>
</span><span id="Generator.gen_synthetic_data_Null-2576"><a href="#Generator.gen_synthetic_data_Null-2576"><span class="linenos">2576</span></a><span class="sd">        Crucial for RAM efficiency, sampling is conditioned on being observed in each of the three (n,0), (0,n&#39;), and n,n&#39;&gt;0 conditions</span>
</span><span id="Generator.gen_synthetic_data_Null-2577"><a href="#Generator.gen_synthetic_data_Null-2577"><span class="linenos">2577</span></a><span class="sd">        so that only Nsamp clones need to be sampled, rather than the N clones in the repertoire.</span>
</span><span id="Generator.gen_synthetic_data_Null-2578"><a href="#Generator.gen_synthetic_data_Null-2578"><span class="linenos">2578</span></a><span class="sd">        Note that no explicit normalization is applied. It is assumed that the values in paras are consistent with N&lt;f&gt;=1 </span>
</span><span id="Generator.gen_synthetic_data_Null-2579"><a href="#Generator.gen_synthetic_data_Null-2579"><span class="linenos">2579</span></a><span class="sd">        (e.g. were obtained through the learning done in this package).</span>
</span><span id="Generator.gen_synthetic_data_Null-2580"><a href="#Generator.gen_synthetic_data_Null-2580"><span class="linenos">2580</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="Generator.gen_synthetic_data_Null-2581"><a href="#Generator.gen_synthetic_data_Null-2581"><span class="linenos">2581</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2582"><a href="#Generator.gen_synthetic_data_Null-2582"><span class="linenos">2582</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2583"><a href="#Generator.gen_synthetic_data_Null-2583"><span class="linenos">2583</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#power law exponent</span>
</span><span id="Generator.gen_synthetic_data_Null-2584"><a href="#Generator.gen_synthetic_data_Null-2584"><span class="linenos">2584</span></a>        <span class="n">fmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">paras</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Generator.gen_synthetic_data_Null-2585"><a href="#Generator.gen_synthetic_data_Null-2585"><span class="linenos">2585</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2586"><a href="#Generator.gen_synthetic_data_Null-2586"><span class="linenos">2586</span></a>            <span class="n">m_total</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">paras</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> 
</span><span id="Generator.gen_synthetic_data_Null-2587"><a href="#Generator.gen_synthetic_data_Null-2587"><span class="linenos">2587</span></a>            <span class="n">r_c1</span><span class="o">=</span><span class="n">NreadsI</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="Generator.gen_synthetic_data_Null-2588"><a href="#Generator.gen_synthetic_data_Null-2588"><span class="linenos">2588</span></a>            <span class="n">r_c2</span><span class="o">=</span><span class="n">NreadsII</span><span class="o">/</span><span class="n">m_total</span>
</span><span id="Generator.gen_synthetic_data_Null-2589"><a href="#Generator.gen_synthetic_data_Null-2589"><span class="linenos">2589</span></a>            <span class="n">r_cvec</span><span class="o">=</span><span class="p">[</span><span class="n">r_c1</span><span class="p">,</span><span class="n">r_c2</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2590"><a href="#Generator.gen_synthetic_data_Null-2590"><span class="linenos">2590</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2591"><a href="#Generator.gen_synthetic_data_Null-2591"><span class="linenos">2591</span></a>            <span class="n">beta_mv</span><span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2592"><a href="#Generator.gen_synthetic_data_Null-2592"><span class="linenos">2592</span></a>            <span class="n">alpha_mv</span><span class="o">=</span><span class="n">paras</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2593"><a href="#Generator.gen_synthetic_data_Null-2593"><span class="linenos">2593</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2594"><a href="#Generator.gen_synthetic_data_Null-2594"><span class="linenos">2594</span></a>        <span class="n">logrhofvec</span><span class="p">,</span><span class="n">logfvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rhof</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="n">fmin</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2595"><a href="#Generator.gen_synthetic_data_Null-2595"><span class="linenos">2595</span></a>        <span class="n">fvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2596"><a href="#Generator.gen_synthetic_data_Null-2596"><span class="linenos">2596</span></a>        <span class="n">dlogf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">logfvec</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
</span><span id="Generator.gen_synthetic_data_Null-2597"><a href="#Generator.gen_synthetic_data_Null-2597"><span class="linenos">2597</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2598"><a href="#Generator.gen_synthetic_data_Null-2598"><span class="linenos">2598</span></a>        <span class="c1">#generate measurement model distribution, Pn_f</span>
</span><span id="Generator.gen_synthetic_data_Null-2599"><a href="#Generator.gen_synthetic_data_Null-2599"><span class="linenos">2599</span></a>        <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">logfvec</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span> <span class="c1">#len(logfvec) samplers</span>
</span><span id="Generator.gen_synthetic_data_Null-2600"><a href="#Generator.gen_synthetic_data_Null-2600"><span class="linenos">2600</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2601"><a href="#Generator.gen_synthetic_data_Null-2601"><span class="linenos">2601</span></a>        <span class="c1">#get value at n=0 to use for conditioning on n&gt;0 (and get full Pn_f here if noise_model=1,2)</span>
</span><span id="Generator.gen_synthetic_data_Null-2602"><a href="#Generator.gen_synthetic_data_Null-2602"><span class="linenos">2602</span></a>        <span class="n">m_max</span><span class="o">=</span><span class="mf">1e3</span> <span class="c1">#conditioned on n=0, so no edge effects</span>
</span><span id="Generator.gen_synthetic_data_Null-2603"><a href="#Generator.gen_synthetic_data_Null-2603"><span class="linenos">2603</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2604"><a href="#Generator.gen_synthetic_data_Null-2604"><span class="linenos">2604</span></a>        <span class="n">Nreadsvec</span><span class="o">=</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span><span class="n">NreadsII</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2605"><a href="#Generator.gen_synthetic_data_Null-2605"><span class="linenos">2605</span></a>        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2606"><a href="#Generator.gen_synthetic_data_Null-2606"><span class="linenos">2606</span></a>            <span class="n">Pn_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fvec</span><span class="p">),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2607"><a href="#Generator.gen_synthetic_data_Null-2607"><span class="linenos">2607</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2608"><a href="#Generator.gen_synthetic_data_Null-2608"><span class="linenos">2608</span></a>                <span class="n">m1vec</span><span class="o">=</span><span class="n">Nreadsvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="Generator.gen_synthetic_data_Null-2609"><a href="#Generator.gen_synthetic_data_Null-2609"><span class="linenos">2609</span></a>                <span class="k">for</span> <span class="n">find</span><span class="p">,</span><span class="n">m1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m1vec</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2610"><a href="#Generator.gen_synthetic_data_Null-2610"><span class="linenos">2610</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2611"><a href="#Generator.gen_synthetic_data_Null-2611"><span class="linenos">2611</span></a>                <span class="n">logPn0_f</span><span class="o">=-</span><span class="n">m1vec</span>
</span><span id="Generator.gen_synthetic_data_Null-2612"><a href="#Generator.gen_synthetic_data_Null-2612"><span class="linenos">2612</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2613"><a href="#Generator.gen_synthetic_data_Null-2613"><span class="linenos">2613</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">Nreadsvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="Generator.gen_synthetic_data_Null-2614"><a href="#Generator.gen_synthetic_data_Null-2614"><span class="linenos">2614</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2615"><a href="#Generator.gen_synthetic_data_Null-2615"><span class="linenos">2615</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="Generator.gen_synthetic_data_Null-2616"><a href="#Generator.gen_synthetic_data_Null-2616"><span class="linenos">2616</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator.gen_synthetic_data_Null-2617"><a href="#Generator.gen_synthetic_data_Null-2617"><span class="linenos">2617</span></a>                <span class="k">for</span> <span class="n">find</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">)):</span>
</span><span id="Generator.gen_synthetic_data_Null-2618"><a href="#Generator.gen_synthetic_data_Null-2618"><span class="linenos">2618</span></a>                    <span class="n">Pn_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2619"><a href="#Generator.gen_synthetic_data_Null-2619"><span class="linenos">2619</span></a>                <span class="n">Pn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">Pn_find</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">Pn_find</span> <span class="ow">in</span> <span class="n">Pn_f</span><span class="p">])</span>
</span><span id="Generator.gen_synthetic_data_Null-2620"><a href="#Generator.gen_synthetic_data_Null-2620"><span class="linenos">2620</span></a>                <span class="n">logPn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2621"><a href="#Generator.gen_synthetic_data_Null-2621"><span class="linenos">2621</span></a>            
</span><span id="Generator.gen_synthetic_data_Null-2622"><a href="#Generator.gen_synthetic_data_Null-2622"><span class="linenos">2622</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2623"><a href="#Generator.gen_synthetic_data_Null-2623"><span class="linenos">2623</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span>
</span><span id="Generator.gen_synthetic_data_Null-2624"><a href="#Generator.gen_synthetic_data_Null-2624"><span class="linenos">2624</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2625"><a href="#Generator.gen_synthetic_data_Null-2625"><span class="linenos">2625</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="Generator.gen_synthetic_data_Null-2626"><a href="#Generator.gen_synthetic_data_Null-2626"><span class="linenos">2626</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator.gen_synthetic_data_Null-2627"><a href="#Generator.gen_synthetic_data_Null-2627"><span class="linenos">2627</span></a>                <span class="n">Pn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fvec</span><span class="p">),))</span>
</span><span id="Generator.gen_synthetic_data_Null-2628"><a href="#Generator.gen_synthetic_data_Null-2628"><span class="linenos">2628</span></a>                <span class="k">for</span> <span class="n">find</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)):</span>
</span><span id="Generator.gen_synthetic_data_Null-2629"><a href="#Generator.gen_synthetic_data_Null-2629"><span class="linenos">2629</span></a>                    <span class="n">nbtmp</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">find</span><span class="p">],</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">find</span><span class="p">])</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2630"><a href="#Generator.gen_synthetic_data_Null-2630"><span class="linenos">2630</span></a>                    <span class="n">ptmp</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_cvec</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2631"><a href="#Generator.gen_synthetic_data_Null-2631"><span class="linenos">2631</span></a>                    <span class="n">Pn0_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nbtmp</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ptmp</span><span class="p">)))</span>
</span><span id="Generator.gen_synthetic_data_Null-2632"><a href="#Generator.gen_synthetic_data_Null-2632"><span class="linenos">2632</span></a>                <span class="n">logPn0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pn0_f</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2633"><a href="#Generator.gen_synthetic_data_Null-2633"><span class="linenos">2633</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2634"><a href="#Generator.gen_synthetic_data_Null-2634"><span class="linenos">2634</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1,or 2 only&#39;</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2635"><a href="#Generator.gen_synthetic_data_Null-2635"><span class="linenos">2635</span></a>            
</span><span id="Generator.gen_synthetic_data_Null-2636"><a href="#Generator.gen_synthetic_data_Null-2636"><span class="linenos">2636</span></a>            <span class="k">if</span> <span class="n">it</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2637"><a href="#Generator.gen_synthetic_data_Null-2637"><span class="linenos">2637</span></a>                <span class="n">Pn1_f</span><span class="o">=</span><span class="n">Pn_f</span>
</span><span id="Generator.gen_synthetic_data_Null-2638"><a href="#Generator.gen_synthetic_data_Null-2638"><span class="linenos">2638</span></a>                <span class="n">logPn10_f</span><span class="o">=</span><span class="n">logPn0_f</span>
</span><span id="Generator.gen_synthetic_data_Null-2639"><a href="#Generator.gen_synthetic_data_Null-2639"><span class="linenos">2639</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2640"><a href="#Generator.gen_synthetic_data_Null-2640"><span class="linenos">2640</span></a>                <span class="n">Pn2_f</span><span class="o">=</span><span class="n">Pn_f</span>
</span><span id="Generator.gen_synthetic_data_Null-2641"><a href="#Generator.gen_synthetic_data_Null-2641"><span class="linenos">2641</span></a>                <span class="n">logPn20_f</span><span class="o">=</span><span class="n">logPn0_f</span>
</span><span id="Generator.gen_synthetic_data_Null-2642"><a href="#Generator.gen_synthetic_data_Null-2642"><span class="linenos">2642</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2643"><a href="#Generator.gen_synthetic_data_Null-2643"><span class="linenos">2643</span></a>        <span class="c1">#3-quadrant q|f conditional distribution (qx0:n1&gt;0,n2=0;q0x:n1=0,n2&gt;0;qxx:n1,n2&gt;0)</span>
</span><span id="Generator.gen_synthetic_data_Null-2644"><a href="#Generator.gen_synthetic_data_Null-2644"><span class="linenos">2644</span></a>        <span class="n">logPqx0_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn10_f</span><span class="p">))</span><span class="o">+</span><span class="n">logPn20_f</span>
</span><span id="Generator.gen_synthetic_data_Null-2645"><a href="#Generator.gen_synthetic_data_Null-2645"><span class="linenos">2645</span></a>        <span class="n">logPq0x_f</span><span class="o">=</span><span class="n">logPn10_f</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn20_f</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2646"><a href="#Generator.gen_synthetic_data_Null-2646"><span class="linenos">2646</span></a>        <span class="n">logPqxx_f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn10_f</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPn20_f</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2647"><a href="#Generator.gen_synthetic_data_Null-2647"><span class="linenos">2647</span></a>        <span class="c1">#3-quadrant q,f joint distribution</span>
</span><span id="Generator.gen_synthetic_data_Null-2648"><a href="#Generator.gen_synthetic_data_Null-2648"><span class="linenos">2648</span></a>        <span class="n">logPfqx0</span><span class="o">=</span><span class="n">logPqx0_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="Generator.gen_synthetic_data_Null-2649"><a href="#Generator.gen_synthetic_data_Null-2649"><span class="linenos">2649</span></a>        <span class="n">logPfq0x</span><span class="o">=</span><span class="n">logPq0x_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="Generator.gen_synthetic_data_Null-2650"><a href="#Generator.gen_synthetic_data_Null-2650"><span class="linenos">2650</span></a>        <span class="n">logPfqxx</span><span class="o">=</span><span class="n">logPqxx_f</span><span class="o">+</span><span class="n">logrhofvec</span>
</span><span id="Generator.gen_synthetic_data_Null-2651"><a href="#Generator.gen_synthetic_data_Null-2651"><span class="linenos">2651</span></a>        <span class="c1">#3-quadrant q marginal distribution </span>
</span><span id="Generator.gen_synthetic_data_Null-2652"><a href="#Generator.gen_synthetic_data_Null-2652"><span class="linenos">2652</span></a>        <span class="n">Pqx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2653"><a href="#Generator.gen_synthetic_data_Null-2653"><span class="linenos">2653</span></a>        <span class="n">Pq0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2654"><a href="#Generator.gen_synthetic_data_Null-2654"><span class="linenos">2654</span></a>        <span class="n">Pqxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="o">+</span><span class="n">logfvec</span><span class="p">),</span><span class="n">x</span><span class="o">=</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2655"><a href="#Generator.gen_synthetic_data_Null-2655"><span class="linenos">2655</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2656"><a href="#Generator.gen_synthetic_data_Null-2656"><span class="linenos">2656</span></a>        <span class="c1">#3 quadrant conditional f|q distribution</span>
</span><span id="Generator.gen_synthetic_data_Null-2657"><a href="#Generator.gen_synthetic_data_Null-2657"><span class="linenos">2657</span></a>        <span class="n">Pf_qx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pqx0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2658"><a href="#Generator.gen_synthetic_data_Null-2658"><span class="linenos">2658</span></a>        <span class="n">Pf_q0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pq0x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pq0x</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2659"><a href="#Generator.gen_synthetic_data_Null-2659"><span class="linenos">2659</span></a>        <span class="n">Pf_qxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Pqxx</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pqxx</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2660"><a href="#Generator.gen_synthetic_data_Null-2660"><span class="linenos">2660</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2661"><a href="#Generator.gen_synthetic_data_Null-2661"><span class="linenos">2661</span></a>        <span class="c1">#3-quadrant q marginal distribution</span>
</span><span id="Generator.gen_synthetic_data_Null-2662"><a href="#Generator.gen_synthetic_data_Null-2662"><span class="linenos">2662</span></a>        <span class="n">newPqZ</span><span class="o">=</span><span class="n">Pqx0</span> <span class="o">+</span> <span class="n">Pq0x</span> <span class="o">+</span> <span class="n">Pqxx</span>
</span><span id="Generator.gen_synthetic_data_Null-2663"><a href="#Generator.gen_synthetic_data_Null-2663"><span class="linenos">2663</span></a>        <span class="n">Pqx0</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="Generator.gen_synthetic_data_Null-2664"><a href="#Generator.gen_synthetic_data_Null-2664"><span class="linenos">2664</span></a>        <span class="n">Pq0x</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="Generator.gen_synthetic_data_Null-2665"><a href="#Generator.gen_synthetic_data_Null-2665"><span class="linenos">2665</span></a>        <span class="n">Pqxx</span><span class="o">/=</span><span class="n">newPqZ</span>
</span><span id="Generator.gen_synthetic_data_Null-2666"><a href="#Generator.gen_synthetic_data_Null-2666"><span class="linenos">2666</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2667"><a href="#Generator.gen_synthetic_data_Null-2667"><span class="linenos">2667</span></a>        <span class="n">Pfqx0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqx0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2668"><a href="#Generator.gen_synthetic_data_Null-2668"><span class="linenos">2668</span></a>        <span class="n">Pfq0x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfq0x</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2669"><a href="#Generator.gen_synthetic_data_Null-2669"><span class="linenos">2669</span></a>        <span class="n">Pfqxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logPfqxx</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2670"><a href="#Generator.gen_synthetic_data_Null-2670"><span class="linenos">2670</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2671"><a href="#Generator.gen_synthetic_data_Null-2671"><span class="linenos">2671</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model probs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pq0x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Pqxx</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2672"><a href="#Generator.gen_synthetic_data_Null-2672"><span class="linenos">2672</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2673"><a href="#Generator.gen_synthetic_data_Null-2673"><span class="linenos">2673</span></a>        <span class="c1">#get samples </span>
</span><span id="Generator.gen_synthetic_data_Null-2674"><a href="#Generator.gen_synthetic_data_Null-2674"><span class="linenos">2674</span></a>        <span class="n">num_samples</span><span class="o">=</span><span class="n">Nsamp</span>
</span><span id="Generator.gen_synthetic_data_Null-2675"><a href="#Generator.gen_synthetic_data_Null-2675"><span class="linenos">2675</span></a>        <span class="n">q_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="n">Pqx0</span><span class="p">,</span><span class="n">Pq0x</span><span class="p">,</span><span class="n">Pqxx</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2676"><a href="#Generator.gen_synthetic_data_Null-2676"><span class="linenos">2676</span></a>        <span class="n">vals</span><span class="p">,</span><span class="n">counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">q_samples</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2677"><a href="#Generator.gen_synthetic_data_Null-2677"><span class="linenos">2677</span></a>        <span class="n">num_qx0</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2678"><a href="#Generator.gen_synthetic_data_Null-2678"><span class="linenos">2678</span></a>        <span class="n">num_q0x</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2679"><a href="#Generator.gen_synthetic_data_Null-2679"><span class="linenos">2679</span></a>        <span class="n">num_qxx</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2680"><a href="#Generator.gen_synthetic_data_Null-2680"><span class="linenos">2680</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qx0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_q0x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qxx</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2681"><a href="#Generator.gen_synthetic_data_Null-2681"><span class="linenos">2681</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;q sampled probs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qx0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_q0x</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_qxx</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">))))</span>
</span><span id="Generator.gen_synthetic_data_Null-2682"><a href="#Generator.gen_synthetic_data_Null-2682"><span class="linenos">2682</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2683"><a href="#Generator.gen_synthetic_data_Null-2683"><span class="linenos">2683</span></a>        <span class="c1">#x0</span>
</span><span id="Generator.gen_synthetic_data_Null-2684"><a href="#Generator.gen_synthetic_data_Null-2684"><span class="linenos">2684</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_qx0</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2685"><a href="#Generator.gen_synthetic_data_Null-2685"><span class="linenos">2685</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_qx0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="Generator.gen_synthetic_data_Null-2686"><a href="#Generator.gen_synthetic_data_Null-2686"><span class="linenos">2686</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2687"><a href="#Generator.gen_synthetic_data_Null-2687"><span class="linenos">2687</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="Generator.gen_synthetic_data_Null-2688"><a href="#Generator.gen_synthetic_data_Null-2688"><span class="linenos">2688</span></a>        <span class="n">qx0_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2689"><a href="#Generator.gen_synthetic_data_Null-2689"><span class="linenos">2689</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2690"><a href="#Generator.gen_synthetic_data_Null-2690"><span class="linenos">2690</span></a>        <span class="n">qx0_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,))</span>
</span><span id="Generator.gen_synthetic_data_Null-2691"><a href="#Generator.gen_synthetic_data_Null-2691"><span class="linenos">2691</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2692"><a href="#Generator.gen_synthetic_data_Null-2692"><span class="linenos">2692</span></a>            <span class="n">qx0_m_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,))</span>
</span><span id="Generator.gen_synthetic_data_Null-2693"><a href="#Generator.gen_synthetic_data_Null-2693"><span class="linenos">2693</span></a>            <span class="c1">#conditioning on n&gt;0 applies an m-dependent factor to Pm_f, which can&#39;t be incorporated into the ppf method used for noise_model 1 and 2. </span>
</span><span id="Generator.gen_synthetic_data_Null-2694"><a href="#Generator.gen_synthetic_data_Null-2694"><span class="linenos">2694</span></a>            <span class="c1">#We handle that here by using a custom finite range sampler, which has the drawback of having to define an upper limit. </span>
</span><span id="Generator.gen_synthetic_data_Null-2695"><a href="#Generator.gen_synthetic_data_Null-2695"><span class="linenos">2695</span></a>            <span class="c1">#This works so long as n_max/r_c&lt;&lt;m_max, so depends on highest counts in data (n_max). My data had max counts of 1e3-1e4.</span>
</span><span id="Generator.gen_synthetic_data_Null-2696"><a href="#Generator.gen_synthetic_data_Null-2696"><span class="linenos">2696</span></a>            <span class="c1">#Alternatively, could define a custom scipy RV class by defining it&#39;s PMF, but has to be array-compatible which requires care. </span>
</span><span id="Generator.gen_synthetic_data_Null-2697"><a href="#Generator.gen_synthetic_data_Null-2697"><span class="linenos">2697</span></a>            <span class="n">m_samp_max</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e5</span><span class="p">)</span> 
</span><span id="Generator.gen_synthetic_data_Null-2698"><a href="#Generator.gen_synthetic_data_Null-2698"><span class="linenos">2698</span></a>            <span class="n">mvec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_samp_max</span><span class="p">)</span>   
</span><span id="Generator.gen_synthetic_data_Null-2699"><a href="#Generator.gen_synthetic_data_Null-2699"><span class="linenos">2699</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2700"><a href="#Generator.gen_synthetic_data_Null-2700"><span class="linenos">2700</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2701"><a href="#Generator.gen_synthetic_data_Null-2701"><span class="linenos">2701</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>      
</span><span id="Generator.gen_synthetic_data_Null-2702"><a href="#Generator.gen_synthetic_data_Null-2702"><span class="linenos">2702</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2703"><a href="#Generator.gen_synthetic_data_Null-2703"><span class="linenos">2703</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2704"><a href="#Generator.gen_synthetic_data_Null-2704"><span class="linenos">2704</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="Generator.gen_synthetic_data_Null-2705"><a href="#Generator.gen_synthetic_data_Null-2705"><span class="linenos">2705</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator.gen_synthetic_data_Null-2706"><a href="#Generator.gen_synthetic_data_Null-2706"><span class="linenos">2706</span></a>                <span class="n">Pm1_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2707"><a href="#Generator.gen_synthetic_data_Null-2707"><span class="linenos">2707</span></a>            
</span><span id="Generator.gen_synthetic_data_Null-2708"><a href="#Generator.gen_synthetic_data_Null-2708"><span class="linenos">2708</span></a>                <span class="n">Pm1_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c1</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm1_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="Generator.gen_synthetic_data_Null-2709"><a href="#Generator.gen_synthetic_data_Null-2709"><span class="linenos">2709</span></a>                <span class="n">Pm1_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm1_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)))</span>
</span><span id="Generator.gen_synthetic_data_Null-2710"><a href="#Generator.gen_synthetic_data_Null-2710"><span class="linenos">2710</span></a>                <span class="n">qx0_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm1_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="Generator.gen_synthetic_data_Null-2711"><a href="#Generator.gen_synthetic_data_Null-2711"><span class="linenos">2711</span></a>            
</span><span id="Generator.gen_synthetic_data_Null-2712"><a href="#Generator.gen_synthetic_data_Null-2712"><span class="linenos">2712</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qx0_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2713"><a href="#Generator.gen_synthetic_data_Null-2713"><span class="linenos">2713</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2714"><a href="#Generator.gen_synthetic_data_Null-2714"><span class="linenos">2714</span></a>                    <span class="n">Pn1_m1</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c1</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2715"><a href="#Generator.gen_synthetic_data_Null-2715"><span class="linenos">2715</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2716"><a href="#Generator.gen_synthetic_data_Null-2716"><span class="linenos">2716</span></a>                    <span class="n">qx0_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2717"><a href="#Generator.gen_synthetic_data_Null-2717"><span class="linenos">2717</span></a> 
</span><span id="Generator.gen_synthetic_data_Null-2718"><a href="#Generator.gen_synthetic_data_Null-2718"><span class="linenos">2718</span></a>        
</span><span id="Generator.gen_synthetic_data_Null-2719"><a href="#Generator.gen_synthetic_data_Null-2719"><span class="linenos">2719</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2720"><a href="#Generator.gen_synthetic_data_Null-2720"><span class="linenos">2720</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2721"><a href="#Generator.gen_synthetic_data_Null-2721"><span class="linenos">2721</span></a>                <span class="n">qx0_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2722"><a href="#Generator.gen_synthetic_data_Null-2722"><span class="linenos">2722</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2723"><a href="#Generator.gen_synthetic_data_Null-2723"><span class="linenos">2723</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1, or 2 only&#39;</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2724"><a href="#Generator.gen_synthetic_data_Null-2724"><span class="linenos">2724</span></a>        <span class="n">qx0_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">qx0_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qx0</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span> 
</span><span id="Generator.gen_synthetic_data_Null-2725"><a href="#Generator.gen_synthetic_data_Null-2725"><span class="linenos">2725</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2726"><a href="#Generator.gen_synthetic_data_Null-2726"><span class="linenos">2726</span></a>        <span class="c1">#0x</span>
</span><span id="Generator.gen_synthetic_data_Null-2727"><a href="#Generator.gen_synthetic_data_Null-2727"><span class="linenos">2727</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_q0x</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2728"><a href="#Generator.gen_synthetic_data_Null-2728"><span class="linenos">2728</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_q0x</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="Generator.gen_synthetic_data_Null-2729"><a href="#Generator.gen_synthetic_data_Null-2729"><span class="linenos">2729</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2730"><a href="#Generator.gen_synthetic_data_Null-2730"><span class="linenos">2730</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="Generator.gen_synthetic_data_Null-2731"><a href="#Generator.gen_synthetic_data_Null-2731"><span class="linenos">2731</span></a>        <span class="n">q0x_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2732"><a href="#Generator.gen_synthetic_data_Null-2732"><span class="linenos">2732</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2733"><a href="#Generator.gen_synthetic_data_Null-2733"><span class="linenos">2733</span></a>        <span class="n">q0x_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,))</span>
</span><span id="Generator.gen_synthetic_data_Null-2734"><a href="#Generator.gen_synthetic_data_Null-2734"><span class="linenos">2734</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2735"><a href="#Generator.gen_synthetic_data_Null-2735"><span class="linenos">2735</span></a>            <span class="n">q0x_m_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,))</span>
</span><span id="Generator.gen_synthetic_data_Null-2736"><a href="#Generator.gen_synthetic_data_Null-2736"><span class="linenos">2736</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2737"><a href="#Generator.gen_synthetic_data_Null-2737"><span class="linenos">2737</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2738"><a href="#Generator.gen_synthetic_data_Null-2738"><span class="linenos">2738</span></a>                <span class="n">m2</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2739"><a href="#Generator.gen_synthetic_data_Null-2739"><span class="linenos">2739</span></a>                <span class="n">v2</span><span class="o">=</span><span class="n">m2</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2740"><a href="#Generator.gen_synthetic_data_Null-2740"><span class="linenos">2740</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span>
</span><span id="Generator.gen_synthetic_data_Null-2741"><a href="#Generator.gen_synthetic_data_Null-2741"><span class="linenos">2741</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m2</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator.gen_synthetic_data_Null-2742"><a href="#Generator.gen_synthetic_data_Null-2742"><span class="linenos">2742</span></a>                <span class="n">Pm2_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2743"><a href="#Generator.gen_synthetic_data_Null-2743"><span class="linenos">2743</span></a>            
</span><span id="Generator.gen_synthetic_data_Null-2744"><a href="#Generator.gen_synthetic_data_Null-2744"><span class="linenos">2744</span></a>                <span class="n">Pm2_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c2</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm2_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="Generator.gen_synthetic_data_Null-2745"><a href="#Generator.gen_synthetic_data_Null-2745"><span class="linenos">2745</span></a>                <span class="n">Pm2_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm2_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm2_f_adj</span><span class="p">)))</span>
</span><span id="Generator.gen_synthetic_data_Null-2746"><a href="#Generator.gen_synthetic_data_Null-2746"><span class="linenos">2746</span></a>                <span class="n">q0x_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm2_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="Generator.gen_synthetic_data_Null-2747"><a href="#Generator.gen_synthetic_data_Null-2747"><span class="linenos">2747</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2748"><a href="#Generator.gen_synthetic_data_Null-2748"><span class="linenos">2748</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">q0x_m_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2749"><a href="#Generator.gen_synthetic_data_Null-2749"><span class="linenos">2749</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2750"><a href="#Generator.gen_synthetic_data_Null-2750"><span class="linenos">2750</span></a>                    <span class="n">Pn2_m2</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2751"><a href="#Generator.gen_synthetic_data_Null-2751"><span class="linenos">2751</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2752"><a href="#Generator.gen_synthetic_data_Null-2752"><span class="linenos">2752</span></a>                    <span class="n">q0x_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2753"><a href="#Generator.gen_synthetic_data_Null-2753"><span class="linenos">2753</span></a>        
</span><span id="Generator.gen_synthetic_data_Null-2754"><a href="#Generator.gen_synthetic_data_Null-2754"><span class="linenos">2754</span></a>                       
</span><span id="Generator.gen_synthetic_data_Null-2755"><a href="#Generator.gen_synthetic_data_Null-2755"><span class="linenos">2755</span></a>        
</span><span id="Generator.gen_synthetic_data_Null-2756"><a href="#Generator.gen_synthetic_data_Null-2756"><span class="linenos">2756</span></a>            <span class="k">elif</span> <span class="n">noise_model</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2757"><a href="#Generator.gen_synthetic_data_Null-2757"><span class="linenos">2757</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2758"><a href="#Generator.gen_synthetic_data_Null-2758"><span class="linenos">2758</span></a>                <span class="n">q0x_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2759"><a href="#Generator.gen_synthetic_data_Null-2759"><span class="linenos">2759</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2760"><a href="#Generator.gen_synthetic_data_Null-2760"><span class="linenos">2760</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1,or 2 only&#39;</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2761"><a href="#Generator.gen_synthetic_data_Null-2761"><span class="linenos">2761</span></a>        <span class="n">q0x_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_q0x</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="n">q0x_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>
</span><span id="Generator.gen_synthetic_data_Null-2762"><a href="#Generator.gen_synthetic_data_Null-2762"><span class="linenos">2762</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2763"><a href="#Generator.gen_synthetic_data_Null-2763"><span class="linenos">2763</span></a>        <span class="c1">#qxx</span>
</span><span id="Generator.gen_synthetic_data_Null-2764"><a href="#Generator.gen_synthetic_data_Null-2764"><span class="linenos">2764</span></a>        <span class="n">integ</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pf_qxx</span><span class="p">)</span><span class="o">+</span><span class="n">logfvec</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2765"><a href="#Generator.gen_synthetic_data_Null-2765"><span class="linenos">2765</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_distsample</span><span class="p">(</span><span class="n">dlogf</span><span class="o">*</span><span class="p">(</span><span class="n">integ</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">integ</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">num_qxx</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>        
</span><span id="Generator.gen_synthetic_data_Null-2766"><a href="#Generator.gen_synthetic_data_Null-2766"><span class="linenos">2766</span></a>        <span class="n">f_sorted_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2767"><a href="#Generator.gen_synthetic_data_Null-2767"><span class="linenos">2767</span></a>        <span class="n">f_samples_inds</span><span class="o">=</span><span class="n">f_samples_inds</span><span class="p">[</span><span class="n">f_sorted_inds</span><span class="p">]</span> 
</span><span id="Generator.gen_synthetic_data_Null-2768"><a href="#Generator.gen_synthetic_data_Null-2768"><span class="linenos">2768</span></a>        <span class="n">qxx_f_samples</span><span class="o">=</span><span class="n">fvec</span><span class="p">[</span><span class="n">f_samples_inds</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2769"><a href="#Generator.gen_synthetic_data_Null-2769"><span class="linenos">2769</span></a>        <span class="n">find_vals</span><span class="p">,</span><span class="n">f_start_ind</span><span class="p">,</span><span class="n">f_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">f_samples_inds</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2770"><a href="#Generator.gen_synthetic_data_Null-2770"><span class="linenos">2770</span></a>        <span class="n">qxx_n1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="Generator.gen_synthetic_data_Null-2771"><a href="#Generator.gen_synthetic_data_Null-2771"><span class="linenos">2771</span></a>        <span class="n">qxx_n2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="Generator.gen_synthetic_data_Null-2772"><a href="#Generator.gen_synthetic_data_Null-2772"><span class="linenos">2772</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2773"><a href="#Generator.gen_synthetic_data_Null-2773"><span class="linenos">2773</span></a>            <span class="n">qxx_m1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="Generator.gen_synthetic_data_Null-2774"><a href="#Generator.gen_synthetic_data_Null-2774"><span class="linenos">2774</span></a>            <span class="n">qxx_m2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_qxx</span><span class="p">,))</span>
</span><span id="Generator.gen_synthetic_data_Null-2775"><a href="#Generator.gen_synthetic_data_Null-2775"><span class="linenos">2775</span></a>        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">find</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">find_vals</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2776"><a href="#Generator.gen_synthetic_data_Null-2776"><span class="linenos">2776</span></a>            <span class="k">if</span> <span class="n">noise_model</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2777"><a href="#Generator.gen_synthetic_data_Null-2777"><span class="linenos">2777</span></a>                <span class="n">m1</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2778"><a href="#Generator.gen_synthetic_data_Null-2778"><span class="linenos">2778</span></a>                <span class="n">v1</span><span class="o">=</span><span class="n">m1</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2779"><a href="#Generator.gen_synthetic_data_Null-2779"><span class="linenos">2779</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span>
</span><span id="Generator.gen_synthetic_data_Null-2780"><a href="#Generator.gen_synthetic_data_Null-2780"><span class="linenos">2780</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m1</span><span class="o">*</span><span class="n">m1</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator.gen_synthetic_data_Null-2781"><a href="#Generator.gen_synthetic_data_Null-2781"><span class="linenos">2781</span></a>                <span class="n">Pm1_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2782"><a href="#Generator.gen_synthetic_data_Null-2782"><span class="linenos">2782</span></a>            
</span><span id="Generator.gen_synthetic_data_Null-2783"><a href="#Generator.gen_synthetic_data_Null-2783"><span class="linenos">2783</span></a>                <span class="n">Pm1_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c1</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm1_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="Generator.gen_synthetic_data_Null-2784"><a href="#Generator.gen_synthetic_data_Null-2784"><span class="linenos">2784</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2785"><a href="#Generator.gen_synthetic_data_Null-2785"><span class="linenos">2785</span></a>                    <span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="Generator.gen_synthetic_data_Null-2786"><a href="#Generator.gen_synthetic_data_Null-2786"><span class="linenos">2786</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2787"><a href="#Generator.gen_synthetic_data_Null-2787"><span class="linenos">2787</span></a>                    <span class="n">Pm1_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm1_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)))</span>
</span><span id="Generator.gen_synthetic_data_Null-2788"><a href="#Generator.gen_synthetic_data_Null-2788"><span class="linenos">2788</span></a>                    <span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm1_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="Generator.gen_synthetic_data_Null-2789"><a href="#Generator.gen_synthetic_data_Null-2789"><span class="linenos">2789</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2790"><a href="#Generator.gen_synthetic_data_Null-2790"><span class="linenos">2790</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qxx_m1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2791"><a href="#Generator.gen_synthetic_data_Null-2791"><span class="linenos">2791</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2792"><a href="#Generator.gen_synthetic_data_Null-2792"><span class="linenos">2792</span></a>                    <span class="n">Pn1_m1</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c1</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2793"><a href="#Generator.gen_synthetic_data_Null-2793"><span class="linenos">2793</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_m1</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2794"><a href="#Generator.gen_synthetic_data_Null-2794"><span class="linenos">2794</span></a>                    <span class="n">qxx_n1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn1_m1</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2795"><a href="#Generator.gen_synthetic_data_Null-2795"><span class="linenos">2795</span></a>                
</span><span id="Generator.gen_synthetic_data_Null-2796"><a href="#Generator.gen_synthetic_data_Null-2796"><span class="linenos">2796</span></a>                <span class="n">m2</span><span class="o">=</span><span class="n">m_total</span><span class="o">*</span><span class="n">fvec</span><span class="p">[</span><span class="n">find</span><span class="p">]</span>
</span><span id="Generator.gen_synthetic_data_Null-2797"><a href="#Generator.gen_synthetic_data_Null-2797"><span class="linenos">2797</span></a>                <span class="n">v2</span><span class="o">=</span><span class="n">m2</span><span class="o">+</span><span class="n">beta_mv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">alpha_mv</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2798"><a href="#Generator.gen_synthetic_data_Null-2798"><span class="linenos">2798</span></a>                <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span>
</span><span id="Generator.gen_synthetic_data_Null-2799"><a href="#Generator.gen_synthetic_data_Null-2799"><span class="linenos">2799</span></a>                <span class="n">n</span><span class="o">=</span><span class="n">m2</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">p</span>
</span><span id="Generator.gen_synthetic_data_Null-2800"><a href="#Generator.gen_synthetic_data_Null-2800"><span class="linenos">2800</span></a>                <span class="n">Pm2_f</span><span class="o">=</span><span class="n">nbinom</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2801"><a href="#Generator.gen_synthetic_data_Null-2801"><span class="linenos">2801</span></a>            
</span><span id="Generator.gen_synthetic_data_Null-2802"><a href="#Generator.gen_synthetic_data_Null-2802"><span class="linenos">2802</span></a>                <span class="n">Pm2_f_adj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r_c2</span><span class="o">*</span><span class="n">mvec</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Pm2_f</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">mvec</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">r_c2</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">),</span><span class="n">n</span><span class="p">))))</span> <span class="c1">#adds m-dependent factor due to conditioning on n&gt;0...</span>
</span><span id="Generator.gen_synthetic_data_Null-2803"><a href="#Generator.gen_synthetic_data_Null-2803"><span class="linenos">2803</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm1_f_adj</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2804"><a href="#Generator.gen_synthetic_data_Null-2804"><span class="linenos">2804</span></a>                    <span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="Generator.gen_synthetic_data_Null-2805"><a href="#Generator.gen_synthetic_data_Null-2805"><span class="linenos">2805</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2806"><a href="#Generator.gen_synthetic_data_Null-2806"><span class="linenos">2806</span></a>                    <span class="n">Pm2_f_adj_obj</span><span class="o">=</span><span class="n">rv_discrete</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;nbinom_adj&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">(</span><span class="n">mvec</span><span class="p">,</span><span class="n">Pm2_f_adj</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Pm2_f_adj</span><span class="p">)))</span>
</span><span id="Generator.gen_synthetic_data_Null-2807"><a href="#Generator.gen_synthetic_data_Null-2807"><span class="linenos">2807</span></a>                    <span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pm2_f_adj_obj</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
</span><span id="Generator.gen_synthetic_data_Null-2808"><a href="#Generator.gen_synthetic_data_Null-2808"><span class="linenos">2808</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2809"><a href="#Generator.gen_synthetic_data_Null-2809"><span class="linenos">2809</span></a>                <span class="n">mvals</span><span class="p">,</span><span class="n">minds</span><span class="p">,</span><span class="n">m_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qxx_m2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]],</span><span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2810"><a href="#Generator.gen_synthetic_data_Null-2810"><span class="linenos">2810</span></a>                <span class="k">for</span> <span class="n">mit</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mvals</span><span class="p">):</span>
</span><span id="Generator.gen_synthetic_data_Null-2811"><a href="#Generator.gen_synthetic_data_Null-2811"><span class="linenos">2811</span></a>                    <span class="n">Pn2_m2</span><span class="o">=</span><span class="n">poisson</span><span class="p">(</span><span class="n">r_c2</span><span class="o">*</span><span class="n">m</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2812"><a href="#Generator.gen_synthetic_data_Null-2812"><span class="linenos">2812</span></a>                    <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">m_counts</span><span class="p">[</span><span class="n">mit</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_m2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2813"><a href="#Generator.gen_synthetic_data_Null-2813"><span class="linenos">2813</span></a>                    <span class="n">qxx_n2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]][</span><span class="n">minds</span><span class="o">==</span><span class="n">mit</span><span class="p">]</span><span class="o">=</span><span class="n">Pn2_m2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>    
</span><span id="Generator.gen_synthetic_data_Null-2814"><a href="#Generator.gen_synthetic_data_Null-2814"><span class="linenos">2814</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2815"><a href="#Generator.gen_synthetic_data_Null-2815"><span class="linenos">2815</span></a>                          
</span><span id="Generator.gen_synthetic_data_Null-2816"><a href="#Generator.gen_synthetic_data_Null-2816"><span class="linenos">2816</span></a>            <span class="k">elif</span> <span class="n">noise_model</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2817"><a href="#Generator.gen_synthetic_data_Null-2817"><span class="linenos">2817</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2818"><a href="#Generator.gen_synthetic_data_Null-2818"><span class="linenos">2818</span></a>                <span class="n">qxx_n1_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn1_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2819"><a href="#Generator.gen_synthetic_data_Null-2819"><span class="linenos">2819</span></a>                <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2820"><a href="#Generator.gen_synthetic_data_Null-2820"><span class="linenos">2820</span></a>                <span class="n">qxx_n2_samples</span><span class="p">[</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]:</span><span class="n">f_start_ind</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">f_counts</span><span class="p">[</span><span class="n">it</span><span class="p">]]</span><span class="o">=</span><span class="n">Pn2_f</span><span class="p">[</span><span class="n">find</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2821"><a href="#Generator.gen_synthetic_data_Null-2821"><span class="linenos">2821</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Generator.gen_synthetic_data_Null-2822"><a href="#Generator.gen_synthetic_data_Null-2822"><span class="linenos">2822</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acq_model is 0,1, or 2 only&#39;</span><span class="p">)</span>
</span><span id="Generator.gen_synthetic_data_Null-2823"><a href="#Generator.gen_synthetic_data_Null-2823"><span class="linenos">2823</span></a>            
</span><span id="Generator.gen_synthetic_data_Null-2824"><a href="#Generator.gen_synthetic_data_Null-2824"><span class="linenos">2824</span></a>        <span class="n">qxx_pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">qxx_n1_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">qxx_n2_samples</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>
</span><span id="Generator.gen_synthetic_data_Null-2825"><a href="#Generator.gen_synthetic_data_Null-2825"><span class="linenos">2825</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2826"><a href="#Generator.gen_synthetic_data_Null-2826"><span class="linenos">2826</span></a>        <span class="n">pair_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">q0x_pair_samples</span><span class="p">,</span><span class="n">qx0_pair_samples</span><span class="p">,</span><span class="n">qxx_pair_samples</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2827"><a href="#Generator.gen_synthetic_data_Null-2827"><span class="linenos">2827</span></a>        <span class="n">f_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_f_samples</span><span class="p">,</span><span class="n">qx0_f_samples</span><span class="p">,</span><span class="n">qxx_f_samples</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2828"><a href="#Generator.gen_synthetic_data_Null-2828"><span class="linenos">2828</span></a>        <span class="n">output_m_samples</span><span class="o">=</span><span class="kc">False</span>
</span><span id="Generator.gen_synthetic_data_Null-2829"><a href="#Generator.gen_synthetic_data_Null-2829"><span class="linenos">2829</span></a>        <span class="k">if</span> <span class="n">noise_model</span><span class="o">&lt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">output_m_samples</span><span class="p">:</span>                
</span><span id="Generator.gen_synthetic_data_Null-2830"><a href="#Generator.gen_synthetic_data_Null-2830"><span class="linenos">2830</span></a>            <span class="n">m1_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_m1_samples</span><span class="p">,</span><span class="n">qx0_m1_samples</span><span class="p">,</span><span class="n">qxx_m1_samples</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2831"><a href="#Generator.gen_synthetic_data_Null-2831"><span class="linenos">2831</span></a>            <span class="n">m2_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">q0x_m2_samples</span><span class="p">,</span><span class="n">qx0_m2_samples</span><span class="p">,</span><span class="n">qxx_m2_samples</span><span class="p">))</span>
</span><span id="Generator.gen_synthetic_data_Null-2832"><a href="#Generator.gen_synthetic_data_Null-2832"><span class="linenos">2832</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2833"><a href="#Generator.gen_synthetic_data_Null-2833"><span class="linenos">2833</span></a>        <span class="n">pair_samples_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">:</span><span class="n">pair_samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">:</span><span class="n">pair_samples</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]})</span>
</span><span id="Generator.gen_synthetic_data_Null-2834"><a href="#Generator.gen_synthetic_data_Null-2834"><span class="linenos">2834</span></a>
</span><span id="Generator.gen_synthetic_data_Null-2835"><a href="#Generator.gen_synthetic_data_Null-2835"><span class="linenos">2835</span></a>        <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_fraction_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_1&#39;</span><span class="p">])</span>
</span><span id="Generator.gen_synthetic_data_Null-2836"><a href="#Generator.gen_synthetic_data_Null-2836"><span class="linenos">2836</span></a>        <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_fraction_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pair_samples_df</span><span class="p">[</span><span class="s1">&#39;Clone_count_2&#39;</span><span class="p">])</span>
</span><span id="Generator.gen_synthetic_data_Null-2837"><a href="#Generator.gen_synthetic_data_Null-2837"><span class="linenos">2837</span></a>    
</span><span id="Generator.gen_synthetic_data_Null-2838"><a href="#Generator.gen_synthetic_data_Null-2838"><span class="linenos">2838</span></a>        <span class="k">return</span> <span class="n">f_samples</span><span class="p">,</span><span class="n">pair_samples_df</span>
</span></pre></div>


            <div class="docstring"><p>outputs an array of observed clone frequencies and corresponding dataframe of pair counts
for a null model learned from a dataset pair with NreadsI and NreadsII number of reads, respectively.
Crucial for RAM efficiency, sampling is conditioned on being observed in each of the three (n,0), (0,n'), and n,n'>0 conditions
so that only Nsamp clones need to be sampled, rather than the N clones in the repertoire.
Note that no explicit normalization is applied. It is assumed that the values in paras are consistent with N<f>=1 
(e.g. were obtained through the learning done in this package).</p>
</div>


                            </div>
                            <div id="Generator.generate_trajectories" class="classattr">
                                        <input id="Generator.generate_trajectories-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_trajectories</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">tau</span>,</span><span class="param">	<span class="n">theta</span>,</span><span class="param">	<span class="n">method</span>,</span><span class="param">	<span class="n">paras_1</span>,</span><span class="param">	<span class="n">paras_2</span>,</span><span class="param">	<span class="n">t_ime</span>,</span><span class="param">	<span class="n">filename</span>,</span><span class="param">	<span class="n">NreadsI</span><span class="o">=</span><span class="s1">&#39;1e6&#39;</span>,</span><span class="param">	<span class="n">NreadsII</span><span class="o">=</span><span class="s1">&#39;1e6&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Generator.generate_trajectories-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Generator.generate_trajectories"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Generator.generate_trajectories-2841"><a href="#Generator.generate_trajectories-2841"><span class="linenos">2841</span></a>    <span class="k">def</span> <span class="nf">generate_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">paras_1</span><span class="p">,</span> <span class="n">paras_2</span><span class="p">,</span> <span class="n">t_ime</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">NreadsI</span> <span class="o">=</span> <span class="s1">&#39;1e6&#39;</span><span class="p">,</span> <span class="n">NreadsII</span> <span class="o">=</span> <span class="s1">&#39;1e6&#39;</span><span class="p">):</span>
</span><span id="Generator.generate_trajectories-2842"><a href="#Generator.generate_trajectories-2842"><span class="linenos">2842</span></a>
</span><span id="Generator.generate_trajectories-2843"><a href="#Generator.generate_trajectories-2843"><span class="linenos">2843</span></a>
</span><span id="Generator.generate_trajectories-2844"><a href="#Generator.generate_trajectories-2844"><span class="linenos">2844</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Generator.generate_trajectories-2845"><a href="#Generator.generate_trajectories-2845"><span class="linenos">2845</span></a><span class="sd">        generate in-silico t_ime apart RepSeq samples.</span>
</span><span id="Generator.generate_trajectories-2846"><a href="#Generator.generate_trajectories-2846"><span class="linenos">2846</span></a><span class="sd">        </span>
</span><span id="Generator.generate_trajectories-2847"><a href="#Generator.generate_trajectories-2847"><span class="linenos">2847</span></a><span class="sd">        Parameters</span>
</span><span id="Generator.generate_trajectories-2848"><a href="#Generator.generate_trajectories-2848"><span class="linenos">2848</span></a><span class="sd">        ----------</span>
</span><span id="Generator.generate_trajectories-2849"><a href="#Generator.generate_trajectories-2849"><span class="linenos">2849</span></a><span class="sd">        paras_1  : numpy array</span>
</span><span id="Generator.generate_trajectories-2850"><a href="#Generator.generate_trajectories-2850"><span class="linenos">2850</span></a><span class="sd">            parameters of the noise model that has been learnt at time_1</span>
</span><span id="Generator.generate_trajectories-2851"><a href="#Generator.generate_trajectories-2851"><span class="linenos">2851</span></a><span class="sd">        paras_2  : numpy array</span>
</span><span id="Generator.generate_trajectories-2852"><a href="#Generator.generate_trajectories-2852"><span class="linenos">2852</span></a><span class="sd">            parameters of the noise model that has been learnt at time_2</span>
</span><span id="Generator.generate_trajectories-2853"><a href="#Generator.generate_trajectories-2853"><span class="linenos">2853</span></a><span class="sd">        method   : str</span>
</span><span id="Generator.generate_trajectories-2854"><a href="#Generator.generate_trajectories-2854"><span class="linenos">2854</span></a><span class="sd">            &#39;negative_binomial&#39; or &#39;poisson&#39;</span>
</span><span id="Generator.generate_trajectories-2855"><a href="#Generator.generate_trajectories-2855"><span class="linenos">2855</span></a><span class="sd">        tau      : float</span>
</span><span id="Generator.generate_trajectories-2856"><a href="#Generator.generate_trajectories-2856"><span class="linenos">2856</span></a><span class="sd">            first time-scale parameter of the dynamics</span>
</span><span id="Generator.generate_trajectories-2857"><a href="#Generator.generate_trajectories-2857"><span class="linenos">2857</span></a><span class="sd">        theta    : float</span>
</span><span id="Generator.generate_trajectories-2858"><a href="#Generator.generate_trajectories-2858"><span class="linenos">2858</span></a><span class="sd">            second time-scale parameter of the dynamics</span>
</span><span id="Generator.generate_trajectories-2859"><a href="#Generator.generate_trajectories-2859"><span class="linenos">2859</span></a><span class="sd">        t_ime    : float</span>
</span><span id="Generator.generate_trajectories-2860"><a href="#Generator.generate_trajectories-2860"><span class="linenos">2860</span></a><span class="sd">            number of years between both synthetic sampling (between time_1 and time_2)</span>
</span><span id="Generator.generate_trajectories-2861"><a href="#Generator.generate_trajectories-2861"><span class="linenos">2861</span></a><span class="sd">        filename : str</span>
</span><span id="Generator.generate_trajectories-2862"><a href="#Generator.generate_trajectories-2862"><span class="linenos">2862</span></a><span class="sd">            name of the file in which the dataframe is stored  </span>
</span><span id="Generator.generate_trajectories-2863"><a href="#Generator.generate_trajectories-2863"><span class="linenos">2863</span></a>
</span><span id="Generator.generate_trajectories-2864"><a href="#Generator.generate_trajectories-2864"><span class="linenos">2864</span></a><span class="sd">        Returns</span>
</span><span id="Generator.generate_trajectories-2865"><a href="#Generator.generate_trajectories-2865"><span class="linenos">2865</span></a><span class="sd">        -------</span>
</span><span id="Generator.generate_trajectories-2866"><a href="#Generator.generate_trajectories-2866"><span class="linenos">2866</span></a><span class="sd">        data-frame - csv file</span>
</span><span id="Generator.generate_trajectories-2867"><a href="#Generator.generate_trajectories-2867"><span class="linenos">2867</span></a><span class="sd">            the output is a csv file of columns : &#39;Clone_count_1&#39; (at time_1) &#39;Clone_count_2&#39; (at time_2) and the frequency counterparts &#39;Clone_frequency_1&#39; and &#39;Clone_frequency_2&#39;</span>
</span><span id="Generator.generate_trajectories-2868"><a href="#Generator.generate_trajectories-2868"><span class="linenos">2868</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Generator.generate_trajectories-2869"><a href="#Generator.generate_trajectories-2869"><span class="linenos">2869</span></a>
</span><span id="Generator.generate_trajectories-2870"><a href="#Generator.generate_trajectories-2870"><span class="linenos">2870</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span> 
</span><span id="Generator.generate_trajectories-2871"><a href="#Generator.generate_trajectories-2871"><span class="linenos">2871</span></a>        <span class="n">np</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2872"><a href="#Generator.generate_trajectories-2872"><span class="linenos">2872</span></a>
</span><span id="Generator.generate_trajectories-2873"><a href="#Generator.generate_trajectories-2873"><span class="linenos">2873</span></a>        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;negative_binomial&#39;</span>
</span><span id="Generator.generate_trajectories-2874"><a href="#Generator.generate_trajectories-2874"><span class="linenos">2874</span></a>
</span><span id="Generator.generate_trajectories-2875"><a href="#Generator.generate_trajectories-2875"><span class="linenos">2875</span></a>
</span><span id="Generator.generate_trajectories-2876"><a href="#Generator.generate_trajectories-2876"><span class="linenos">2876</span></a>        <span class="c1"># Synthetic data generation</span>
</span><span id="Generator.generate_trajectories-2877"><a href="#Generator.generate_trajectories-2877"><span class="linenos">2877</span></a>
</span><span id="Generator.generate_trajectories-2878"><a href="#Generator.generate_trajectories-2878"><span class="linenos">2878</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;execution starting...&#39;</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2879"><a href="#Generator.generate_trajectories-2879"><span class="linenos">2879</span></a>
</span><span id="Generator.generate_trajectories-2880"><a href="#Generator.generate_trajectories-2880"><span class="linenos">2880</span></a>        <span class="n">st</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="Generator.generate_trajectories-2881"><a href="#Generator.generate_trajectories-2881"><span class="linenos">2881</span></a>
</span><span id="Generator.generate_trajectories-2882"><a href="#Generator.generate_trajectories-2882"><span class="linenos">2882</span></a>        <span class="c1">#Values of the parameters</span>
</span><span id="Generator.generate_trajectories-2883"><a href="#Generator.generate_trajectories-2883"><span class="linenos">2883</span></a>        <span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">tau</span>
</span><span id="Generator.generate_trajectories-2884"><a href="#Generator.generate_trajectories-2884"><span class="linenos">2884</span></a>        <span class="n">B</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">theta</span>
</span><span id="Generator.generate_trajectories-2885"><a href="#Generator.generate_trajectories-2885"><span class="linenos">2885</span></a>        <span class="n">N_0</span> <span class="o">=</span> <span class="mi">40</span>
</span><span id="Generator.generate_trajectories-2886"><a href="#Generator.generate_trajectories-2886"><span class="linenos">2886</span></a>        <span class="n">NreadsI</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2887"><a href="#Generator.generate_trajectories-2887"><span class="linenos">2887</span></a>        <span class="n">NreadsII</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">NreadsII</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2888"><a href="#Generator.generate_trajectories-2888"><span class="linenos">2888</span></a>
</span><span id="Generator.generate_trajectories-2889"><a href="#Generator.generate_trajectories-2889"><span class="linenos">2889</span></a>        <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_ime</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2890"><a href="#Generator.generate_trajectories-2890"><span class="linenos">2890</span></a>
</span><span id="Generator.generate_trajectories-2891"><a href="#Generator.generate_trajectories-2891"><span class="linenos">2891</span></a>        <span class="k">if</span> <span class="n">NreadsI</span> <span class="o">==</span> <span class="n">NreadsII</span><span class="p">:</span>
</span><span id="Generator.generate_trajectories-2892"><a href="#Generator.generate_trajectories-2892"><span class="linenos">2892</span></a>            <span class="n">key_sym</span> <span class="o">=</span> <span class="s1">&#39;_sym_&#39;</span>
</span><span id="Generator.generate_trajectories-2893"><a href="#Generator.generate_trajectories-2893"><span class="linenos">2893</span></a>
</span><span id="Generator.generate_trajectories-2894"><a href="#Generator.generate_trajectories-2894"><span class="linenos">2894</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Generator.generate_trajectories-2895"><a href="#Generator.generate_trajectories-2895"><span class="linenos">2895</span></a>            <span class="n">key_sym</span> <span class="o">=</span> <span class="s1">&#39;_asym_&#39;</span>
</span><span id="Generator.generate_trajectories-2896"><a href="#Generator.generate_trajectories-2896"><span class="linenos">2896</span></a>
</span><span id="Generator.generate_trajectories-2897"><a href="#Generator.generate_trajectories-2897"><span class="linenos">2897</span></a>        <span class="c1"># Name of the directory</span>
</span><span id="Generator.generate_trajectories-2898"><a href="#Generator.generate_trajectories-2898"><span class="linenos">2898</span></a>
</span><span id="Generator.generate_trajectories-2899"><a href="#Generator.generate_trajectories-2899"><span class="linenos">2899</span></a>
</span><span id="Generator.generate_trajectories-2900"><a href="#Generator.generate_trajectories-2900"><span class="linenos">2900</span></a>        <span class="n">dirName</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span>    
</span><span id="Generator.generate_trajectories-2901"><a href="#Generator.generate_trajectories-2901"><span class="linenos">2901</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirName</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span><span id="Generator.generate_trajectories-2902"><a href="#Generator.generate_trajectories-2902"><span class="linenos">2902</span></a>
</span><span id="Generator.generate_trajectories-2903"><a href="#Generator.generate_trajectories-2903"><span class="linenos">2903</span></a>        <span class="n">paras</span> <span class="o">=</span> <span class="n">paras_1</span> <span class="c1">#Just put a and b of the negative binomiale distribution [0.7, 1.1]</span>
</span><span id="Generator.generate_trajectories-2904"><a href="#Generator.generate_trajectories-2904"><span class="linenos">2904</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">A</span><span class="o">/</span><span class="n">B</span>
</span><span id="Generator.generate_trajectories-2905"><a href="#Generator.generate_trajectories-2905"><span class="linenos">2905</span></a>        <span class="c1">#print(&#39;alpha : &#39; + str(alpha))</span>
</span><span id="Generator.generate_trajectories-2906"><a href="#Generator.generate_trajectories-2906"><span class="linenos">2906</span></a>
</span><span id="Generator.generate_trajectories-2907"><a href="#Generator.generate_trajectories-2907"><span class="linenos">2907</span></a>        <span class="c1">#1/ Generate log-population at initial time from steady-state distribution + GBM diffusion trajectories for 2 years</span>
</span><span id="Generator.generate_trajectories-2908"><a href="#Generator.generate_trajectories-2908"><span class="linenos">2908</span></a>        <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">Prop_Matrix_LB</span><span class="p">,</span> <span class="n">p_ext_LB</span><span class="p">,</span> <span class="n">results_extinction_LB</span><span class="p">,</span> <span class="n">time_vec_LB</span><span class="p">,</span> <span class="n">results_extinction_source_LB</span><span class="p">,</span> <span class="n">x_source_LB</span> <span class="o">=</span> <span class="n">_generator_diffusion_LB</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">N_0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2909"><a href="#Generator.generate_trajectories-2909"><span class="linenos">2909</span></a>        
</span><span id="Generator.generate_trajectories-2910"><a href="#Generator.generate_trajectories-2910"><span class="linenos">2910</span></a>        <span class="c1">#x_i_LB, x_f_LB, Prop_Matrix, p_ext, results_extinction  = generator_diffusion_LB(B, A, N_0, t)</span>
</span><span id="Generator.generate_trajectories-2911"><a href="#Generator.generate_trajectories-2911"><span class="linenos">2911</span></a>        <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_i_LB</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_f_LB</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_source_LB</span><span class="p">))</span>  <span class="c1">#N_cells_final_LB</span>
</span><span id="Generator.generate_trajectories-2912"><a href="#Generator.generate_trajectories-2912"><span class="linenos">2912</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NUMBER OF CELLS AT INITIAL TIME&#39;</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2913"><a href="#Generator.generate_trajectories-2913"><span class="linenos">2913</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">N_cells_day_0_LB</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2914"><a href="#Generator.generate_trajectories-2914"><span class="linenos">2914</span></a>
</span><span id="Generator.generate_trajectories-2915"><a href="#Generator.generate_trajectories-2915"><span class="linenos">2915</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NUMBER OF CELLS AT FINAL TIME&#39;</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2916"><a href="#Generator.generate_trajectories-2916"><span class="linenos">2916</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2917"><a href="#Generator.generate_trajectories-2917"><span class="linenos">2917</span></a>
</span><span id="Generator.generate_trajectories-2918"><a href="#Generator.generate_trajectories-2918"><span class="linenos">2918</span></a>        <span class="c1">#print(&#39;SHAPE_X_I &#39; +  str(np.shape(x_i_LB)))</span>
</span><span id="Generator.generate_trajectories-2919"><a href="#Generator.generate_trajectories-2919"><span class="linenos">2919</span></a>        <span class="c1">#print(&#39;SHAPE_X_F &#39; +  str(np.shape(x_f_LB)))</span>
</span><span id="Generator.generate_trajectories-2920"><a href="#Generator.generate_trajectories-2920"><span class="linenos">2920</span></a>
</span><span id="Generator.generate_trajectories-2921"><a href="#Generator.generate_trajectories-2921"><span class="linenos">2921</span></a>
</span><span id="Generator.generate_trajectories-2922"><a href="#Generator.generate_trajectories-2922"><span class="linenos">2922</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;negative_binomial&#39;</span><span class="p">:</span>
</span><span id="Generator.generate_trajectories-2923"><a href="#Generator.generate_trajectories-2923"><span class="linenos">2923</span></a>
</span><span id="Generator.generate_trajectories-2924"><a href="#Generator.generate_trajectories-2924"><span class="linenos">2924</span></a>            <span class="n">df_diffusion_LB</span>  <span class="o">=</span> <span class="n">_experimental_sampling_diffusion_NegBin</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">paras</span><span class="p">,</span> <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2925"><a href="#Generator.generate_trajectories-2925"><span class="linenos">2925</span></a>            <span class="n">df_diffusion_LB</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span> <span class="p">,</span> <span class="n">sep</span><span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2926"><a href="#Generator.generate_trajectories-2926"><span class="linenos">2926</span></a>
</span><span id="Generator.generate_trajectories-2927"><a href="#Generator.generate_trajectories-2927"><span class="linenos">2927</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;poisson&#39;</span><span class="p">:</span> 
</span><span id="Generator.generate_trajectories-2928"><a href="#Generator.generate_trajectories-2928"><span class="linenos">2928</span></a>
</span><span id="Generator.generate_trajectories-2929"><a href="#Generator.generate_trajectories-2929"><span class="linenos">2929</span></a>            <span class="n">df_diffusion_LB</span>  <span class="o">=</span> <span class="n">_experimental_sampling_diffusion_Poisson</span><span class="p">(</span><span class="n">NreadsI</span><span class="p">,</span> <span class="n">NreadsII</span><span class="p">,</span> <span class="n">x_i_LB</span><span class="p">,</span> <span class="n">x_f_LB</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">N_cells_day_0_LB</span><span class="p">,</span> <span class="n">N_cells_day_1_LB</span><span class="p">)</span>
</span><span id="Generator.generate_trajectories-2930"><a href="#Generator.generate_trajectories-2930"><span class="linenos">2930</span></a>            <span class="n">df_diffusion_LB</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span> <span class="p">,</span> <span class="n">sep</span><span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>generate in-silico t_ime apart RepSeq samples.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>paras_1</strong> (numpy array):
parameters of the noise model that has been learnt at time_1</li>
<li><strong>paras_2</strong> (numpy array):
parameters of the noise model that has been learnt at time_2</li>
<li><strong>method</strong> (str):
'negative_binomial' or 'poisson'</li>
<li><strong>tau</strong> (float):
first time-scale parameter of the dynamics</li>
<li><strong>theta</strong> (float):
second time-scale parameter of the dynamics</li>
<li><strong>t_ime</strong> (float):
number of years between both synthetic sampling (between time_1 and time_2)</li>
<li><strong>filename</strong> (str):
name of the file in which the dataframe is stored</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>data-frame - csv file</strong>: the output is a csv file of columns : 'Clone_count_1' (at time_1) 'Clone_count_2' (at time_2) and the frequency counterparts 'Clone_frequency_1' and 'Clone_frequency_2'</li>
</ul>
</div>


                            </div>
                </section>
    </main>
</body>
</html>
